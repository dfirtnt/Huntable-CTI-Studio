{% extends "base.html" %}

{% block title %}{{ article.title[:50] }}... - CTI Scraper{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <a href="/articles" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2">Articles</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Article #{{ article.id }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Article Header -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ article.title }}</h1>
                
                <div class="flex items-center space-x-6 text-sm text-gray-500 mb-4">
                    <div class="flex items-center">
                        <span class="mr-2">üì∞</span>
                        <span>Source: 
                            {% if article.canonical_url %}
                                <a href="{{ article.canonical_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                                    {{ source.name if source else article.source_id }}
                                </a>
                            {% else %}
                                {{ source.name if source else article.source_id }}
                            {% endif %}
                        </span>
                    </div>
                    {% if article.published_at %}
                    <div class="flex items-center">
                        <span class="mr-2">üìÖ</span>
                        <span>{{ article.published_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    </div>
                    {% endif %}
                    <div class="flex items-center">
                        <span class="mr-2">üìä</span>
                        <span>{{ article.content|length }} characters</span>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-2">üÜî</span>
                        <span>#{{ article.id }}</span>
                    </div>
                    {% if article.metadata and article.metadata.get('threat_hunting_score') is not none %}
                    <div class="flex items-center">
                        <span class="mr-2">üéØ</span>
                        <span>Threat Hunting Score: 
                            {% set score = article.metadata.get('threat_hunting_score', 0) %}
                            {% if score >= 80 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    üéØ {{ "%.1f"|format(score) }}
                                </span>
                            {% elif score >= 60 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    üü° {{ "%.1f"|format(score) }}
                                </span>
                            {% elif score >= 40 %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                    üü† {{ "%.1f"|format(score) }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    üî¥ {{ "%.1f"|format(score) }}
                                </span>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>

                {% if article.canonical_url %}
                <div class="mb-4">
                    <a href="{{ article.canonical_url }}" target="_blank" 
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        <span class="mr-2">üîó</span>
                        View Original Source
                    </a>
                </div>
                {% endif %}
                
                <!-- Delete Article Button -->
                <div class="mb-4">
                    <button onclick="deleteArticle({{ article.id }})" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                        <span class="mr-2">üóëÔ∏è</span>
                        Delete Article
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyword Matches Display -->
    {% if article.metadata and (article.metadata.get('perfect_keyword_matches') or article.metadata.get('good_keyword_matches') or article.metadata.get('lolbas_matches')) %}
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üéØ Keyword Matches</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Perfect Discriminators -->
            {% if article.metadata.get('perfect_keyword_matches') %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-green-800 mb-2 flex items-center">
                    <span class="mr-2">‚úÖ</span>
                    Perfect Discriminators
                </h3>
                <div class="flex flex-wrap gap-1">
                    {% for keyword in article.metadata.get('perfect_keyword_matches', []) %}
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                        {{ keyword }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Good Discriminators -->
            {% if article.metadata.get('good_keyword_matches') %}
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-purple-800 mb-2 flex items-center">
                    <span class="mr-2">üü£</span>
                    Good Discriminators
                </h3>
                <div class="flex flex-wrap gap-1">
                    {% for keyword in article.metadata.get('good_keyword_matches', []) %}
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">
                        {{ keyword }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- LOLBAS Executables -->
            {% if article.metadata.get('lolbas_matches') %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                    <span class="mr-2">üîß</span>
                    LOLBAS Executables
                </h3>
                <div class="flex flex-wrap gap-1">
                    {% for keyword in article.metadata.get('lolbas_matches', []) %}
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        {{ keyword }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
        </div>
        
        <!-- Additional Metrics -->
        {% if article.metadata.get('keyword_density') %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">Keyword Density:</span>
                    <span class="text-gray-600">{{ "%.2f"|format(article.metadata.get('keyword_density', 0)) }} per 1000 words</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Classification Controls -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üè∑Ô∏è Article Classification</h2>
        
        <!-- Settings Status -->
        <!-- Current Classification Status -->
        <div class="mb-6">
            {% if article.metadata and article.metadata.get('training_category') %}
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">Current Status:</span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if article.metadata.get('training_category') == 'chosen' %}bg-green-100 text-green-800
                        {% elif article.metadata.get('training_category') == 'rejected' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {% if article.metadata.get('training_category') == 'chosen' %}‚úÖ Chosen
                        {% elif article.metadata.get('training_category') == 'rejected' %}‚ùå Rejected
                        {% else %}‚è≥ Unclassified{% endif %}
                    </span>
                    {% if article.metadata.get('training_categorized_at') %}
                        <span class="text-sm text-gray-500">({{ article.metadata.get('training_categorized_at')[:19] }})</span>
                    {% endif %}
                </div>
            {% else %}
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">Current Status:</span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        ‚è≥ Unclassified
                    </span>
                </div>
            {% endif %}
        </div>
        
        <!-- GPT4o Ranking Results -->
        <div id="gpt4o-ranking-results" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg" style="display: none;">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">üìä GPT4o SIGMA Huntability Analysis</h3>
            <div id="gpt4o-ranking-content" class="text-sm text-blue-800">
                <!-- Results will be populated here -->
            </div>
        </div>
        
        <!-- Classification Buttons -->
        <div class="flex flex-wrap gap-4 mb-6">
            <button onclick="classifyArticle('chosen')" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                <span class="mr-2">‚úÖ</span>
                Mark as Chosen
            </button>
            
            <button onclick="classifyArticle('rejected')" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                <span class="mr-2">‚ùå</span>
                Mark as Rejected
            </button>
            
            <button onclick="classifyArticle('unclassified')" 
                    class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                <span class="mr-2">‚è≥</span>
                Mark as Unclassified
            </button>
            
            <!-- AI Assistant Button -->
            <button onclick="showAIAssistant()" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                <span class="mr-2">ü§ñ</span>
                AI Assistant
            </button>
            
            <!-- GPT4o Ranking Button -->
            <button onclick="rankWithGPT4o()" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                <span class="mr-2">üìä</span>
                Rank with GPT4o
            </button>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="flex flex-wrap gap-4">
            <button onclick="navigateToNextUnclassified()" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                <span class="mr-2">‚è≠Ô∏è</span>
                Next Unclassified
            </button>
            
            <button onclick="navigateToPrevious()" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                <span class="mr-2">‚èÆÔ∏è</span>
                Previous Article
            </button>
            
            <button onclick="navigateToNext()" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                <span class="mr-2">‚è≠Ô∏è</span>
                Next Article
            </button>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üìÑ Article Content</h2>
        
        {% if article.summary %}
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Summary</h3>
            <p class="text-gray-700">{{ article.summary }}</p>
        </div>
        {% endif %}
        
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Article Content</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Select text to annotate</span>
                    <div class="flex items-center space-x-1">
                        <span class="w-3 h-3 bg-green-100 border border-green-300 rounded"></span>
                        <span class="text-xs text-gray-600">Huntable</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="w-3 h-3 bg-red-100 border border-red-300 rounded"></span>
                        <span class="text-xs text-gray-600">Not Huntable</span>
                    </div>
                </div>
            </div>
            <div class="prose max-w-none">
                <div id="article-content" class="whitespace-pre-wrap text-sm text-gray-800 font-mono leading-relaxed select-text">{{ article.content|highlight_keywords(article.metadata)|safe }}</div>
            </div>
        </div>
    </div>

    <!-- Article Metadata -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üìã Article Metadata</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Basic Information</h3>
                <dl class="space-y-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Article ID</dt>
                        <dd class="text-sm text-gray-900">#{{ article.id }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Source ID</dt>
                        <dd class="text-sm text-gray-900">{{ article.source_id }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Published At</dt>
                        <dd class="text-sm text-gray-900">{{ article.published_at.strftime('%Y-%m-%d %H:%M:%S') if article.published_at else 'N/A' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Discovered At</dt>
                        <dd class="text-sm text-gray-900">{{ article.discovered_at.strftime('%Y-%m-%d %H:%M:%S') if article.discovered_at else 'N/A' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Processing Status</dt>
                        <dd class="text-sm text-gray-900">{{ article.processing_status }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Word Count</dt>
                        <dd class="text-sm text-gray-900">{{ article.word_count or 'N/A' }}</dd>
                    </div>
                </dl>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Content Details</h3>
                <dl class="space-y-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Content Length</dt>
                        <dd class="text-sm text-gray-900">{{ article.content|length }} characters</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Content Hash</dt>
                        <dd class="text-sm text-gray-900 font-mono">{{ article.content_hash[:20] }}...</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Authors</dt>
                        <dd class="text-sm text-gray-900">
                            {% if article.authors %}
                                {{ article.authors|join(', ') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Tags</dt>
                        <dd class="text-sm text-gray-900">
                            {% if article.tags %}
                                {{ article.tags|join(', ') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
        
        {% if article.metadata %}
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Additional Metadata</h3>
            <pre class="bg-gray-50 p-4 rounded-lg text-sm text-gray-700 overflow-x-auto">{{ article.metadata|tojson(indent=2) }}</pre>
        </div>
        {% endif %}
    </div>

    <!-- Navigation -->
    <div class="flex items-center justify-between">
        <a href="/articles" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <span class="mr-2">‚Üê</span>
            Back to Articles
        </a>
        
        <div class="flex space-x-2">
            {% if article.id > 1 %}
            <a href="/articles/{{ article.id - 1 }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                Previous Article
            </a>
            {% endif %}
            
            <a href="/articles/{{ article.id + 1 }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                Next Article
                <span class="ml-2">‚Üí</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add syntax highlighting for matched text
    document.addEventListener('DOMContentLoaded', function() {
        
        // Syntax highlighting for matched text
        const matchedTexts = document.querySelectorAll('.font-mono');
        matchedTexts.forEach(element => {
            element.style.backgroundColor = '#fef3c7';
            element.style.border = '1px solid #f59e0b';
        });
        
        // Initialize current article classification in localStorage
        const currentClassification = '{{ article.metadata.get("training_category", "") }}';
        localStorage.setItem('currentArticleClassification', currentClassification);
        
        // Load existing annotations
    });
    
    // Simple Text Management System - Single Source of Truth
    class SimpleTextManager {
        constructor() {
            this.contentElement = document.getElementById('article-content');
            this.userClassifications = new Map();
            this.previousStates = []; // Store previous HTML states for undo
            this.maxUndoStates = 10;
            
            this.init();
        }
        
        init() {
            // Load existing user classifications
            this.loadExistingClassifications();
            
            // Enable user text selection
            this.enableUserSelection();
            
            // Enable keyboard shortcuts
            this.enableKeyboardShortcuts();
            
            // Enable clicking on annotations to remove them
            this.enableAnnotationClicking();
        }
        
        
        async loadExistingClassifications() {
            try {
                console.log('Loading existing classifications for article {{ article.id }}');
                const response = await fetch(`/api/articles/{{ article.id }}/annotations`);
                const data = await response.json();
                
                console.log('API response:', data);
                
                if (data.success && data.annotations) {
                    console.log(`Found ${data.annotations.length} existing annotations`);
                    
                    // Wait a bit for the page to fully load before adding annotations
                    setTimeout(() => {
                        data.annotations.forEach(annotation => {
                            console.log(`Loading annotation: ${annotation.annotation_type} - "${annotation.selected_text.substring(0, 50)}..."`);
                            this.addExistingClassification(
                                annotation.start_position,
                                annotation.end_position,
                                annotation.annotation_type,
                                annotation.selected_text
                            );
                        });
                    }, 100);
                } else {
                    console.log('No existing annotations found');
                }
            } catch (error) {
                console.error('Failed to load existing classifications:', error);
            }
        }
        
        addExistingClassification(start, end, classification, text) {
            console.log(`Checking existing annotation: ${classification} - "${text.substring(0, 50)}..."`);
            
            // Check if this text is already highlighted by looking for spans with our classes
            const cssClass = classification === 'huntable' 
                ? 'bg-blue-100' 
                : 'bg-red-100';
            
            // Look for existing spans with our annotation classes
            const existingSpans = this.contentElement.querySelectorAll(`span.${cssClass}`);
            let alreadyHighlighted = false;
            
            for (const span of existingSpans) {
                // Check if this span contains our text (or vice versa for partial matches)
                const spanText = span.textContent.trim();
                const searchText = text.trim();
                
                // More precise matching - check if the span text matches our annotation text
                if (spanText === searchText || spanText.includes(searchText)) {
                    alreadyHighlighted = true;
                    console.log(`Text already highlighted in span: "${spanText.substring(0, 50)}..."`);
                    break;
                }
            }
            
            if (!alreadyHighlighted) {
                console.log('Text not yet highlighted, adding annotation');
                this.addUserClassification(start, end, classification, text);
            } else {
                console.log('Skipping duplicate annotation');
            }
        }
        
        addUserClassification(start, end, classification, text) {
            console.log(`Attempting to add ${classification} classification for: "${text.substring(0, 100)}..."`);
            console.log(`Text length: ${text.length}, Start: ${start}, End: ${end}`);
            
            // For very long text selections, try to highlight more of it
            if (text.length > 2000) {
                console.log('Very long text selection detected, using position-based approach');
                this.addLongTextClassification(start, end, classification, text);
                return;
            }
            
            // Get the current HTML content
            const content = this.contentElement.innerHTML;
            
            // Create the highlight span
            const cssClass = classification === 'huntable' 
                ? 'bg-blue-100 border-blue-300 text-blue-800' 
                : 'bg-red-100 border-red-300 text-red-800';
            
            const highlightSpan = `<span class="px-1 py-0.5 rounded text-xs font-medium border ${cssClass}" title="${classification === 'huntable' ? 'Huntable' : 'Not Huntable'}: ${text.substring(0, 50)}...">${text}</span>`;
            
            // Debug: Log what we're looking for vs what's in the content
            console.log('=== TEXT REPLACEMENT DEBUG ===');
            console.log('Looking for text:', JSON.stringify(text));
            console.log('Text length:', text.length);
            console.log('Content preview:', content.substring(0, 500));
            
            // Use a more reliable approach - replace only the first occurrence
            let newContent = content;
            let replaced = false;
            
            // Approach 1: Exact match using indexOf (most reliable)
            const index = content.indexOf(text);
            console.log('Exact match index:', index);
            
            if (index !== -1) {
                // Verify this is actually the text we want to replace
                const beforeText = content.substring(Math.max(0, index - 20), index);
                const afterText = content.substring(index + text.length, index + text.length + 20);
                console.log('Context before:', beforeText);
                console.log('Context after:', afterText);
                
                newContent = content.substring(0, index) + highlightSpan + content.substring(index + text.length);
                console.log('Found exact text match, replaced');
                replaced = true;
            } else {
                console.log('Exact match failed, trying different approaches...');
                
                // Approach 2: Try with HTML entities decoded
                const decodedText = text.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
                const decodedIndex = content.indexOf(decodedText);
                console.log('Decoded text match index:', decodedIndex);
                
                if (decodedIndex !== -1) {
                    newContent = content.substring(0, decodedIndex) + highlightSpan + content.substring(decodedIndex + decodedText.length);
                    console.log('Found decoded text match, replaced');
                    replaced = true;
                } else {
                    // Approach 3: Try with a longer substring (up to 500 chars)
                    const longerText = text.substring(0, Math.min(500, text.length));
                    const longerIndex = content.indexOf(longerText);
                    console.log('Longer text match index:', longerIndex);
                    
                    if (longerIndex !== -1) {
                        newContent = content.substring(0, longerIndex) + highlightSpan + content.substring(longerIndex + longerText.length);
                        console.log('Found longer text match, replaced');
                        replaced = true;
                    } else {
                        // Approach 4: Try with a shorter substring as last resort
                        const shortText = text.substring(0, Math.min(100, text.length));
                        const shortIndex = content.indexOf(shortText);
                        console.log('Short text match index:', shortIndex);
                        
                        if (shortIndex !== -1) {
                            newContent = content.substring(0, shortIndex) + highlightSpan + content.substring(shortIndex + shortText.length);
                            console.log('Found short text match, replaced');
                            replaced = true;
                        } else {
                            console.log('Could not find text to replace');
                            console.log('Looking for:', text.substring(0, 100));
                            console.log('In content:', content.substring(0, 200) + '...');
                            return; // Don't update if we can't find the text
                        }
                    }
                }
            }
            
            console.log('=== END DEBUG ===');
            
            // Save state before making changes
            this.saveState();
            
            // Update the content
            this.contentElement.innerHTML = newContent;
            console.log(`Successfully added ${classification} classification`);
        }
        
        addLongTextClassification(start, end, classification, text) {
            // For very long text, try to highlight multiple parts of it
            const cssClass = classification === 'huntable' 
                ? 'bg-blue-100 border-blue-300 text-blue-800' 
                : 'bg-red-100 border-red-300 text-red-800';
            
            // Get the current HTML content
            const content = this.contentElement.innerHTML;
            
            // Try to highlight the first 500 characters and add an indicator
            const shortText = text.substring(0, Math.min(500, text.length));
            const highlightSpan = `<span class="px-1 py-0.5 rounded text-xs font-medium border ${cssClass}" title="${classification === 'huntable' ? 'Huntable' : 'Not Huntable'}: Long selection (${text.length} chars)">${shortText}${text.length > 500 ? '...' : ''}</span>`;
            
            // Try to find and replace the text
            if (content.includes(shortText)) {
                let newContent = content.replace(shortText, highlightSpan);
                
                // Also try to highlight the end of the selection if it's very long
                if (text.length > 1000) {
                    const endText = text.substring(text.length - 100);
                    const endHighlightSpan = `<span class="px-1 py-0.5 rounded text-xs font-medium border ${cssClass}" title="End of long ${classification} selection">...${endText}</span>`;
                    
                    if (newContent.includes(endText) && !newContent.includes(endHighlightSpan)) {
                        newContent = newContent.replace(endText, endHighlightSpan);
                    }
                }
                
                this.contentElement.innerHTML = newContent;
                console.log(`Added ${classification} highlight for long text selection (${text.length} chars)`);
            } else {
                // Fallback to shorter text
                const veryShortText = text.substring(0, Math.min(100, text.length));
                if (content.includes(veryShortText)) {
                    const shortHighlightSpan = `<span class="px-1 py-0.5 rounded text-xs font-medium border ${cssClass}" title="${classification === 'huntable' ? 'Huntable' : 'Not Huntable'}: Long selection (${text.length} chars)">${veryShortText}...</span>`;
                    const newContent = content.replace(veryShortText, shortHighlightSpan);
                    this.contentElement.innerHTML = newContent;
                    console.log(`Added ${classification} highlight for part of long text selection`);
                } else {
                    console.log(`Could not find text for long selection highlighting`);
                }
            }
        }
        
        saveState() {
            // Save current HTML state for undo functionality
            this.previousStates.push(this.contentElement.innerHTML);
            
            // Keep only the last maxUndoStates
            if (this.previousStates.length > this.maxUndoStates) {
                this.previousStates.shift();
            }
        }
        
        async undo() {
            if (this.previousStates.length > 0) {
                const previousState = this.previousStates.pop();
                this.contentElement.innerHTML = previousState;
                
                // Delete the last annotation from database
                try {
                    const response = await fetch(`/api/articles/{{ article.id }}/annotations`, {
                        method: 'GET'
                    });
                    const data = await response.json();
                    
                    if (data.success && data.annotations.length > 0) {
                        // Get the most recent annotation (highest ID)
                        const lastAnnotation = data.annotations.reduce((prev, current) => 
                            (prev.id > current.id) ? prev : current
                        );
                        
                        // Delete it from database
                        const deleteResponse = await fetch(`/api/articles/{{ article.id }}/annotations/${lastAnnotation.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (deleteResponse.ok) {
                            console.log(`Undid last classification and removed annotation ID ${lastAnnotation.id} from database`);
                        } else {
                            console.error('Failed to remove annotation from database');
                        }
                    }
                } catch (error) {
                    console.error('Error removing annotation from database:', error);
                }
                
                console.log('Undid last classification');
                return true;
            } else {
                console.log('No previous states to undo');
                return false;
            }
        }
        
        
        enableKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+Z for undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    this.undo();
                }
            });
        }
        
        enableAnnotationClicking() {
            // Use event delegation to handle clicks on annotation spans
            this.contentElement.addEventListener('click', (e) => {
                // Check if clicked element is an annotation span
                const clickedSpan = e.target.closest('span.px-1.py-0\\.5.rounded.text-xs.font-medium.border');
                
                if (clickedSpan) {
                    // Check if it's a user annotation (not a keyword discriminator)
                    const isHuntableAnnotation = clickedSpan.classList.contains('bg-blue-100');
                    const isNotHuntableAnnotation = clickedSpan.classList.contains('bg-red-100');
                    
                    if (isHuntableAnnotation || isNotHuntableAnnotation) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const annotationType = isHuntableAnnotation ? 'huntable' : 'not_huntable';
                        const annotationText = clickedSpan.textContent;
                        
                        this.showRemoveAnnotationModal(clickedSpan, annotationType, annotationText);
                    }
                }
            });
        }
        
        enableUserSelection() {
            let isSelecting = false;
            let startPos = null;
            let endPos = null;
            
            this.contentElement.addEventListener('mousedown', (e) => {
                isSelecting = true;
                startPos = this.getTextPositionFromEvent(e);
            });
            
            this.contentElement.addEventListener('mousemove', (e) => {
                if (isSelecting) {
                    endPos = this.getTextPositionFromEvent(e);
                    this.showSelectionPreview(startPos, endPos);
                }
            });
            
            this.contentElement.addEventListener('mouseup', (e) => {
                if (isSelecting) {
                    isSelecting = false;
                    endPos = this.getTextPositionFromEvent(e);
                    this.showClassificationOptions(startPos, endPos);
                }
            });
        }
        
        getTextPositionFromEvent(e) {
            const range = document.caretRangeFromPoint(e.clientX, e.clientY);
            if (!range) return 0;
            
            // Find the character position in the text content (ignoring HTML)
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(this.contentElement);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            
            return preCaretRange.toString().length;
        }
        
        showSelectionPreview(start, end) {
            // Clear previous preview
            this.clearSelectionPreview();
            
            if (start === end) return;
            
            const min = Math.min(start, end);
            const max = Math.max(start, end);
            
            const preview = document.createElement('div');
            preview.className = 'absolute bg-yellow-200 bg-opacity-50 border border-yellow-400';
            preview.id = 'selection-preview';
            
            try {
                // Create a range based on text content positions
                const range = document.createRange();
                const textContent = this.contentElement.textContent;
                
                // Find the text nodes that contain our selection
                const walker = document.createTreeWalker(
                    this.contentElement,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let currentPos = 0;
                let startNode = null;
                let endNode = null;
                let startOffset = 0;
                let endOffset = 0;
                
                while (walker.nextNode()) {
                    const textNode = walker.currentNode;
                    const nodeLength = textNode.textContent.length;
                    
                    if (!startNode && currentPos + nodeLength >= min) {
                        startNode = textNode;
                        startOffset = min - currentPos;
                    }
                    
                    if (!endNode && currentPos + nodeLength >= max) {
                        endNode = textNode;
                        endOffset = max - currentPos;
                        break;
                    }
                    
                    currentPos += nodeLength;
                }
                
                if (startNode && endNode) {
                    range.setStart(startNode, startOffset);
                    range.setEnd(endNode, endOffset);
                    
                    const rect = range.getBoundingClientRect();
                    const containerRect = this.contentElement.getBoundingClientRect();
                    
                    preview.style.left = `${rect.left - containerRect.left}px`;
                    preview.style.top = `${rect.top - containerRect.top}px`;
                    preview.style.width = `${rect.width}px`;
                    preview.style.height = `${rect.height}px`;
                    
                    this.contentElement.appendChild(preview);
                }
            } catch (error) {
                console.error('Error showing selection preview:', error);
            }
        }
        
        clearSelectionPreview() {
            const preview = document.getElementById('selection-preview');
            if (preview) {
                preview.remove();
            }
        }
        
        showClassificationOptions(start, end) {
            this.clearSelectionPreview();
            
            if (start === end) return;
            
            const min = Math.min(start, end);
            const max = Math.max(start, end);
            const selectedText = this.contentElement.textContent.substring(min, max);
            
            // Show classification modal
            this.showClassificationModal(selectedText, min, max);
        }
        
        showClassificationModal(text, start, end) {
            // Create modal for classification
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Classify Selected Text</h3>
                    <p class="text-sm text-gray-600 mb-4">"${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"</p>
                    <div class="flex space-x-3">
                        <button onclick="simpleTextManager.classifySelection(${start}, ${end}, 'huntable')" 
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            Huntable
                        </button>
                        <button onclick="simpleTextManager.classifySelection(${start}, ${end}, 'not_huntable')" 
                                class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Not Huntable
                        </button>
                        <button onclick="simpleTextManager.closeModal()" 
                                class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        classifySelection(start, end, classification) {
            const text = this.contentElement.textContent.substring(start, end);
            
            // Add the classification highlight
            this.addUserClassification(start, end, classification, text);
            
            // Save to server
            this.saveClassification(start, end, text, classification);
            
            this.closeModal();
        }
        
        showRemoveAnnotationModal(spanElement, annotationType, annotationText) {
            // Store reference to the span element for removal
            this.pendingRemovalSpan = spanElement;
            this.pendingRemovalText = annotationText;
            
            // Create modal for removing annotation
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Remove Annotation</h3>
                    <p class="text-sm text-gray-600 mb-2">
                        <strong>Type:</strong> ${annotationType === 'huntable' ? 'Huntable' : 'Not Huntable'}
                    </p>
                    <p class="text-sm text-gray-600 mb-4">
                        <strong>Text:</strong> "${annotationText.substring(0, 100)}${annotationText.length > 100 ? '...' : ''}"
                    </p>
                    <p class="text-sm text-gray-700 mb-4">
                        Do you want to remove this annotation?
                    </p>
                    <div class="flex space-x-3">
                        <button onclick="simpleTextManager.confirmRemoveAnnotation()" 
                                class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Remove
                        </button>
                        <button onclick="simpleTextManager.closeModal()" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async confirmRemoveAnnotation() {
            if (!this.pendingRemovalSpan || !this.pendingRemovalText) {
                console.error('No pending annotation removal');
                return;
            }
            
            try {
                // Save state for undo
                this.saveState();
                
                // Remove the span from the DOM (replace with original text)
                const originalText = this.pendingRemovalText;
                const parent = this.pendingRemovalSpan.parentNode;
                const textNode = document.createTextNode(originalText);
                parent.replaceChild(textNode, this.pendingRemovalSpan);
                
                // Find and delete the annotation from the database
                const response = await fetch(`/api/articles/{{ article.id }}/annotations`, {
                    method: 'GET'
                });
                const data = await response.json();
                
                if (data.success && data.annotations.length > 0) {
                    // Find the annotation that matches our text
                    const matchingAnnotation = data.annotations.find(annotation => 
                        annotation.selected_text === originalText
                    );
                    
                    if (matchingAnnotation) {
                        // Delete it from database
                        const deleteResponse = await fetch(`/api/articles/{{ article.id }}/annotations/${matchingAnnotation.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (deleteResponse.ok) {
                            console.log(`Removed annotation ID ${matchingAnnotation.id} from database`);
                        } else {
                            console.error('Failed to remove annotation from database');
                        }
                    } else {
                        console.log('Could not find matching annotation in database');
                    }
                }
                
                // Clear pending removal references
                this.pendingRemovalSpan = null;
                this.pendingRemovalText = null;
                
                console.log('Annotation removed successfully');
                
            } catch (error) {
                console.error('Error removing annotation:', error);
            }
            
            this.closeModal();
        }
        
        closeModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-gray-600');
            if (modal) {
                modal.remove();
            }
            
            // Clear pending removal references when modal is closed
            this.pendingRemovalSpan = null;
            this.pendingRemovalText = null;
        }
        
        async saveClassification(start, end, text, classification) {
            try {
                const response = await fetch(`/api/articles/{{ article.id }}/annotations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selected_text: text,
                        start_position: start,
                        end_position: end,
                        annotation_type: classification
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save classification');
                }
                
                console.log('Classification saved successfully');
            } catch (error) {
                console.error('Error saving classification:', error);
                alert('Failed to save classification. Please try again.');
            }
        }
    }
    
    // Initialize the simple text manager
    let simpleTextManager;
    document.addEventListener('DOMContentLoaded', function() {
        simpleTextManager = new SimpleTextManager();
    });
    
    // Classification functions
    async function classifyArticle(category) {
        const articleId = {{ article.id }};
        
        // Check if comment prompts are enabled
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const commentPromptsEnabled = settings.commentPromptsEnabled !== false; // Default to true
        
        let reason = null;
        if (commentPromptsEnabled && (category === 'chosen' || category === 'rejected')) {
            reason = prompt(`Reason for marking as ${category} (optional):`);
        }
        
        try {
            const response = await fetch(`/api/articles/${articleId}/classify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    reason: reason || null
                })
            });
            
            if (response.ok) {
                // Show success message
                showNotification(`Article marked as ${category} successfully!`, 'success');
                
                // Update the current status display
                updateClassificationStatus(category);
                
                // Auto-advance to next unclassified only if marked as rejected
                if (category === 'rejected') {
                    setTimeout(() => {
                        navigateToNextUnclassified();
                    }, 2000); // Increased delay to ensure database is updated
                }
            } else {
                const error = await response.json();
                showNotification(`Error: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        }
    }
    
    function updateClassificationStatus(category) {
        const statusElement = document.querySelector('.inline-flex.items-center.px-3.py-1.rounded-full');
        if (statusElement) {
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium';
            
            if (category === 'chosen') {
                statusElement.className += ' bg-green-100 text-green-800';
                statusElement.textContent = '‚úÖ Chosen';
            } else if (category === 'rejected') {
                statusElement.className += ' bg-red-100 text-red-800';
                statusElement.textContent = '‚ùå Rejected';
            } else {
                statusElement.className += ' bg-gray-100 text-gray-800';
                statusElement.textContent = '‚è≥ Unclassified';
            }
        }
        
        // Store the current classification in localStorage for the AI Assistant modal
        localStorage.setItem('currentArticleClassification', category);
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'error' ? 'bg-red-500 text-white' : 
            type === 'info' ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    function markOperationComplete(operationId, status = 'completed') {
        console.log('markOperationComplete called with:', operationId, status);
        
        // Update operation status in localStorage
        const ongoingOps = JSON.parse(localStorage.getItem('ongoingAIOperations') || '[]');
        const operationIndex = ongoingOps.findIndex(op => op.id === operationId);
        
        console.log('Found operation at index:', operationIndex, 'Operations:', ongoingOps);
        
        if (operationIndex !== -1) {
            ongoingOps[operationIndex].status = status;
            ongoingOps[operationIndex].completedAt = Date.now();
            localStorage.setItem('ongoingAIOperations', JSON.stringify(ongoingOps));
            
            // Store completion notification for cross-page display
            if (status === 'completed') {
                const completionNotification = {
                    id: `completion_${Date.now()}`,
                    operationId: operationId,
                    type: ongoingOps[operationIndex].type,
                    typeText: ongoingOps[operationIndex].typeText,
                    typeIcon: ongoingOps[operationIndex].typeIcon,
                    articleId: ongoingOps[operationIndex].articleId,
                    articleTitle: ongoingOps[operationIndex].articleTitle,
                    completedAt: Date.now()
                };
                
                console.log('Creating completion notification:', completionNotification);
                
                const completions = JSON.parse(localStorage.getItem('pendingCompletions') || '[]');
                completions.push(completionNotification);
                localStorage.setItem('pendingCompletions', JSON.stringify(completions));
                
                console.log('Stored pending completions:', completions);
            }
        }
    }
    
    function showCompletionBanner(type, typeText, typeIcon, articleId = null, articleTitle = null) {
        console.log('showCompletionBanner called with:', type, typeText, typeIcon, articleId, articleTitle);
        
        // Create completion banner
        const banner = document.createElement('div');
        banner.id = 'completionBanner';
        banner.className = 'fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm bg-green-500 text-white';
        
        const bannerArticleTitle = articleTitle || '{{ article.title }}';
        const bannerArticleId = articleId || {{ article.id }};
        
        banner.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-lg">${typeIcon}</span>
                <div class="flex-1">
                    <div class="font-medium">${typeText} Complete!</div>
                    <div class="text-sm opacity-90">Article: ${bannerArticleTitle.length > 30 ? bannerArticleTitle.substring(0, 30) + '...' : bannerArticleTitle}</div>
                    <a href="/articles/${bannerArticleId}#${type}" class="text-sm underline hover:no-underline">View Results ‚Üí</a>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(banner);
        console.log('Banner added to DOM:', banner);
        
        // Remove after 10 seconds
        setTimeout(() => {
            const bannerElement = document.getElementById('completionBanner');
            if (bannerElement) {
                console.log('Removing banner after 10 seconds');
                bannerElement.remove();
            }
        }, 10000);
    }
    
    // Navigation functions
    async function navigateToNextUnclassified(retryCount = 0) {
        try {
            const response = await fetch(`/api/articles/next-unclassified?current_article_id={{ article.id }}`);
            const data = await response.json();
            
            if (data.article_id) {
                window.location.href = `/articles/${data.article_id}`;
            } else {
                // If no article found and we haven't retried yet, wait and retry once
                if (retryCount === 0) {
                    console.log('No unclassified article found, retrying in 1 second...');
                    setTimeout(() => {
                        navigateToNextUnclassified(1);
                    }, 1000);
            } else {
                showNotification('No more unclassified articles found!', 'info');
                }
            }
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        }
    }
    
    function navigateToPrevious() {
        const currentId = {{ article.id }};
        window.location.href = `/articles/${currentId - 1}`;
    }
    
    function navigateToNext() {
        const currentId = {{ article.id }};
        window.location.href = `/articles/${currentId + 1}`;
    }
    
    // AI Assistant Functions
    function showAIAssistant() {
        // Get AI model from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const aiModel = settings.aiModel || 'chatgpt';
        
        // Get current article classification
        const currentClassification = localStorage.getItem('currentArticleClassification') || '{{ article.metadata.get("training_category", "") }}';
        const isChosen = currentClassification === 'chosen';
        
        // Get threat hunting score for SIGMA warning
        const threatHuntingScore = {{ article.metadata.get('threat_hunting_score', 0) if article.metadata and article.metadata.get('threat_hunting_score') is not none else 0 }};
        const showSigmaWarning = isChosen && threatHuntingScore < 65;
        
        // Check for existing generated content
        const hasSummary = {{ 'true' if article.metadata and article.metadata.get('chatgpt_summary') else 'false' }};
        const hasSigmaRules = {{ 'true' if article.metadata and article.metadata.get('sigma_rules') else 'false' }};
        const hasIOCs = {{ 'true' if article.metadata and article.metadata.get('extracted_iocs') else 'false' }};
        
        const modal = document.createElement('div');
        modal.id = 'aiAssistantModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeAIAssistantModal();
            }
        });
        
        // Add ESC key to close
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                closeAIAssistantModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ AI Assistant</h3>
                    <p class="text-sm text-gray-500 mb-6">Choose what you'd like to ${hasSummary || hasSigmaRules || hasIOCs ? 'view or regenerate' : 'generate'}:</p>
                    
                    <div class="space-y-3">
                        <button onclick="generateAIAnalysis('summary')" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <span class="mr-2">üìù</span>
                            ${hasSummary ? 'Display Summary' : 'Generate Summary'}
                        </button>
                        
                        <button onclick="generateAIAnalysis('sigma')" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md transition-colors ${isChosen ? 'text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500' : 'text-gray-400 bg-gray-300 cursor-not-allowed'}"
                                ${!isChosen ? 'disabled' : ''}
                                title="${isChosen ? (hasSigmaRules ? 'Display existing SIGMA detection rules' : 'Generate SIGMA detection rules for this article') : 'SIGMA rules can only be generated for articles marked as "Chosen". Please classify this article first.'}">
                            <span class="mr-2">üîç</span>
                            ${hasSigmaRules ? 'Display SIGMA Rules' : 'Generate SIGMA Rules'}
                            ${showSigmaWarning ? '<span class="ml-2 text-yellow-300">‚ö†Ô∏è</span>' : ''}
                        </button>
                        ${!isChosen ? '<div class="text-xs text-gray-500 text-center mt-1">‚ö†Ô∏è Only available for articles marked as "Chosen"</div>' : ''}
                        ${showSigmaWarning ? '<div class="text-xs text-yellow-600 text-center mt-1">‚ö†Ô∏è Low threat hunting score (' + threatHuntingScore + '/100) - SIGMA rules may lack technical depth</div>' : ''}
                        
                        <button onclick="generateAIAnalysis('iocs')" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">
                            <span class="mr-2">üîç</span>
                            ${hasIOCs ? 'Display IOCs' : 'Extract IOCs'}
                        </button>
                        
                        <button onclick="showCustomPromptModal()" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                            <span class="mr-2">üí¨</span>
                            Custom Prompt
                        </button>
                        
                        <button onclick="closeAIAssistantModal()" 
                                class="w-full inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                            Cancel
                        </button>
                    </div>
                    
                    <div class="mt-4 p-2 bg-gray-50 rounded text-xs text-gray-600">
                        Using: ${aiModel === 'chatgpt' ? 'ChatGPT (OpenAI)' : 'Mistral (Local)'}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closeAIAssistantModal() {
        const modal = document.getElementById('aiAssistantModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function generateAIAnalysis(type, forceRegenerate = false) {
        closeAIAssistantModal();
        
        // Check for existing content first (unless force regenerate)
        if (!forceRegenerate) {
            if (type === 'summary' && {{ 'true' if article.metadata and article.metadata.get('chatgpt_summary') else 'false' }}) {
                const summaryData = {{ article.metadata.get('chatgpt_summary') | tojson if article.metadata and article.metadata.get('chatgpt_summary') else 'null' }};
                showChatGPTSummaryModal(summaryData.summary, summaryData);
                return;
            }
            
            if (type === 'sigma' && {{ 'true' if article.metadata and article.metadata.get('sigma_rules') else 'false' }}) {
                const sigmaData = {{ article.metadata.get('sigma_rules') | tojson if article.metadata and article.metadata.get('sigma_rules') else 'null' }};
                showSigmaRulesModal(sigmaData.rules, sigmaData);
                return;
            }
            
            if (type === 'iocs' && {{ 'true' if article.metadata and article.metadata.get('extracted_iocs') else 'false' }}) {
                const iocData = {{ article.metadata.get('extracted_iocs') | tojson if article.metadata and article.metadata.get('extracted_iocs') else 'null' }};
                showIOCsModal(iocData.iocs, iocData);
                return;
            }
        }
        
        // Check if SIGMA rules are allowed for this article
        if (type === 'sigma') {
            const currentClassification = localStorage.getItem('currentArticleClassification') || '{{ article.metadata.get("training_category", "") }}';
            const isChosen = currentClassification === 'chosen';
            if (!isChosen) {
                showNotification('SIGMA rules can only be generated for articles marked as "Chosen". Please classify this article first.', 'error');
                return;
            }
            
            // Check threat hunting score for SIGMA rules
            const threatHuntingScore = {{ article.metadata.get('threat_hunting_score', 0) if article.metadata and article.metadata.get('threat_hunting_score') is not none else 0 }};
            if (threatHuntingScore < 65) {
                const confirmed = confirm(`‚ö†Ô∏è Warning: This article has a low threat hunting score (${threatHuntingScore}/100).\n\nSIGMA rules are not recommended for articles with scores below 65 as they may lack sufficient technical depth for effective detection rules.\n\nDo you want to proceed anyway?`);
                if (!confirmed) {
                    return;
                }
            }
        }
        
        // Get AI model from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const aiModel = settings.aiModel || 'chatgpt';
        const apiKey = settings.openaiApiKey;
        
        if (aiModel === 'chatgpt' && !apiKey) {
            showNotification('Please configure your OpenAI API key in Settings first', 'error');
            return;
        }
        
        // Store ongoing AI operation in localStorage for cross-page tracking
        const articleId = {{ article.id }};
        const operationId = `ai_${type}_${articleId}_${Date.now()}`;
        const operationData = {
            id: operationId,
            type: type,
            typeText: type === 'summary' ? 'Summary' : type === 'sigma' ? 'SIGMA Rules' : 'IOCs',
            typeIcon: type === 'summary' ? 'üìù' : type === 'sigma' ? 'üîç' : 'üîç',
            articleId: articleId,
            articleTitle: '{{ article.title }}',
            startedAt: Date.now(),
            status: 'running'
        };
        
        // Store in localStorage
        const ongoingOps = JSON.parse(localStorage.getItem('ongoingAIOperations') || '[]');
        ongoingOps.push(operationData);
        localStorage.setItem('ongoingAIOperations', JSON.stringify(ongoingOps));
        
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'loadingModal';
        loadingModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        const typeText = operationData.typeText;
        const typeIcon = operationData.typeIcon;
        
        // Debug logging
        console.log('generateAIAnalysis called with type:', type);
        console.log('typeText:', typeText);
        console.log('typeIcon:', typeIcon);
        
        // Add ESC key handler to close loading modal
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                loadingModal.remove();
                document.removeEventListener('keydown', handleEsc);
                showNotification('AI generation continues in the background. You can return to this article later to view the results.', 'info');
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        loadingModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100">
                        <svg class="animate-spin h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mt-4">${typeIcon} ${type === 'summary' ? 'Generating' : type === 'sigma' ? 'Generating' : 'Extracting'} ${typeText}...</h3>
                    <p class="text-sm text-gray-500 mt-2">${type === 'summary' ? 'Creating a comprehensive summary' : type === 'sigma' ? 'Creating detection rules' : 'Extracting indicators of compromise'} - this may take a few moments.</p>
                    <p class="text-xs text-gray-400 mt-3">üí° Press <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">ESC</kbd> to leave while generation continues</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        try {
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timed out after 60 seconds')), 60000);
            });
            
            // Create the fetch promise
            const endpoint = type === 'summary' ? 'chatgpt-summary' : type === 'sigma' ? 'generate-sigma' : 'extract-iocs';
            
            // Prepare request body
            const requestBody = {
                include_content: true,
                api_key: apiKey,
                force_regenerate: forceRegenerate
            };
            
            // Add author name for SIGMA rules
            if (type === 'sigma') {
                const sigmaAuthor = settings.sigmaAuthor || 'CTIScraper User';
                requestBody.author_name = sigmaAuthor;
            }
            
            const fetchPromise = fetch(`/api/articles/{{ article.id }}/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            // Race between fetch and timeout
            const response = await Promise.race([fetchPromise, timeoutPromise]);
            
            if (response.ok) {
                const data = await response.json();
                
                console.log('AI generation completed successfully:', data);
                
                // Mark operation as complete and show banner
                markOperationComplete(operationId);
                showCompletionBanner(type, typeText, typeIcon);
                
                console.log('Completion banner should be showing now');
                
                // Don't automatically show results - let user choose when to view them
            } else {
                const error = await response.json();
                console.log('API Error:', error);
                markOperationComplete(operationId, 'failed');
                showNotification(`${typeText} ${type === 'summary' ? 'generation' : type === 'sigma' ? 'generation' : 'extraction'} failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.log('Caught error:', error);
            markOperationComplete(operationId, 'failed');
            if (error.message.includes('timed out')) {
                showNotification(`${typeText} ${type === 'summary' ? 'generation' : type === 'sigma' ? 'generation' : 'extraction'} timed out after 60 seconds. Try using a different model or check your settings.`, 'error');
            } else {
                showNotification(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Remove loading modal and clean up ESC handler
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.remove();
                // Clean up the ESC key handler
                document.removeEventListener('keydown', handleEsc);
            }
        }
    }
    
    // GPT4o Ranking Function
    async function rankWithGPT4o() {
        const articleId = {{ article.id }};
        const articleUrl = '{{ article.canonical_url }}';
        
        // Get API key from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const apiKey = settings.openaiApiKey;
        
        if (!apiKey) {
            showNotification('Please configure your OpenAI API key in Settings first', 'error');
            return;
        }
        
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="mr-2">‚è≥</span>Analyzing...';
        button.disabled = true;
        
        try {
            const response = await fetch(`/api/articles/${articleId}/gpt4o-rank`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: articleUrl,
                    api_key: apiKey
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                displayGPT4oRanking(data.analysis);
                showNotification('GPT4o analysis completed successfully!', 'success');
            } else {
                const error = await response.json();
                showNotification(`GPT4o analysis failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    function displayGPT4oRanking(analysis) {
        const resultsDiv = document.getElementById('gpt4o-ranking-results');
        const contentDiv = document.getElementById('gpt4o-ranking-content');
        
        // Format the analysis for display
        const formattedAnalysis = analysis.replace(/\n/g, '<br>');
        contentDiv.innerHTML = formattedAnalysis;
        
        // Show the results section
        resultsDiv.style.display = 'block';
        
        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showCustomPromptModal() {
        closeAIAssistantModal();
        
        // Get AI model from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const aiModel = settings.aiModel || 'chatgpt';
        const modelDisplayName = aiModel === 'chatgpt' ? 'ChatGPT (OpenAI)' : 'Mistral (Local Ollama)';
        
        const modal = document.createElement('div');
        modal.id = 'customPromptModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCustomPromptModal();
            }
        });
        
        // Add ESC key to close
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                closeCustomPromptModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">üí¨ Custom AI Prompt</h3>
                    <button onclick="closeCustomPromptModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-md">
                    <div class="text-sm text-gray-700">
                        <p class="font-medium mb-1">ü§ñ AI Model:</p>
                        <p class="text-gray-600">${modelDisplayName}</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="customPrompt" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Question or Request
                    </label>
                    <textarea id="customPrompt" 
                              rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Ask anything about this article. For example:&#10;- What are the main attack vectors mentioned?&#10;- How would I detect this threat in my network?&#10;- What are the key IOCs to monitor?&#10;- Explain the technical details in simple terms"></textarea>
                </div>
                
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <div class="text-sm text-blue-800">
                        <p class="font-medium mb-1">üí° Tips:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Be specific about what you want to know</li>
                            <li>Ask for technical details, IOCs, or analysis</li>
                            <li>Request detection rules or threat hunting queries</li>
                            <li>Ask for explanations in different detail levels</li>
                        </ul>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeCustomPromptModal()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        Cancel
                    </button>
                    <button onclick="generateCustomPrompt()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <span class="mr-2">ü§ñ</span>
                        Generate Response
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closeCustomPromptModal() {
        const modal = document.getElementById('customPromptModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function generateCustomPrompt() {
        const customPrompt = document.getElementById('customPrompt').value.trim();
        
        if (!customPrompt) {
            showNotification('Please enter a question or request', 'error');
            return;
        }
        
        closeCustomPromptModal();
        
        // Get AI model from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const aiModel = settings.aiModel || 'chatgpt';
        const apiKey = settings.openaiApiKey;
        
        if (aiModel === 'chatgpt' && !apiKey) {
            showNotification('Please configure your OpenAI API key in Settings first', 'error');
            return;
        }
        
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'loadingModal';
        loadingModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        loadingModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100">
                        <svg class="animate-spin h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mt-4">ü§ñ Processing Custom Request...</h3>
                    <p class="text-sm text-gray-500 mt-2">This may take a few moments.</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        try {
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timed out after 60 seconds')), 60000);
            });
            
            // Create the fetch promise
            const fetchPromise = fetch(`/api/articles/{{ article.id }}/custom-prompt`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: customPrompt,
                    api_key: apiKey
                })
            });
            
            // Race between fetch and timeout
            const response = await Promise.race([fetchPromise, timeoutPromise]);
            
            if (response.ok) {
                const data = await response.json();
                showCustomResponseModal(data.response, customPrompt, data);
            } else {
                const error = await response.json();
                showNotification(`Custom prompt failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            if (error.message.includes('timed out')) {
                showNotification('Custom prompt timed out after 60 seconds. Try using a different model or check your settings.', 'error');
            } else {
                showNotification(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Remove loading modal
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.remove();
            }
        }
    }
    
    function showCustomResponseModal(response, originalPrompt, data = null) {
        const modal = document.createElement('div');
        modal.id = 'customResponseModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeCustomResponseModal();
            }
        });
        
        // Add ESC key to close
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                closeCustomResponseModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        const modelUsed = data?.model_name || 'Unknown';
        const respondedAt = data?.responded_at ? new Date(data.responded_at).toLocaleString() : 'Unknown';
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">üí¨ Custom AI Response</h3>
                    <button onclick="closeCustomResponseModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Your Question:</span>
                            <p class="text-gray-900 mt-1">${originalPrompt}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Model Used:</span>
                            <span class="text-gray-900">${modelUsed}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Responded At:</span>
                            <span class="text-gray-900">${respondedAt}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div class="prose max-w-none">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono">${response}</pre>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end space-x-3">
                    <button onclick="showCustomPromptModal()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <span class="mr-2">üí¨</span>
                        Ask Another Question
                    </button>
                    <button onclick="closeCustomResponseModal()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closeCustomResponseModal() {
        const modal = document.getElementById('customResponseModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // Threat Hunting Analysis Functions
    function showThreatHuntingAnalysis() {
        // Check if we already have an analysis
        const existingAnalysis = {{ article.metadata.get('threat_hunting_analysis', {}).get('analysis', 'null') | tojson }};
        const existingModelName = {{ article.metadata.get('threat_hunting_analysis', {}).get('model_name', 'null') | tojson }};
        
        if (existingAnalysis && existingAnalysis !== 'null') {
            // Show existing analysis
            showAnalysisModal(existingAnalysis, true, {
                model_name: existingModelName !== 'null' ? existingModelName : 'mistral',
                model_used: 'ollama'
            });
        } else {
            // Show options for new analysis
            showAnalysisOptionsModal();
        }
    }
    
    function showAnalysisOptionsModal() {
        const modal = document.createElement('div');
        modal.id = 'analysisOptionsModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">üîç Threat Hunting Analysis</h3>
                    <p class="text-sm text-gray-500 mb-6">Choose what to analyze:</p>
                    
                    <div class="space-y-3">
                        <button onclick="analyzeThreatHunting(false)" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <span class="mr-2">üìã</span>
                            Analyze Metadata Only (Faster)
                        </button>
                        
                        <button onclick="analyzeThreatHunting(true)" 
                                class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                            <span class="mr-2">üìÑ</span>
                            Analyze Full Content (More Detailed)
                        </button>
                        
                        <button onclick="closeAnalysisOptionsModal()" 
                                class="w-full inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closeAnalysisOptionsModal() {
        const modal = document.getElementById('analysisOptionsModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function analyzeThreatHunting(analyzeContent) {
        closeAnalysisOptionsModal();
        
        // Show loading modal
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'loadingModal';
        loadingModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        loadingModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-purple-100">
                        <svg class="animate-spin h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mt-4">Analyzing Article...</h3>
                    <p class="text-sm text-gray-500 mt-2">This may take a few moments.</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        try {
            const response = await fetch(`/api/articles/{{ article.id }}/analyze-threat-hunting`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    analyze_content: analyzeContent
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                showAnalysisModal(data.analysis, false, data);
            } else {
                const error = await response.json();
                showNotification(`Analysis failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Remove loading modal
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.remove();
            }
        }
    }
    
    function showAnalysisModal(analysis, isExisting = false, data = null) {
        const modal = document.createElement('div');
        modal.id = 'analysisModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeAnalysisModal();
            }
        });
        
        // Add ESC key to close
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                closeAnalysisModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        const analysisType = data?.analyzed_content ? 'Full Content' : 'Metadata Only';
        const modelUsed = data?.model_name || (data?.model_used === 'customgpt' ? 'CustomGPT' : (data?.model_used === 'ollama' ? 'Mistral (via Ollama)' : 'Unknown'));
        const analyzedAt = data?.analyzed_at ? new Date(data.analyzed_at).toLocaleString() : 'Unknown';
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">üîç Threat Hunting Analysis</h3>
                    <button onclick="closeAnalysisModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Analysis Type:</span>
                            <span class="text-gray-900">${analysisType}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Model Used:</span>
                            <span class="text-gray-900">${modelUsed}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Analyzed At:</span>
                            <span class="text-gray-900">${analyzedAt}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div class="prose max-w-none">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono">${analysis}</pre>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end space-x-3">
                    ${!isExisting ? `
                    <button onclick="analyzeThreatHunting(true)" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <span class="mr-2">üìÑ</span>
                        Analyze Full Content
                    </button>
                    ` : ''}
                    <button onclick="closeAnalysisModal()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closeAnalysisModal() {
        const modal = document.getElementById('analysisModal');
        if (modal) {
            modal.remove();
        }
    }
    
    // ChatGPT Summary Functions
    async function generateChatGPTSummary() {
        console.log('ChatGPT Summary button clicked!'); // Debug log
        
        // Check if we already have a summary
        const existingSummary = {{ article.metadata.get('chatgpt_summary', {}).get('summary', 'null') | tojson }};
        const existingModelName = {{ article.metadata.get('chatgpt_summary', {}).get('model_name', 'null') | tojson }};
        const existingSummarizedAt = {{ article.metadata.get('chatgpt_summary', {}).get('summarized_at', 'null') | tojson }};
        
        if (existingSummary && existingSummary !== 'null') {
            // Show existing summary
            console.log('Found existing summary, showing it...'); // Debug log
            showChatGPTSummaryModal(existingSummary, {
                model_name: existingModelName !== 'null' ? existingModelName : 'mistral',
                model_used: 'ollama',
                summarized_at: existingSummarizedAt !== 'null' ? existingSummarizedAt : null,
                content_type: 'full content'
            });
            return;
        }
        
        // Get API key from settings
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const apiKey = settings.openaiApiKey;
        
        if (!apiKey) {
            showNotification('Please configure your OpenAI API key in Settings first', 'error');
            return;
        }
        
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'loadingModal';
        loadingModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        loadingModal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mt-4">Generating ChatGPT Summary</h3>
                    <p class="text-sm text-gray-500 mt-2">This may take a few moments.</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        try {
            console.log('Making API request to ChatGPT summary endpoint...'); // Debug log
            
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timed out after 60 seconds')), 60000);
            });
            
            // Create the fetch promise
            const fetchPromise = fetch(`/api/articles/{{ article.id }}/chatgpt-summary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    include_content: true,  // Set to false to send only URL
                    api_key: apiKey  // Send API key from settings
                })
            });
            
            // Race between fetch and timeout
            const response = await Promise.race([fetchPromise, timeoutPromise]);
            
            console.log('Response status:', response.status); // Debug log
            
            if (response.ok) {
                const data = await response.json();
                console.log('Success! Showing summary modal...'); // Debug log
                showChatGPTSummaryModal(data.summary, data);
            } else {
                const error = await response.json();
                console.error('API error:', error); // Debug log
                showNotification(`ChatGPT Summary failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.error('JavaScript error:', error); // Debug log
            if (error.message.includes('timed out')) {
                showNotification('ChatGPT Summary timed out after 60 seconds. Try using metadata-only analysis or configure OpenAI API key for faster results.', 'error');
            } else {
                showNotification(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Remove loading modal
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.remove();
            }
        }
    }
    
    function showChatGPTSummaryModal(summary, data = null) {
        console.log('showChatGPTSummaryModal called with:', summary, data);
        
        const modal = document.createElement('div');
        modal.id = 'chatGPTSummaryModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        // Add click outside to close
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeChatGPTSummaryModal();
            }
        });
        
        // Add ESC key to close
        const handleEsc = function(e) {
            if (e.key === 'Escape') {
                closeChatGPTSummaryModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        const modelUsed = data?.model_name || 'gpt-4';
        const summarizedAt = data?.summarized_at ? new Date(data.summarized_at).toLocaleString() : 'Unknown';
        const contentType = data?.content_type || 'full content';
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">üìù ChatGPT Summary</h3>
                    <button onclick="closeChatGPTSummaryModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-3 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Model Used:</span>
                            <span class="text-gray-900">${modelUsed}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Summarized At:</span>
                            <span class="text-gray-900">${summarizedAt}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Content Type:</span>
                            <span class="text-gray-900">${contentType}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Status:</span>
                            <span class="text-gray-900">${data?.cached ? '<span class="text-blue-600 font-medium">(Cached)</span>' : '<span class="text-green-600 font-medium">(Fresh)</span>'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div class="prose max-w-none">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800 font-mono">${summary}</pre>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end space-x-3">
                    <button onclick="regenerateChatGPTSummary()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <span class="mr-2">üîÑ</span>
                        ${data?.cached ? 'Regenerate Summary' : 'Generate New Summary'}
                    </button>
                    <button onclick="closeChatGPTSummaryModal()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        console.log('ChatGPT Summary modal added to DOM:', modal);
    }
    
    function closeChatGPTSummaryModal() {
        const modal = document.getElementById('chatGPTSummaryModal');
        if (modal) {
            modal.remove();
        }
    }
    
    function showSigmaRulesModal(sigmaRules, data) {
        // Remove any existing modal
        closeSigmaRulesModal();
        
        const modal = document.createElement('div');
        modal.id = 'sigmaRulesModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        const modelUsed = data?.model_name || 'gpt-4';
        const generatedAt = data?.generated_at ? new Date(data.generated_at).toLocaleString() : 'Unknown';
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">üîç SIGMA Detection Rules</h3>
                    <button onclick="closeSigmaRulesModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 text-sm text-gray-600">
                    <span class="font-medium">Generated by:</span> ${modelUsed} | 
                    <span class="font-medium">Generated at:</span> ${generatedAt}
                    ${data?.cached ? ' | <span class="font-medium text-blue-600">(Cached)</span>' : ''}
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <pre class="text-sm font-mono whitespace-pre-wrap text-gray-800">${sigmaRules}</pre>
                </div>
                
                <div class="mt-4 flex justify-between">
                    <button onclick="regenerateSigmaRules()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        üîÑ Regenerate
                    </button>
                    <button onclick="closeSigmaRulesModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function closeSigmaRulesModal() {
        const modal = document.getElementById('sigmaRulesModal');
        if (modal) {
            modal.remove();
        }
    }
    
    function showIOCsModal(iocsJson, data) {
        // Remove any existing modal
        closeIOCsModal();
        
        const modal = document.createElement('div');
        modal.id = 'iocsModal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        
        const modelUsed = data?.model_name || 'gpt-4';
        const extractedAt = data?.extracted_at ? new Date(data.extracted_at).toLocaleString() : 'Unknown';
        
        // Try to parse the JSON for better display
        let iocsData = {};
        let jsonError = null;
        try {
            // If iocsJson is already an array, use it directly
            if (Array.isArray(iocsJson)) {
                iocsData = iocsJson;
            } else {
                // Try to extract JSON from the response if it contains text before JSON
                let jsonText = iocsJson.trim();
                
                // If the response starts with text, try to find JSON within it
                if (!jsonText.startsWith('{') && !jsonText.startsWith('[')) {
                    const jsonMatch = jsonText.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        jsonText = jsonMatch[0];
                    }
                }
                
                iocsData = JSON.parse(jsonText);
            }
        } catch (e) {
            jsonError = e.message;
        }
        
        modal.innerHTML = `
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">üîç Extracted IOCs</h3>
                    <button onclick="closeIOCsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 text-sm text-gray-600">
                    <span class="font-medium">Generated by:</span> ${modelUsed} | 
                    <span class="font-medium">Extracted at:</span> ${extractedAt}
                    ${data?.cached ? ' | <span class="font-medium text-blue-600">(Cached)</span>' : ''}
                </div>
                
                ${jsonError ? `
                <div class="bg-red-50 p-4 rounded-lg mb-4">
                    <div class="text-red-800">
                        <strong>JSON Parse Error:</strong> ${jsonError}
                    </div>
                    <div class="mt-2">
                        <strong>Raw Response:</strong>
                        <pre class="text-sm mt-1 bg-gray-100 p-2 rounded overflow-x-auto">${iocsJson}</pre>
                    </div>
                </div>
                ` : `
                <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    ${Array.isArray(iocsData) ? `
                    <div class="space-y-3">
                        <div class="text-sm text-gray-600 mb-2">
                            <strong>Total IOCs found:</strong> ${iocsData.length}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${iocsData.map(ioc => `
                            <div class="bg-white p-3 rounded border">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded capitalize">${ioc.type}</span>
                                    <span class="text-xs text-gray-500">${(ioc.confidence * 100).toFixed(0)}%</span>
                                </div>
                                <div class="font-mono text-sm text-gray-900 break-all">${ioc.value}</div>
                                ${ioc.context ? `<div class="text-xs text-gray-600 mt-1 italic">${ioc.context.substring(0, 100)}${ioc.context.length > 100 ? '...' : ''}</div>` : ''}
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${Object.entries(iocsData).map(([category, items]) => `
                        <div class="bg-white p-3 rounded border">
                            <h4 class="font-medium text-gray-900 mb-2 capitalize">${category.replace(/_/g, ' ')}</h4>
                            ${items && items.length > 0 ? `
                            <ul class="text-sm text-gray-700 space-y-1">
                                ${items.map(item => `<li class="font-mono text-xs bg-gray-50 px-2 py-1 rounded">${item}</li>`).join('')}
                            </ul>
                            ` : '<p class="text-gray-500 text-sm">No items found</p>'}
                        </div>
                        `).join('')}
                    </div>
                    `}
                </div>
                `}
                
                <div class="mt-4 flex justify-between">
                    <button onclick="regenerateIOCs()" 
                            class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                        üîÑ Regenerate
                    </button>
                    <button onclick="closeIOCsModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function closeIOCsModal() {
        const modal = document.getElementById('iocsModal');
        if (modal) {
            modal.remove();
        }
    }
    
    function regenerateSigmaRules() {
        // Close current modal
        closeSigmaRulesModal();
        
        // Call generateAIAnalysis with force regeneration
        generateAIAnalysis('sigma', true);
    }
    
    function regenerateChatGPTSummary() {
        // Close current modal
        closeChatGPTSummaryModal();
        
        // Call generateAIAnalysis with force regeneration
        generateAIAnalysis('summary', true);
    }
    
    function regenerateIOCs() {
        // Close current modal
        closeIOCsModal();
        
        // Call generateAIAnalysis with force regeneration
        generateAIAnalysis('iocs', true);
    }
    
    // Text annotation system now handled by LayeredTextManager
    
    // Delete article function
    function deleteArticle(articleId) {
        if (confirm('Are you sure you want to delete this article? This action cannot be undone and will also delete all annotations for this article.')) {
            fetch(`/api/articles/${articleId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Article deleted successfully!');
                    // Redirect to articles page
                    window.location.href = '/articles';
                } else {
                    alert('Failed to delete article: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete article: ' + error.message);
            });
        }
    }
    
    // Check for pending completion notifications from other pages
    function checkPendingCompletions() {
        const pendingCompletions = JSON.parse(localStorage.getItem('pendingCompletions') || '[]');
        
        pendingCompletions.forEach(completion => {
            // Show completion banner
            showCompletionBanner(completion.type, completion.typeText, completion.typeIcon, completion.articleId, completion.articleTitle);
        });
        
        // Clear pending completions after showing them
        localStorage.removeItem('pendingCompletions');
    }
    
    // Handle URL fragments to auto-open results
    console.log('Setting up URL fragment handler...');
    window.addEventListener('load', function() {
        console.log('Page loaded, checking URL fragments...');
        
        // Check for pending completions first
        checkPendingCompletions();
        
        const hash = window.location.hash.substring(1); // Remove the #
        console.log('URL hash:', hash);
        
        if (hash === 'summary') {
            console.log('Processing summary hash...');
            // Check if summary exists and show it
            const hasSummary = {{ 'true' if article.metadata and article.metadata.get('chatgpt_summary') else 'false' }};
            console.log('Has summary:', hasSummary);
            if (hasSummary) {
                const summaryData = {{ article.metadata.get('chatgpt_summary') | tojson if article.metadata and article.metadata.get('chatgpt_summary') else 'null' }};
                console.log('Summary data:', summaryData);
                if (summaryData) {
                    console.log('Auto-opening summary modal from URL fragment');
                    setTimeout(() => {
                        console.log('About to call showChatGPTSummaryModal');
                        showChatGPTSummaryModal(summaryData.summary, summaryData);
                    }, 500);
                }
            } else {
                console.log('No summary found for this article');
            }
        } else if (hash === 'sigma') {
            // Check if SIGMA rules exist and show them
            const hasSigmaRules = {{ 'true' if article.metadata and article.metadata.get('sigma_rules') else 'false' }};
            if (hasSigmaRules) {
                const sigmaData = {{ article.metadata.get('sigma_rules') | tojson if article.metadata and article.metadata.get('sigma_rules') else 'null' }};
                if (sigmaData) {
                    console.log('Auto-opening SIGMA modal from URL fragment');
                    setTimeout(() => showSigmaRulesModal(sigmaData.rules, sigmaData), 500);
                }
            } else {
                console.log('No SIGMA rules found for this article');
            }
        } else if (hash === 'iocs') {
            // Check if IOCs exist and show them
            const hasIOCs = {{ 'true' if article.metadata and article.metadata.get('extracted_iocs') else 'false' }};
            if (hasIOCs) {
                const iocData = {{ article.metadata.get('extracted_iocs') | tojson if article.metadata and article.metadata.get('extracted_iocs') else 'null' }};
                if (iocData) {
                    console.log('Auto-opening IOCs modal from URL fragment');
                    setTimeout(() => showIOCsModal(JSON.stringify(iocData.iocs, null, 2), iocData), 500);
                }
            } else {
                console.log('No IOCs found for this article');
            }
        }
        
        // Clear the hash from URL after handling
        if (hash) {
            console.log('Clearing URL hash:', hash);
            window.history.replaceState(null, null, window.location.pathname);
        }
    });

    // Handle URL fragments to auto-open results
    console.log('Setting up URL fragment handler...');
    window.addEventListener('load', function() {
        console.log('Page loaded, checking URL fragments...');
        
        // Check for pending completions first
        checkPendingCompletions();
        
        const hash = window.location.hash.substring(1); // Remove the #
        console.log('URL hash:', hash);
        
        if (hash === 'summary') {
            console.log('Processing summary hash...');
            
            // Get current article ID from URL
            const currentArticleId = window.location.pathname.split('/').pop();
            console.log('Current article ID:', currentArticleId);
            
            // Check if this is the same article as the template context
            const templateArticleId = {{ article.id }};
            console.log('Template article ID:', templateArticleId);
            
            if (currentArticleId == templateArticleId) {
                // Same article - use template data
                const hasSummary = {{ 'true' if article.metadata and article.metadata.get('chatgpt_summary') else 'false' }};
                console.log('Has summary (template):', hasSummary);
                
                if (hasSummary) {
                    const summaryData = {{ article.metadata.get('chatgpt_summary') | tojson if article.metadata and article.metadata.get('chatgpt_summary') else 'null' }};
                    console.log('Summary data (template):', summaryData);
                    
                    if (summaryData) {
                        console.log('Auto-opening summary modal from URL fragment (template)');
                        setTimeout(() => showChatGPTSummaryModal(summaryData.summary, summaryData), 500);
                    }
                }
            } else {
                // Different article - fetch data via API
                console.log('Different article, fetching summary data via API...');
                fetch(`/api/articles/${currentArticleId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched article data:', data);
                        if (data.metadata && data.metadata.chatgpt_summary) {
                            console.log('Auto-opening summary modal from URL fragment (API)');
                            setTimeout(() => showChatGPTSummaryModal(data.metadata.chatgpt_summary.summary, data.metadata.chatgpt_summary), 500);
                        } else {
                            console.log('No summary data found for this article');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching article data:', error);
                    });
            }
        } else if (hash === 'sigma') {
            console.log('Processing sigma hash...');
            
            // Get current article ID from URL
            const currentArticleId = window.location.pathname.split('/').pop();
            const templateArticleId = {{ article.id }};
            
            if (currentArticleId == templateArticleId) {
                // Same article - use template data
                const hasSigma = {{ 'true' if article.metadata and article.metadata.get('sigma_rules') else 'false' }};
                console.log('Has sigma (template):', hasSigma);
                
                if (hasSigma) {
                    const sigmaData = {{ article.metadata.get('sigma_rules') | tojson if article.metadata and article.metadata.get('sigma_rules') else 'null' }};
                    console.log('Sigma data (template):', sigmaData);
                    
                    if (sigmaData) {
                        console.log('Auto-opening sigma modal from URL fragment (template)');
                        setTimeout(() => showSigmaModal(sigmaData.rules, sigmaData), 500);
                    }
                }
            } else {
                // Different article - fetch data via API
                console.log('Different article, fetching sigma data via API...');
                fetch(`/api/articles/${currentArticleId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched article data for sigma:', data);
                        if (data.metadata && data.metadata.sigma_rules) {
                            console.log('Auto-opening sigma modal from URL fragment (API)');
                            setTimeout(() => showSigmaModal(data.metadata.sigma_rules.rules, data.metadata.sigma_rules), 500);
                        } else {
                            console.log('No sigma data found for this article');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching article data for sigma:', error);
                    });
            }
        } else if (hash === 'iocs') {
            console.log('Processing iocs hash...');
            
            // Get current article ID from URL
            const currentArticleId = window.location.pathname.split('/').pop();
            const templateArticleId = {{ article.id }};
            
            if (currentArticleId == templateArticleId) {
                // Same article - use template data
                const hasIocs = {{ 'true' if article.metadata and article.metadata.get('extracted_iocs') else 'false' }};
                console.log('Has iocs (template):', hasIocs);
                
                if (hasIocs) {
                    const iocsData = {{ article.metadata.get('extracted_iocs') | tojson if article.metadata and article.metadata.get('extracted_iocs') else 'null' }};
                    console.log('IOCs data (template):', iocsData);
                    
                    if (iocsData) {
                        console.log('Auto-opening IOCs modal from URL fragment (template)');
                        setTimeout(() => showIOCsModal(iocsData.iocs, iocsData), 500);
                    }
                }
            } else {
                // Different article - fetch data via API
                console.log('Different article, fetching IOCs data via API...');
                fetch(`/api/articles/${currentArticleId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched article data for IOCs:', data);
                        if (data.metadata && data.metadata.extracted_iocs) {
                            console.log('Auto-opening IOCs modal from URL fragment (API)');
                            setTimeout(() => showIOCsModal(data.metadata.extracted_iocs.iocs, data.metadata.extracted_iocs), 500);
                        } else {
                            console.log('No IOCs data found for this article');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching article data for IOCs:', error);
                    });
            }
        }
        
        // Clear the hash from URL after handling
        if (hash) {
            console.log('Clearing URL hash:', hash);
            window.history.replaceState(null, null, window.location.pathname);
        }
    });
</script>
{% endblock %}
