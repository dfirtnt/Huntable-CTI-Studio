{% extends "base.html" %}

{% block title %}Health Checks - CTI Scraper{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">üè• System Health Checks</h1>
            <p class="mt-2 text-gray-700">Monitor system performance, deduplication, and service health</p>
        </div>

        <!-- Health Check Controls -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <div class="flex flex-wrap gap-4">
                <button id="runAllChecks" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    üîÑ Run All Checks
                </button>
                <button id="runDatabaseCheck" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    üóÑÔ∏è Database Health
                </button>
                <button id="runDeduplicationCheck" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    üîç Deduplication Health
                </button>
                <button id="runServicesCheck" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    üîß Services Health
                </button>
                <button id="runCeleryCheck" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    ‚öôÔ∏è Celery Health
                </button>
                <button id="runIngestionCheck" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    üìä Ingestion Analytics
                </button>
                <button id="refreshTimestamp" 
                        class="inline-flex items-center px-4 py-2 border border-gray-400 text-sm font-medium rounded-md text-gray-800 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    ‚è∞ Refresh Timestamp
                </button>
            </div>
        </div>

        <!-- Overall Status -->
        <div id="overallStatus" class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Overall System Status</h2>
            <div id="overallStatusContent" class="text-gray-600">
                Click "Run All Checks" to get system status
            </div>
        </div>

        <!-- Database Health -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üóÑÔ∏è Database Health</h2>
            <div id="databaseHealthContent" class="text-gray-600">
                Click "Database Health" to check database status
            </div>
        </div>

        <!-- Deduplication Health -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üîç Deduplication System Health</h2>
            <div id="deduplicationHealthContent" class="text-gray-600">
                Click "Deduplication Health" to check deduplication status
            </div>
        </div>

        <!-- Services Health -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üîß External Services Health</h2>
            <div id="servicesHealthContent" class="text-gray-600">
                Click "Services Health" to check external services
            </div>
        </div>

        <!-- Celery Health -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">‚öôÔ∏è Celery Workers Health</h2>
            <div id="celeryHealthContent" class="text-gray-600">
                Click "Celery Health" to check background task processing
            </div>
        </div>

        <!-- Ingestion Analytics -->
        <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Article Ingestion Analytics</h2>
            <div id="ingestionAnalyticsContent" class="text-gray-600">
                Click "Ingestion Analytics" to view article collection trends
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Running Health Checks</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-600" id="loadingMessage">Please wait...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Health check functions
    async function runHealthCheck(endpoint, loadingMessage) {
        showLoading(loadingMessage);
        try {
            const response = await fetch(`/api/health${endpoint}`);
            const data = await response.json();
            hideLoading();
            return data;
        } catch (error) {
            hideLoading();
            console.error(`Health check failed for ${endpoint}:`, error);
            return { status: 'error', error: error.message };
        }
    }

    function showLoading(message) {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
    }

    function getStatusColor(status) {
        switch (status) {
            case 'healthy': return 'text-green-600';
            case 'unhealthy': return 'text-red-600';
            case 'error': return 'text-red-600';
            default: return 'text-gray-600 dark:text-gray-300';
        }
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'healthy': return '‚úÖ';
            case 'unhealthy': return '‚ùå';
            case 'error': return '‚ö†Ô∏è';
            default: return '‚ùì';
        }
    }

    // Overall Status Check
    async function updateOverallStatus() {
        const data = await runHealthCheck('', 'Checking overall system status...');
        
        const content = document.getElementById('overallStatusContent');
        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">${getStatusIcon(data.status)}</span>
                        <div>
                            <h3 class="font-medium text-blue-900">System Status</h3>
                            <p class="text-sm font-bold ${getStatusColor(data.status)}">${data.status.toUpperCase()}</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">üïí</span>
                        <div>
                            <h3 class="font-medium text-green-900">Last Check</h3>
                            <p class="text-sm font-bold text-green-700">${formatTimestamp(data.timestamp)}</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">üì¶</span>
                        <div>
                            <h3 class="font-medium text-purple-900">Version</h3>
                            <p class="text-sm font-bold text-purple-700">${data.version || '1.0.0'}</p>
                        </div>
                    </div>
                </div>
            </div>
            ${data.error ? `<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md"><p class="text-sm text-red-800">Error: ${data.error}</p></div>` : ''}
        `;
    }

    // Database Health Check
    async function updateDatabaseHealth() {
        const data = await runHealthCheck('/database', 'Checking database health...');
        
        const content = document.getElementById('databaseHealthContent');
        if (data.status === 'healthy' && data.database) {
            const db = data.database;
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Connection Status -->
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">‚úÖ</span>
                            <div>
                                <h3 class="font-medium text-green-900">Database Connection</h3>
                                <p class="text-sm text-green-700">${db.connection}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-medium text-blue-900">Total Articles</h3>
                            <p class="text-2xl font-bold text-blue-600">${db.total_articles}</p>
                        </div>
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-medium text-blue-900">Total Sources</h3>
                            <p class="text-2xl font-bold text-blue-600">${db.total_sources}</p>
                        </div>
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-medium text-blue-900">SimHash Coverage</h3>
                            <p class="text-2xl font-bold text-blue-600">${db.simhash.coverage}</p>
                        </div>
                    </div>

                    <!-- Deduplication Stats -->
                    <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <h3 class="font-medium text-orange-900 mb-3">Deduplication Statistics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-orange-700">Total Articles</p>
                                <p class="font-bold text-orange-900">${db.deduplication.total_articles}</p>
                            </div>
                            <div>
                                <p class="text-sm text-orange-700">Unique URLs</p>
                                <p class="font-bold text-orange-900">${db.deduplication.unique_urls}</p>
                            </div>
                            <div>
                                <p class="text-sm text-orange-700">Duplicate Rate</p>
                                <p class="font-bold ${db.deduplication.duplicate_rate === '0%' ? 'text-green-600' : 'text-red-600'}">${db.deduplication.duplicate_rate}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <h3 class="font-medium text-indigo-900 mb-3">Performance Metrics</h3>
                        <div class="space-y-2">
                            ${db.performance.map(perf => `
                                <div class="flex justify-between items-center p-3 bg-indigo-100 rounded border border-indigo-200">
                                    <span class="font-medium text-indigo-900">${perf.test}</span>
                                    <div class="text-right">
                                        <span class="text-sm font-bold text-indigo-700">${perf.query_time_ms}ms</span>
                                        <span class="text-xs text-indigo-600 ml-2">(${perf.rows_returned} rows)</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
        } else {
            content.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚ùå</span>
                        <div>
                            <h3 class="font-medium text-red-900">Database Health Check Failed</h3>
                            <p class="text-sm text-red-700">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Deduplication Health Check
    async function updateDeduplicationHealth() {
        const data = await runHealthCheck('/deduplication', 'Checking deduplication system...');
        
        const content = document.getElementById('deduplicationHealthContent');
        if (data.status === 'healthy' && data.deduplication) {
            const dedup = data.deduplication;
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Exact Duplicates -->
                    <div class="p-4 ${dedup.exact_duplicates.content_hash_duplicates === 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">${dedup.exact_duplicates.content_hash_duplicates === 0 ? '‚úÖ' : '‚ùå'}</span>
                            <div>
                                <h3 class="font-medium ${dedup.exact_duplicates.content_hash_duplicates === 0 ? 'text-green-900' : 'text-red-900'}">Exact Duplicates</h3>
                                <p class="text-sm ${dedup.exact_duplicates.content_hash_duplicates === 0 ? 'text-green-700' : 'text-red-700'}">${dedup.exact_duplicates.content_hash_duplicates} content hash duplicates found</p>
                            </div>
                        </div>
                        ${dedup.exact_duplicates.duplicate_details.length > 0 ? `
                            <div class="mt-3">
                                <h4 class="text-sm font-medium text-gray-800 mb-2">Duplicate Details:</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    ${dedup.exact_duplicates.duplicate_details.map(detail => `
                                        <li>Hash ${detail.hash}: ${detail.count} occurrences</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Near Duplicates -->
                    <div class="p-4 ${dedup.near_duplicates.potential_near_duplicates === 0 ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'} border rounded-lg">
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-2">${dedup.near_duplicates.potential_near_duplicates === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <div>
                                <h3 class="font-medium ${dedup.near_duplicates.potential_near_duplicates === 0 ? 'text-green-900' : 'text-yellow-900'}">Near Duplicates</h3>
                                <p class="text-sm ${dedup.near_duplicates.potential_near_duplicates === 0 ? 'text-green-700' : 'text-yellow-700'}">${dedup.near_duplicates.potential_near_duplicates} potential near-duplicates found</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700">SimHash Coverage: ${dedup.near_duplicates.simhash_coverage}</p>
                    </div>

                    <!-- SimHash Buckets -->
                    <div class="p-4 bg-teal-50 border border-teal-200 rounded-lg">
                        <h3 class="font-medium text-teal-900 mb-3">SimHash Bucket Distribution</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            ${dedup.simhash_buckets.bucket_distribution.map(bucket => `
                                <div class="p-2 bg-teal-100 border border-teal-200 rounded text-center">
                                    <div class="text-sm font-medium text-teal-900">Bucket ${bucket.bucket_id}</div>
                                    <div class="text-lg font-bold text-teal-700">${bucket.articles_count}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${dedup.simhash_buckets.most_active_bucket ? `
                            <div class="mt-3 text-sm text-teal-700">
                                Most active bucket: ${dedup.simhash_buckets.most_active_bucket[0]} (${dedup.simhash_buckets.most_active_bucket[1]} articles)
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚ùå</span>
                        <div>
                            <h3 class="font-medium text-red-900">Deduplication Health Check Failed</h3>
                            <p class="text-sm text-red-700">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Services Health Check
    async function updateServicesHealth() {
        const data = await runHealthCheck('/services', 'Checking external services...');
        
        const content = document.getElementById('servicesHealthContent');
        if (data.status === 'healthy' && data.services) {
            const services = data.services;
            content.innerHTML = `
                <div class="space-y-4">
                    ${Object.entries(services).map(([serviceName, serviceData]) => `
                        <div class="p-4 ${serviceData.status === 'healthy' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-2">${getStatusIcon(serviceData.status)}</span>
                                    <div>
                                        <h3 class="font-medium ${serviceData.status === 'healthy' ? 'text-green-900' : 'text-red-900'}">${serviceName.toUpperCase()}</h3>
                                        <p class="text-sm ${serviceData.status === 'healthy' ? 'text-green-700' : 'text-red-700'}">${serviceData.status}</p>
                                    </div>
                                </div>
                                ${serviceData.status === 'healthy' ? `
                                    <div class="text-right text-sm text-gray-700">
                                        ${serviceName === 'ollama' ? `
                                            <p class="font-medium">${serviceData.models_available} models available</p>
                                            <p class="text-xs text-gray-600">${serviceData.models.join(', ')}</p>
                                        ` : serviceName === 'redis' ? `
                                            <p class="font-medium">Memory: ${Math.round(serviceData.info.used_memory / 1024 / 1024)}MB</p>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div class="text-right text-sm text-red-700">
                                        <p class="font-medium">${serviceData.error}</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚ùå</span>
                        <div>
                            <h3 class="font-medium text-red-900">Services Health Check Failed</h3>
                            <p class="text-sm text-red-700">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Ingestion Analytics
    async function updateIngestionAnalytics() {
        const data = await runHealthCheck('/ingestion', 'Analyzing article ingestion trends...');
        
        const content = document.getElementById('ingestionAnalyticsContent');
        if (data.status === 'healthy' && data.ingestion) {
            const ingestion = data.ingestion;
            
            // Prepare chart data
            const dailyLabels = ingestion.daily_trends.map(item => item.date).reverse();
            const dailyArticles = ingestion.daily_trends.map(item => item.articles_count).reverse();
            const dailySources = ingestion.daily_trends.map(item => item.sources_count).reverse();
            
            // Prepare hunt score ranges data
            const huntScoreLabels = ingestion.hunt_score_ranges.map(item => item.date).reverse();
            const excellentData = ingestion.hunt_score_ranges.map(item => item.excellent).reverse();
            const goodData = ingestion.hunt_score_ranges.map(item => item.good).reverse();
            const moderateData = ingestion.hunt_score_ranges.map(item => item.moderate).reverse();
            const lowData = ingestion.hunt_score_ranges.map(item => item.low).reverse();
            const minimalData = ingestion.hunt_score_ranges.map(item => item.minimal).reverse();
            
            const hourlyLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const hourlyData = Array.from({length: 24}, (_, i) => {
                const hourData = ingestion.hourly_distribution.find(h => h.hour === i);
                return hourData ? hourData.articles_count : 0;
            });
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-medium text-blue-900">Total Articles</h3>
                            <p class="text-2xl font-bold text-blue-600">${ingestion.total_stats.total_articles.toLocaleString()}</p>
                        </div>
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h3 class="font-medium text-green-900">Active Sources</h3>
                            <p class="text-2xl font-bold text-green-600">${ingestion.total_stats.total_sources}</p>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <h3 class="font-medium text-purple-900">Earliest Article</h3>
                            <p class="text-sm font-bold text-purple-600">${ingestion.total_stats.earliest_article ? new Date(ingestion.total_stats.earliest_article).toLocaleDateString() : 'N/A'}</p>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                            <h3 class="font-medium text-orange-900">Latest Article</h3>
                            <p class="text-sm font-bold text-orange-600">${ingestion.total_stats.latest_article ? new Date(ingestion.total_stats.latest_article).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Hunt Score Ranges Chart -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <h3 class="font-medium text-slate-900 mb-4">üéØ Hunt Score Ranges (Last 30 Days)</h3>
                        <canvas id="huntScoreChart" width="400" height="200"></canvas>
                    </div>

                    <!-- Hourly Distribution Chart -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <h3 class="font-medium text-slate-900 mb-4">üïê Hourly Distribution (Today)</h3>
                        <canvas id="hourlyChart" width="400" height="200"></canvas>
                    </div>

                    <!-- Source Breakdown -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <h3 class="font-medium text-slate-900 mb-4">üì∞ Top Sources (Last 7 Days)</h3>
                        <div class="space-y-3">
                            ${ingestion.source_breakdown.map(source => `
                                <div class="p-3 bg-white rounded border border-slate-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-slate-900">${source.source_name}</span>
                                        <span class="text-sm font-bold text-blue-600">${source.articles_count} articles</span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                        <div class="text-center p-2 bg-blue-50 rounded">
                                            <div class="font-medium text-blue-900">Average Hunt Score</div>
                                            <div class="text-lg font-bold ${source.avg_hunt_score >= 60 ? 'text-green-600' : source.avg_hunt_score >= 40 ? 'text-yellow-600' : 'text-red-600'}">${source.avg_hunt_score.toFixed(1)}</div>
                                        </div>
                                        <div class="text-center p-2 bg-green-50 rounded">
                                            <div class="font-medium text-green-900">Chosen</div>
                                            <div class="text-sm font-bold text-green-600">${source.chosen_ratio}</div>
                                            <div class="text-xs text-gray-600">${source.chosen_count}</div>
                                        </div>
                                        <div class="text-center p-2 bg-red-50 rounded">
                                            <div class="font-medium text-red-900">Rejected</div>
                                            <div class="text-sm font-bold text-red-600">${source.rejected_ratio}</div>
                                            <div class="text-xs text-gray-600">${source.rejected_count}</div>
                                        </div>
                                        <div class="text-center p-2 bg-gray-50 rounded">
                                            <div class="font-medium text-gray-900">Unclassified</div>
                                            <div class="text-sm font-bold text-gray-600">${source.unclassified_ratio}</div>
                                            <div class="text-xs text-gray-600">${source.unclassified_count}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
                    // Create charts
                    createHuntScoreChart(huntScoreLabels, excellentData, goodData, moderateData, lowData, minimalData);
                    createHourlyChart(hourlyLabels, hourlyData);
        } else {
            content.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚ùå</span>
                        <div>
                            <h3 class="font-medium text-red-900">Ingestion Analytics Failed</h3>
                            <p class="text-sm text-red-700">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Celery Health Check
    async function updateCeleryHealth() {
        const data = await runHealthCheck('/celery', 'Checking Celery workers...');
        
        const content = document.getElementById('celeryHealthContent');
        if (data.status === 'healthy' && data.celery) {
            const celery = data.celery;
            content.innerHTML = `
                <div class="space-y-4">
                    ${Object.entries(celery).map(([component, componentData]) => `
                        <div class="p-4 ${componentData.status === 'healthy' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-2">${getStatusIcon(componentData.status)}</span>
                                    <div>
                                        <h3 class="font-medium ${componentData.status === 'healthy' ? 'text-green-900' : 'text-red-900'}">${component.toUpperCase()}</h3>
                                        <p class="text-sm ${componentData.status === 'healthy' ? 'text-green-700' : 'text-red-700'}">${componentData.status}</p>
                                    </div>
                                </div>
                                ${componentData.status === 'healthy' ? `
                                    <div class="text-right text-sm text-gray-700">
                                        ${component === 'workers' ? `
                                            <p class="font-medium">${componentData.active_workers} active workers</p>
                                        ` : component === 'broker' ? `
                                            <p class="font-medium">${componentData.url}</p>
                                        ` : component === 'result_backend' ? `
                                            <p class="font-medium">${componentData.backend}</p>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div class="text-right text-sm text-red-700">
                                        <p class="font-medium">${componentData.error}</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚ùå</span>
                        <div>
                            <h3 class="font-medium text-red-900">Celery Health Check Failed</h3>
                            <p class="text-sm text-red-700">${data.error || 'Unknown error'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Chart creation functions
    function createHuntScoreChart(labels, excellentData, goodData, moderateData, lowData, minimalData) {
        const ctx = document.getElementById('huntScoreChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Excellent (80-100)',
                    data: excellentData,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 1
                }, {
                    label: 'Good (60-79)',
                    data: goodData,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }, {
                    label: 'Moderate (40-59)',
                    data: moderateData,
                    backgroundColor: 'rgba(251, 191, 36, 0.8)',
                    borderColor: 'rgb(251, 191, 36)',
                    borderWidth: 1
                }, {
                    label: 'Low (20-39)',
                    data: lowData,
                    backgroundColor: 'rgba(249, 115, 22, 0.8)',
                    borderColor: 'rgb(249, 115, 22)',
                    borderWidth: 1
                }, {
                    label: 'Minimal (0-19)',
                    data: minimalData,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    function createHourlyChart(labels, data) {
        const ctx = document.getElementById('hourlyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Articles',
                    data: data,
                    backgroundColor: 'rgba(147, 51, 234, 0.8)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Event listeners
    document.getElementById('runAllChecks').addEventListener('click', async () => {
        await updateOverallStatus();
        await updateDatabaseHealth();
        await updateDeduplicationHealth();
        await updateServicesHealth();
        await updateCeleryHealth();
        await updateIngestionAnalytics();
    });

    document.getElementById('runDatabaseCheck').addEventListener('click', updateDatabaseHealth);
    document.getElementById('runDeduplicationCheck').addEventListener('click', updateDeduplicationHealth);
    document.getElementById('runServicesCheck').addEventListener('click', updateServicesHealth);
    document.getElementById('runCeleryCheck').addEventListener('click', updateCeleryHealth);
    document.getElementById('runIngestionCheck').addEventListener('click', updateIngestionAnalytics);
    document.getElementById('refreshTimestamp').addEventListener('click', updateOverallStatus);

    // Auto-refresh timestamp every 30 seconds
    setInterval(updateOverallStatus, 30000);
</script>
{% endblock %}
