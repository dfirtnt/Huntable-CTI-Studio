{% extends "base.html" %}

{% block title %}RAG Chat - Huntable Detection Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üîç RAG Search</h1>
        <p class="text-gray-600 dark:text-gray-400">AI-powered semantic search across threat intelligence content</p>
    </div>
    
    <div id="rag-chat-container" class="rounded-lg shadow-lg overflow-hidden" style="height: calc(100vh - 120px);"></div>
</div>

<script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const RAGChat = () => {
        const [messages, setMessages] = useState([
            {
                role: 'assistant',
                content: 'Hello! I\'m your threat intelligence assistant. I can help you search through our database of cybersecurity articles using semantic search. What would you like to know about?',
                timestamp: new Date().toISOString()
            }
        ]);
        const [inputMessage, setInputMessage] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [isUpdatingEmbeddings, setIsUpdatingEmbeddings] = useState(false);
        const [embeddingStats, setEmbeddingStats] = useState(null);
        const [settings, setSettings] = useState({
            maxResults: 5,  // Default to 5 articles for compact display
            similarityThreshold: 0.3,  // Lower threshold for broader coverage
            useChunks: false,  // Disable chunk-level search until annotations have embeddings
            contextLength: 2000,  // Context length per chunk
            useLLMGeneration: true,  // Enable LLM synthesis by default
            llmProvider: 'chatgpt'  // Default aligns with Settings page selection
        });
        const [expandedArticles, setExpandedArticles] = useState(new Set());
        const [yamlModal, setYamlModal] = useState({ isOpen: false, content: null, title: null, filePath: null });
        const messagesEndRef = useRef(null);
        const inputRef = useRef(null);

        const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        };

        const openYamlModal = async (ruleId, title, filePath) => {
            try {
                const response = await fetch(`/api/articles/sigma-rules-yaml/${ruleId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch YAML content');
                }
                const data = await response.json();
                setYamlModal({
                    isOpen: true,
                    content: data.yaml_content,
                    title: title || data.title,
                    filePath: filePath || data.file_path
                });
            } catch (error) {
                console.error('Error fetching YAML:', error);
                alert('Failed to load YAML file. ' + error.message);
            }
        };

        const closeYamlModal = () => {
            setYamlModal({ isOpen: false, content: null, title: null, filePath: null });
        };

        const toggleArticleExpansion = (messageIndex, articleIndex) => {
            const key = `${messageIndex}-${articleIndex}`;
            setExpandedArticles(prev => {
                const newSet = new Set(prev);
                if (newSet.has(key)) {
                    newSet.delete(key);
                } else {
                    newSet.add(key);
                }
                return newSet;
            });
        };

        useEffect(() => {
            scrollToBottom();
        }, [messages]);

        // Load embedding stats on component mount
        useEffect(() => {
            loadEmbeddingStats();
        }, []);

        // Close YAML modal on Escape key
        useEffect(() => {
            const handleEscape = (e) => {
                if (e.key === 'Escape' && yamlModal.isOpen) {
                    closeYamlModal();
                }
            };
            document.addEventListener('keydown', handleEscape);
            return () => {
                document.removeEventListener('keydown', handleEscape);
            };
        }, [yamlModal.isOpen]);

        const normalizeModelSelection = (value) => {
            if (!value) {
                return 'chatgpt';
            }
            const normalized = value.toLowerCase();
            if (['openai', 'gpt4o', 'gpt-4o', 'gpt-4o-mini', 'gpt'].includes(normalized)) {
                return 'chatgpt';
            }
            return normalized;
        };

        // Load AI model from Settings on mount
        useEffect(() => {
            const ctiSettings = localStorage.getItem('ctiScraperSettings');
            if (ctiSettings) {
                try {
                    const parsed = JSON.parse(ctiSettings);
                    const aiModel = normalizeModelSelection(parsed.aiModel);
                    setSettings(prev => ({ ...prev, llmProvider: aiModel }));
                } catch (e) {
                    console.error('Failed to parse settings:', e);
                }
            }
        }, []);

        const loadEmbeddingStats = async () => {
            try {
                const response = await fetch('/api/embeddings/stats');
                if (response.ok) {
                    const stats = await response.json();
                    setEmbeddingStats(stats);
                }
            } catch (error) {
                console.error('Failed to load embedding stats:', error);
            }
        };

        const handleUpdateEmbeddings = async () => {
            if (isUpdatingEmbeddings) return;

            setIsUpdatingEmbeddings(true);
            
            try {
                const response = await fetch('/api/embeddings/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        batch_size: 50
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Add success message to chat
                const successMessage = {
                    role: 'assistant',
                    content: `‚úÖ Embedding update started successfully!\n\nTask ID: ${data.task_id}\nBatch Size: ${data.batch_size}\nEstimated Articles: ${data.estimated_articles}\n\nThis process will run in the background. You can continue using the chat while embeddings are being generated.`,
                    timestamp: new Date().toISOString(),
                    isSystemMessage: true
                };
                
                setMessages(prev => [...prev, successMessage]);
                
                // Refresh embedding stats
                await loadEmbeddingStats();
                
            } catch (error) {
                console.error('Error updating embeddings:', error);
                const errorMessage = {
                    role: 'assistant',
                    content: `‚ùå Failed to start embedding update: ${error.message}\n\nPlease try again or contact an administrator if the problem persists.`,
                    timestamp: new Date().toISOString(),
                    isError: true
                };
                setMessages(prev => [...prev, errorMessage]);
            } finally {
                setIsUpdatingEmbeddings(false);
            }
        };

        const handleSendMessage = async () => {
            if (!inputMessage.trim() || isLoading) return;

            const userMessage = {
                role: 'user',
                content: inputMessage,
                timestamp: new Date().toISOString()
            };

            setMessages(prev => [...prev, userMessage]);
            setInputMessage('');
            setIsLoading(true);

            try {
                const response = await fetch('/api/chat/rag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: inputMessage,
                        conversation_history: messages,
                        max_results: settings.maxResults,
                        similarity_threshold: settings.similarityThreshold,
                        use_chunks: settings.useChunks,
                        context_length: settings.contextLength,
                        use_llm_generation: settings.useLLMGeneration,
                        llm_provider: settings.llmProvider,
                        include_sigma_rules: true
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                const assistantMessage = {
                    role: 'assistant',
                    content: data.response,
                    timestamp: data.timestamp,
                    relevantArticles: data.relevant_articles,
                    relevantRules: data.relevant_rules || [],
                    totalResults: data.total_results,
                    totalRules: data.total_rules || 0,
                    llmProvider: data.llm_provider,
                    llmModelName: data.llm_model_name,
                    useLLMGeneration: data.use_llm_generation
                };

                setMessages(prev => [...prev, assistantMessage]);
            } catch (error) {
                console.error('Error sending message:', error);
                const errorMessage = {
                    role: 'assistant',
                    content: 'Sorry, I encountered an error while processing your request. Please try again.',
                    timestamp: new Date().toISOString(),
                    isError: true
                };
                setMessages(prev => [...prev, errorMessage]);
            } finally {
                setIsLoading(false);
            }
        };

        const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        };

        const formatTimestamp = (timestamp) => {
            return new Date(timestamp).toLocaleTimeString();
        };

        const renderMessage = (message, index) => {
            const isUser = message.role === 'user';
            const isError = message.isError;
            const isSystem = message.isSystemMessage;

            return (
                <div
                    key={index}
                    className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}
                >
                    <div
                        className={`max-w-3xl px-4 py-3 rounded-lg ${
                            isUser
                                ? 'bg-purple-600 text-white'
                                : isError
                                ? 'bg-red-900 text-red-200 border border-red-700'
                                : isSystem
                                ? 'bg-green-900 text-green-200 border border-green-700'
                                : 'bg-gray-800 text-gray-200 border border-gray-700'
                        }`}
                    >
                        <div className="whitespace-pre-wrap">{message.content}</div>
                        
                        {message.relevantArticles && message.relevantArticles.length > 0 && (
                            <div className="mt-1 pt-1 border-t border-gray-600">
                                <div className="text-xs font-semibold mb-0.5 text-gray-300">
                                    üìö {message.totalResults} articles:
                                </div>
                                <div className="space-y-0.5">
                                    {message.relevantArticles.map((article, idx) => {
                                        const isExpanded = expandedArticles.has(`${index}-${idx}`);
                                        return (
                                            <div key={idx} className="text-xs bg-gray-700 rounded border border-gray-600 hover:bg-gray-600 transition-colors">
                                                {/* Compact view */}
                                                <div 
                                                    className="px-2 py-1 cursor-pointer flex items-center justify-between"
                                                    onClick={() => toggleArticleExpansion(index, idx)}
                                                >
                                                    <div className="flex items-center flex-1 min-w-0">
                                                        <span className="text-gray-400 text-xs mr-2 flex-shrink-0">
                                                            {(article.similarity * 100).toFixed(0)}%
                                                        </span>
                                                        <span className="text-gray-300 text-xs truncate">
                                                            {article.title}
                                                        </span>
                                                    </div>
                                                    <span className="text-gray-400 text-xs ml-2 flex-shrink-0">
                                                        {isExpanded ? '‚ñº' : '‚ñ∂'}
                                                    </span>
                                                </div>
                                                
                                                {/* Expanded view */}
                                                {isExpanded && (
                                                    <div className="px-2 pb-2 border-t border-gray-600">
                                                        <a 
                                                            href={`/articles/${article.id}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="font-medium text-purple-400 hover:text-purple-300 hover:underline cursor-pointer text-xs block mb-1"
                                                        >
                                                            {article.title}
                                                        </a>
                                                        <div className="text-gray-400 text-xs mb-1">
                                                            Source: {article.source_name} | Similarity: {(article.similarity * 100).toFixed(1)}%
                                                        </div>
                                                        {article.summary && (
                                                            <div className="text-gray-300 text-xs">
                                                                {article.summary.substring(0, 150)}...
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {message.relevantRules && message.relevantRules.length > 0 && (
                            <div className="mt-1 pt-1 border-t border-gray-600">
                                <div className="text-xs font-semibold mb-0.5 text-yellow-300">
                                    üõ°Ô∏è {message.totalRules} detection rules:
                                </div>
                                <div className="space-y-0.5">
                                    {message.relevantRules.map((rule, idx) => {
                                        const isExpanded = expandedArticles.has(`rule-${index}-${idx}`);
                                        const tagList = Array.isArray(rule.tags) ? rule.tags : [];
                                        const mitreTags = tagList.filter(tag => tag.startsWith('attack.'));
                                        return (
                                            <div key={`rule-${idx}`} className="text-xs bg-gray-700 rounded border border-gray-600 hover:bg-gray-600 transition-colors">
                                                {/* Compact view */}
                                                <div 
                                                    className="px-2 py-1 cursor-pointer flex items-center justify-between"
                                                    onClick={() => toggleArticleExpansion(`rule-${index}`, idx)}
                                                >
                                                    <div className="flex items-center flex-1 min-w-0">
                                                        <span className="text-gray-400 text-xs mr-2 flex-shrink-0">
                                                            {(rule.similarity * 100).toFixed(0)}%
                                                        </span>
                                                        <span className="text-gray-300 text-xs truncate">
                                                            {rule.title}
                                                        </span>
                                                    </div>
                                                    <span className="text-gray-400 text-xs ml-2 flex-shrink-0">
                                                        {isExpanded ? '‚ñº' : '‚ñ∂'}
                                                    </span>
                                                </div>
                                                
                                                {/* Expanded view */}
                                                {isExpanded && (
                                                    <div className="px-2 pb-2 border-t border-gray-600">
                                                        <div className="font-medium text-yellow-400 text-xs mb-1">
                                                            {rule.title}
                                                        </div>
                                                        <div className="text-gray-400 text-xs mb-1">
                                                            Status: {rule.status} | Level: {rule.level} | Similarity: {(rule.similarity * 100).toFixed(1)}%
                                                        </div>
                                                        {rule.description && (
                                                            <div className="text-gray-300 text-xs mb-1">
                                                                {rule.description.substring(0, 150)}...
                                                            </div>
                                                        )}
                                                        {mitreTags.length > 0 && (
                                                            <div className="text-cyan-400 text-xs mt-1">
                                                                MITRE: {mitreTags.slice(0, 3).join(', ')}
                                                            </div>
                                                        )}
                                                        {rule.file_path && (
                                                            <div className="text-gray-400 text-xs mt-1">
                                                                üìÅ <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        openYamlModal(rule.rule_id, rule.title, rule.file_path);
                                                                    }}
                                                                    className="text-blue-400 hover:text-blue-300 hover:underline cursor-pointer"
                                                                >
                                                                    {rule.file_path}
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        <div className="flex items-center justify-between mt-2">
                            <div className="text-xs opacity-70 text-gray-400">
                                {formatTimestamp(message.timestamp)}
                            </div>
                            {message.llmModelName && (
                                <div className="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 border border-gray-600">
                                    ü§ñ {message.llmModelName}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <div className="flex flex-col h-full bg-gray-900">
                {/* Header */}
                <div className="bg-gray-800 border-b border-gray-700 p-3">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-lg font-semibold text-white">üîç Threat Intelligence Chat</h2>
                            <p className="text-xs text-gray-300">
                                Ask questions about cybersecurity threats, malware, and security vulnerabilities
                            </p>
                            <p className="text-xs text-green-400 mt-1">
                                ‚úÖ AI-powered responses enabled
                            </p>
                        </div>
                        
                        {/* Settings */}
                        <div className="flex items-center space-x-4 text-sm">
                            <div className="flex items-center space-x-2">
                                <label htmlFor="maxResults" className="text-gray-300">Max Results:</label>
                                <select
                                    id="maxResults"
                                    value={settings.maxResults}
                                    onChange={(e) => setSettings(prev => ({ ...prev, maxResults: parseInt(e.target.value) }))}
                                    className="border border-gray-600 bg-gray-700 text-white rounded px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500"
                                >
                                    <option value={3}>3 Articles</option>
                                    <option value={5}>5 Articles</option>
                                    <option value={10}>10 Articles</option>
                                    <option value={20}>20 Articles</option>
                                </select>
                            </div>
                            
                            <div className="flex items-center space-x-2">
                                <label htmlFor="threshold" className="text-gray-300">Similarity:</label>
                                <select
                                    id="threshold"
                                    value={settings.similarityThreshold}
                                    onChange={(e) => setSettings(prev => ({ ...prev, similarityThreshold: parseFloat(e.target.value) }))}
                                    className="border border-gray-600 bg-gray-700 text-white rounded px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500"
                                >
                                    <option value={0.3}>30%</option>
                                    <option value={0.4}>40%</option>
                                    <option value={0.5}>50%</option>
                                    <option value={0.6}>60%</option>
                                    <option value={0.7}>70%</option>
                                    <option value={0.8}>80%</option>
                                </select>
                            </div>
                            
                            {/* Embedding Stats and Update Button */}
                            <div className="flex items-center space-x-2">
                                {embeddingStats && (
                                    <div className="text-xs text-gray-400">
                                        Embeddings: {embeddingStats.embedded_count}/{embeddingStats.total_articles} ({embeddingStats.embedding_coverage_percent}%)
                                    </div>
                                )}
                                <button
                                    onClick={handleUpdateEmbeddings}
                                    disabled={isUpdatingEmbeddings}
                                    className="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                    title="Update embeddings for new articles"
                                >
                                    {isUpdatingEmbeddings ? (
                                        <div className="flex items-center space-x-1">
                                            <div className="animate-spin rounded-full h-3 w-3 border-b border-white"></div>
                                            <span>Updating...</span>
                                        </div>
                                    ) : (
                                        'üîÑ Update Embeddings'
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Messages */}
                <div className="flex-1 overflow-y-auto p-3 space-y-4 bg-gray-900">
                    {messages.map((message, index) => renderMessage(message, index))}
                    
                    {isLoading && (
                        <div className="flex justify-start">
                            <div className="bg-gray-800 text-gray-200 px-4 py-3 rounded-lg border border-gray-700">
                                <div className="flex items-center space-x-2">
                                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-400"></div>
                                    <span>Searching threat intelligence database...</span>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div ref={messagesEndRef} />
                </div>

                {/* Input */}
                <div className="border-t border-gray-700 p-3 bg-gray-800">
                    <div className="flex space-x-2">
                        <textarea
                            ref={inputRef}
                            value={inputMessage}
                            onChange={(e) => setInputMessage(e.target.value)}
                            onKeyPress={handleKeyPress}
                            placeholder="Ask about cybersecurity threats, malware, vulnerabilities..."
                            className="flex-1 border border-gray-600 bg-gray-700 text-white rounded-lg px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent placeholder-gray-400"
                            rows={1}
                            disabled={isLoading}
                        />
                        <button
                            onClick={handleSendMessage}
                            disabled={!inputMessage.trim() || isLoading}
                            className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                        >
                            {isLoading ? 'Sending...' : 'Send'}
                        </button>
                    </div>
                    
                    <div className="mt-2 text-xs text-gray-400">
                        üí° Try asking: "What are the latest ransomware threats?" or "Tell me about malware detection techniques"
                    </div>
                </div>

                {/* YAML Modal */}
                {yamlModal.isOpen && (
                    <div
                        className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
                        onClick={closeYamlModal}
                    >
                        <div
                            className="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col"
                            onClick={(e) => e.stopPropagation()}
                        >
                            {/* Modal Header */}
                            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-700">
                                <div className="flex-1 min-w-0">
                                    <h2 className="text-xl font-bold text-white truncate">
                                        {yamlModal.title}
                                    </h2>
                                    <p className="text-sm text-gray-400 mt-1">
                                        üìÅ {yamlModal.filePath}
                                    </p>
                                </div>
                                <button
                                    onClick={closeYamlModal}
                                    className="ml-4 text-gray-400 hover:text-white text-2xl font-bold leading-none flex-shrink-0"
                                >
                                    √ó
                                </button>
                            </div>

                            {/* Modal Body */}
                            <div className="flex-1 overflow-auto p-6">
                                <pre className="bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto font-mono">
                                    <code>{yamlModal.content}</code>
                                </pre>
                            </div>

                            {/* Modal Footer */}
                            <div className="flex items-center justify-end px-6 py-4 border-t border-gray-700 space-x-3">
                                <button
                                    onClick={() => {
                                        navigator.clipboard.writeText(yamlModal.content);
                                        alert('YAML content copied to clipboard!');
                                    }}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    üìã Copy to Clipboard
                                </button>
                                <button
                                    onClick={closeYamlModal}
                                    className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // Render the chat component using React 18 createRoot
    const container = document.getElementById('rag-chat-container');
    if (container) {
        const root = ReactDOM.createRoot(container);
        root.render(<RAGChat />);
    }
</script>
{% endblock %}
