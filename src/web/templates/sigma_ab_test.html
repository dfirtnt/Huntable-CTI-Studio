{% extends "base.html" %}

{% block title %}SIGMA Rule A/B Testing - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üß™ SIGMA Rule A/B Comparison</h1>
        <p class="text-gray-600 dark:text-gray-400">Compare two SIGMA rules using behavioral novelty assessment</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Rule A Input -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Rule A</h2>
                <button onclick="loadExample('a')" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400">
                    üìã Load Example
                </button>
            </div>
            <textarea 
                id="ruleA" 
                class="w-full h-96 p-3 border border-gray-300 dark:border-gray-600 rounded-md font-mono text-sm dark:bg-gray-700 dark:text-white"
                placeholder="Paste SIGMA rule YAML here..."
            ></textarea>
            <div id="ruleAValidation" class="mt-2 text-sm"></div>
        </div>

        <!-- Rule B Input -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Rule B</h2>
                <button onclick="loadExample('b')" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400">
                    üìã Load Example
                </button>
            </div>
            <textarea 
                id="ruleB" 
                class="w-full h-96 p-3 border border-gray-300 dark:border-gray-600 rounded-md font-mono text-sm dark:bg-gray-700 dark:text-white"
                placeholder="Paste SIGMA rule YAML here..."
            ></textarea>
            <div id="ruleBValidation" class="mt-2 text-sm"></div>
        </div>
    </div>

    <!-- Options -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Options</h3>
        <div class="space-y-4">
            <div class="flex items-center space-x-6">
                <button 
                    onclick="compareRules(); return false;" 
                    id="compareBtn"
                    type="button"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                >
                    üîç Compare Rules
                </button>
                <button 
                    onclick="compareRuleToRepository(); return false;" 
                    id="compareToRepoBtn"
                    type="button"
                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors"
                >
                    üîé Compare Rule A to Repository
                </button>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
                <p><strong>Compare Rules:</strong> Compare two rules directly using behavioral novelty assessment.</p>
                <p><strong>Compare to Repository:</strong> Compare Rule A against all rules in the SigmaHQ repository.</p>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Comparison Results</h3>
            
            <!-- Overall Similarity & Novelty Classification -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Weighted Similarity</span>
                    <div class="flex items-center space-x-4">
                    <span id="overallSimilarity" class="text-3xl font-bold text-blue-600 dark:text-blue-400">-</span>
                        <span id="noveltyLabel" class="px-3 py-1 rounded text-sm font-semibold"></span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-4">
                    <div id="similarityBar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    <span>Novelty Score: </span>
                    <span id="noveltyScore" class="font-semibold">-</span>
                </div>
            </div>

            <!-- Behavioral Similarity Breakdown -->
            <div class="mb-6">
                <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">üîç Behavioral Similarity Breakdown</h4>
                <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                    <div class="grid grid-cols-1 gap-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-700 dark:text-gray-300">Atom Jaccard <span class="text-gray-500">(weight: 70%)</span>:</span>
                            <span id="atomJaccard" class="font-medium text-blue-700 dark:text-blue-300">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-700 dark:text-gray-300">Logic Shape <span class="text-gray-500">(weight: 30%)</span>:</span>
                            <span id="logicShape" class="font-medium text-blue-700 dark:text-blue-300">-</span>
                        </div>
                        <div id="logicShapeNA" class="hidden text-xs text-gray-500 dark:text-gray-400 italic">
                            N/A - Logic shape not computed when all atoms are identical (proven event equivalence)
                        </div>
                        <div class="pt-2 border-t border-blue-200 dark:border-blue-700 flex justify-between">
                            <span class="text-gray-700 dark:text-gray-300 font-semibold">Weighted Total:</span>
                            <span id="weightedTotal" class="font-medium text-blue-700 dark:text-blue-300">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Explainability -->
            <div id="explainabilitySection" class="mb-6 hidden">
                <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">üìä Explainability</h4>
                <div class="space-y-4">
                    <div id="sharedAtomsSection" class="hidden">
                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Shared Atoms:</h5>
                        <div id="sharedAtoms" class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded p-3 text-xs font-mono text-gray-900 dark:text-gray-100"></div>
                </div>
                    <div id="addedAtomsSection" class="hidden">
                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Atoms in Rule A (not in Rule B):</h5>
                        <div id="addedAtoms" class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded p-3 text-xs font-mono text-gray-900 dark:text-gray-100"></div>
                    </div>
                    <div id="removedAtomsSection" class="hidden">
                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Atoms in Rule B (not in Rule A):</h5>
                        <div id="removedAtoms" class="bg-orange-50 dark:bg-orange-900 border border-orange-200 dark:border-orange-700 rounded p-3 text-xs font-mono text-gray-900 dark:text-gray-100"></div>
                    </div>
                    <div id="filterDifferencesSection" class="hidden">
                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Filter Differences (NOT logic):</h5>
                        <div id="filterDifferences" class="bg-purple-50 dark:bg-purple-900 border border-purple-200 dark:border-purple-700 rounded p-3 text-xs font-mono text-gray-900 dark:text-gray-100"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <span class="text-red-600 dark:text-red-400 font-semibold mr-2">‚ùå Error:</span>
            <span id="errorMessage" class="text-red-800 dark:text-red-200"></span>
        </div>
    </div>
</div>

<script src="/static/js/components/similarity-display.js"></script>
<script>
    // Example rules for testing
    const exampleRules = {
        a: `title: Suspicious PowerShell Execution
id: test-rule-a-001
status: experimental
description: Detects suspicious PowerShell execution patterns
author: Test User
date: 2025/01/01
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    Image|endswith: '\\powershell.exe'
    CommandLine|contains: 
      - '-nop'
      - '-w hidden'
  condition: selection
level: high
tags:
  - attack.execution
  - attack.t1059.001`,
        
        b: `title: PowerShell Obfuscation Detection
id: test-rule-b-001
status: experimental
description: Identifies obfuscated PowerShell command execution
author: Test User
date: 2025/01/01
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ProcessCommandLine|contains: 'powershell'
    CommandLine|re: '.*-nop.*-w.*hidden.*'
  condition: selection
level: high
tags:
  - attack.execution
  - attack.t1059.001`
    };

    function loadExample(rule) {
        const textarea = document.getElementById(`rule${rule.toUpperCase()}`);
        textarea.value = exampleRules[rule] || '';
        validateRule(rule);
        saveRule(rule); // Save to localStorage when loading example
    }

    function validateRule(rule) {
        const textarea = document.getElementById(`rule${rule.toUpperCase()}`);
        const validationDiv = document.getElementById(`${rule}Validation`);
        
        if (!textarea || !validationDiv) {
            return false;
        }
        
        const yaml = textarea.value.trim();
        
        if (!yaml) {
            validationDiv.innerHTML = '<span class="text-gray-500">Empty</span>';
            return false;
        }
        
        // Basic YAML validation (check for key indicators)
        const lines = yaml.split('\n');
        if (lines.length < 3) {
            validationDiv.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è Very short - may be invalid</span>';
            return false;
        }
        
        // Check for basic YAML structure indicators
        const hasColon = yaml.includes(':');
        const hasTitle = yaml.toLowerCase().includes('title:');
        const hasDetection = yaml.toLowerCase().includes('detection:');
        
        if (!hasColon) {
            validationDiv.innerHTML = '<span class="text-red-600">‚ùå Missing YAML structure</span>';
            return false;
        }
        
        if (hasTitle || hasDetection) {
            validationDiv.innerHTML = '<span class="text-green-600">‚úì Valid YAML structure</span>';
            return true;
        }
        
        validationDiv.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è Basic structure found</span>';
        return true;
    }

    // Helper function to clean YAML content
    function cleanYamlContent(yaml) {
        if (!yaml) return '';
        
        // Remove HTML tags if any were accidentally pasted
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = yaml;
        let cleaned = tempDiv.textContent || tempDiv.innerText || yaml;
        
        // Remove common non-YAML patterns that might be accidentally included
        // Remove lines that look like HTML headings or UI text
        const lines = cleaned.split('\n');
        const filteredLines = lines.filter(line => {
            const trimmed = line.trim();
            // Skip lines that look like UI headings or HTML content
            if (trimmed === 'Comparison Results' || 
                trimmed === 'Weighted Similarity' ||
                trimmed === 'Repository Comparison Results' ||
                trimmed.startsWith('<') && trimmed.endsWith('>') ||
                trimmed.match(/^[A-Z][a-z]+ [A-Z][a-z]+$/)) { // Simple pattern like "Comparison Results"
                return false;
            }
            return true;
        });
        
        return filteredLines.join('\n').trim();
    }

    async function compareRules() {
        console.log('compareRules() called');
        
        try {
            let ruleA = document.getElementById('ruleA').value.trim();
            let ruleB = document.getElementById('ruleB').value.trim();
            const compareBtn = document.getElementById('compareBtn');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('errorDisplay');
            
            console.log('Elements found:', { ruleA: !!ruleA, ruleB: !!ruleB, compareBtn: !!compareBtn });
            
            // Hide previous results/errors
            if (resultsDiv) resultsDiv.classList.add('hidden');
            if (errorDiv) errorDiv.classList.add('hidden');
            
            if (!ruleA || !ruleB) {
                showError('Please provide both Rule A and Rule B');
                return;
            }
            
            // Clean YAML content to remove any accidentally pasted HTML or UI text
            ruleA = cleanYamlContent(ruleA);
            ruleB = cleanYamlContent(ruleB);
            
            if (!ruleA || !ruleB) {
                showError('Please provide valid YAML content in both Rule A and Rule B');
                return;
            }
            
            // Disable button and show loading
            if (compareBtn) {
                compareBtn.disabled = true;
                compareBtn.textContent = '‚è≥ Comparing...';
            }
            
            console.log('Sending request to /api/sigma-ab-test/compare');
            
            const response = await fetch('/api/sigma-ab-test/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    rule_a: ruleA,
                    rule_b: ruleB
                })
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { detail: `HTTP error! status: ${response.status}` };
                }
                
                // Improve YAML parsing error messages
                let errorMessage = errorData.detail || `HTTP error! status: ${response.status}`;
                if (errorMessage.includes('Invalid YAML')) {
                    errorMessage = 'Invalid YAML detected. Please ensure your rules contain only valid YAML content. ' +
                        'Make sure you haven\'t accidentally pasted HTML or UI text into the rule fields.';
                }
                
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Comparison failed');
            }
            
            // Display results
            displayResults(data);
            
        } catch (error) {
            console.error('Error in compareRules:', error);
            showError(error.message || 'Failed to compare rules');
        } finally {
            const compareBtn = document.getElementById('compareBtn');
            if (compareBtn) {
                compareBtn.disabled = false;
                compareBtn.textContent = 'üîç Compare Rules';
            }
        }
    }

    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.classList.remove('hidden');
        
        // Use standardized similarity display component
        updateSimilarityDisplay(data, { prefix: '' });
        
        // Show error if present (e.g., incompatible logsource)
        if (data.error) {
            showError(data.error);
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorDisplay');
        document.getElementById('errorMessage').textContent = message;
        errorDiv.classList.remove('hidden');
    }
    
    // Compare Rule A against the repository
    async function compareRuleToRepository() {
        console.log('compareRuleToRepository() called');
        
        try {
            let ruleA = document.getElementById('ruleA').value.trim();
            const compareToRepoBtn = document.getElementById('compareToRepoBtn');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('errorDisplay');
            
            // Hide previous results/errors
            if (resultsDiv) resultsDiv.classList.add('hidden');
            if (errorDiv) errorDiv.classList.add('hidden');
            
            // Remove any existing repository results
            const existingRepoResults = document.getElementById('repositoryResults');
            if (existingRepoResults) existingRepoResults.remove();
            
            if (!ruleA) {
                showError('Please provide Rule A to compare against the repository');
                return;
            }
            
            // Clean YAML content to remove any accidentally pasted HTML or UI text
            ruleA = cleanYamlContent(ruleA);
            
            if (!ruleA) {
                showError('Please provide valid YAML content in Rule A');
                return;
            }
            
            // Disable button and show loading
            if (compareToRepoBtn) {
                compareToRepoBtn.disabled = true;
                compareToRepoBtn.textContent = '‚è≥ Searching Repository...';
            }
            
            console.log('Sending request to /api/sigma-ab-test/compare-to-repository');
            
            const response = await fetch('/api/sigma-ab-test/compare-to-repository', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    rule: ruleA
                })
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { detail: `HTTP error! status: ${response.status}` };
                }
                
                // Improve YAML parsing error messages
                let errorMessage = errorData.detail || `HTTP error! status: ${response.status}`;
                if (errorMessage.includes('Invalid YAML')) {
                    errorMessage = 'Invalid YAML detected. Please ensure your rule contains only valid YAML content. ' +
                        'Make sure you haven\'t accidentally pasted HTML or UI text into the rule field.';
                }
                
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Repository comparison failed');
            }
            
            // Display repository comparison results
            displayRepositoryResults(data);
            
        } catch (error) {
            console.error('Error in compareRuleToRepository:', error);
            showError(error.message || 'Failed to compare rule to repository');
        } finally {
            const compareToRepoBtn = document.getElementById('compareToRepoBtn');
            if (compareToRepoBtn) {
                compareToRepoBtn.disabled = false;
                compareToRepoBtn.textContent = 'üîé Compare Rule A to Repository';
            }
        }
    }
    
    function displayRepositoryResults(data) {
        const matches = data.matches || [];
        const matchesHtml = matches.length > 0 ? matches.map((match, index) => {
            const similarity = ((match.similarity || match.similarity_score || 0) * 100).toFixed(1);
            const atomJaccard = ((match.atom_jaccard || 0) * 100).toFixed(1);
            const logicShape = match.logic_shape_similarity !== null && match.logic_shape_similarity !== undefined 
                ? ((match.logic_shape_similarity * 100).toFixed(1)) + '%' 
                : 'N/A';
            
            return `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">${escapeHtml(match.title || 'Unknown')}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${escapeHtml(match.rule_id || '')}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${similarity}%</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Similarity</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm mt-3">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Atom Jaccard:</span>
                            <span class="font-medium ml-2">${atomJaccard}%</span>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Logic Shape:</span>
                            <span class="font-medium ml-2">${logicShape}</span>
                        </div>
                    </div>
                    ${match.shared_atoms && match.shared_atoms.length > 0 ? `
                        <div class="mt-2 text-xs">
                            <span class="text-gray-600 dark:text-gray-400">Shared atoms:</span>
                            <span class="font-mono text-gray-700 dark:text-gray-300">${match.shared_atoms.slice(0, 3).join(', ')}${match.shared_atoms.length > 3 ? '...' : ''}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('') : `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 text-green-500 dark:text-green-400 flex items-center justify-center">
                    <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <p class="text-lg font-semibold text-gray-900 dark:text-white mb-2">‚ú® Novel Detection Pattern</p>
                <p class="text-gray-600 dark:text-gray-400 mb-1">No similar rules found in SigmaHQ repository</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">This rule represents a unique detection pattern that is not currently covered by existing SigmaHQ rules.</p>
            </div>
        `;
        
        // Create repository results section
        const repoResultsDiv = document.createElement('div');
        repoResultsDiv.id = 'repositoryResults';
        repoResultsDiv.className = 'bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-6';
        repoResultsDiv.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Repository Comparison Results</h3>
            <div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
                Found ${matches.length} most similar rules (behavioral novelty assessment) (sorted by similarity)
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                ${matchesHtml}
            </div>
        `;
        
        // Insert before error display
        const errorDisplay = document.getElementById('errorDisplay');
        if (errorDisplay && errorDisplay.parentNode) {
            errorDisplay.parentNode.insertBefore(repoResultsDiv, errorDisplay);
        } else {
            document.querySelector('.container').appendChild(repoResultsDiv);
        }
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load saved rules from localStorage on page load
    function loadSavedRules() {
        const savedRuleA = localStorage.getItem('sigma_ab_test_rule_a');
        const savedRuleB = localStorage.getItem('sigma_ab_test_rule_b');
        
        if (savedRuleA) {
            document.getElementById('ruleA').value = savedRuleA;
            validateRule('a');
        }
        
        if (savedRuleB) {
            document.getElementById('ruleB').value = savedRuleB;
            validateRule('b');
        }
    }
    
    // Save rules to localStorage on input
    function saveRule(section) {
        const textarea = document.getElementById(`rule${section.toUpperCase()}`);
        if (textarea) {
            localStorage.setItem(`sigma_ab_test_rule_${section.toLowerCase()}`, textarea.value);
        }
    }
    
    // Validate on input and save to localStorage
    document.getElementById('ruleA').addEventListener('input', () => {
        validateRule('a');
        saveRule('a');
    });
    document.getElementById('ruleB').addEventListener('input', () => {
        validateRule('b');
        saveRule('b');
    });
    
    // Load saved rules when page loads
    window.addEventListener('DOMContentLoaded', () => {
        loadSavedRules();
    });
</script>
{% endblock %}

