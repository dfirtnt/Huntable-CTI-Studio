{% extends "base.html" %}

{% block title %}Settings - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400 md:ml-2">Settings</span>
                </div>
            </li>
        </ol>
    </nav>
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-3">
            <img src="/static/icons/settings-icon.svg" alt="Settings" class="w-[63px] h-[63px]" />
            Settings
        </h1>
        <p class="text-gray-600 dark:text-gray-400">Configure your Huntable CTI Studio preferences</p>
    </div>

    <!-- Settings Sections -->
    <div class="space-y-8">

        <!-- Documentation -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-6">
            <div id="documentation-header" data-collapsible-panel="documentation" class="flex items-center justify-between cursor-pointer">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">üìö Documentation</h2>
                <span id="documentation-toggle" class="text-gray-500 dark:text-gray-400 transform transition-transform duration-200" aria-hidden="true">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </span>
            </div>
            <div id="documentation-content" class="space-y-4 hidden">
                <p class="text-sm text-gray-600 dark:text-gray-400">Open the MkDocs documentation site. If the page does not load, run <code class="bg-gray-700 px-1 rounded">./run_mkdocs.sh</code> in the project directory first.</p>
                <a id="launchMkdocsBtn"
                   href="http://127.0.0.1:8000"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-4L10 14"></path>
                    </svg>
                    Launch MkDocs server
                </a>
            </div>
        </div>

        <!-- Backup Configuration -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-6">
            <div id="backupConfig-header" data-collapsible-panel="backupConfig" class="flex items-center justify-between cursor-pointer">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">üíæ Backup Configuration</h2>
                <span id="backupConfig-toggle" class="text-gray-500 dark:text-gray-400 transform transition-transform duration-200" aria-hidden="true">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </span>
            </div>
            
            <div id="backupConfig-content" class="space-y-6 hidden">
                <!-- Backup Schedule -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üïê Schedule</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="backupTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Daily Backup Time
                            </label>
                            <input type="time" 
                                   id="backupTime" 
                                   value="02:00"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Time for daily automated backups</p>
                        </div>
                        <div>
                            <label for="cleanupTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Weekly Cleanup Time
                            </label>
                            <input type="time" 
                                   id="cleanupTime" 
                                   value="03:00"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Time for weekly cleanup (Sundays)</p>
                        </div>
                    </div>
                </div>

                <!-- Retention Policy -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üìä Retention Policy</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="dailyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Daily Backups
                            </label>
                            <input type="number" 
                                   id="dailyRetention" 
                                   value="7" 
                                   min="0" 
                                   max="30"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N daily backups</p>
                        </div>
                        <div>
                            <label for="weeklyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Weekly Backups
                            </label>
                            <input type="number" 
                                   id="weeklyRetention" 
                                   value="4" 
                                   min="0" 
                                   max="12"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N weekly backups</p>
                        </div>
                        <div>
                            <label for="monthlyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Monthly Backups
                            </label>
                            <input type="number" 
                                   id="monthlyRetention" 
                                   value="3" 
                                   min="0" 
                                   max="12"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N monthly backups</p>
                        </div>
                        <div>
                            <label for="maxSizeGb" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Max Size (GB)
                            </label>
                            <input type="number" 
                                   id="maxSizeGb" 
                                   value="50" 
                                   min="1" 
                                   max="1000"
                                   step="1"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Maximum total backup size</p>
                        </div>
                    </div>
                </div>

                <!-- Backup Components -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üß© Backup Components</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupDatabase" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupDatabase" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Database
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupModels" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupModels" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                ML Models
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupConfig" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupConfig" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Configuration
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupOutputs" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupOutputs" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Training Data
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupLogs" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupLogs" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Logs
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupDockerVolumes" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupDockerVolumes" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Docker Volumes
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Backup Settings -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">‚öôÔ∏è Backup Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="backupDirectory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Backup Directory
                            </label>
                            <input type="text" 
                                   id="backupDirectory" 
                                   value="backups"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Directory to store backups</p>
                        </div>
                        <div>
                            <label for="backupType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Backup Type
                            </label>
                            <select id="backupType" 
                                    class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                                <option value="full">Full System</option>
                                <option value="database">Database Only</option>
                                <option value="files">Files Only</option>
                            </select>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Type of backup to create</p>
                        </div>
                    </div>
                    <div class="mt-4 space-y-3">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="enableCompression" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enableCompression" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Enable Compression
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="enableVerification" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enableVerification" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Enable Verification
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Backup Actions -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üöÄ Backup Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button id="createBackupBtn" 
                                class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Create Backup Now
                        </button>
                        <button id="listBackupsBtn" 
                                class="px-4 py-2 border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            List Backups
                        </button>
                        <button id="backupStatusBtn" 
                                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Check Status
                        </button>
                        <button id="restoreBackupBtn" 
                                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Restore from Backup
                        </button>
                    </div>
                </div>

                <!-- Restore from backup file -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üìÅ Restore from Backup File</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Upload a backup file (.sql or .sql.gz) to restore the database.</p>
                    <div class="flex flex-wrap items-center gap-3">
                        <input type="file"
                               id="restoreBackupFileInput"
                               accept=".sql,.sql.gz"
                               class="block w-full max-w-xs text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-orange-500 file:text-white hover:file:bg-orange-600 file:cursor-pointer">
                        <button id="restoreFromFileBtn"
                                type="button"
                                disabled
                                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed">
                            Restore from File
                        </button>
                    </div>
                    <div id="restoreFromFileProgress" class="hidden mt-2">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-orange-600 mr-2"></div>
                            <span class="text-sm text-gray-300">Restoring from file...</span>
                        </div>
                    </div>
                    <div id="restoreFromFileError" class="hidden mt-2 p-3 bg-red-900 border border-red-700 rounded-lg">
                        <p class="text-sm text-red-200"></p>
                    </div>
                </div>

                 <!-- Backup Status Display -->
                 <div id="backupStatusDisplay" class="hidden">
                     <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üìä Backup Status</h3>
                     <div id="backupStatusContent" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                         <!-- Status content will be populated here -->
                     </div>
                 </div>

                 <!-- Data Export -->
                 <div>
                     <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üì§ Data Export</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Download all text classifications (huntable/not huntable) as a CSV file</p>

                     <button id="exportAnnotationsBtn"
                             class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                         </svg>
                         Export Annotations CSV
                     </button>

                     <div id="exportProgress" class="hidden mt-2">
                         <div class="flex items-center">
                             <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                             <span class="text-sm text-gray-600">Generating CSV...</span>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

        <!-- Agentic Workflow Configuration -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-6">
            <div data-collapsible-panel="agenticWorkflowConfig" class="flex items-center justify-between cursor-pointer">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">ü§ñ Agentic Workflow Configuration</h2>
                <span id="agenticWorkflowConfig-toggle" class="text-gray-500 dark:text-gray-400 transform transition-transform duration-200" aria-hidden="true">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </span>
            </div>

            <div id="agenticWorkflowConfig-content" class="space-y-4 hidden">
                <!-- Model Provider Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                        Model Providers
                    </label>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Select one or more AI providers for agentic workflows</p>

                    <div class="space-y-3">
                        <!-- OpenAI Provider -->
                        <div class="flex items-center">
                            <input type="checkbox"
                                   id="workflowOpenaiEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowOpenaiEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                OpenAI
                            </label>
                        </div>

                        <!-- Anthropic Provider -->
                        <div class="flex items-center">
                            <input type="checkbox"
                                   id="workflowAnthropicEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowAnthropicEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Anthropic
                            </label>
                        </div>

                        <!-- Gemini Provider (hidden until supported in workflow UI) -->
                        <div class="flex items-center hidden" aria-hidden="true">
                            <input type="checkbox"
                                   id="workflowGeminiEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowGeminiEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Google Gemini
                            </label>
                        </div>

                        <!-- LMStudio Provider (greyed out when user proceeded without LMStudio at start.sh) -->
                        <div id="workflowLmstudioRow" class="flex items-center">
                            <input type="checkbox"
                                   id="workflowLmstudioEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowLmstudioEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                LMStudio (Local)
                            </label>
                            <span id="workflowLmstudioProceedNote" class="ml-2 text-xs text-gray-500 dark:text-gray-400 hidden" aria-hidden="true"></span>
                        </div>
                    </div>
                </div>

                <!-- OpenAI API Key Section -->
                <div id="workflowOpenaiApiKeySection" style="display: none;">
                    <label for="workflowOpenaiApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        OpenAI API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowOpenaiApiKey"
                               placeholder="sk-..."
                               class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 pr-10 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        <button type="button"
                                id="toggleWorkflowOpenaiApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for OpenAI-powered agentic workflows</p>
                        <button id="testWorkflowOpenaiApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                            Test
                        </button>
                    </div>
                    <span id="workflowOpenaiApiKeyStatus" class="text-sm"></span>
                </div>

                <!-- Anthropic API Key Section -->
                <div id="workflowAnthropicApiKeySection" style="display: none;">
                    <label for="workflowAnthropicApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Anthropic API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowAnthropicApiKey"
                               placeholder="sk-ant-..."
                               class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 pr-10 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        <button type="button"
                                id="toggleWorkflowAnthropicApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for Anthropic-powered agentic workflows</p>
                        <button id="testWorkflowAnthropicApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                            Test
                        </button>
                    </div>
                    <span id="workflowAnthropicApiKeyStatus" class="text-sm"></span>
                </div>

                <!-- Gemini API Key Section (hidden until supported in workflow UI) -->
                <div id="workflowGeminiApiKeySection" class="hidden" style="display: none;">
                    <label for="workflowGeminiApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Google Gemini API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowGeminiApiKey"
                               placeholder="AIza..."
                               class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 pr-10 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        <button type="button"
                                id="toggleWorkflowGeminiApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for Google Gemini-powered agentic workflows</p>
                        <button id="testWorkflowGeminiApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                            Test
                        </button>
                    </div>
                    <span id="workflowGeminiApiKeyStatus" class="text-sm"></span>
                </div>

                 <!-- LMStudio API Key Section -->
                 <div id="workflowLmstudioApiKeySection" style="display: none;">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                         LMStudio Configuration
                     </label>
                     <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">LMStudio runs locally and doesn't require API keys. Ensure LMStudio is running on the default port.</p>
                     <div class="flex items-center justify-between">
                         <p class="text-sm text-gray-500 dark:text-gray-400">Test connection to local LMStudio server</p>
                         <button id="testWorkflowLmstudioApiKey"
                                 class="inline-flex items-center px-3 py-1 text-xs border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                             Get Models
                         </button>
                     </div>
                     <span id="workflowLmstudioApiKeyStatus" class="text-sm"></span>
                 </div>

                 <!-- Langfuse Configuration -->
                 <div id="langfuseApiKeySection" class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                     <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Langfuse Configuration</h3>
                     <form onsubmit="event.preventDefault(); return false;">
                     <!-- Langfuse Public Key -->
                     <div class="mb-4">
                         <label for="langfusePublicKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Public Key
                         </label>
                         <div class="relative">
                             <input type="password"
                                    id="langfusePublicKey"
                                    placeholder="pk-..."
                                    class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 pr-10 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                             <button type="button"
                                     id="toggleLangfusePublicKey"
                                     class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                 <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                 </svg>
                             </button>
                         </div>
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Required for Langfuse observability and tracing</p>
                     </div>

                     <!-- Langfuse Secret Key -->
                     <div class="mb-4">
                         <label for="langfuseSecretKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Secret Key
                         </label>
                         <div class="relative">
                             <input type="password"
                                    id="langfuseSecretKey"
                                    placeholder="sk-..."
                                    class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 pr-10 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                             <button type="button"
                                     id="toggleLangfuseSecretKey"
                                     class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                 <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                 </svg>
                             </button>
                         </div>
                     </div>

                     <!-- Langfuse Host -->
                     <div class="mb-4">
                         <label for="langfuseHost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Host URL
                         </label>
                         <input type="text"
                                id="langfuseHost"
                                placeholder="https://cloud.langfuse.com"
                                class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Optional: Defaults to https://cloud.langfuse.com</p>
                     </div>

                     <!-- Langfuse Project ID -->
                     <div class="mb-4">
                         <label for="langfuseProjectId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Project ID
                         </label>
                         <input type="text"
                                id="langfuseProjectId"
                                placeholder="your-project-id"
                                class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Optional: Found in your Langfuse URL (e.g., https://us.cloud.langfuse.com/project/{project_id}/traces)</p>
                     </div>

                     <!-- Langfuse Test Button -->
                     <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                         <button type="button" id="testLangfuseConnection"
                                 class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                             üß™ Test Langfuse Connection
                         </button>
                         <span id="langfuseTestStatus" class="ml-3 text-sm"></span>
                     </div>
                     </form>
                 </div>
             </div>
        </div>

        <!-- GitHub PR Configuration -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-6">
            <div data-collapsible-panel="githubPRConfig" class="flex items-center justify-between cursor-pointer">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">üì§ GitHub PR Configuration</h2>
                <span id="githubPRConfig-toggle" class="text-gray-500 dark:text-gray-400 transform transition-transform duration-200" aria-hidden="true">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </span>
            </div>

            <div id="githubPRConfig-content" class="space-y-4 hidden">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Configure GitHub authentication and repository settings for submitting approved SIGMA rules as Pull Requests.
                </p>
                <form onsubmit="event.preventDefault(); return false;">
                <!-- GitHub Token -->
                <div>
                    <label for="githubToken" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        GitHub Personal Access Token
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="githubToken"
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <button type="button"
                                id="toggleGithubToken"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Required for creating PRs. Token needs <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">repo</code> scope.
                        <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Create token ‚Üí</a>
                    </p>
                </div>

                <!-- Repository Path -->
                <div>
                    <label for="sigmaRepoPath" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        SIGMA Repository Path
                    </label>
                    <input type="text"
                           id="sigmaRepoPath"
                           placeholder="huntable-sigma-repo"
                           class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Path to the SIGMA rules repository inside the container.
                        <br><strong>Docker:</strong> Use <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">sigma-repo</code> (mounted at <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">/app/sigma-repo</code>)
                        <br><strong>Local:</strong> Use <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">../Huntable-SIGMA-Rules</code> or absolute path
                    </p>
                </div>

                <!-- GitHub Repository -->
                <div>
                    <label for="githubRepo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        GitHub Repository
                    </label>
                    <input type="text"
                           id="githubRepo"
                           placeholder=""
                           class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Repository in format <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">owner/repo</code>
                    </p>
                </div>

                <!-- Git User Configuration -->
                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Git Configuration</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Git user identity for commits (required for creating PRs)
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="gitUserName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Git User Name
                            </label>
                            <input type="text"
                                   id="gitUserName"
                                   placeholder="Huntable CTI Studio"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="gitUserEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Git User Email
                            </label>
                            <input type="email"
                                   id="gitUserEmail"
                                   placeholder="cti-studio@huntable.local"
                                   class="w-full bg-panel-0 border border-gray-700 rounded-lg px-3 py-2 text-gray-50 placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        Used as commit author when creating PRs. Defaults shown if not set.
                    </p>
                </div>

                <!-- Test Connection Button -->
                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="testGitHubConnection"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        üß™ Test GitHub Connection
                    </button>
                    <span id="githubTestStatus" class="ml-3 text-sm"></span>
                </div>
                </form>
            </div>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end">
            <button id="saveSettings" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                üíæ Save Settings
            </button>
        </div>
    </div>
</div>

<!-- Success Notification (hidden when not in use) -->
<div id="successNotification" class="hidden fixed top-4 right-4 z-[100] p-4 rounded-md shadow-lg w-full max-w-[min(24rem,calc(100vw-2rem))] bg-green-500 text-white transform translate-x-full transition-transform duration-300 pointer-events-none" aria-live="polite" aria-hidden="true">
    <div class="flex items-center">
        <span class="mr-2">‚úÖ</span>
        <span>Settings saved successfully!</span>
    </div>
</div>

<!-- Restore Backup Modal -->
<div id="restoreBackupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">üîÑ Restore from Backup</h3>
                <button id="closeRestoreModal" class="text-gray-400 hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Select Backup to Restore
                </label>
                <div id="restoreBackupList" class="space-y-2 max-h-64 overflow-y-auto border border-gray-700 rounded-lg p-3">
                    <div class="text-center text-gray-500 py-4">Loading backups...</div>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="restoreForce" 
                           class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                    <label for="restoreForce" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                        Skip snapshot creation (faster but no rollback option)
                    </label>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-6">
                    Note: A snapshot allows you to rollback if the restore fails. Skipping it is faster but less safe.
                </p>
            </div>
            
            <div id="restoreProgress" class="hidden mb-4">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-orange-600 mr-2"></div>
                    <span class="text-sm text-gray-300">Restoring backup...</span>
                </div>
            </div>
            
            <div id="restoreError" class="hidden mb-4 p-3 bg-red-900 border border-red-700 rounded-lg">
                <p class="text-sm text-red-200"></p>
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="cancelRestore" 
                        class="px-4 py-2 border border-gray-600 hover:bg-gray-800 text-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                    Cancel
                </button>
                <button id="confirmRestore" 
                        class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed">
                    Restore
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const WORKFLOW_PROVIDER_SETTING_KEYS = {
        openaiEnabled: 'WORKFLOW_OPENAI_ENABLED',
        openaiApiKey: 'WORKFLOW_OPENAI_API_KEY',
        anthropicEnabled: 'WORKFLOW_ANTHROPIC_ENABLED',
        anthropicApiKey: 'WORKFLOW_ANTHROPIC_API_KEY',
        geminiEnabled: 'WORKFLOW_GEMINI_ENABLED',
        geminiApiKey: 'WORKFLOW_GEMINI_API_KEY',
        lmstudioEnabled: 'WORKFLOW_LMSTUDIO_ENABLED'
    };

    // Load settings from localStorage and database
    async function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        
        
        
        // Load Langfuse settings from database (priority over localStorage)
        await loadLangfuseSettings();

        // Load backup configuration
        loadBackupSettings();
        
        // Load GitHub PR settings from database
        await loadGitHubPRSettings();
        
        // Load workflow configuration
        const workflowAppSettings = await loadWorkflowAppSettings();

        const workflowOpenaiEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.openaiEnabled,
            settings.workflowOpenaiEnabled || false
        );
        document.getElementById('workflowOpenaiEnabled').checked = workflowOpenaiEnabled;

        const workflowAnthropicEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.anthropicEnabled,
            settings.workflowAnthropicEnabled || false
        );
        document.getElementById('workflowAnthropicEnabled').checked = workflowAnthropicEnabled;

        const workflowGeminiEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.geminiEnabled,
            settings.workflowGeminiEnabled || false
        );
        document.getElementById('workflowGeminiEnabled').checked = workflowGeminiEnabled;
        // Keep element hidden until Gemini workflow support ships
        const geminiProviderRow = document.getElementById('workflowGeminiEnabled')?.closest('div');
        if (geminiProviderRow) {
            geminiProviderRow.style.display = 'none';
        }

        const workflowLmstudioEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.lmstudioEnabled,
            settings.workflowLmstudioEnabled || false
        );
        document.getElementById('workflowLmstudioEnabled').checked = workflowLmstudioEnabled;
        const proceedWithoutLmstudio = String(workflowAppSettings.PROCEED_WITHOUT_LMSTUDIO || '').trim() !== '';
        window.__proceedWithoutLmstudio = proceedWithoutLmstudio;
        if (proceedWithoutLmstudio) {
            const row = document.getElementById('workflowLmstudioRow');
            if (row) {
                row.classList.add('opacity-50', 'pointer-events-none');
                row.title = 'Disabled: you chose to proceed without LMStudio at startup.';
            }
            const cb = document.getElementById('workflowLmstudioEnabled');
            if (cb) cb.disabled = true;
            const note = document.getElementById('workflowLmstudioProceedNote');
            if (note) {
                note.textContent = '(disabled: proceeded without LMStudio at startup)';
                note.classList.remove('hidden');
            }
        }

        const workflowOpenaiApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.openaiApiKey,
            settings.workflowOpenaiApiKey || ''
        );
        document.getElementById('workflowOpenaiApiKey').value = workflowOpenaiApiKey;

        const workflowAnthropicApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.anthropicApiKey,
            settings.workflowAnthropicApiKey || ''
        );
        document.getElementById('workflowAnthropicApiKey').value = workflowAnthropicApiKey;

        const workflowGeminiApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.geminiApiKey,
            settings.workflowGeminiApiKey || ''
        );
        document.getElementById('workflowGeminiApiKey').value = workflowGeminiApiKey;

        // Update workflow API key visibility
        updateWorkflowApiKeyVisibility();
    }
    
    // Load Langfuse settings from database (with localStorage fallback)
    async function loadLangfuseSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        
        // Langfuse Public Key - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_PUBLIC_KEY');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfusePublicKey').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfusePublicKey').value = settings.langfusePublicKey || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_PUBLIC_KEY from database:', error);
            document.getElementById('langfusePublicKey').value = settings.langfusePublicKey || '';
        }
        
        // Langfuse Secret Key - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_SECRET_KEY');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseSecretKey').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfuseSecretKey').value = settings.langfuseSecretKey || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_SECRET_KEY from database:', error);
            document.getElementById('langfuseSecretKey').value = settings.langfuseSecretKey || '';
        }
        
        // Langfuse Host - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_HOST');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseHost').value = data.value;
            } else {
                // Fallback to localStorage or default
                document.getElementById('langfuseHost').value = settings.langfuseHost || 'https://cloud.langfuse.com';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_HOST from database:', error);
            document.getElementById('langfuseHost').value = settings.langfuseHost || 'https://cloud.langfuse.com';
        }
        
        // Langfuse Project ID - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_PROJECT_ID');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseProjectId').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfuseProjectId').value = settings.langfuseProjectId || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_PROJECT_ID from database:', error);
            document.getElementById('langfuseProjectId').value = settings.langfuseProjectId || '';
        }
    }
    
    async function loadWorkflowAppSettings() {
        try {
            const response = await fetch('/api/settings');
            if (!response.ok) {
                console.warn('Unable to fetch workflow settings from server', response.status);
                return {};
            }
            const data = await response.json();
            return data.settings || {};
        } catch (error) {
            console.warn('Error loading workflow settings from server', error);
            return {};
        }
    }

    function parseWorkflowBooleanSetting(settings, key, fallback) {
        const rawValue = settings[key];
        if (rawValue === undefined || rawValue === null) {
            return fallback;
        }
        return String(rawValue).toLowerCase() === 'true';
    }

    function parseWorkflowStringSetting(settings, key, fallback) {
        const rawValue = settings[key];
        if (rawValue === undefined || rawValue === null) {
            return fallback;
        }
        return String(rawValue);
    }

    async function persistWorkflowAppSettings(payload) {
        try {
            const response = await fetch('/api/settings/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ settings: payload })
            });

            if (!response.ok) {
                const detail = await response.text();
                console.error('Failed to save workflow settings', response.status, detail);
                return;
            }

            const result = await response.json();
            if (!result.success) {
                console.warn('Workflow settings save returned unsuccessful response', result);
            }
        } catch (error) {
            console.error('Error saving workflow settings to server', error);
        }
    }



    // Load backup settings
    function loadBackupSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const backupSettings = settings.backupSettings || {};
        
        // Set backup schedule
        document.getElementById('backupTime').value = backupSettings.backupTime || '02:00';
        document.getElementById('cleanupTime').value = backupSettings.cleanupTime || '03:00';
        
        // Set retention policy
        document.getElementById('dailyRetention').value = backupSettings.dailyRetention || 7;
        document.getElementById('weeklyRetention').value = backupSettings.weeklyRetention || 4;
        document.getElementById('monthlyRetention').value = backupSettings.monthlyRetention || 3;
        document.getElementById('maxSizeGb').value = backupSettings.maxSizeGb || 50;
        
        // Set backup components
        document.getElementById('backupDatabase').checked = backupSettings.backupDatabase !== false;
        document.getElementById('backupModels').checked = backupSettings.backupModels !== false;
        document.getElementById('backupConfig').checked = backupSettings.backupConfig !== false;
        document.getElementById('backupOutputs').checked = backupSettings.backupOutputs !== false;
        document.getElementById('backupLogs').checked = backupSettings.backupLogs !== false;
        document.getElementById('backupDockerVolumes').checked = backupSettings.backupDockerVolumes !== false;
        
        // Set backup settings
        document.getElementById('backupDirectory').value = backupSettings.backupDirectory || 'backups';
        document.getElementById('backupType').value = backupSettings.backupType || 'full';
        document.getElementById('enableCompression').checked = backupSettings.enableCompression !== false;
        document.getElementById('enableVerification').checked = backupSettings.enableVerification !== false;
    }
    
    // Save settings to localStorage
    async function saveSettings() {
        const settings = {
            langfusePublicKey: document.getElementById('langfusePublicKey').value.trim() || '',
            langfuseSecretKey: document.getElementById('langfuseSecretKey').value.trim() || '',
            langfuseHost: document.getElementById('langfuseHost').value.trim() || '',
            langfuseProjectId: document.getElementById('langfuseProjectId').value.trim() || '',
            workflowOpenaiEnabled: document.getElementById('workflowOpenaiEnabled').checked,
            workflowAnthropicEnabled: document.getElementById('workflowAnthropicEnabled').checked,
            workflowGeminiEnabled: document.getElementById('workflowGeminiEnabled').checked,
            workflowLmstudioEnabled: document.getElementById('workflowLmstudioEnabled').checked,
            workflowOpenaiApiKey: document.getElementById('workflowOpenaiApiKey').value.trim() || '',
            workflowAnthropicApiKey: document.getElementById('workflowAnthropicApiKey').value.trim() || '',
            workflowGeminiApiKey: document.getElementById('workflowGeminiApiKey').value.trim() || '',
            backupSettings: {
                backupTime: document.getElementById('backupTime').value,
                cleanupTime: document.getElementById('cleanupTime').value,
                dailyRetention: parseInt(document.getElementById('dailyRetention').value),
                weeklyRetention: parseInt(document.getElementById('weeklyRetention').value),
                monthlyRetention: parseInt(document.getElementById('monthlyRetention').value),
                maxSizeGb: parseInt(document.getElementById('maxSizeGb').value),
                backupDatabase: document.getElementById('backupDatabase').checked,
                backupModels: document.getElementById('backupModels').checked,
                backupConfig: document.getElementById('backupConfig').checked,
                backupOutputs: document.getElementById('backupOutputs').checked,
                backupLogs: document.getElementById('backupLogs').checked,
                backupDockerVolumes: document.getElementById('backupDockerVolumes').checked,
                backupDirectory: document.getElementById('backupDirectory').value,
                backupType: document.getElementById('backupType').value,
                enableCompression: document.getElementById('enableCompression').checked,
                enableVerification: document.getElementById('enableVerification').checked
            }
        };

        localStorage.setItem('ctiScraperSettings', JSON.stringify(settings));

        const lmstudioEnabledForSave = window.__proceedWithoutLmstudio ? false : settings.workflowLmstudioEnabled;
        const workflowSettingsPayload = {
            [WORKFLOW_PROVIDER_SETTING_KEYS.openaiEnabled]: settings.workflowOpenaiEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.anthropicEnabled]: settings.workflowAnthropicEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.geminiEnabled]: settings.workflowGeminiEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.lmstudioEnabled]: lmstudioEnabledForSave ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.openaiApiKey]: settings.workflowOpenaiApiKey,
            [WORKFLOW_PROVIDER_SETTING_KEYS.anthropicApiKey]: settings.workflowAnthropicApiKey,
            [WORKFLOW_PROVIDER_SETTING_KEYS.geminiApiKey]: settings.workflowGeminiApiKey
        };
        await persistWorkflowAppSettings(workflowSettingsPayload);

        // Save GitHub PR settings to backend API
        try {
            const githubPRSettings = [
                { key: 'GITHUB_TOKEN', value: document.getElementById('githubToken').value.trim() },
                { key: 'SIGMA_REPO_PATH', value: document.getElementById('sigmaRepoPath').value.trim() },
                { key: 'GITHUB_REPO', value: document.getElementById('githubRepo').value.trim() },
                { key: 'GIT_NAME', value: document.getElementById('gitUserName').value.trim() },
                { key: 'GIT_EMAIL', value: document.getElementById('gitUserEmail').value.trim() }
            ];
            
            for (const setting of githubPRSettings) {
                if (setting.value) {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            key: setting.key,
                            value: setting.value
                        })
                    });
                } else {
                    // Delete if empty (revert to env var)
                    await fetch(`/api/settings/${setting.key}`, {
                        method: 'DELETE'
                    });
                }
            }
        } catch (error) {
            console.error('‚ùå Error saving GitHub PR settings:', error);
        }
        
        // Save Langfuse keys to backend API
        try {
            const langfuseSettings = [
                { key: 'LANGFUSE_PUBLIC_KEY', value: document.getElementById('langfusePublicKey').value.trim() },
                { key: 'LANGFUSE_SECRET_KEY', value: document.getElementById('langfuseSecretKey').value.trim() },
                { key: 'LANGFUSE_HOST', value: document.getElementById('langfuseHost').value.trim() },
                { key: 'LANGFUSE_PROJECT_ID', value: document.getElementById('langfuseProjectId').value.trim() }
            ];
            
            for (const setting of langfuseSettings) {
                if (setting.value) {
                    // Save non-empty value to database
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                        body: JSON.stringify(setting)
                });
                } else {
                    // Delete empty value from database (revert to environment variable)
                    await fetch(`/api/settings/${setting.key}`, {
                        method: 'DELETE'
                    });
                }
            }
            console.log('‚úÖ Langfuse settings saved to database');
        } catch (error) {
            console.error('‚ùå Error saving Langfuse settings:', error);
        }

        showSuccessNotification();
    }
    
    
    // Test Langfuse connection
    async function testLangfuseConnection() {
        const statusElement = document.getElementById('langfuseTestStatus');
        const testButton = document.getElementById('testLangfuseConnection');
        
        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'üß™ Testing...';
        statusElement.textContent = '‚è≥ Testing Langfuse connection...';
        statusElement.className = 'ml-3 text-sm text-gray-600 dark:text-gray-400';
        
        try {
            const response = await fetch('/api/test-langfuse-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.valid) {
                    statusElement.textContent = `‚úÖ ${result.message}`;
                    statusElement.className = 'ml-3 text-sm text-green-600 dark:text-green-400';
                } else {
                    statusElement.textContent = `‚ùå ${result.message}`;
                    statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
                }
            } else {
                const error = await response.json();
                statusElement.textContent = `‚ùå ${error.detail || 'Connection test failed'}`;
                statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
            }
        } catch (error) {
            statusElement.textContent = '‚ùå Network error - please try again';
            statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
        } finally {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = 'üß™ Test Langfuse Connection';
        }
    }
    

    
    // Toggle Langfuse Public Key visibility
    function toggleLangfusePublicKeyVisibility() {
        const input = document.getElementById('langfusePublicKey');
        const button = document.getElementById('toggleLangfusePublicKey');
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }
    
    // Toggle Langfuse Secret Key visibility
    function toggleLangfuseSecretKeyVisibility() {
        const input = document.getElementById('langfuseSecretKey');
        const button = document.getElementById('toggleLangfuseSecretKey');
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }
    
    // Toggle GitHub Token visibility
    function toggleGithubTokenVisibility() {
        const input = document.getElementById('githubToken');
        const button = document.getElementById('toggleGithubToken');
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }
    
    // Load GitHub PR settings from database (with localStorage fallback)
    async function loadGitHubPRSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        
        // GitHub Token - check database first
        try {
            const response = await fetch('/api/settings/GITHUB_TOKEN');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('githubToken').value = data.value;
            } else {
                // Fallback to localStorage or env default
                document.getElementById('githubToken').value = settings.githubToken || '';
            }
        } catch (error) {
            console.log('Could not fetch GITHUB_TOKEN from database:', error);
            document.getElementById('githubToken').value = settings.githubToken || '';
        }
        
        // SIGMA Repo Path - check database first
        try {
            const response = await fetch('/api/settings/SIGMA_REPO_PATH');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('sigmaRepoPath').value = data.value;
            } else {
                // Fallback to localStorage or default
                document.getElementById('sigmaRepoPath').value = settings.sigmaRepoPath || 'huntable-sigma-repo';
            }
        } catch (error) {
            console.log('Could not fetch SIGMA_REPO_PATH from database:', error);
            document.getElementById('sigmaRepoPath').value = settings.sigmaRepoPath || 'huntable-sigma-repo';
        }
        
        // GitHub Repo - check database first
        try {
            const response = await fetch('/api/settings/GITHUB_REPO');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('githubRepo').value = data.value;
            } else {
                // Fallback to localStorage or default (blank)
                document.getElementById('githubRepo').value = settings.githubRepo || '';
            }
        } catch (error) {
            console.log('Could not fetch GITHUB_REPO from database:', error);
            document.getElementById('githubRepo').value = settings.githubRepo || '';
        }
        
        // Git User Name - check database first
        try {
            const response = await fetch('/api/settings/GIT_NAME');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('gitUserName').value = data.value;
            } else {
                document.getElementById('gitUserName').value = settings.gitUserName || 'Huntable CTI Studio';
            }
        } catch (error) {
            console.log('Could not fetch GIT_NAME from database:', error);
            document.getElementById('gitUserName').value = settings.gitUserName || 'Huntable CTI Studio';
        }
        
        // Git User Email - check database first
        try {
            const response = await fetch('/api/settings/GIT_EMAIL');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('gitUserEmail').value = data.value;
            } else {
                document.getElementById('gitUserEmail').value = settings.gitUserEmail || 'cti-studio@huntable.local';
            }
        } catch (error) {
            console.log('Could not fetch GIT_EMAIL from database:', error);
            document.getElementById('gitUserEmail').value = settings.gitUserEmail || 'cti-studio@huntable.local';
        }
    }
    
    // Test GitHub connection
    async function testGitHubConnection() {
        const statusElement = document.getElementById('githubTestStatus');
        const testButton = document.getElementById('testGitHubConnection');
        const token = document.getElementById('githubToken').value.trim();
        const repo = document.getElementById('githubRepo').value.trim();
        
        if (!token) {
            statusElement.textContent = 'Please enter a GitHub token first';
            statusElement.className = 'text-sm text-red-600';
            return;
        }
        
        if (!repo || !repo.includes('/')) {
            statusElement.textContent = 'Please enter a valid repository (owner/repo)';
            statusElement.className = 'text-sm text-red-600';
            return;
        }
        
        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = 'Testing connection...';
        statusElement.className = 'text-sm text-gray-600';
        
        try {
            // Test by fetching repo info
            const [owner, repoName] = repo.split('/');
            const response = await fetch(`https://api.github.com/repos/${owner}/${repoName}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                statusElement.textContent = '‚úÖ Connection successful!';
                statusElement.className = 'text-sm text-green-600';
            } else if (response.status === 401) {
                statusElement.textContent = '‚ùå Invalid token or insufficient permissions';
                statusElement.className = 'text-sm text-red-600';
            } else if (response.status === 404) {
                statusElement.textContent = '‚ùå Repository not found or no access';
                statusElement.className = 'text-sm text-red-600';
            } else {
                statusElement.textContent = `‚ùå Error: ${response.status} ${response.statusText}`;
                statusElement.className = 'text-sm text-red-600';
            }
        } catch (error) {
            statusElement.textContent = '‚ùå Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        } finally {
            testButton.disabled = false;
            testButton.textContent = 'üß™ Test GitHub Connection';
        }
    }
    
    // Toggle functions
    function setToggleState(toggleId, enabled) {
        const toggle = document.getElementById(toggleId);
        const span = toggle.querySelector('span:not(.sr-only)');
        
        if (enabled) {
            toggle.classList.add('bg-blue-600');
            toggle.classList.remove('bg-gray-200');
            span.classList.add('translate-x-5');
            span.classList.remove('translate-x-1');
            toggle.setAttribute('aria-checked', 'true');
        } else {
            toggle.classList.remove('bg-blue-600');
            toggle.classList.add('bg-gray-200');
            span.classList.remove('translate-x-5');
            span.classList.add('translate-x-1');
            toggle.setAttribute('aria-checked', 'false');
        }
    }
    
    function getToggleState(toggleId) {
        const toggle = document.getElementById(toggleId);
        return toggle.getAttribute('aria-checked') === 'true';
    }
    
    function toggleSwitch(toggleId) {
        const currentState = getToggleState(toggleId);
        setToggleState(toggleId, !currentState);
    }
    
    function cacheWorkflowProviderCatalog(catalog) {
        if (!catalog || typeof localStorage === 'undefined') return;
        try {
            localStorage.setItem('providerModelCatalog', JSON.stringify({
                data: catalog,
                updatedAt: Date.now()
            }));
        } catch (error) {
            console.warn('Failed to cache provider catalog', error);
        }
    }

    function describeModelUpdate(result) {
        if (!result || !Array.isArray(result.models) || result.models.length === 0) {
            return '';
        }
        const count = result.models.length;
        return ` (updated ${count} model${count === 1 ? '' : 's'})`;
    }

    // Update workflow API key sections visibility based on checkbox selections
    function updateWorkflowApiKeyVisibility() {
        const openaiEnabled = document.getElementById('workflowOpenaiEnabled').checked;
        const anthropicEnabled = document.getElementById('workflowAnthropicEnabled').checked;
        const geminiEnabled = document.getElementById('workflowGeminiEnabled')?.checked;
        const lmstudioEnabled = document.getElementById('workflowLmstudioEnabled').checked;

        const openaiSection = document.getElementById('workflowOpenaiApiKeySection');
        const anthropicSection = document.getElementById('workflowAnthropicApiKeySection');
        const geminiSection = document.getElementById('workflowGeminiApiKeySection');
        const lmstudioSection = document.getElementById('workflowLmstudioApiKeySection');

        // Show/hide sections based on checkbox state
        openaiSection.style.display = openaiEnabled ? 'block' : 'none';
        anthropicSection.style.display = anthropicEnabled ? 'block' : 'none';
        // Keep Gemini UI hidden even if enabled
        if (geminiSection) {
            geminiSection.style.display = 'none';
        }
        lmstudioSection.style.display = lmstudioEnabled ? 'block' : 'none';
    }

    // Test workflow API key for specific provider
    function testWorkflowApiKey(provider) {
        let apiKey = '';
        let statusElement;
        let testButton;
        let providerName = '';

        if (provider === 'openai') {
            apiKey = document.getElementById('workflowOpenaiApiKey').value;
            statusElement = document.getElementById('workflowOpenaiApiKeyStatus');
            testButton = document.getElementById('testWorkflowOpenaiApiKey');
            providerName = 'OpenAI';
        } else if (provider === 'anthropic') {
            apiKey = document.getElementById('workflowAnthropicApiKey').value;
            statusElement = document.getElementById('workflowAnthropicApiKeyStatus');
            testButton = document.getElementById('testWorkflowAnthropicApiKey');
            providerName = 'Anthropic';
        } else if (provider === 'gemini') {
            apiKey = document.getElementById('workflowGeminiApiKey').value;
            statusElement = document.getElementById('workflowGeminiApiKeyStatus');
            testButton = document.getElementById('testWorkflowGeminiApiKey');
            providerName = 'Gemini';
        } else if (provider === 'lmstudio') {
            statusElement = document.getElementById('workflowLmstudioApiKeyStatus');
            testButton = document.getElementById('testWorkflowLmstudioApiKey');
            providerName = 'LMStudio';
        }

        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = (provider === 'lmstudio' ? 'Getting models' : 'Testing API key') + '...';
        statusElement.className = 'text-sm text-gray-600';

        let endpoint = '';
        let requestBody = {};

        if (provider === 'openai') {
            endpoint = '/api/test-openai-key';
            requestBody = { api_key: apiKey };
        } else if (provider === 'anthropic') {
            endpoint = '/api/test-anthropic-key';
            requestBody = { api_key: apiKey };
        } else if (provider === 'gemini') {
            endpoint = '/api/test-gemini-key'; // Assuming this endpoint exists
            requestBody = { api_key: apiKey };
        } else if (provider === 'lmstudio') {
            endpoint = '/api/lmstudio-models';
            requestBody = {}; // No body needed for GET request
        }

        fetch(endpoint, {
            method: provider === 'lmstudio' ? 'GET' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: provider === 'lmstudio' ? null : JSON.stringify(requestBody)
        }).then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('API request failed');
            }
        }).then(function(result) {
            if (provider === 'lmstudio') {
                if (result.success && result.models && result.models.length > 0) {
                    statusElement.textContent = 'Found ' + result.models.length + ' model' + (result.models.length === 1 ? '' : 's');
                    statusElement.className = 'text-sm text-green-600';
                } else if (result.success && (!result.models || result.models.length === 0)) {
                    statusElement.textContent = 'LMStudio running but no models found';
                    statusElement.className = 'text-sm text-yellow-600';
                } else {
                    statusElement.textContent = result.message || 'Failed to get models';
                    statusElement.className = 'text-sm text-red-600';
                }
            } else {
                if (result.valid) {
                    statusElement.textContent = 'API key is valid' + describeModelUpdate(result);
                    statusElement.className = 'text-sm text-green-600';
                    if (result.catalog) {
                        cacheWorkflowProviderCatalog(result.catalog);
                    }
                } else {
                    statusElement.textContent = result.message;
                    statusElement.className = 'text-sm text-red-600';
                }
            }
        }).catch(function(error) {
            statusElement.textContent = 'Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        }).finally(function() {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = provider === 'lmstudio' ? 'Get Models' : 'Test';
        });
    }

    // Toggle workflow API key visibility functions
    function toggleWorkflowOpenaiApiKeyVisibility() {
        const input = document.getElementById('workflowOpenaiApiKey');
        const button = document.getElementById('toggleWorkflowOpenaiApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleWorkflowAnthropicApiKeyVisibility() {
        const input = document.getElementById('workflowAnthropicApiKey');
        const button = document.getElementById('toggleWorkflowAnthropicApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleWorkflowGeminiApiKeyVisibility() {
        const input = document.getElementById('workflowGeminiApiKey');
        const button = document.getElementById('toggleWorkflowGeminiApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }



    
    // Show success notification (slide in, then after 5s slide out and hide completely)
    function showSuccessNotification() {
        const notification = document.getElementById('successNotification');
        if (!notification) return;
        notification.classList.remove('hidden', 'translate-x-full');
        notification.setAttribute('aria-hidden', 'false');
        setTimeout(function() {
            notification.classList.add('translate-x-full');
            notification.addEventListener('transitionend', function onEnd() {
                notification.removeEventListener('transitionend', onEnd);
                notification.classList.add('hidden');
                notification.setAttribute('aria-hidden', 'true');
            }, { once: true });
        }, 5000);
    }

    function safeAddListener(id, event, handler) {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener(event, handler);
        }
        return element;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Register modals with ModalManager
        if (window.ModalManager) {
            const restoreBackupModal = document.getElementById('restoreBackupModal');
            if (restoreBackupModal) {
                window.ModalManager.register('restoreBackupModal', {
                    isDynamic: false,
                    hasInput: false
                });
            }
        }
        
        loadSettings().catch(function(err) {
            console.error('Error loading settings:', err);
        });

        // Workflow provider checkboxes
        ['workflowOpenaiEnabled', 'workflowAnthropicEnabled', 'workflowGeminiEnabled', 'workflowLmstudioEnabled'].forEach(function(id) {
            safeAddListener(id, 'change', function() {
                updateWorkflowApiKeyVisibility();
            });
        });

        // Workflow API key visibility toggles
        safeAddListener('toggleWorkflowOpenaiApiKey', 'click', function() {
            toggleWorkflowOpenaiApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowAnthropicApiKey', 'click', function() {
            toggleWorkflowAnthropicApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowGeminiApiKey', 'click', function() {
            toggleWorkflowGeminiApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowLmstudioApiKey', 'click', function() {
            toggleWorkflowLmstudioApiKeyVisibility();
        });

        // Langfuse visibility toggles and test button
        safeAddListener('toggleLangfusePublicKey', 'click', toggleLangfusePublicKeyVisibility);
        safeAddListener('toggleLangfuseSecretKey', 'click', toggleLangfuseSecretKeyVisibility);
        safeAddListener('testLangfuseConnection', 'click', testLangfuseConnection);
        
        // GitHub PR settings
        safeAddListener('toggleGithubToken', 'click', toggleGithubTokenVisibility);
        safeAddListener('testGitHubConnection', 'click', testGitHubConnection);

        // Test workflow API key buttons
        safeAddListener('testWorkflowOpenaiApiKey', 'click', function() {
            testWorkflowApiKey('openai');
        });

        safeAddListener('testWorkflowAnthropicApiKey', 'click', function() {
            testWorkflowApiKey('anthropic');
        });

        safeAddListener('testWorkflowGeminiApiKey', 'click', function() {
            testWorkflowApiKey('gemini');
        });

        safeAddListener('testWorkflowLmstudioApiKey', 'click', function() {
            testWorkflowApiKey('lmstudio');
        });

        // Backup configuration fields
        ['backupTime', 'cleanupTime', 'dailyRetention', 'weeklyRetention', 'monthlyRetention', 'maxSizeGb'].forEach(function(id) {
            safeAddListener(id, 'change', saveSettings);
        });

        // Backup checkboxes
        ['backupDatabase', 'backupModels', 'backupConfig', 'backupOutputs', 'backupLogs', 'backupDockerVolumes'].forEach(function(id) {
            var element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveSettings);
            }
        });

        // Save settings button
        document.getElementById('saveSettings').addEventListener('click', function() {
            saveSettings();
        });

        // Handle Enter key in input fields
        ['backupDirectory', 'dailyRetention', 'weeklyRetention', 'monthlyRetention', 'maxSizeGb'].forEach(function(id) {
            var element = document.getElementById(id);
            if (element) {
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSettings();
                    }
                });
            }
        });

        // Export annotations button
        var exportBtn = document.getElementById('exportAnnotationsBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                var progressDiv = document.getElementById('exportProgress');
                progressDiv.classList.remove('hidden');
                exportBtn.disabled = true;

                fetch('/api/export/annotations', {
                    method: 'GET'
                }).then(function(response) {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        return response.json().then(function(result) {
                            throw new Error(result.detail || 'Export failed');
                        });
                    }
                }).then(function(blob) {
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'annotations.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Annotations exported successfully', 'success');
                }).catch(function(error) {
                    console.error('Export error:', error);
                    showNotification('Failed to export annotations: ' + error.message, 'error');
                }).finally(function() {
                    // Hide progress
                    exportBtn.disabled = false;
                    progressDiv.classList.add('hidden');
                });
            });
        }

        // Backup action buttons
        var createBackupBtn = document.getElementById('createBackupBtn');
        if (createBackupBtn) {
            createBackupBtn.addEventListener('click', createBackup);
        }
        var listBackupsBtn = document.getElementById('listBackupsBtn');
        if (listBackupsBtn) {
            listBackupsBtn.addEventListener('click', listBackups);
        }
        var backupStatusBtn = document.getElementById('backupStatusBtn');
        if (backupStatusBtn) {
            backupStatusBtn.addEventListener('click', checkBackupStatus);
        }
        var restoreBackupBtn = document.getElementById('restoreBackupBtn');
        if (restoreBackupBtn) {
            restoreBackupBtn.addEventListener('click', openRestoreModal);
        }
        var restoreBackupFileInput = document.getElementById('restoreBackupFileInput');
        var restoreFromFileBtn = document.getElementById('restoreFromFileBtn');
        if (restoreBackupFileInput && restoreFromFileBtn) {
            restoreBackupFileInput.addEventListener('change', function() {
                restoreFromFileBtn.disabled = !restoreBackupFileInput.files || restoreBackupFileInput.files.length === 0;
            });
            restoreFromFileBtn.addEventListener('click', restoreFromBackupFile);
        }

        // Restore modal handlers
        var closeRestoreModal = document.getElementById('closeRestoreModal');
        if (closeRestoreModal) {
            closeRestoreModal.addEventListener('click', closeRestoreModalFunc);
        }
        var cancelRestore = document.getElementById('cancelRestore');
        if (cancelRestore) {
            cancelRestore.addEventListener('click', closeRestoreModalFunc);
        }
        var confirmRestore = document.getElementById('confirmRestore');
        if (confirmRestore) {
            confirmRestore.addEventListener('click', performRestore);
        }
    });

    async function createBackup() {
        const backupType = document.getElementById('backupType').value;
        const compress = document.getElementById('enableCompression').checked;
        const verify = document.getElementById('enableVerification').checked;

        try {
            const response = await fetch('/api/backup/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: backupType,
                    compress: compress,
                    verify: verify
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Backup created successfully: ${result.backup_name}`, 'success');
            } else {
                const error = await response.json();
                showNotification(`Backup failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Backup failed: ${error.message}`, 'error');
        }
    }

    async function listBackups() {
        try {
            const response = await fetch('/api/backup/list');
            if (response.ok) {
                const backups = await response.json();
                displayBackupList(backups);
            } else {
                showNotification('Failed to list backups', 'error');
            }
        } catch (error) {
            showNotification(`Failed to list backups: ${error.message}`, 'error');
        }
    }

    async function checkBackupStatus() {
        try {
            const response = await fetch('/api/backup/status');
            if (response.ok) {
                const status = await response.json();
                displayBackupStatus(status);
            } else {
                showNotification('Failed to get backup status', 'error');
            }
        } catch (error) {
            showNotification(`Failed to get backup status: ${error.message}`, 'error');
        }
    }

    function displayBackupList(backups) {
        const statusDisplay = document.getElementById('backupStatusDisplay');
        const statusContent = document.getElementById('backupStatusContent');

        let html = '<h4 class="font-semibold mb-2">Available Backups:</h4>';
        if (backups.length === 0) {
            html += '<p class="text-gray-500">No backups found.</p>';
        } else {
            html += '<div class="space-y-2">';
            backups.forEach(backup => {
                html += `
                    <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded">
                        <span class="font-mono text-sm">${backup.name}</span>
                        <span class="text-sm text-gray-500">${backup.size_mb} MB</span>
                    </div>
                `;
            });
            html += '</div>';
        }

        statusContent.innerHTML = html;
        statusDisplay.classList.remove('hidden');
    }

    function displayBackupStatus(status) {
        const statusDisplay = document.getElementById('backupStatusDisplay');
        const statusContent = document.getElementById('backupStatusContent');

        let html = '<h4 class="font-semibold mb-2">Backup Status:</h4>';
        html += `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span>Automated Backups:</span>
                    <span class="${status.automated ? 'text-green-600' : 'text-red-600'}">
                        ${status.automated ? '‚úÖ Enabled' : '‚ùå Disabled'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>Total Backups:</span>
                    <span>${status.total_backups}</span>
                </div>
                <div class="flex justify-between">
                    <span>Total Size:</span>
                    <span>${status.total_size_gb} GB</span>
                </div>
                <div class="flex justify-between">
                    <span>Last Backup:</span>
                    <span>${status.last_backup || 'Never'}</span>
                </div>
            </div>
        `;

        statusContent.innerHTML = html;
        statusDisplay.classList.remove('hidden');
    }

    // Restore backup functions
    var selectedBackupName = null;
    
    async function openRestoreModal() {
        const modal = document.getElementById('restoreBackupModal');
        const backupList = document.getElementById('restoreBackupList');
        const restoreError = document.getElementById('restoreError');
        const restoreProgress = document.getElementById('restoreProgress');
        const confirmRestoreBtn = document.getElementById('confirmRestore');
        
        // Reset state
        selectedBackupName = null;
        restoreError.classList.add('hidden');
        restoreProgress.classList.add('hidden');
        confirmRestoreBtn.disabled = true;
        backupList.innerHTML = '<div class="text-center text-gray-500 py-4">Loading backups...</div>';
        
        // Register and open with ModalManager
        if (window.ModalManager) {
            window.ModalManager.register('restoreBackupModal', {
                isDynamic: false,
                hasInput: false
            });
            window.ModalManager.open('restoreBackupModal');
        } else {
            modal.classList.remove('hidden');
        }
        
        // Load backups
        try {
            const response = await fetch('/api/backup/list');
            if (response.ok) {
                const backups = await response.json();
                if (backups.length === 0) {
                    backupList.innerHTML = '<div class="text-center text-gray-500 py-4">No backups available</div>';
                } else {
                    backupList.innerHTML = '';
                    backups.forEach(function(backup) {
                        const backupItem = document.createElement('div');
                        backupItem.className = 'p-3 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                        backupItem.dataset.backupName = backup.name;
                        backupItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-mono text-sm text-gray-200">${backup.name}</div>
                                    <div class="text-xs text-gray-400 mt-1">${backup.size_mb.toFixed(2)} MB</div>
                                </div>
                                <svg class="w-5 h-5 text-gray-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        `;
                        backupItem.addEventListener('click', function() {
                            // Remove selection from all items
                            backupList.querySelectorAll('.bg-gray-700').forEach(function(item) {
                                item.classList.remove('bg-gray-700');
                                item.querySelector('svg').classList.add('hidden');
                            });
                            // Select this item
                            backupItem.classList.add('bg-gray-700');
                            backupItem.querySelector('svg').classList.remove('hidden');
                            selectedBackupName = backup.name;
                            confirmRestoreBtn.disabled = false;
                        });
                        backupList.appendChild(backupItem);
                    });
                }
            } else {
                backupList.innerHTML = '<div class="text-center text-red-500 py-4">Failed to load backups</div>';
            }
        } catch (error) {
            backupList.innerHTML = '<div class="text-center text-red-500 py-4">Error loading backups: ' + error.message + '</div>';
        }
    }
    
    function closeRestoreModalFunc() {
        if (window.ModalManager) {
            window.ModalManager.close('restoreBackupModal');
        } else {
            const modal = document.getElementById('restoreBackupModal');
            modal.classList.add('hidden');
        }
        selectedBackupName = null;
    }
    
    async function performRestore() {
        if (!selectedBackupName) {
            showNotification('Please select a backup to restore', 'error');
            return;
        }
        
        const restoreError = document.getElementById('restoreError');
        const restoreProgress = document.getElementById('restoreProgress');
        const confirmRestoreBtn = document.getElementById('confirmRestore');
        const restoreForce = document.getElementById('restoreForce');
        
        // Confirm action
        const confirmed = confirm('‚ö†Ô∏è WARNING: This will restore the system from backup. This action may overwrite current data.\n\nAre you sure you want to continue?');
        if (!confirmed) {
            return;
        }
        
        const no_snapshot = restoreForce.checked;
        
        // Show progress
        restoreError.classList.add('hidden');
        restoreProgress.classList.remove('hidden');
        confirmRestoreBtn.disabled = true;
        
        try {
            const response = await fetch('/api/backup/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    backup_name: selectedBackupName,
                    backup_dir: document.getElementById('backupDirectory').value || 'backups',
                    force: true,  // Always true to skip interactive prompt (user already confirmed)
                    no_snapshot: no_snapshot
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification('Backup restored successfully', 'success');
                closeRestoreModalFunc();
            } else {
                const error = await response.json();
                restoreError.querySelector('p').textContent = error.detail || 'Restore failed';
                restoreError.classList.remove('hidden');
            }
        } catch (error) {
            restoreError.querySelector('p').textContent = 'Restore failed: ' + error.message;
            restoreError.classList.remove('hidden');
        } finally {
            restoreProgress.classList.add('hidden');
            confirmRestoreBtn.disabled = false;
        }
    }

    async function restoreFromBackupFile() {
        var fileInput = document.getElementById('restoreBackupFileInput');
        var btn = document.getElementById('restoreFromFileBtn');
        var progressEl = document.getElementById('restoreFromFileProgress');
        var errorEl = document.getElementById('restoreFromFileError');
        if (!fileInput.files || fileInput.files.length === 0) {
            showNotification('Please select a backup file', 'error');
            return;
        }
        var confirmed = confirm('‚ö†Ô∏è WARNING: This will restore the database from the selected file. Current data may be overwritten.\n\nAre you sure you want to continue?');
        if (!confirmed) return;

        errorEl.classList.add('hidden');
        progressEl.classList.remove('hidden');
        btn.disabled = true;
        try {
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);
            var response = await fetch('/api/backup/restore-from-file', {
                method: 'POST',
                body: formData
            });
            var data = response.ok ? await response.json() : await response.json().catch(function() { return { detail: 'Restore failed' }; });
            if (response.ok) {
                showNotification('Restore from file completed successfully', 'success');
                fileInput.value = '';
                btn.disabled = true;
            } else {
                errorEl.querySelector('p').textContent = data.detail || 'Restore failed';
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            errorEl.querySelector('p').textContent = 'Restore failed: ' + error.message;
            errorEl.classList.remove('hidden');
        } finally {
            progressEl.classList.add('hidden');
            btn.disabled = !fileInput.files || fileInput.files.length === 0;
        }
    }
</script>
{% endblock %}
