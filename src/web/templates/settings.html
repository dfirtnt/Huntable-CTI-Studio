{% extends "base.html" %}

{% block title %}Settings - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">‚öôÔ∏è Settings</h1>
        <p class="text-gray-600 dark:text-gray-400">Configure your Huntable CTI Studio preferences</p>
    </div>

    <!-- Settings Sections -->
    <div class="space-y-8">

        <!-- Backup Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleBackupConfig()">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">üíæ Backup Configuration</h2>
                <svg id="backupConfigChevron" class="w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            
            <div id="backupConfigContent" class="space-y-6 hidden">
                <!-- Backup Schedule -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üïê Schedule</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="backupTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Daily Backup Time
                            </label>
                            <input type="time" 
                                   id="backupTime" 
                                   value="02:00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Time for daily automated backups</p>
                        </div>
                        <div>
                            <label for="cleanupTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Weekly Cleanup Time
                            </label>
                            <input type="time" 
                                   id="cleanupTime" 
                                   value="03:00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Time for weekly cleanup (Sundays)</p>
                        </div>
                    </div>
                </div>

                <!-- Retention Policy -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üìä Retention Policy</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="dailyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Daily Backups
                            </label>
                            <input type="number" 
                                   id="dailyRetention" 
                                   value="7" 
                                   min="0" 
                                   max="30"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N daily backups</p>
                        </div>
                        <div>
                            <label for="weeklyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Weekly Backups
                            </label>
                            <input type="number" 
                                   id="weeklyRetention" 
                                   value="4" 
                                   min="0" 
                                   max="12"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N weekly backups</p>
                        </div>
                        <div>
                            <label for="monthlyRetention" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Monthly Backups
                            </label>
                            <input type="number" 
                                   id="monthlyRetention" 
                                   value="3" 
                                   min="0" 
                                   max="12"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Keep last N monthly backups</p>
                        </div>
                        <div>
                            <label for="maxSizeGb" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Max Size (GB)
                            </label>
                            <input type="number" 
                                   id="maxSizeGb" 
                                   value="50" 
                                   min="1" 
                                   max="1000"
                                   step="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Maximum total backup size</p>
                        </div>
                    </div>
                </div>

                <!-- Backup Components -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üß© Backup Components</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupDatabase" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupDatabase" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Database
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupModels" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupModels" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                ML Models
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupConfig" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupConfig" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Configuration
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupOutputs" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupOutputs" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Training Data
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupLogs" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupLogs" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Logs
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="backupDockerVolumes" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="backupDockerVolumes" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Docker Volumes
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Backup Settings -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">‚öôÔ∏è Backup Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="backupDirectory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Backup Directory
                            </label>
                            <input type="text" 
                                   id="backupDirectory" 
                                   value="backups"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Directory to store backups</p>
                        </div>
                        <div>
                            <label for="backupType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Backup Type
                            </label>
                            <select id="backupType" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="full">Full System</option>
                                <option value="database">Database Only</option>
                                <option value="files">Files Only</option>
                            </select>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Type of backup to create</p>
                        </div>
                    </div>
                    <div class="mt-4 space-y-3">
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="enableCompression" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enableCompression" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Enable Compression
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="enableVerification" 
                                   checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="enableVerification" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Enable Verification
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Backup Actions -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üöÄ Backup Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button id="createBackupBtn" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Create Backup Now
                        </button>
                        <button id="listBackupsBtn" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            List Backups
                        </button>
                        <button id="backupStatusBtn" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            Check Status
                        </button>
                    </div>
                </div>

                 <!-- Backup Status Display -->
                 <div id="backupStatusDisplay" class="hidden">
                     <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üìä Backup Status</h3>
                     <div id="backupStatusContent" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                         <!-- Status content will be populated here -->
                     </div>
                 </div>

                 <!-- Data Export -->
                 <div>
                     <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">üì§ Data Export</h3>
                     <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Download all text classifications (huntable/not huntable) as a CSV file</p>

                     <button id="exportAnnotationsBtn"
                             class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                         </svg>
                         Export Annotations CSV
                     </button>

                     <div id="exportProgress" class="hidden mt-2">
                         <div class="flex items-center">
                             <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                             <span class="text-sm text-gray-600">Generating CSV...</span>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

        <!-- AI Model Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleAIModelConfig()">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">ü§ñ AL/ML Assistant Configuration</h2>
                <svg id="aiModelConfigChevron" class="w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <div id="aiModelConfigContent" class="space-y-4 hidden">
                <!-- AI Model Selection -->
                <div>
                    <label for="aiModel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Preferred AI Model
                    </label>
                    <select id="aiModel" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="chatgpt">OpenAI ‚Üí GPT-4o-mini</option>
                        <option value="anthropic">Anthropic ‚Üí Claude Sonnet 4.5</option>
                        <option value="lmstudio">LMStudio (Local)</option>
                    </select>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Choose your preferred AI model for summaries and analysis</p>
                </div>

                <!-- OpenAI API Key Section (only shown when OpenAI is selected) -->
                <div id="aiOpenaiApiKeySection" style="display: none;">
                    <label for="aiOpenaiApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        OpenAI API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="aiOpenaiApiKey"
                               placeholder="sk-..."
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                id="toggleAiOpenaiApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Required for OpenAI-powered AI assistant</p>
                </div>

                <!-- Anthropic API Key Section (only shown when Anthropic is selected) -->
                <div id="aiAnthropicApiKeySection" style="display: none;">
                    <label for="aiAnthropicApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Anthropic API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="aiAnthropicApiKey"
                               placeholder="sk-ant-..."
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                id="toggleAiAnthropicApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Required for Anthropic-powered AI assistant</p>
                </div>

                <!-- OpenAI Test Section (only shown when OpenAI is selected) -->
                <div id="openaiTestSection" style="display: none;">
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Test OpenAI API key connection</p>
                        <button id="testAiOpenaiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Test API Key
                        </button>
                    </div>
                    <span id="aiOpenaiStatus" class="text-sm"></span>
                </div>

                <!-- Anthropic Test Section (only shown when Anthropic is selected) -->
                <div id="anthropicTestSection" style="display: none;">
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Test Anthropic API key connection</p>
                        <button id="testAiAnthropicKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Test API Key
                        </button>
                    </div>
                    <span id="aiAnthropicStatus" class="text-sm"></span>
                </div>

                <!-- LMStudio Model Selection (only shown when LMStudio is selected) -->
                <div id="lmstudioModelSection" style="display: none;">
                    <label for="lmstudioModel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        LMStudio Model
                    </label>
                    <select id="lmstudioModel"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Loading models...</option>
                    </select>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Select which LMStudio model to use for generation</p>
                        <button id="testAiLmstudioConnection"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Get Models
                        </button>
                    </div>
                    <span id="aiLmstudioStatus" class="text-sm"></span>
                </div>

                <!-- Temperature Setting -->
                <div>
                    <label for="aiTemperature" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        LLM Temperature
                    </label>
                    <div class="flex items-center space-x-4">
                        <input type="range" 
                               id="aiTemperature" 
                               min="0.0" 
                               max="1.0" 
                               step="0.1" 
                               value="0.3"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                        <span id="temperatureValue" class="text-sm font-medium text-gray-700 dark:text-gray-300 min-w-[3rem]">0.3</span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Controls randomness: <span class="font-medium">0.0</span> = deterministic, 
                        <span class="font-medium">1.0</span> = creative. Default: <span class="font-medium">0.3</span>
                    </p>
                </div>
                

            </div>
        </div>

        <!-- Agentic Workflow Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleAgenticWorkflowConfig()">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">ü§ñ Agentic Workflow Configuration</h2>
                <svg id="agenticWorkflowConfigChevron" class="w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <div id="agenticWorkflowConfigContent" class="space-y-4 hidden">
                <!-- Model Provider Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                        Model Providers
                    </label>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Select one or more AI providers for agentic workflows</p>

                    <div class="space-y-3">
                        <!-- OpenAI Provider -->
                        <div class="flex items-center">
                            <input type="checkbox"
                                   id="workflowOpenaiEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowOpenaiEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                OpenAI
                            </label>
                        </div>

                        <!-- Anthropic Provider -->
                        <div class="flex items-center">
                            <input type="checkbox"
                                   id="workflowAnthropicEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowAnthropicEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Anthropic
                            </label>
                        </div>

                        <!-- Gemini Provider (hidden until supported in workflow UI) -->
                        <div class="flex items-center hidden" aria-hidden="true">
                            <input type="checkbox"
                                   id="workflowGeminiEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowGeminiEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Google Gemini
                            </label>
                        </div>

                        <!-- LMStudio Provider -->
                        <div class="flex items-center">
                            <input type="checkbox"
                                   id="workflowLmstudioEnabled"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="workflowLmstudioEnabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                LMStudio (Local)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- OpenAI API Key Section -->
                <div id="workflowOpenaiApiKeySection" style="display: none;">
                    <label for="workflowOpenaiApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        OpenAI API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowOpenaiApiKey"
                               placeholder="sk-..."
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                id="toggleWorkflowOpenaiApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for OpenAI-powered agentic workflows</p>
                        <button id="testWorkflowOpenaiApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Test
                        </button>
                    </div>
                    <span id="workflowOpenaiApiKeyStatus" class="text-sm"></span>
                </div>

                <!-- Anthropic API Key Section -->
                <div id="workflowAnthropicApiKeySection" style="display: none;">
                    <label for="workflowAnthropicApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Anthropic API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowAnthropicApiKey"
                               placeholder="sk-ant-..."
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                id="toggleWorkflowAnthropicApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for Anthropic-powered agentic workflows</p>
                        <button id="testWorkflowAnthropicApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Test
                        </button>
                    </div>
                    <span id="workflowAnthropicApiKeyStatus" class="text-sm"></span>
                </div>

                <!-- Gemini API Key Section (hidden until supported in workflow UI) -->
                <div id="workflowGeminiApiKeySection" class="hidden" style="display: none;">
                    <label for="workflowGeminiApiKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Google Gemini API Key
                    </label>
                    <div class="relative">
                        <input type="password"
                               id="workflowGeminiApiKey"
                               placeholder="AIza..."
                               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <button type="button"
                                id="toggleWorkflowGeminiApiKey"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Required for Google Gemini-powered agentic workflows</p>
                        <button id="testWorkflowGeminiApiKey"
                                class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                            Test
                        </button>
                    </div>
                    <span id="workflowGeminiApiKeyStatus" class="text-sm"></span>
                </div>

                 <!-- LMStudio API Key Section -->
                 <div id="workflowLmstudioApiKeySection" style="display: none;">
                     <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                         LMStudio Configuration
                     </label>
                     <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">LMStudio runs locally and doesn't require API keys. Ensure LMStudio is running on the default port.</p>
                     <div class="flex items-center justify-between">
                         <p class="text-sm text-gray-500 dark:text-gray-400">Test connection to local LMStudio server</p>
                         <button id="testWorkflowLmstudioApiKey"
                                 class="inline-flex items-center px-3 py-1 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors rounded">
                             Get Models
                         </button>
                     </div>
                     <span id="workflowLmstudioApiKeyStatus" class="text-sm"></span>
                 </div>

                 <!-- Langfuse Configuration -->
                 <div id="langfuseApiKeySection" class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                     <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Langfuse Configuration</h3>

                     <!-- Langfuse Public Key -->
                     <div class="mb-4">
                         <label for="langfusePublicKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Public Key
                         </label>
                         <div class="relative">
                             <input type="password"
                                    id="langfusePublicKey"
                                    placeholder="pk-..."
                                    class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                             <button type="button"
                                     id="toggleLangfusePublicKey"
                                     class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                 <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                 </svg>
                             </button>
                         </div>
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Required for Langfuse observability and tracing</p>
                     </div>

                     <!-- Langfuse Secret Key -->
                     <div class="mb-4">
                         <label for="langfuseSecretKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Secret Key
                         </label>
                         <div class="relative">
                             <input type="password"
                                    id="langfuseSecretKey"
                                    placeholder="sk-..."
                                    class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                             <button type="button"
                                     id="toggleLangfuseSecretKey"
                                     class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                 <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                 </svg>
                             </button>
                         </div>
                     </div>

                     <!-- Langfuse Host -->
                     <div class="mb-4">
                         <label for="langfuseHost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Host URL
                         </label>
                         <input type="text"
                                id="langfuseHost"
                                placeholder="https://cloud.langfuse.com"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Optional: Defaults to https://cloud.langfuse.com</p>
                     </div>

                     <!-- Langfuse Project ID -->
                     <div class="mb-4">
                         <label for="langfuseProjectId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                             Langfuse Project ID
                         </label>
                         <input type="text"
                                id="langfuseProjectId"
                                placeholder="cmhk4f8nr02m9ad07cq29m3be"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Optional: Found in your Langfuse URL (e.g., https://us.cloud.langfuse.com/project/{project_id}/traces)</p>
                     </div>

                     <!-- Langfuse Test Button -->
                     <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                         <button id="testLangfuseConnection"
                                 class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                             üß™ Test Langfuse Connection
                         </button>
                         <span id="langfuseTestStatus" class="ml-3 text-sm"></span>
                     </div>
                 </div>
             </div>
        </div>




        <!-- Save Button -->
        <div class="flex justify-end">
            <button id="saveSettings" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                üíæ Save Settings
            </button>
        </div>
    </div>
</div>

<!-- Success Notification -->
<div id="successNotification" class="fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm bg-green-500 text-white transform translate-x-full transition-transform duration-300">
    <div class="flex items-center">
        <span class="mr-2">‚úÖ</span>
        <span>Settings saved successfully!</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const WORKFLOW_PROVIDER_SETTING_KEYS = {
        openaiEnabled: 'WORKFLOW_OPENAI_ENABLED',
        openaiApiKey: 'WORKFLOW_OPENAI_API_KEY',
        anthropicEnabled: 'WORKFLOW_ANTHROPIC_ENABLED',
        anthropicApiKey: 'WORKFLOW_ANTHROPIC_API_KEY',
        geminiEnabled: 'WORKFLOW_GEMINI_ENABLED',
        geminiApiKey: 'WORKFLOW_GEMINI_API_KEY',
        lmstudioEnabled: 'WORKFLOW_LMSTUDIO_ENABLED'
    };

    // Load settings from localStorage and database
    async function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        
        
        
        // Load Langfuse settings from database (priority over localStorage)
        await loadLangfuseSettings();
        
        // Set AI model
        const aiModel = settings.aiModel || 'chatgpt';
        document.getElementById('aiModel').value = aiModel;
        
        // Set AI temperature
        const aiTemperature = settings.aiTemperature || '0.3';
        document.getElementById('aiTemperature').value = aiTemperature;
        document.getElementById('temperatureValue').textContent = aiTemperature;

        // Load AI model API keys
        const aiOpenaiApiKey = settings.aiOpenaiApiKey || '';
        document.getElementById('aiOpenaiApiKey').value = aiOpenaiApiKey;

        const aiAnthropicApiKey = settings.aiAnthropicApiKey || '';
        document.getElementById('aiAnthropicApiKey').value = aiAnthropicApiKey;
        

        // Load backup configuration
        loadBackupSettings();
        
        // Load dynamic LMStudio models (fire and forget - don't block page load)
        loadLMStudioModels().catch(function(err) {
            console.error('Error loading LMStudio models:', err);
        });

        // Load workflow configuration
        const workflowAppSettings = await loadWorkflowAppSettings();

        const workflowOpenaiEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.openaiEnabled,
            settings.workflowOpenaiEnabled || false
        );
        document.getElementById('workflowOpenaiEnabled').checked = workflowOpenaiEnabled;

        const workflowAnthropicEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.anthropicEnabled,
            settings.workflowAnthropicEnabled || false
        );
        document.getElementById('workflowAnthropicEnabled').checked = workflowAnthropicEnabled;

        const workflowGeminiEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.geminiEnabled,
            settings.workflowGeminiEnabled || false
        );
        document.getElementById('workflowGeminiEnabled').checked = workflowGeminiEnabled;
        // Keep element hidden until Gemini workflow support ships
        const geminiProviderRow = document.getElementById('workflowGeminiEnabled')?.closest('div');
        if (geminiProviderRow) {
            geminiProviderRow.style.display = 'none';
        }

        const workflowLmstudioEnabled = parseWorkflowBooleanSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.lmstudioEnabled,
            settings.workflowLmstudioEnabled || false
        );
        document.getElementById('workflowLmstudioEnabled').checked = workflowLmstudioEnabled;

        const workflowOpenaiApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.openaiApiKey,
            settings.workflowOpenaiApiKey || ''
        );
        document.getElementById('workflowOpenaiApiKey').value = workflowOpenaiApiKey;

        const workflowAnthropicApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.anthropicApiKey,
            settings.workflowAnthropicApiKey || ''
        );
        document.getElementById('workflowAnthropicApiKey').value = workflowAnthropicApiKey;

        const workflowGeminiApiKey = parseWorkflowStringSetting(
            workflowAppSettings,
            WORKFLOW_PROVIDER_SETTING_KEYS.geminiApiKey,
            settings.workflowGeminiApiKey || ''
        );
        document.getElementById('workflowGeminiApiKey').value = workflowGeminiApiKey;

        // Update workflow API key visibility
        updateWorkflowApiKeyVisibility();
    }
    
    // Load Langfuse settings from database (with localStorage fallback)
    async function loadLangfuseSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        
        // Langfuse Public Key - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_PUBLIC_KEY');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfusePublicKey').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfusePublicKey').value = settings.langfusePublicKey || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_PUBLIC_KEY from database:', error);
            document.getElementById('langfusePublicKey').value = settings.langfusePublicKey || '';
        }
        
        // Langfuse Secret Key - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_SECRET_KEY');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseSecretKey').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfuseSecretKey').value = settings.langfuseSecretKey || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_SECRET_KEY from database:', error);
            document.getElementById('langfuseSecretKey').value = settings.langfuseSecretKey || '';
        }
        
        // Langfuse Host - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_HOST');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseHost').value = data.value;
            } else {
                // Fallback to localStorage or default
                document.getElementById('langfuseHost').value = settings.langfuseHost || 'https://cloud.langfuse.com';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_HOST from database:', error);
            document.getElementById('langfuseHost').value = settings.langfuseHost || 'https://cloud.langfuse.com';
        }
        
        // Langfuse Project ID - check database first
        try {
            const response = await fetch('/api/settings/LANGFUSE_PROJECT_ID');
            const data = await response.json();
            if (data.success && data.exists && data.value) {
                document.getElementById('langfuseProjectId').value = data.value;
            } else {
                // Fallback to localStorage
                document.getElementById('langfuseProjectId').value = settings.langfuseProjectId || '';
            }
        } catch (error) {
            console.log('Could not fetch LANGFUSE_PROJECT_ID from database:', error);
            document.getElementById('langfuseProjectId').value = settings.langfuseProjectId || '';
        }
    }
    
    async function loadWorkflowAppSettings() {
        try {
            const response = await fetch('/api/settings');
            if (!response.ok) {
                console.warn('Unable to fetch workflow settings from server', response.status);
                return {};
            }
            const data = await response.json();
            return data.settings || {};
        } catch (error) {
            console.warn('Error loading workflow settings from server', error);
            return {};
        }
    }

    function parseWorkflowBooleanSetting(settings, key, fallback) {
        const rawValue = settings[key];
        if (rawValue === undefined || rawValue === null) {
            return fallback;
        }
        return String(rawValue).toLowerCase() === 'true';
    }

    function parseWorkflowStringSetting(settings, key, fallback) {
        const rawValue = settings[key];
        if (rawValue === undefined || rawValue === null) {
            return fallback;
        }
        return String(rawValue);
    }

    async function persistWorkflowAppSettings(payload) {
        try {
            const response = await fetch('/api/settings/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ settings: payload })
            });

            if (!response.ok) {
                const detail = await response.text();
                console.error('Failed to save workflow settings', response.status, detail);
                return;
            }

            const result = await response.json();
            if (!result.success) {
                console.warn('Workflow settings save returned unsuccessful response', result);
            }
        } catch (error) {
            console.error('Error saving workflow settings to server', error);
        }
    }



    // Update AI model test sections visibility
    function updateAiModelTestSections() {
        const aiModel = document.getElementById('aiModel').value;
        const openaiApiKeySection = document.getElementById('aiOpenaiApiKeySection');
        const anthropicApiKeySection = document.getElementById('aiAnthropicApiKeySection');
        const openaiTestSection = document.getElementById('openaiTestSection');
        const anthropicTestSection = document.getElementById('anthropicTestSection');

        // Hide all sections first
        if (openaiApiKeySection) openaiApiKeySection.style.display = 'none';
        if (anthropicApiKeySection) anthropicApiKeySection.style.display = 'none';
        if (openaiTestSection) openaiTestSection.style.display = 'none';
        if (anthropicTestSection) anthropicTestSection.style.display = 'none';

        // Show the relevant sections
        if (aiModel === 'chatgpt') {
            if (openaiApiKeySection) openaiApiKeySection.style.display = 'block';
            if (openaiTestSection) openaiTestSection.style.display = 'block';
        } else if (aiModel === 'anthropic') {
            if (anthropicApiKeySection) anthropicApiKeySection.style.display = 'block';
            if (anthropicTestSection) anthropicTestSection.style.display = 'block';
        }

        // Show/hide LMStudio model selection dropdown
        const lmstudioModelSection = document.getElementById('lmstudioModelSection');
        if (lmstudioModelSection) {
            lmstudioModelSection.style.display = aiModel === 'lmstudio' ? 'block' : 'none';
        }
    }
    
    // Load LMStudio models dynamically
    async function loadLMStudioModels() {
        try {
            const response = await fetch('/api/lmstudio-models');
            const data = await response.json();

            if (data.success && data.models.length > 0) {
                // Populate the LMStudio model dropdown
                const lmstudioModelSelect = document.getElementById('lmstudioModel');
                lmstudioModelSelect.innerHTML = ''; // Clear loading option

                // Get current saved model from database
                let savedModel = null;
                try {
                    const settingsResponse = await fetch('/api/settings/lmstudio_model');
                    const settingsData = await settingsResponse.json();
                    if (settingsData.success && settingsData.exists) {
                        savedModel = settingsData.value;
                    }
                } catch (error) {
                    console.log('Could not fetch saved LMStudio model:', error);
                }

                // Sort models alphabetically
                const sortedModels = [...data.models].sort();

                sortedModels.forEach(function(model, index) {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    // Select the saved model or first model if no saved preference
                    if ((savedModel && model === savedModel) || (!savedModel && index === 0)) {
                        option.selected = true;
                    }
                    lmstudioModelSelect.appendChild(option);
                });

                // Update the main dropdown to show it's LMStudio (keep it simple)
                const select = document.getElementById('aiModel');
                const lmstudioOption = select.querySelector('option[value="lmstudio"]');
                if (lmstudioOption) {
                    // Just show "LMStudio" - the specific model is shown in the dropdown below
                    lmstudioOption.textContent = `LMStudio (Local)`;
                }
            } else {
                // Fallback to default text if no models found
                const lmstudioModelSelect = document.getElementById('lmstudioModel');
                lmstudioModelSelect.innerHTML = '<option value="">No models available</option>';

                const select = document.getElementById('aiModel');
                const lmstudioOption = select.querySelector('option[value="lmstudio"]');
                if (lmstudioOption) {
                    lmstudioOption.textContent = 'LMStudio ‚Üí Local';
                }
            }
        } catch (error) {
            console.log('Could not load LMStudio models:', error);
            const lmstudioModelSelect = document.getElementById('lmstudioModel');
            lmstudioModelSelect.innerHTML = '<option value="">Error loading models</option>';
        }
    }
    
    // Load backup settings
    function loadBackupSettings() {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        const backupSettings = settings.backupSettings || {};
        
        // Set backup schedule
        document.getElementById('backupTime').value = backupSettings.backupTime || '02:00';
        document.getElementById('cleanupTime').value = backupSettings.cleanupTime || '03:00';
        
        // Set retention policy
        document.getElementById('dailyRetention').value = backupSettings.dailyRetention || 7;
        document.getElementById('weeklyRetention').value = backupSettings.weeklyRetention || 4;
        document.getElementById('monthlyRetention').value = backupSettings.monthlyRetention || 3;
        document.getElementById('maxSizeGb').value = backupSettings.maxSizeGb || 50;
        
        // Set backup components
        document.getElementById('backupDatabase').checked = backupSettings.backupDatabase !== false;
        document.getElementById('backupModels').checked = backupSettings.backupModels !== false;
        document.getElementById('backupConfig').checked = backupSettings.backupConfig !== false;
        document.getElementById('backupOutputs').checked = backupSettings.backupOutputs !== false;
        document.getElementById('backupLogs').checked = backupSettings.backupLogs !== false;
        document.getElementById('backupDockerVolumes').checked = backupSettings.backupDockerVolumes !== false;
        
        // Set backup settings
        document.getElementById('backupDirectory').value = backupSettings.backupDirectory || 'backups';
        document.getElementById('backupType').value = backupSettings.backupType || 'full';
        document.getElementById('enableCompression').checked = backupSettings.enableCompression !== false;
        document.getElementById('enableVerification').checked = backupSettings.enableVerification !== false;
    }
    
    // Save settings to localStorage
    async function saveSettings() {
        // Get values from form inputs
        const aiModelInput = document.getElementById('aiModel').value;
        const lmstudioModelInput = document.getElementById('lmstudioModel') ? document.getElementById('lmstudioModel').value : null;

        // DEBUG: Log what we're saving
        console.log('üíæ Saving settings:', {
            aiModel: aiModelInput,
            lmstudioModel: lmstudioModelInput
        });

        const settings = {
            langfusePublicKey: document.getElementById('langfusePublicKey').value.trim() || '',
            langfuseSecretKey: document.getElementById('langfuseSecretKey').value.trim() || '',
            langfuseHost: document.getElementById('langfuseHost').value.trim() || '',
            langfuseProjectId: document.getElementById('langfuseProjectId').value.trim() || '',
            aiModel: aiModelInput,
            aiTemperature: document.getElementById('aiTemperature').value,
            aiOpenaiApiKey: document.getElementById('aiOpenaiApiKey').value.trim() || '',
            aiAnthropicApiKey: document.getElementById('aiAnthropicApiKey').value.trim() || '',
            workflowOpenaiEnabled: document.getElementById('workflowOpenaiEnabled').checked,
            workflowAnthropicEnabled: document.getElementById('workflowAnthropicEnabled').checked,
            workflowGeminiEnabled: document.getElementById('workflowGeminiEnabled').checked,
            workflowLmstudioEnabled: document.getElementById('workflowLmstudioEnabled').checked,
            workflowOpenaiApiKey: document.getElementById('workflowOpenaiApiKey').value.trim() || '',
            workflowAnthropicApiKey: document.getElementById('workflowAnthropicApiKey').value.trim() || '',
            workflowGeminiApiKey: document.getElementById('workflowGeminiApiKey').value.trim() || '',
            backupSettings: {
                backupTime: document.getElementById('backupTime').value,
                cleanupTime: document.getElementById('cleanupTime').value,
                dailyRetention: parseInt(document.getElementById('dailyRetention').value),
                weeklyRetention: parseInt(document.getElementById('weeklyRetention').value),
                monthlyRetention: parseInt(document.getElementById('monthlyRetention').value),
                maxSizeGb: parseInt(document.getElementById('maxSizeGb').value),
                backupDatabase: document.getElementById('backupDatabase').checked,
                backupModels: document.getElementById('backupModels').checked,
                backupConfig: document.getElementById('backupConfig').checked,
                backupOutputs: document.getElementById('backupOutputs').checked,
                backupLogs: document.getElementById('backupLogs').checked,
                backupDockerVolumes: document.getElementById('backupDockerVolumes').checked,
                backupDirectory: document.getElementById('backupDirectory').value,
                backupType: document.getElementById('backupType').value,
                enableCompression: document.getElementById('enableCompression').checked,
                enableVerification: document.getElementById('enableVerification').checked
            }
        };

        localStorage.setItem('ctiScraperSettings', JSON.stringify(settings));

        const workflowSettingsPayload = {
            [WORKFLOW_PROVIDER_SETTING_KEYS.openaiEnabled]: settings.workflowOpenaiEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.anthropicEnabled]: settings.workflowAnthropicEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.geminiEnabled]: settings.workflowGeminiEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.lmstudioEnabled]: settings.workflowLmstudioEnabled ? 'true' : 'false',
            [WORKFLOW_PROVIDER_SETTING_KEYS.openaiApiKey]: settings.workflowOpenaiApiKey,
            [WORKFLOW_PROVIDER_SETTING_KEYS.anthropicApiKey]: settings.workflowAnthropicApiKey,
            [WORKFLOW_PROVIDER_SETTING_KEYS.geminiApiKey]: settings.workflowGeminiApiKey
        };
        await persistWorkflowAppSettings(workflowSettingsPayload);

        // Save Langfuse keys to backend API
        try {
            const langfuseSettings = [
                { key: 'LANGFUSE_PUBLIC_KEY', value: document.getElementById('langfusePublicKey').value.trim() },
                { key: 'LANGFUSE_SECRET_KEY', value: document.getElementById('langfuseSecretKey').value.trim() },
                { key: 'LANGFUSE_HOST', value: document.getElementById('langfuseHost').value.trim() },
                { key: 'LANGFUSE_PROJECT_ID', value: document.getElementById('langfuseProjectId').value.trim() }
            ];
            
            for (const setting of langfuseSettings) {
                if (setting.value) {
                    // Save non-empty value to database
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                        body: JSON.stringify(setting)
                });
                } else {
                    // Delete empty value from database (revert to environment variable)
                    await fetch(`/api/settings/${setting.key}`, {
                        method: 'DELETE'
                    });
                }
            }
            console.log('‚úÖ Langfuse settings saved to database');
        } catch (error) {
            console.error('‚ùå Error saving Langfuse settings:', error);
        }

        // Save LMStudio model to database (if selected and changed)
        if (aiModelInput === 'lmstudio' && lmstudioModelInput) {
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: 'lmstudio_model',
                        value: lmstudioModelInput
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ LMStudio model saved to database:', lmstudioModelInput);
                } else {
                    console.error('‚ùå Failed to save LMStudio model to database');
                }
            } catch (error) {
                console.error('‚ùå Error saving LMStudio model:', error);
            }
        }

        // DEBUG: Verify what was saved
        const saved = JSON.parse(localStorage.getItem('ctiScraperSettings'));
        console.log('‚úÖ Settings saved. Verification:', {
            aiModel: saved.aiModel
        });

        showSuccessNotification();
    }
    
    
    // Test Langfuse connection
    async function testLangfuseConnection() {
        const statusElement = document.getElementById('langfuseTestStatus');
        const testButton = document.getElementById('testLangfuseConnection');
        
        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'üß™ Testing...';
        statusElement.textContent = '‚è≥ Testing Langfuse connection...';
        statusElement.className = 'ml-3 text-sm text-gray-600 dark:text-gray-400';
        
        try {
            const response = await fetch('/api/test-langfuse-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.valid) {
                    statusElement.textContent = `‚úÖ ${result.message}`;
                    statusElement.className = 'ml-3 text-sm text-green-600 dark:text-green-400';
                } else {
                    statusElement.textContent = `‚ùå ${result.message}`;
                    statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
                }
            } else {
                const error = await response.json();
                statusElement.textContent = `‚ùå ${error.detail || 'Connection test failed'}`;
                statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
            }
        } catch (error) {
            statusElement.textContent = '‚ùå Network error - please try again';
            statusElement.className = 'ml-3 text-sm text-red-600 dark:text-red-400';
        } finally {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = 'üß™ Test Langfuse Connection';
        }
    }
    

    
    // Toggle Langfuse Public Key visibility
    function toggleLangfusePublicKeyVisibility() {
        const input = document.getElementById('langfusePublicKey');
        const button = document.getElementById('toggleLangfusePublicKey');
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }
    
    // Toggle Langfuse Secret Key visibility
    function toggleLangfuseSecretKeyVisibility() {
        const input = document.getElementById('langfuseSecretKey');
        const button = document.getElementById('toggleLangfuseSecretKey');
        const icon = button.querySelector('svg');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }
    
    // Toggle functions
    function setToggleState(toggleId, enabled) {
        const toggle = document.getElementById(toggleId);
        const span = toggle.querySelector('span:not(.sr-only)');
        
        if (enabled) {
            toggle.classList.add('bg-blue-600');
            toggle.classList.remove('bg-gray-200');
            span.classList.add('translate-x-5');
            span.classList.remove('translate-x-1');
            toggle.setAttribute('aria-checked', 'true');
        } else {
            toggle.classList.remove('bg-blue-600');
            toggle.classList.add('bg-gray-200');
            span.classList.remove('translate-x-5');
            span.classList.add('translate-x-1');
            toggle.setAttribute('aria-checked', 'false');
        }
    }
    
    function getToggleState(toggleId) {
        const toggle = document.getElementById(toggleId);
        return toggle.getAttribute('aria-checked') === 'true';
    }
    
    function toggleSwitch(toggleId) {
        const currentState = getToggleState(toggleId);
        setToggleState(toggleId, !currentState);
    }
    
    // Toggle backup configuration section
    function toggleBackupConfig() {
        const content = document.getElementById('backupConfigContent');
        const chevron = document.getElementById('backupConfigChevron');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Toggle AI model configuration section
    function toggleAIModelConfig() {
        const content = document.getElementById('aiModelConfigContent');
        const chevron = document.getElementById('aiModelConfigChevron');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Toggle agentic workflow configuration section
    function toggleAgenticWorkflowConfig() {
        const content = document.getElementById('agenticWorkflowConfigContent');
        const chevron = document.getElementById('agenticWorkflowConfigChevron');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    // Test AI model API keys
    function testAiOpenaiKey() {
        const statusElement = document.getElementById('aiOpenaiStatus');
        const testButton = document.getElementById('testAiOpenaiKey');
        const apiKey = document.getElementById('aiOpenaiApiKey').value;

        if (!apiKey) {
            statusElement.textContent = 'Please enter an OpenAI API key first';
            statusElement.className = 'text-sm text-red-600';
            return;
        }

        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = 'Testing API key...';
        statusElement.className = 'text-sm text-gray-600';

        fetch('/api/test-openai-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: apiKey
            })
        }).then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('API request failed');
            }
        }).then(function(result) {
            if (result.valid) {
                statusElement.textContent = 'API key is valid' + describeModelUpdate(result);
                statusElement.className = 'text-sm text-green-600';
                if (result.catalog) {
                    cacheWorkflowProviderCatalog(result.catalog);
                }
            } else {
                statusElement.textContent = result.message;
                statusElement.className = 'text-sm text-red-600';
            }
        }).catch(function(error) {
            statusElement.textContent = 'Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        }).finally(function() {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = 'Test API Key';
        });
    }

    function testAiAnthropicKey() {
        const statusElement = document.getElementById('aiAnthropicStatus');
        const testButton = document.getElementById('testAiAnthropicKey');
        const apiKey = document.getElementById('aiAnthropicApiKey').value;

        if (!apiKey) {
            statusElement.textContent = 'Please enter an Anthropic API key first';
            statusElement.className = 'text-sm text-red-600';
            return;
        }

        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = 'Testing API key...';
        statusElement.className = 'text-sm text-gray-600';

        fetch('/api/test-anthropic-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: apiKey
            })
        }).then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('API request failed');
            }
        }).then(function(result) {
            if (result.valid) {
                statusElement.textContent = 'API key is valid' + describeModelUpdate(result);
                statusElement.className = 'text-sm text-green-600';
                if (result.catalog) {
                    cacheWorkflowProviderCatalog(result.catalog);
                }
            } else {
                statusElement.textContent = result.message;
                statusElement.className = 'text-sm text-red-600';
            }
        }).catch(function(error) {
            statusElement.textContent = 'Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        }).finally(function() {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = 'Test API Key';
        });
    }

    function testAiLmstudioConnection() {
        const statusElement = document.getElementById('aiLmstudioStatus');
        const testButton = document.getElementById('testAiLmstudioConnection');

        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = 'Getting models...';
        statusElement.className = 'text-sm text-gray-600';

        fetch('/api/lmstudio-models').then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('API request failed');
            }
        }).then(function(result) {
            if (result.success && result.models && result.models.length > 0) {
                statusElement.textContent = 'Found ' + result.models.length + ' model' + (result.models.length === 1 ? '' : 's');
                statusElement.className = 'text-sm text-green-600';
            } else if (result.success && (!result.models || result.models.length === 0)) {
                statusElement.textContent = 'LMStudio running but no models found';
                statusElement.className = 'text-sm text-yellow-600';
            } else {
                statusElement.textContent = result.message || 'Failed to get models';
                statusElement.className = 'text-sm text-red-600';
            }
        }).catch(function(error) {
            statusElement.textContent = 'Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        }).finally(function() {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = 'Get Models';
        });
    }

    function cacheWorkflowProviderCatalog(catalog) {
        if (!catalog || typeof localStorage === 'undefined') return;
        try {
            localStorage.setItem('providerModelCatalog', JSON.stringify({
                data: catalog,
                updatedAt: Date.now()
            }));
        } catch (error) {
            console.warn('Failed to cache provider catalog', error);
        }
    }

    function describeModelUpdate(result) {
        if (!result || !Array.isArray(result.models) || result.models.length === 0) {
            return '';
        }
        const count = result.models.length;
        return ` (updated ${count} model${count === 1 ? '' : 's'})`;
    }

    // Update workflow API key sections visibility based on checkbox selections
    function updateWorkflowApiKeyVisibility() {
        const openaiEnabled = document.getElementById('workflowOpenaiEnabled').checked;
        const anthropicEnabled = document.getElementById('workflowAnthropicEnabled').checked;
        const geminiEnabled = document.getElementById('workflowGeminiEnabled')?.checked;
        const lmstudioEnabled = document.getElementById('workflowLmstudioEnabled').checked;

        const openaiSection = document.getElementById('workflowOpenaiApiKeySection');
        const anthropicSection = document.getElementById('workflowAnthropicApiKeySection');
        const geminiSection = document.getElementById('workflowGeminiApiKeySection');
        const lmstudioSection = document.getElementById('workflowLmstudioApiKeySection');

        // Show/hide sections based on checkbox state
        openaiSection.style.display = openaiEnabled ? 'block' : 'none';
        anthropicSection.style.display = anthropicEnabled ? 'block' : 'none';
        // Keep Gemini UI hidden even if enabled
        if (geminiSection) {
            geminiSection.style.display = 'none';
        }
        lmstudioSection.style.display = lmstudioEnabled ? 'block' : 'none';
    }

    // Test workflow API key for specific provider
    function testWorkflowApiKey(provider) {
        let apiKey = '';
        let statusElement;
        let testButton;
        let providerName = '';

        if (provider === 'openai') {
            apiKey = document.getElementById('workflowOpenaiApiKey').value;
            statusElement = document.getElementById('workflowOpenaiApiKeyStatus');
            testButton = document.getElementById('testWorkflowOpenaiApiKey');
            providerName = 'OpenAI';
        } else if (provider === 'anthropic') {
            apiKey = document.getElementById('workflowAnthropicApiKey').value;
            statusElement = document.getElementById('workflowAnthropicApiKeyStatus');
            testButton = document.getElementById('testWorkflowAnthropicApiKey');
            providerName = 'Anthropic';
        } else if (provider === 'gemini') {
            apiKey = document.getElementById('workflowGeminiApiKey').value;
            statusElement = document.getElementById('workflowGeminiApiKeyStatus');
            testButton = document.getElementById('testWorkflowGeminiApiKey');
            providerName = 'Gemini';
        } else if (provider === 'lmstudio') {
            statusElement = document.getElementById('workflowLmstudioApiKeyStatus');
            testButton = document.getElementById('testWorkflowLmstudioApiKey');
            providerName = 'LMStudio';
        }

        // Disable button and show loading
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        statusElement.textContent = (provider === 'lmstudio' ? 'Getting models' : 'Testing API key') + '...';
        statusElement.className = 'text-sm text-gray-600';

        let endpoint = '';
        let requestBody = {};

        if (provider === 'openai') {
            endpoint = '/api/test-openai-key';
            requestBody = { api_key: apiKey };
        } else if (provider === 'anthropic') {
            endpoint = '/api/test-anthropic-key';
            requestBody = { api_key: apiKey };
        } else if (provider === 'gemini') {
            endpoint = '/api/test-gemini-key'; // Assuming this endpoint exists
            requestBody = { api_key: apiKey };
        } else if (provider === 'lmstudio') {
            endpoint = '/api/lmstudio-models';
            requestBody = {}; // No body needed for GET request
        }

        fetch(endpoint, {
            method: provider === 'lmstudio' ? 'GET' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: provider === 'lmstudio' ? null : JSON.stringify(requestBody)
        }).then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('API request failed');
            }
        }).then(function(result) {
            if (provider === 'lmstudio') {
                if (result.success && result.models && result.models.length > 0) {
                    statusElement.textContent = 'Found ' + result.models.length + ' model' + (result.models.length === 1 ? '' : 's');
                    statusElement.className = 'text-sm text-green-600';
                } else if (result.success && (!result.models || result.models.length === 0)) {
                    statusElement.textContent = 'LMStudio running but no models found';
                    statusElement.className = 'text-sm text-yellow-600';
                } else {
                    statusElement.textContent = result.message || 'Failed to get models';
                    statusElement.className = 'text-sm text-red-600';
                }
            } else {
                if (result.valid) {
                    statusElement.textContent = 'API key is valid' + describeModelUpdate(result);
                    statusElement.className = 'text-sm text-green-600';
                    if (result.catalog) {
                        cacheWorkflowProviderCatalog(result.catalog);
                    }
                } else {
                    statusElement.textContent = result.message;
                    statusElement.className = 'text-sm text-red-600';
                }
            }
        }).catch(function(error) {
            statusElement.textContent = 'Network error - please try again';
            statusElement.className = 'text-sm text-red-600';
        }).finally(function() {
            // Re-enable button
            testButton.disabled = false;
            testButton.textContent = provider === 'lmstudio' ? 'Get Models' : 'Test';
        });
    }

    // Toggle workflow API key visibility functions
    function toggleWorkflowOpenaiApiKeyVisibility() {
        const input = document.getElementById('workflowOpenaiApiKey');
        const button = document.getElementById('toggleWorkflowOpenaiApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleWorkflowAnthropicApiKeyVisibility() {
        const input = document.getElementById('workflowAnthropicApiKey');
        const button = document.getElementById('toggleWorkflowAnthropicApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleWorkflowGeminiApiKeyVisibility() {
        const input = document.getElementById('workflowGeminiApiKey');
        const button = document.getElementById('toggleWorkflowGeminiApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleAiOpenaiApiKeyVisibility() {
        const input = document.getElementById('aiOpenaiApiKey');
        const button = document.getElementById('toggleAiOpenaiApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }

    function toggleAiAnthropicApiKeyVisibility() {
        const input = document.getElementById('aiAnthropicApiKey');
        const button = document.getElementById('toggleAiAnthropicApiKey');
        const icon = button.querySelector('svg');

        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            `;
        } else {
            input.type = 'password';
            icon.innerHTML = `
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            `;
        }
    }


    
    // Show success notification
    function showSuccessNotification() {
        const notification = document.getElementById('successNotification');
        notification.classList.remove('translate-x-full');
        
        setTimeout(function() {
            notification.remove();
        }, 5000);
    }

    function safeAddListener(id, event, handler) {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener(event, handler);
        }
        return element;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings().catch(function(err) {
            console.error('Error loading settings:', err);
        });


        // AI model selection
        safeAddListener('aiModel', 'change', function() {
            // Update AI model test sections visibility
            updateAiModelTestSections();
        });

        // AI model API key visibility toggles
        safeAddListener('toggleAiOpenaiApiKey', 'click', function() {
            toggleAiOpenaiApiKeyVisibility();
        });

        safeAddListener('toggleAiAnthropicApiKey', 'click', function() {
            toggleAiAnthropicApiKeyVisibility();
        });

        // AI model test buttons
        safeAddListener('testAiOpenaiKey', 'click', function() {
            testAiOpenaiKey();
        });

        safeAddListener('testAiAnthropicKey', 'click', function() {
            testAiAnthropicKey();
        });

        safeAddListener('testAiLmstudioConnection', 'click', function() {
            testAiLmstudioConnection();
        });

        // Workflow provider checkboxes
        ['workflowOpenaiEnabled', 'workflowAnthropicEnabled', 'workflowGeminiEnabled', 'workflowLmstudioEnabled'].forEach(function(id) {
            safeAddListener(id, 'change', function() {
                updateWorkflowApiKeyVisibility();
            });
        });

        // Workflow API key visibility toggles
        safeAddListener('toggleWorkflowOpenaiApiKey', 'click', function() {
            toggleWorkflowOpenaiApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowAnthropicApiKey', 'click', function() {
            toggleWorkflowAnthropicApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowGeminiApiKey', 'click', function() {
            toggleWorkflowGeminiApiKeyVisibility();
        });

        safeAddListener('toggleWorkflowLmstudioApiKey', 'click', function() {
            toggleWorkflowLmstudioApiKeyVisibility();
        });

        // Test workflow API key buttons
        safeAddListener('testWorkflowOpenaiApiKey', 'click', function() {
            testWorkflowApiKey('openai');
        });

        safeAddListener('testWorkflowAnthropicApiKey', 'click', function() {
            testWorkflowApiKey('anthropic');
        });

        safeAddListener('testWorkflowGeminiApiKey', 'click', function() {
            testWorkflowApiKey('gemini');
        });

        safeAddListener('testWorkflowLmstudioApiKey', 'click', function() {
            testWorkflowApiKey('lmstudio');
        });

        // Backup configuration fields
        ['backupTime', 'cleanupTime', 'dailyRetention', 'weeklyRetention', 'monthlyRetention', 'maxSizeGb'].forEach(function(id) {
            safeAddListener(id, 'change', saveSettings);
        });

        // Backup checkboxes
        ['backupDatabase', 'backupModels', 'backupConfig', 'backupOutputs', 'backupLogs', 'backupDockerVolumes'].forEach(function(id) {
            var element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveSettings);
            }
        });

        // Save settings button
        document.getElementById('saveSettings').addEventListener('click', function() {
            saveSettings();
        });

        // Temperature slider event listener
        var temperatureSlider = document.getElementById('aiTemperature');
        var temperatureValue = document.getElementById('temperatureValue');

        if (temperatureSlider && temperatureValue) {
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
        }

        // Handle Enter key in input fields
        ['backupDirectory', 'dailyRetention', 'weeklyRetention', 'monthlyRetention', 'maxSizeGb'].forEach(function(id) {
            var element = document.getElementById(id);
            if (element) {
                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSettings();
                    }
                });
            }
        });

        // Export annotations button
        var exportBtn = document.getElementById('exportAnnotationsBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                var progressDiv = document.getElementById('exportProgress');
                progressDiv.classList.remove('hidden');
                exportBtn.disabled = true;

                fetch('/api/export/annotations', {
                    method: 'GET'
                }).then(function(response) {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        return response.json().then(function(result) {
                            throw new Error(result.detail || 'Export failed');
                        });
                    }
                }).then(function(blob) {
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'annotations.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('Annotations exported successfully', 'success');
                }).catch(function(error) {
                    console.error('Export error:', error);
                    showNotification('Failed to export annotations: ' + error.message, 'error');
                }).finally(function() {
                    // Hide progress
                    exportBtn.disabled = false;
                    progressDiv.classList.add('hidden');
                });
            });
        }

        // Backup action buttons
        var createBackupBtn = document.getElementById('createBackupBtn');
        if (createBackupBtn) {
            createBackupBtn.addEventListener('click', createBackup);
        }
        var listBackupsBtn = document.getElementById('listBackupsBtn');
        if (listBackupsBtn) {
            listBackupsBtn.addEventListener('click', listBackups);
        }
        var backupStatusBtn = document.getElementById('backupStatusBtn');
        if (backupStatusBtn) {
            backupStatusBtn.addEventListener('click', checkBackupStatus);
        }
    });

    async function createBackup() {
        const backupType = document.getElementById('backupType').value;
        const compress = document.getElementById('enableCompression').checked;
        const verify = document.getElementById('enableVerification').checked;

        try {
            const response = await fetch('/api/backup/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: backupType,
                    compress: compress,
                    verify: verify
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Backup created successfully: ${result.backup_name}`, 'success');
            } else {
                const error = await response.json();
                showNotification(`Backup failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Backup failed: ${error.message}`, 'error');
        }
    }

    async function listBackups() {
        try {
            const response = await fetch('/api/backup/list');
            if (response.ok) {
                const backups = await response.json();
                displayBackupList(backups);
            } else {
                showNotification('Failed to list backups', 'error');
            }
        } catch (error) {
            showNotification(`Failed to list backups: ${error.message}`, 'error');
        }
    }

    async function checkBackupStatus() {
        try {
            const response = await fetch('/api/backup/status');
            if (response.ok) {
                const status = await response.json();
                displayBackupStatus(status);
            } else {
                showNotification('Failed to get backup status', 'error');
            }
        } catch (error) {
            showNotification(`Failed to get backup status: ${error.message}`, 'error');
        }
    }

    function displayBackupList(backups) {
        const statusDisplay = document.getElementById('backupStatusDisplay');
        const statusContent = document.getElementById('backupStatusContent');

        let html = '<h4 class="font-semibold mb-2">Available Backups:</h4>';
        if (backups.length === 0) {
            html += '<p class="text-gray-500">No backups found.</p>';
        } else {
            html += '<div class="space-y-2">';
            backups.forEach(backup => {
                html += `
                    <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded">
                        <span class="font-mono text-sm">${backup.name}</span>
                        <span class="text-sm text-gray-500">${backup.size_mb} MB</span>
                    </div>
                `;
            });
            html += '</div>';
        }

        statusContent.innerHTML = html;
        statusDisplay.classList.remove('hidden');
    }

    function displayBackupStatus(status) {
        const statusDisplay = document.getElementById('backupStatusDisplay');
        const statusContent = document.getElementById('backupStatusContent');

        let html = '<h4 class="font-semibold mb-2">Backup Status:</h4>';
        html += `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span>Automated Backups:</span>
                    <span class="${status.automated ? 'text-green-600' : 'text-red-600'}">
                        ${status.automated ? '‚úÖ Enabled' : '‚ùå Disabled'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>Total Backups:</span>
                    <span>${status.total_backups}</span>
                </div>
                <div class="flex justify-between">
                    <span>Total Size:</span>
                    <span>${status.total_size_gb} GB</span>
                </div>
                <div class="flex justify-between">
                    <span>Last Backup:</span>
                    <span>${status.last_backup || 'Never'}</span>
                </div>
            </div>
        `;

        statusContent.innerHTML = html;
        statusDisplay.classList.remove('hidden');
    }

    function showNotification(message, type) {
        // Create notification element
        var notification = document.createElement('div');
        var className = 'fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm transform transition-all duration-300 ';
        if (type === 'success') {
            className += 'bg-green-500 text-white';
        } else if (type === 'error') {
            className += 'bg-red-500 text-white';
        } else {
            className += 'bg-blue-500 text-white';
        }
        notification.className = className;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Remove after 5 seconds
        setTimeout(function() {
            notification.remove();
        }, 5000);
    }
</script>
{% endblock %}
