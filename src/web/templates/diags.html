{% extends "base.html" %}

{% block title %}System Diagnostics & Health - Huntable CTI Studio{% endblock %}

{% block content %}
<style>
/* Diags page: theme vars only (ui-designer.mdc) */
.diags-card { background-color: var(--mlops-card-bg); border: 1px solid var(--mlops-card-border); border-radius: 0.5rem; box-shadow: 0 1px 3px var(--shadow-card); }
.diags-heading { color: var(--text-primary); }
.diags-muted { color: var(--text-muted-slate); }
.diags-btn-secondary { background-color: var(--panel-bg-4); color: var(--text-primary); border: 1px solid var(--border-muted); }
.diags-btn-secondary:hover { background-color: var(--panel-bg-5); border-color: var(--border-subtle); }
.diags-pulse { background-color: var(--border-muted); }
.diags-panel-hover:hover { background-color: var(--panel-bg-4); }
.diags-status-success { color: var(--action-success-light); }
.diags-status-warning { color: var(--action-warning); }
.diags-status-error { color: var(--action-danger); }
.diags-status-info { color: var(--action-info); }
.diags-panel-success { background-color: var(--action-success-bg); border: 1px solid var(--action-success); color: var(--action-success-dark); }
.diags-panel-warning { background-color: var(--action-warning-bg-light); border: 1px solid var(--border-warning); color: var(--action-warning-dark); }
.diags-panel-error { background-color: var(--action-danger-bg); border: 1px solid var(--action-danger); color: var(--action-danger-hover); }
.diags-panel-info { background-color: var(--action-info-bg); border: 1px solid var(--action-info); color: var(--action-info-dark); }
.diags-panel-neutral { background-color: var(--panel-bg-4); border: 1px solid var(--mlops-card-border); color: var(--text-muted-slate); }
.diags-overlay-bg { background-color: var(--shadow-overlay); }
.diags-loading-spinner-bg { background-color: var(--action-info-fill); }
.diags-loading-spinner { color: var(--action-info); }
.diags-checkbox:focus { border-color: var(--border-focus); box-shadow: 0 0 0 2px var(--purple-border-15); }
</style>
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold diags-heading mb-2 flex items-center gap-3">
            <img src="/static/icons/diags-icon.svg" alt="Diags" class="w-[63px] h-[63px]" />
            System Diagnostics & Health
        </h1>
        <p class="diags-muted">Monitor system health, background jobs, service status, and analytics</p>
    </div>

    <!-- Quick Actions -->
    <div class="diags-card p-6 mb-8">
        <h2 class="text-xl font-semibold diags-heading mb-4">‚ö° Quick Actions</h2>
        <div class="flex flex-wrap gap-4">
            <button id="runAllHealthChecks" type="button" class="btn-analyze inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--action-info)] transition-colors">
                üè• Run All Health Checks
            </button>
            <button id="refreshJobData" type="button" class="diags-btn-secondary inline-flex items-center px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--border-focus)] transition-colors">
                üîÑ Refresh Job Data
            </button>
            <label class="flex items-center">
                <input type="checkbox" id="autoRefresh" class="diags-checkbox rounded border-[var(--border-muted)] shadow-sm" style="accent-color: var(--action-info);" checked>
                <span class="ml-2 text-sm diags-muted">Auto-refresh (5s)</span>
            </label>
            <div class="text-sm diags-muted">
                Last updated: <span id="lastUpdated">Never</span>
            </div>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üè• System Health</h2>
            <div id="overallHealthStatus" class="diags-muted">
                Click "Run All Health Checks" to get system status
            </div>
        </div>
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üë• Worker Status</h2>
            <div id="workerStatus" class="space-y-3">
                <div class="animate-pulse">
                    <div class="h-4 diags-pulse rounded w-3/4"></div>
                    <div class="h-4 diags-pulse rounded w-1/2 mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Health Checks -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üóÑÔ∏è Database Health</h2>
            <div id="databaseHealthContent" class="diags-muted">
                Click "Run All Health Checks" to check database status
            </div>
        </div>
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üîß External Services</h2>
            <div id="servicesHealthContent" class="diags-muted">
                Click "Run All Health Checks" to check external services
            </div>
        </div>
    </div>

    <!-- Job Monitoring -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üìä Queue Status</h2>
            <p class="text-xs diags-muted mb-3">Shows pending tasks per queue and which worker(s) consume each queue</p>
            <div id="queueStatus" class="space-y-3">
                <div class="animate-pulse">
                    <div class="h-4 diags-pulse rounded w-3/4"></div>
                    <div class="h-4 diags-pulse rounded w-1/2 mt-2"></div>
                </div>
            </div>
        </div>
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">‚ö° Active Tasks</h2>
            <p class="text-xs diags-muted mb-3">Currently running tasks across all workers</p>
            <div id="activeTasks" class="space-y-3">
                <div class="animate-pulse">
                    <div class="h-4 diags-pulse rounded w-full"></div>
                    <div class="h-4 diags-pulse rounded w-2/3 mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Health Checks -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">üîç Deduplication System</h2>
            <div id="deduplicationHealthContent" class="diags-muted">
                Click "Run All Health Checks" to check deduplication status
            </div>
        </div>
        <div class="diags-card p-6">
            <h2 class="text-xl font-semibold diags-heading mb-4">‚öôÔ∏è Celery Workers</h2>
            <div id="celeryHealthContent" class="diags-muted">
                Click "Run All Health Checks" to check background task processing
            </div>
        </div>
    </div>

    <!-- Job History -->
    <div class="diags-card p-6 mb-8">
        <div data-collapsible-panel="job-history" class="diags-panel-hover flex items-center justify-between mb-4 -m-6 p-6 pb-4 rounded-t-lg transition-colors cursor-pointer">
            <h2 class="text-xl font-semibold diags-heading">üìã Recent Job History</h2>
            <p class="text-xs diags-muted mt-1">Completed tasks with inferred worker/queue assignment</p>
            <span id="job-history-toggle" class="diags-muted transition-transform duration-200" aria-hidden="true">
                <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </span>
        </div>
        <div id="job-history-content" class="space-y-3 hidden">
            <div class="animate-pulse">
                <div class="h-4 diags-pulse rounded w-full"></div>
                <div class="h-4 diags-pulse rounded w-3/4 mt-2"></div>
                <div class="h-4 diags-pulse rounded w-1/2 mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 diags-overlay-bg backdrop-blur-sm overflow-y-auto h-full w-full z-50 hidden flex items-center justify-center">
    <div class="diags-card rounded-xl p-6 max-w-md w-full mx-4">
        <div class="mt-3 text-center">
            <div class="diags-loading-spinner-bg mx-auto flex items-center justify-center h-12 w-12 rounded-full">
                <svg class="animate-spin h-6 w-6 diags-loading-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium diags-heading mt-4">Running Diagnostics</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm diags-muted" id="loadingMessage">Please wait...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval;
let isAutoRefresh = true;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing diagnostics...');
    
    // Test if elements exist
    const workerStatus = document.getElementById('workerStatus');
    const queueStatus = document.getElementById('queueStatus');
    const activeTasks = document.getElementById('activeTasks');
    const jobHistoryContent = document.getElementById('job-history-content');
    
    console.log('Elements found:', {
        workerStatus: !!workerStatus,
        queueStatus: !!queueStatus,
        activeTasks: !!activeTasks,
        jobHistoryContent: !!jobHistoryContent
    });
    
    if (workerStatus && queueStatus && activeTasks && jobHistoryContent) {
        loadJobData();
        setupAutoRefresh();
        setupEventListeners();
    } else {
        console.error('Required DOM elements not found');
        showError('Failed to initialize diagnostics - missing DOM elements');
    }
});

function setupEventListeners() {
    const autoRefreshEl = document.getElementById('autoRefresh');
    const refreshBtn = document.getElementById('refreshJobData');
    const runAllHealthBtn = document.getElementById('runAllHealthChecks');
    
    if (autoRefreshEl) {
        autoRefreshEl.addEventListener('change', function(e) {
            isAutoRefresh = e.target.checked;
            if (isAutoRefresh) {
                setupAutoRefresh();
            } else {
                clearInterval(autoRefreshInterval);
            }
        });
    }

    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            loadJobData();
        });
    }

    if (runAllHealthBtn) {
        runAllHealthBtn.addEventListener('click', async () => {
            await updateOverallHealthStatus();
            await updateDatabaseHealth();
            await updateDeduplicationHealth();
            await updateServicesHealth();
            await updateCeleryHealth();
        });
    }
}

// setupJobHistoryToggle removed - now handled by global initCollapsiblePanels()

function setupAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    if (isAutoRefresh) {
        autoRefreshInterval = setInterval(loadJobData, 5000);
    }
}

// Job monitoring functions
async function loadJobData() {
    try {
        console.log('Loading job data...');
        
        // Load all data in parallel
        const [statusResponse, queueResponse, historyResponse] = await Promise.all([
            fetch('/api/jobs/status'),
            fetch('/api/jobs/queues'),
            fetch('/api/jobs/history?limit=20')
        ]);

        const statusData = await statusResponse.json();
        const queueData = await queueResponse.json();
        const historyData = await historyResponse.json();

        console.log('Status data:', statusData);
        console.log('Queue data:', queueData);
        console.log('History data:', historyData);

        updateWorkerStatus(statusData);
        // Pass worker info to queue status for queue-to-worker mapping
        updateQueueStatus({...queueData, worker_stats: statusData.worker_stats, active_queues: statusData.active_queues});
        updateActiveTasks(statusData);
        updateJobHistory(historyData);
        
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedEl) {
            lastUpdatedEl.textContent = new Date().toLocaleTimeString();
        }
    } catch (error) {
        console.error('Failed to load job data:', error);
        showError('Failed to load job data: ' + error.message);
    }
}

function updateWorkerStatus(data) {
    const container = document.getElementById('workerStatus');
    console.log('Updating worker status with data:', data);
    
    if (data.status === 'error') {
        container.innerHTML = '<div class="diags-status-error">‚ùå Error loading worker status</div>';
        return;
    }
    
    if (data.status === 'timeout') {
        container.innerHTML = '<div class="diags-status-warning">‚ö†Ô∏è Worker status timeout - workers may be unresponsive</div>';
        return;
    }

    const workerStats = data.worker_stats || {};
    const activeQueues = data.active_queues || {};
    const activeWorkers = Object.keys(workerStats);
    
    console.log('Active workers:', activeWorkers);
    console.log('Worker stats:', workerStats);
    console.log('Active queues:', activeQueues);
    
    if (activeWorkers.length === 0) {
        container.innerHTML = '<div class="diags-status-warning">‚ö†Ô∏è No active workers</div>';
        return;
    }

    let html = '';
    activeWorkers.forEach(worker => {
        const stats = workerStats[worker];
        const processCount = Array.isArray(stats.pool?.processes) ? stats.pool.processes.length : 'N/A';
        const totalTasks = stats.total ? Object.values(stats.total).reduce((a, b) => a + b, 0) : 0;
        
        // Get queues this worker is consuming
        const workerQueues = activeQueues[worker] || [];
        let queueNames = 'all queues';
        if (workerQueues.length > 0) {
            queueNames = workerQueues.map(q => {
                if (typeof q === 'string') return q;
                if (typeof q === 'object' && q.name) return q.name;
                return String(q);
            }).join(', ');
        }
        
        // Identify worker type based on name or queues
        const isWorkflowWorker = worker.includes('workflow') || queueNames.includes('workflows');
        const workerType = isWorkflowWorker ? 'üîÑ Workflow' : '‚öôÔ∏è General';
        
        html += `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--panel-bg-4);">
                <div>
                    <div class="font-medium diags-heading">${workerType} Worker</div>
                    <div class="text-sm diags-muted">${worker}</div>
                    <div class="text-xs diags-muted mt-1">Queues: ${queueNames} | Pool: ${processCount} processes</div>
                </div>
                <div class="text-right">
                    <div class="text-sm diags-status-success">‚úÖ Active</div>
                    <div class="text-xs diags-muted">Tasks: ${totalTasks}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateQueueStatus(data) {
    const container = document.getElementById('queueStatus');
    console.log('Updating queue status with data:', data);
    
    if (data.status === 'error') {
        container.innerHTML = '<div class="diags-status-error">‚ùå Error loading queue status</div>';
        return;
    }

    const queues = data.queues || {};
    console.log('Queues:', queues);
    
    let html = '';
    
    // Map queues to workers (from worker status data if available)
    const queueToWorkers = {};
    if (data.worker_stats && data.active_queues) {
        Object.entries(data.active_queues).forEach(([worker, queues]) => {
            queues.forEach(queue => {
                const queueName = typeof queue === 'string' ? queue : (queue.name || String(queue));
                if (!queueToWorkers[queueName]) {
                    queueToWorkers[queueName] = [];
                }
                const isWorkflowWorker = worker.includes('workflow') || queueName === 'workflows';
                queueToWorkers[queueName].push({
                    worker: worker,
                    type: isWorkflowWorker ? 'üîÑ Workflow' : '‚öôÔ∏è General'
                });
            });
        });
    }
    
    Object.entries(queues).forEach(([queueName, length]) => {
        const statusClass = length > 0 ? 'diags-status-warning' : 'diags-status-success';
        const statusIcon = length > 0 ? '‚è≥' : '‚úÖ';
        const workers = queueToWorkers[queueName] || [];
        const workerInfo = workers.length > 0 
            ? workers.map(w => w.type).join(', ')
            : 'No active consumers';
        
        html += `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--panel-bg-4);">
                <div>
                    <div class="font-medium diags-heading">${queueName}</div>
                    <div class="text-sm diags-muted">Queue length</div>
                    <div class="text-xs diags-muted mt-1">Consumed by: ${workerInfo}</div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold ${statusClass}">${length}</div>
                    <div class="text-xs diags-muted">${statusIcon} ${length > 0 ? 'Pending' : 'Empty'}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateActiveTasks(data) {
    const container = document.getElementById('activeTasks');
    console.log('Updating active tasks with data:', data);
    
    if (data.status === 'error') {
        container.innerHTML = '<div class="diags-status-error">‚ùå Error loading active tasks</div>';
        return;
    }
    
    if (data.status === 'timeout') {
        container.innerHTML = '<div class="diags-status-warning">‚ö†Ô∏è Active tasks timeout - workers may be unresponsive</div>';
        return;
    }

    const activeTasks = data.active_tasks || {};
    console.log('Active tasks:', activeTasks);
    
    const allTasks = [];
    
    Object.entries(activeTasks).forEach(([worker, tasks]) => {
        if (Array.isArray(tasks)) {
            tasks.forEach(task => {
                allTasks.push({...task, worker});
            });
        }
    });
    
    console.log('All tasks:', allTasks);
    
    if (allTasks.length === 0) {
        container.innerHTML = '<div class="diags-muted text-center py-8">No active tasks</div>';
        return;
    }

    // Get worker info for context
    const workerStats = data.worker_stats || {};
    const activeQueues = data.active_queues || {};
    
    let html = '';
    allTasks.forEach(task => {
        const startTime = new Date(task.time_start * 1000).toLocaleTimeString();
        const taskName = task.name ? task.name.split('.').pop() : 'Unknown Task';
        const sourceId = task.args && task.args[0] ? `Source ${task.args[0]}` : 'Unknown Source';
        
        // Determine worker type
        const worker = task.worker || '';
        const isWorkflowWorker = worker.includes('workflow');
        const workerType = isWorkflowWorker ? 'üîÑ Workflow' : '‚öôÔ∏è General';
        const workerQueues = activeQueues[worker] || [];
        const queueNames = workerQueues.length > 0 
            ? workerQueues.map(q => typeof q === 'string' ? q : (q.name || String(q))).join(', ')
            : '';
        
        html += `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--panel-bg-4);">
                <div>
                    <div class="font-medium diags-heading">${taskName}</div>
                    <div class="text-sm diags-muted">${sourceId} | Started: ${startTime}</div>
                    <div class="text-xs diags-muted mt-1">${workerType} Worker${queueNames ? ` (${queueNames})` : ''}</div>
                </div>
                <div class="text-right">
                    <div class="text-sm diags-status-info">üîÑ Running</div>
                    <div class="text-xs diags-muted">ID: ${task.id.substring(0, 8)}...</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateJobHistory(data) {
    const container = document.getElementById('job-history-content');
    console.log('Updating job history with data:', data);
    
    if (data.status === 'error') {
        container.innerHTML = '<div class="diags-status-error">‚ùå Error loading job history</div>';
        return;
    }

    const tasks = data.recent_tasks || [];
    console.log('Recent tasks:', tasks);
    
    if (tasks.length === 0) {
        container.innerHTML = '<div class="diags-muted text-center py-8">No recent tasks</div>';
        return;
    }

    // Helper to determine likely queue/worker from task name
    function getTaskQueueInfo(taskName) {
        if (!taskName) return { queue: 'unknown', workerType: '‚öôÔ∏è General' };
        
        const taskLower = taskName.toLowerCase();
        if (taskLower.includes('trigger_agentic_workflow') || taskLower.includes('workflow')) {
            return { queue: 'workflows', workerType: 'üîÑ Workflow' };
        }
        if (taskLower.includes('check_all_sources') || taskLower.includes('check_source')) {
            return { queue: 'source_checks', workerType: '‚öôÔ∏è General' };
        }
        if (taskLower.includes('collect_from_source')) {
            return { queue: 'collection', workerType: '‚öôÔ∏è General' };
        }
        if (taskLower.includes('cleanup') || taskLower.includes('maintenance')) {
            return { queue: 'maintenance', workerType: '‚öôÔ∏è General' };
        }
        if (taskLower.includes('report')) {
            return { queue: 'reports', workerType: '‚öôÔ∏è General' };
        }
        return { queue: 'default', workerType: '‚öôÔ∏è General' };
    }
    
    let html = '';
    tasks.forEach(task => {
        const statusColor = getStatusColor(task.status);
        const statusIcon = getStatusIcon(task.status);
        const dateDone = task.date_done ? new Date(task.date_done).toLocaleString() : 'N/A';
        const resultText = task.result ? JSON.stringify(task.result).substring(0, 50) + '...' : 'No result';
        
        // Extract task name from result or use task_id
        const taskName = task.result?.task_name || task.task_id;
        const queueInfo = getTaskQueueInfo(taskName);
        
        html += `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--panel-bg-4);">
                <div>
                    <div class="font-medium diags-heading">${task.task_id.substring(0, 8)}...</div>
                    <div class="text-sm diags-muted">Completed: ${dateDone}</div>
                    <div class="text-xs diags-muted mt-1">${queueInfo.workerType} Worker (${queueInfo.queue} queue)</div>
                </div>
                <div class="text-right">
                    <div class="text-sm ${statusColor}">${statusIcon} ${task.status}</div>
                    <div class="text-xs diags-muted">${resultText}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getStatusColor(status) {
    switch (status) {
        case 'SUCCESS': return 'diags-status-success';
        case 'FAILURE': return 'diags-status-error';
        case 'PENDING': return 'diags-status-warning';
        case 'RETRY': return 'diags-status-warning';
        default: return 'diags-muted';
    }
}

function getStatusIcon(status) {
    switch (status) {
        case 'SUCCESS': return '‚úÖ';
        case 'FAILURE': return '‚ùå';
        case 'PENDING': return '‚è≥';
        case 'RETRY': return 'üîÑ';
        default: return '‚ùì';
    }
}

// Health check functions
async function runHealthCheck(endpoint, loadingMessage) {
    showLoading(loadingMessage);
    try {
        const response = await fetch(`/api/health${endpoint}`);
        const data = await response.json();
        hideLoading();
        return data;
    } catch (error) {
        hideLoading();
        console.error(`Health check failed for ${endpoint}:`, error);
        return { status: 'error', error: error.message };
    }
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

function formatTimestamp(timestamp) {
    return new Date(timestamp).toLocaleString();
}

function getHealthStatusColor(status) {
    switch (status) {
        case 'healthy': return 'diags-status-success';
        case 'unhealthy': return 'diags-status-error';
        case 'error': return 'diags-status-error';
        default: return 'diags-muted';
    }
}

function getHealthStatusIcon(status) {
    switch (status) {
        case 'healthy': return '‚úÖ';
        case 'unhealthy': return '‚ùå';
        case 'error': return '‚ö†Ô∏è';
        case 'not_configured': return '‚ö™';
        default: return '‚ùì';
    }
}

// Overall Health Status Check
async function updateOverallHealthStatus() {
    const data = await runHealthCheck('', 'Checking overall system status...');
    
    const content = document.getElementById('overallHealthStatus');
    content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 diags-panel-info rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">${getHealthStatusIcon(data.status)}</span>
                    <div>
                        <h3 class="font-medium">System Status</h3>
                        <p class="text-sm font-bold ${getHealthStatusColor(data.status)}">${data.status.toUpperCase()}</p>
                    </div>
                </div>
            </div>
            <div class="p-4 diags-panel-success rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üïí</span>
                    <div>
                        <h3 class="font-medium">Last Check</h3>
                        <p class="text-sm font-bold">${formatTimestamp(data.timestamp)}</p>
                    </div>
                </div>
            </div>
            <div class="p-4 rounded-lg" style="background-color: var(--action-execute-fill); border: 1px solid var(--action-execute); color: var(--action-execute-dark);">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üì¶</span>
                    <div>
                        <h3 class="font-medium">Version</h3>
                        <p class="text-sm font-bold">${data.version || '1.0.0'}</p>
                    </div>
                </div>
            </div>
        </div>
        ${data.error ? `<div class="mt-4 p-3 diags-panel-error rounded-md"><p class="text-sm">Error: ${data.error}</p></div>` : ''}
    `;
}

// Database Health Check
async function updateDatabaseHealth() {
    const data = await runHealthCheck('/database', 'Checking database health...');
    
    const content = document.getElementById('databaseHealthContent');
    if (data.status === 'healthy' && data.database) {
        const db = data.database;
        content.innerHTML = `
            <div class="space-y-4">
                <div class="p-4 diags-panel-success rounded-lg">
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">‚úÖ</span>
                        <div>
                            <h3 class="font-medium">Database Connection</h3>
                            <p class="text-sm">${db.connection}</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 diags-panel-info rounded-lg">
                        <h3 class="font-medium">Total Articles</h3>
                        <p class="text-2xl font-bold">${db.total_articles}</p>
                    </div>
                    <div class="p-4 diags-panel-info rounded-lg">
                        <h3 class="font-medium">Total Sources</h3>
                        <p class="text-2xl font-bold">${db.total_sources}</p>
                    </div>
                    <div class="p-4 diags-panel-info rounded-lg">
                        <h3 class="font-medium">SimHash Coverage</h3>
                        <p class="text-2xl font-bold">${db.simhash.coverage}</p>
                    </div>
                </div>
                <div class="p-4 border rounded-lg ${db.corruption && db.corruption.count === 0 ? 'diags-panel-success' : 'diags-panel-error'}">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">${db.corruption && db.corruption.count === 0 ? '‚úÖ' : '‚ùå'}</span>
                        <div>
                            <h3 class="font-medium">Content Integrity</h3>
                            <p class="text-sm">${db.corruption ? db.corruption.count : 0} corrupted articles found</p>
                        </div>
                    </div>
                    ${db.corruption && db.corruption.count > 0 ? `
                        <div class="mt-2 text-sm diags-muted">
                            <p class="font-medium mb-1">Examples:</p>
                            <ul class="list-disc list-inside pl-2">
                                ${db.corruption.examples.map(ex => `<li>ID ${ex.id}: ${ex.title}</li>`).join('')}
                            </ul>
                            <p class="mt-2 text-xs italic">Run <code>python fix_corrupted_articles.py --all</code> to fix.</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
    } else {
        content.innerHTML = `
            <div class="p-4 diags-panel-error rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚ùå</span>
                    <div>
                        <h3 class="font-medium">Database Health Check Failed</h3>
                        <p class="text-sm">${data.error || 'Unknown error'}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Deduplication Health Check
async function updateDeduplicationHealth() {
    const data = await runHealthCheck('/deduplication', 'Checking deduplication system...');
    
    const content = document.getElementById('deduplicationHealthContent');
    if (data.status === 'healthy' && data.deduplication) {
        const dedup = data.deduplication;
        content.innerHTML = `
            <div class="space-y-4">
                <div class="p-4 border rounded-lg ${dedup.exact_duplicates.content_hash_duplicates === 0 ? 'diags-panel-success' : 'diags-panel-error'}">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">${dedup.exact_duplicates.content_hash_duplicates === 0 ? '‚úÖ' : '‚ùå'}</span>
                        <div>
                            <h3 class="font-medium">Exact Duplicates</h3>
                            <p class="text-sm">${dedup.exact_duplicates.content_hash_duplicates} content hash duplicates found</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 border rounded-lg ${dedup.near_duplicates.potential_near_duplicates === 0 ? 'diags-panel-success' : 'diags-panel-warning'}">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl mr-2">${dedup.near_duplicates.potential_near_duplicates === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div>
                            <h3 class="font-medium">Near Duplicates</h3>
                            <p class="text-sm">${dedup.near_duplicates.potential_near_duplicates} potential near-duplicates found</p>
                        </div>
                    </div>
                    <p class="text-sm diags-muted">SimHash Coverage: ${dedup.near_duplicates.simhash_coverage}</p>
                </div>
            </div>
        `;
    } else {
        content.innerHTML = `
            <div class="p-4 diags-panel-error rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚ùå</span>
                    <div>
                        <h3 class="font-medium">Deduplication Health Check Failed</h3>
                        <p class="text-sm">${data.error || 'Unknown error'}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Services Health Check
async function updateServicesHealth() {
    const data = await runHealthCheck('/services', 'Checking external services...');
    
    const content = document.getElementById('servicesHealthContent');
    if (data.status === 'healthy' && data.services) {
        const services = data.services;
        content.innerHTML = `
            <div class="space-y-4">
                ${Object.entries(services).map(([serviceName, serviceData]) => `
                    <div class="p-4 border rounded-lg ${serviceData.status === 'healthy' ? 'diags-panel-success' : serviceData.status === 'not_configured' ? 'diags-panel-neutral' : 'diags-panel-error'}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">${getHealthStatusIcon(serviceData.status)}</span>
                                <div>
                                    <h3 class="font-medium">${serviceName.toUpperCase()}</h3>
                                    <p class="text-sm">${serviceData.status}</p>
                                </div>
                            </div>
                            ${serviceData.status === 'healthy' ? `
                                <div class="text-right text-sm diags-muted">
                                    ${serviceName === 'lmstudio' ? `
                                        <p class="font-medium">${serviceData.models_available} models available</p>
                                        <p class="text-xs">${serviceData.models.slice(0, 3).join(', ')}${serviceData.models.length > 3 ? '...' : ''}</p>
                                    ` : serviceName === 'langfuse' ? `
                                        <p class="font-medium">${serviceData.configured ? 'Configured' : 'Not configured'}</p>
                                        ${serviceData.message ? `<p class="text-xs">${serviceData.message}</p>` : ''}
                                    ` : serviceName === 'redis' ? `
                                        <p class="font-medium">Memory: ${Math.round(serviceData.info.used_memory / 1024 / 1024)}MB</p>
                                    ` : ''}
                                </div>
                            ` : serviceData.status === 'not_configured' ? `
                                <div class="text-right text-sm diags-muted">
                                    <p class="font-medium">Not Configured</p>
                                    ${serviceData.message ? `<p class="text-xs">${serviceData.message}</p>` : ''}
                                </div>
                            ` : `
                                <div class="text-right text-sm diags-status-error">
                                    <p class="font-medium">Error</p>
                                    <p class="text-xs">${serviceData.error || 'Unknown error'}</p>
                                </div>
                            `}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        content.innerHTML = `
            <div class="p-4 diags-panel-error rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚ùå</span>
                    <div>
                        <h3 class="font-medium">Services Health Check Failed</h3>
                        <p class="text-sm">${data.error || 'Unknown error'}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Celery Health Check
async function updateCeleryHealth() {
    const data = await runHealthCheck('/celery', 'Checking Celery workers...');

    const content = document.getElementById('celeryHealthContent');
    if (data.status === 'healthy' && data.celery) {
        const celery = data.celery;
        content.innerHTML = `
            <div class="space-y-4">
                ${Object.entries(celery).map(([component, componentData]) => `
                    <div class="p-4 border rounded-lg ${componentData.status === 'healthy' ? 'diags-panel-success' : 'diags-panel-error'}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">${getHealthStatusIcon(componentData.status)}</span>
                                <div>
                                    <h3 class="font-medium">${component.toUpperCase()}</h3>
                                    <p class="text-sm">${componentData.status}</p>
                                </div>
                            </div>
                            ${componentData.status === 'healthy' ? `
                                <div class="text-right text-sm diags-muted">
                                    ${component === 'workers' ? `
                                        <p class="font-medium">${componentData.active_workers} active workers</p>
                                    ` : component === 'broker' ? `
                                        <p class="font-medium">${componentData.url}</p>
                                    ` : component === 'result_backend' ? `
                                        <p class="font-medium">${componentData.backend}</p>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="text-right text-sm diags-status-error">
                                    <p class="font-medium">${componentData.error}</p>
                                </div>
                            `}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        content.innerHTML = `
            <div class="p-4 diags-panel-error rounded-lg">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚ùå</span>
                    <div>
                        <h3 class="font-medium">Celery Health Check Failed</h3>
                        <p class="text-sm">${data.error || 'Unknown error'}</p>
                    </div>
                </div>
            </div>
        `;
    }
}



function showError(message) {
    // Simple error display - could be enhanced with a toast notification
    console.error(message);

    // Show error in the UI
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50';
    errorDiv.style.backgroundColor = 'var(--action-danger)';
    errorDiv.style.color = 'var(--text-emphasis)';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);

    // Remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}
</script>
{% endblock %}
