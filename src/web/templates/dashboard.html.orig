{% extends "base.html" %}

{% block title %}Dashboard - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="min-h-screen">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="mt-2 text-sm text-gray-500 dark:text-gray-500">
            Last updated: <span id="last-updated">{{ current_time }}</span>
        </div>
    </div>

    <!-- 3x3 Grid Layout -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        
        <!-- 1. Article Ingestion Health Card -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Article Ingestion Health</h3>
                <div id="health-indicator" class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-400">Uptime</span>
                    <span id="uptime-value" class="font-mono">98.7%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Total Sources</span>
                    <span id="total-sources" class="font-mono">135</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Avg Response</span>
                    <span id="avg-response" class="font-mono">1.42s</span>
                </div>
            </div>
        </div>

        <!-- 2. Volume Chart Card -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg md:col-span-2">
            <h3 class="text-lg font-semibold mb-4">Article Volume</h3>
            <div id="top-articles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm text-gray-400 mb-3">Daily Volume</h4>
                    <div class="h-40"><canvas id="dailyChart"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm text-gray-400 mb-3">Hourly Volume</h4>
                    <div class="h-40"><canvas id="hourlyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- 3. Top Failing Sources -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4">Failing Sources</h3>
            <div id="failing-sources-container" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- 4. High-Score Articles -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg md:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">High-Score Articles (Last 7 Days)</h3>
                <button onclick="copyArticleUrls()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors text-sm font-medium">
                    üìã Copy URLs
                </button>
            </div>
            <div id="high-score-articles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                
                
            </div>
        </div>

        <!-- 5. System Stats -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4">System Stats</h3>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-400">Total Articles</span>
                    <span class="font-mono">{{ stats.total_articles if stats else '0' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Active Sources</span>
                    <span class="font-mono">{{ sources|length if sources else '0' }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Processing Queue</span>
                    <span class="font-mono">12</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Avg Score</span>
                    <span class="font-mono">7.2</span>
                </div>
            </div>
        </div>

        <!-- 6. Recent Activity -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
            <div id="recent-activity-container" class="space-y-2 max-h-48 overflow-y-auto">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- 7. Quick Actions -->
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-lg">
            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <button onclick="rescoreAllArticles()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                    üîÑ Rescore All Articles
                </button>
                <button onclick="runHealthCheck()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                    üîç Run Health Check
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart.js configuration for dark theme (guard if CDN not loaded yet)
    if (window.Chart && window.Chart.defaults) {
        Chart.defaults.color = '#9CA3AF';
        Chart.defaults.borderColor = '#374151';
        Chart.defaults.backgroundColor = '#374151';
    }

    // Global chart instances
    let dailyChart = null;
    let hourlyChart = null;

    // Load dashboard data and update charts
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard/data');
            if (!response.ok) throw new Error('Failed to fetch dashboard data');
            
            const data = await response.json();
            
            // Update health metrics
            document.getElementById('uptime-value').textContent = data.health.uptime + '%';
            document.getElementById('total-sources').textContent = data.health.total_sources;
            document.getElementById('avg-response').textContent = data.health.avg_response_time + 's';
            
            // Update health indicator color
            const indicator = document.getElementById('health-indicator');
            if (data.health.uptime > 95) {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500';
            } else if (data.health.uptime > 80) {
                indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
            }
            
            // Update charts if they exist
            console.log('Updating charts...', data.volume);
            if (dailyChart && data.volume.daily && dailyChart.data && dailyChart.data.datasets && dailyChart.data.datasets[0]) {
                console.log('Daily chart data before:', dailyChart.data.datasets[0].data);
                const dailyKeys = Object.keys(data.volume.daily).sort();
                const dailyValues = dailyKeys.map(key => data.volume.daily[key]);
                dailyChart.data.labels = dailyKeys;
                dailyChart.data.datasets[0].data = dailyValues;
                console.log('Daily chart data after:', dailyChart.data.datasets[0].data);
                dailyChart.update('active');
            } else {
                console.log('Daily chart update failed:', {
                    dailyChart: !!dailyChart,
                    volumeData: !!data.volume.daily,
                    chartData: !!dailyChart?.data,
                    datasets: !!dailyChart?.data?.datasets,
                    dataset0: !!dailyChart?.data?.datasets?.[0]
                });
            }
            
            if (hourlyChart && data.volume.hourly && hourlyChart.data && hourlyChart.data.datasets && hourlyChart.data.datasets[0]) {
                console.log('Hourly chart data before:', hourlyChart.data.datasets[0].data);
                // Sort hourly keys properly (00, 01, 02, etc.)
                const hourlyKeys = Object.keys(data.volume.hourly).sort((a, b) => {
                    const hourA = parseInt(a);
                    const hourB = parseInt(b);
                    return hourA - hourB;
                });
                const hourlyValues = hourlyKeys.map(key => data.volume.hourly[key]);
                hourlyChart.data.labels = hourlyKeys;
                hourlyChart.data.datasets[0].data = hourlyValues;
                console.log('Hourly chart data after:', hourlyChart.data.datasets[0].data);
                hourlyChart.update('active');
            } else {
                console.log('Hourly chart update failed:', {
                    hourlyChart: !!hourlyChart,
                    volumeData: !!data.volume.hourly,
                    chartData: !!hourlyChart?.data,
                    datasets: !!hourlyChart?.data?.datasets,
                    dataset0: !!hourlyChart?.data?.datasets?.[0]
                });
            }
            
            // Update timestamp
            
            // Update Failing Sources
            updateFailingSources();
            
            // Update Recent Activity
            updateRecentActivity(data.recent_activities);
            
            // Update High-Score Articles
            const topArticlesContainer = document.getElementById("high-score-articles-container");
            if (topArticlesContainer && data.top_articles) {
                topArticlesContainer.innerHTML = "";
                // Store articles globally for copy function
                window.currentTopArticles = data.top_articles;
                data.top_articles.forEach(article => {
                    const scoreColor = "text-yellow-400";
                    const card = document.createElement("a");
                    card.href = `/articles/${article.id}`;
                    card.className = "block p-5 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors min-h-[120px]";
                    card.innerHTML = `
                        <div class="flex justify-end items-start mb-3">
                            <span class="text-lg font-mono font-bold ${scoreColor}">${article.hunt_score || 0}</span>
                        </div>
                        <h4 class="font-semibold text-base mb-2 leading-tight">${article.title || "Untitled"}</h4>
                        <p class="text-sm text-gray-400 leading-relaxed">Source: <span class="text-gray-300 font-medium">${article.source_name || "Unknown Source"}</span></p>
                        <p class="text-sm text-gray-400 leading-relaxed">Publication date: ${article.published_at || "Unknown"}</p>
                    `;
                    topArticlesContainer.appendChild(card);
                });
            }
                        document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
        }
    }
    // Expose for base.html auto-refresh
    window.loadDashboardData = loadDashboardData;

    // Copy article URLs to clipboard
    function copyArticleUrls() {
        if (!window.currentTopArticles || window.currentTopArticles.length === 0) {
            alert('No articles to copy');
            return;
        }
        
        const urls = window.currentTopArticles
            .map(article => article.url)
            .filter(url => url) // Remove empty URLs
            .join('\n');
        
        if (!urls) {
            alert('No URLs found in articles');
            return;
        }
        
        navigator.clipboard.writeText(urls).then(() => {
            // Show temporary feedback
            const button = document.querySelector('button[onclick="copyArticleUrls()"]');
            if (button) {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('bg-green-600');
                button.classList.remove('bg-blue-600');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-blue-600');
                }, 2000);
            }
        }).catch(err => {
            console.error('Failed to copy URLs:', err);
            alert('Failed to copy URLs to clipboard');
        });
    }
    window.copyArticleUrls = copyArticleUrls;

    // Initialize charts and start polling (robust to timing/CDN)
    function initCharts() {
        if (window.chartsInitialized) return;
        if (!window.Chart) { setTimeout(initCharts, 300); return; }

        const dailyCanvas = document.getElementById('dailyChart');
        const hourlyCanvas = document.getElementById('hourlyChart');
        if (!dailyCanvas || !hourlyCanvas) { setTimeout(initCharts, 100); return; }
        const dailyCtx = dailyCanvas.getContext('2d');
        const hourlyCtx = hourlyCanvas.getContext('2d');

        // Initialize charts with empty data - will be populated by API
        dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Articles',
                    data: [],
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        displayColors: false,
                        titleFont: { size: 0 },
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                return context.parsed.y;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: { grid: { color: '#374151' } },
                    y: { grid: { color: '#374151' } }
                }
            }
        });

        hourlyChart = new Chart(hourlyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Articles',
                    data: [],
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        displayColors: false,
                        titleFont: { size: 0 },
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                return context.parsed.y;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: { grid: { color: '#374151' } },
                    y: { grid: { color: '#374151' } }
                }
            }
        });

        window.chartsInitialized = true;
        
        // Load data first, then start polling
        loadDashboardData().then(() => {
            setInterval(loadDashboardData, 60000);
        });
    }

    // Function to update failing sources
    async function updateFailingSources() {
        try {
            const response = await fetch('/api/sources/failing');
            if (!response.ok) throw new Error('Failed to fetch failing sources');
            
            const failingSources = await response.json();
            const container = document.getElementById('failing-sources-container');
            
            if (!container) return;
            
            if (failingSources.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">No failing sources</div>';
                return;
            }
            
            container.innerHTML = failingSources.map(source => {
                const bgOpacity = source.consecutive_failures >= 5 ? 'bg-opacity-50' : 
                                 source.consecutive_failures >= 3 ? 'bg-opacity-40' : 'bg-opacity-30';
                const bgColor = source.consecutive_failures >= 5 ? 'bg-red-900' : 
                               source.consecutive_failures >= 3 ? 'bg-red-900' : 'bg-yellow-900';
                
                return `
                    <div class="flex justify-between items-center p-2 rounded ${bgColor} ${bgOpacity}">
                        <div>
                            <div class="font-medium text-sm">${source.source_name}</div>
                            <div class="text-sm text-gray-400 leading-relaxed">${source.consecutive_failures} failures</div>
                        </div>
                        <div class="text-sm text-gray-400 leading-relaxed">${source.last_success}</div>
                    </div>
                `;
            }).join('');
            
        } catch (error) {
            console.error('Error updating failing sources:', error);
            const container = document.getElementById('failing-sources-container');
            if (container) {
                container.innerHTML = '<div class="text-center text-red-400 py-4">Error loading failing sources</div>';
            }
        }
    }

    // Function to update recent activity
    function updateRecentActivity(activities) {
        const container = document.getElementById('recent-activity-container');
        if (!container) return;
        
        if (!activities || activities.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 py-4">No recent activity</div>';
            return;
        }
        
        container.innerHTML = activities.map(activity => {
            const colorClass = activity.color === 'green' ? 'bg-green-500' : 
                              activity.color === 'red' ? 'bg-red-500' : 
                              activity.color === 'yellow' ? 'bg-yellow-500' : 'bg-blue-500';
            
            return `
                <div class="flex items-center space-x-3 text-sm">
                    <div class="w-2 h-2 ${colorClass} rounded-full"></div>
                    <span class="text-gray-400">${activity.time_ago}</span>
                    <span>${activity.message}</span>
                </div>
            `;
        }).join('');
    }

    // Quick Actions functions
    async function rescoreAllArticles() {
        try {
            showNotification('Starting article rescoring...', 'info');
            
            const response = await fetch('/api/actions/rescore-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification(`Rescoring completed: ${result.processed} articles processed`, 'success');
                // Refresh dashboard data
                setTimeout(() => loadDashboardData(), 2000);
            } else {
                const error = await response.json();
                showNotification(`Rescoring failed: ${error.detail}`, 'error');
            }
        } catch (error) {
            showNotification(`Rescoring failed: ${error.message}`, 'error');
        }
    }


    async function runHealthCheck() {
        try {
            showNotification('Navigating to health checks...', 'info');
            
            // Set flag to auto-run checks when health checks page loads
            sessionStorage.setItem('autoRunHealthChecks', 'true');
            
            // Navigate to diagnostics page
            window.location.href = '/diags';
        } catch (error) {
            showNotification(`Navigation failed: ${error.message}`, 'error');
        }
    }


    function showNotification(message, type = 'info') {
        // Simple notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 
            type === 'error' ? 'bg-red-600' : 
            type === 'info' ? 'bg-blue-600' : 'bg-gray-600'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCharts);
    } else {
        initCharts();
    }
</script>
{% endblock %}
