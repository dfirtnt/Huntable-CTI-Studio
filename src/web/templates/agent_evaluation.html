{% extends "base.html" %}

{% block title %}{{ agent_name }} Evaluations - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ agent_name }} Evaluations</h1>
                <p class="text-gray-600 dark:text-gray-400">Performance metrics and improvement tracking</p>
            </div>
            <a href="/evaluations" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                ‚Üê Back to All Evaluations
            </a>
        </div>
    </div>

    <!-- Subagents Section (ExtractAgent only) -->
    {% if agent_name == 'ExtractAgent' %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Subagents</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">ExtractAgent uses specialized subagents for different extraction tasks:</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <a href="/evaluations/ExtractAgent/CmdlineExtract" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">CmdlineExtract</h3>
                    <span class="text-2xl">üíª</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">Command-line patterns and executed commands</p>
            </a>
            <a href="/evaluations/ExtractAgent/ProcTreeExtract" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ProcTreeExtract</h3>
                    <span class="text-2xl">üå≥</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">Process lineage and parent-child relationships</p>
            </a>
            <a href="/evaluations/ExtractAgent/HuntQueriesExtract" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">HuntQueriesExtract</h3>
                    <span class="text-2xl">üîç</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">Hunting queries (KQL, Splunk, Sigma, etc.)</p>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Latest Evaluation Summary -->
    {% if latest %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Latest Evaluation</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Type</div>
                <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ latest.evaluation_type }}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Model</div>
                <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ latest.model_version or 'N/A' }}</div>
            </div>
            <div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Articles Tested</div>
                <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ latest.total_articles }}</div>
            </div>
        </div>
        
        <!-- Metrics Display -->
        <div id="latest-metrics" class="mt-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Key Metrics</h3>
            <div id="metrics-content" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                Loading metrics...
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Evaluation History -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Evaluation History</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Model</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Articles</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="history-table" class="bg-gray-800 border border-gray-700 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for eval in history %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 {% if selected_evaluation and eval.id == selected_evaluation.id %}bg-blue-50 dark:bg-blue-900{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ eval.evaluation_type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ eval.model_version or 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ eval.total_articles }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ eval.created_at[:10] if eval.created_at else 'N/A' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a href="/evaluations/{{ agent_name }}?evaluation_id={{ eval.id }}" class="text-blue-600 dark:text-blue-400 hover:underline mr-3">View</a>
                            {% if loop.index > 1 %}
                            <a href="/evaluations/compare?baseline_id={{ history[loop.index - 1].id }}&current_id={{ eval.id }}" class="text-green-600 dark:text-green-400 hover:underline">Compare</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Selected Evaluation Details -->
    {% if selected_evaluation %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Evaluation Details</h2>
        <div id="evaluation-details">
            <div class="mb-4">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Evaluation ID</div>
                <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ selected_evaluation.id }}</div>
            </div>
            <div class="mb-4">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Type</div>
                <div class="text-lg font-semibold text-gray-900 dark:text-white">{{ selected_evaluation.evaluation_type }}</div>
            </div>
            <div id="metrics-display" class="mt-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Metrics</h3>
                <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm">{{ selected_evaluation.metrics | tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Manual Test Results (ObservablesCountAgent or ExtractAgent) -->
    {% if agent_name == 'ObservablesCountAgent' or agent_name == 'ExtractAgent' %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mt-8" id="observables-count-results">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Model Comparison - Observables Count</h2>
        <div id="observables-results-loading" class="text-gray-500 dark:text-gray-400">Loading observables count results...</div>
        <div id="observables-results-content" class="hidden">
            <!-- Model Summary -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Model Performance Summary</h3>
                <div id="model-summary" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
            </div>
            <!-- Results Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-900 sticky top-0">
                        <tr id="observables-table-header">
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">URL</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Title</th>
                        </tr>
                    </thead>
                    <tbody id="observables-results-table-body" class="bg-gray-800 border border-gray-700 divide-y divide-gray-200 dark:divide-gray-700">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Manual Test Results (OSDetection only) -->
    {% if agent_name == 'OSDetection' %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mt-8" id="manual-test-results">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Manual Test Results - Model Comparison</h2>
        <div id="manual-results-loading" class="text-gray-500 dark:text-gray-400">Loading manual test results...</div>
        <div id="manual-results-content" class="hidden">
            <!-- Accuracy Summary -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Model Accuracy Summary</h3>
                <div id="accuracy-summary" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
            </div>
            <!-- Results Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-900 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">URL</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Title</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Gemini</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Sonnet 4.5</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Haiku 4.5</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">GPT-4o</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">GPT-5.1</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">SEC-BERT</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">CTI-BERT</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">DeepSeek R1</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qwen2-7B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qwen3-4B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Llama 3.1-8B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Llama 3-8B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Llama 3-13B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Llama 3.3-70B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Phi-3 Mini</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Llama 3.2-1B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Mistral-7B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Mixtral 8x7B</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase bg-yellow-100 dark:bg-yellow-900">Human</th>
                        </tr>
                    </thead>
                    <tbody id="manual-results-table-body" class="bg-gray-800 border border-gray-700 divide-y divide-gray-200 dark:divide-gray-700">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Run Evaluation Section -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mt-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Run New Evaluation</h2>
        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg mb-4">
            <p class="text-sm text-gray-700 dark:text-gray-300">
                <strong>Note:</strong> Evaluations should be run via CLI scripts for full control. 
                Use the command below with your test dataset path.
            </p>
        </div>
        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg font-mono text-sm">
            <div class="text-gray-600 dark:text-gray-400 mb-2">Command:</div>
            <div id="eval-command" class="text-gray-900 dark:text-white">
                {% if agent_name == 'ExtractAgent' %}
                python scripts/eval_extract_agent.py --test-data &lt;your_dataset.json&gt; --evaluation-type baseline --save-to-db
                {% elif agent_name == 'RankAgent' %}
                python scripts/eval_rank_agent.py --test-data &lt;your_dataset.json&gt; --evaluation-type baseline --save-to-db
                {% elif agent_name == 'SigmaAgent' %}
                python scripts/eval_sigma_agent.py --test-data &lt;your_dataset.json&gt; --evaluation-type baseline --save-to-db
                {% elif agent_name == 'OSDetection' %}
                python scripts/eval_os_detection.py --test-data &lt;your_dataset.json&gt; --evaluation-type baseline --save-to-db
                {% elif agent_name == 'ObservablesCountAgent' %}
                python scripts/eval_observables_count_multiple_models.py --models deepseek-r1-qwen3-8b mistral-7b qwen2-7b
                {% else %}
                python scripts/eval_&lt;agent&gt;.py --test-data &lt;your_dataset.json&gt; --evaluation-type baseline --save-to-db
                {% endif %}
            </div>
            <button onclick="copyCommand()" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                Copy Command
            </button>
        </div>
    </div>

    <!-- Trend Charts -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mt-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Performance Trends</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <canvas id="trend-chart-1"></canvas>
            </div>
            <div>
                <canvas id="trend-chart-2"></canvas>
            </div>
        </div>
    </div>

    <!-- RankAgent Benchmark Graphs -->
    {% if agent_name == 'RankAgent' %}
    <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-6 mt-8" id="rank-agent-benchmarks">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">üìä Benchmark Graphs</h2>
        <div id="benchmarks-loading" class="text-gray-500 dark:text-gray-400 mb-4">Loading benchmark data...</div>
        <div id="benchmarks-content" class="hidden">
            <!-- Score Distribution and Model Comparison -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Score Distribution</h3>
                    <div class="h-64">
                        <canvas id="score-distribution-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Model Comparison</h3>
                    <div class="h-64">
                        <canvas id="model-comparison-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Threshold Accuracy and Score Mean Trends -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Threshold Accuracy Over Time</h3>
                    <div class="h-64">
                        <canvas id="threshold-accuracy-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Score Mean & Std Dev Trends</h3>
                    <div class="h-64">
                        <canvas id="score-trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function copyCommand() {
    const command = document.getElementById('eval-command').textContent;
    navigator.clipboard.writeText(command).then(() => {
        showNotification('Command copied to clipboard!', 'success');
    });
}
</script>

<script>
// Load latest metrics (getThemeColor from base.html)
{% if latest %}
document.addEventListener('DOMContentLoaded', () => {
    const metrics = {{ latest.metrics | tojson }};
    const agentName = '{{ agent_name }}';
    
    let metricsHtml = '';
    
    if (agentName === 'ExtractAgent') {
        if (metrics.json_validity_rate !== undefined) {
            metricsHtml += `<div class="bg-green-100 dark:bg-green-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">JSON Validity</div><div class="text-2xl font-bold">${(metrics.json_validity_rate * 100).toFixed(1)}%</div></div>`;
        }
        if (metrics.field_completeness_rate !== undefined) {
            metricsHtml += `<div class="bg-blue-100 dark:bg-blue-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Field Completeness</div><div class="text-2xl font-bold">${(metrics.field_completeness_rate * 100).toFixed(1)}%</div></div>`;
        }
        if (metrics.avg_discrete_count !== undefined) {
            metricsHtml += `<div class="bg-purple-100 dark:bg-purple-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Avg Observables</div><div class="text-2xl font-bold">${metrics.avg_discrete_count.toFixed(1)}</div></div>`;
        }
        if (metrics.total_commandlines !== undefined) {
            metricsHtml += `<div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Total Command-lines</div><div class="text-2xl font-bold">${metrics.total_commandlines}</div></div>`;
        }
    } else if (agentName === 'RankAgent') {
        if (metrics.score_mean !== undefined) {
            metricsHtml += `<div class="bg-green-100 dark:bg-green-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Avg Score</div><div class="text-2xl font-bold">${metrics.score_mean.toFixed(2)}</div></div>`;
        }
        if (metrics.threshold_accuracy !== undefined) {
            metricsHtml += `<div class="bg-blue-100 dark:bg-blue-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Threshold Accuracy</div><div class="text-2xl font-bold">${(metrics.threshold_accuracy * 100).toFixed(1)}%</div></div>`;
        }
    } else if (agentName === 'SigmaAgent') {
        if (metrics.avg_huntability_score !== undefined) {
            metricsHtml += `<div class="bg-green-100 dark:bg-green-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Huntability Score</div><div class="text-2xl font-bold">${metrics.avg_huntability_score.toFixed(1)}/10</div></div>`;
        }
        if (metrics.structural_validation_pass_rate !== undefined) {
            metricsHtml += `<div class="bg-blue-100 dark:bg-blue-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Validation Pass Rate</div><div class="text-2xl font-bold">${(metrics.structural_validation_pass_rate * 100).toFixed(1)}%</div></div>`;
        }
        if (metrics.avg_semantic_similarity !== undefined) {
            metricsHtml += `<div class="bg-purple-100 dark:bg-purple-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Semantic Similarity</div><div class="text-2xl font-bold">${(metrics.avg_semantic_similarity * 100).toFixed(1)}%</div></div>`;
        }
    } else if (agentName === 'OSDetection') {
        if (metrics.accuracy !== undefined) {
            metricsHtml += `<div class="bg-green-100 dark:bg-green-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Accuracy</div><div class="text-2xl font-bold">${(metrics.accuracy * 100).toFixed(1)}%</div></div>`;
        }
        if (metrics.avg_confidence !== undefined) {
            metricsHtml += `<div class="bg-blue-100 dark:bg-blue-900 p-3 rounded"><div class="text-xs text-gray-600 dark:text-gray-400">Avg Confidence</div><div class="text-2xl font-bold">${(metrics.avg_confidence * 100).toFixed(1)}%</div></div>`;
        }
    }
    
    document.getElementById('metrics-content').innerHTML = metricsHtml || '<div class="text-gray-500">No metrics available</div>';
    
    // Load trend charts
    loadTrendCharts(agentName);
});
{% endif %}

async function loadTrendCharts(agentName) {
    // Load trends for key metrics
    const metricKeys = agentName === 'ExtractAgent' ? ['json_validity_rate', 'avg_discrete_count'] :
                       agentName === 'RankAgent' ? ['score_mean', 'threshold_accuracy'] :
                       agentName === 'SigmaAgent' ? ['avg_huntability_score', 'structural_validation_pass_rate'] :
                       ['accuracy', 'avg_confidence'];
    
    for (let i = 0; i < 2 && i < metricKeys.length; i++) {
        try {
            const response = await fetch(`/api/eval/trends?agent_name=${agentName}&metric_key=${metricKeys[i]}`);
            if (response.ok) {
                const data = await response.json();
                const trends = data.trends || [];
                
                if (trends.length > 0) {
                    const ctx = document.getElementById(`trend-chart-${i + 1}`).getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trends.map(t => new Date(t.timestamp).toLocaleDateString()),
                            datasets: [{
                                label: metricKeys[i],
                                data: trends.map(t => t.value),
                                borderColor: getThemeColor('--action-info') || 'rgb(59, 130, 246)',
                                backgroundColor: getThemeColor('--action-info-fill') || 'rgba(59, 130, 246, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: metricKeys[i].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                                }
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error(`Error loading trend for ${metricKeys[i]}:`, error);
        }
    }
}

// Load observables count results for ObservablesCountAgent or ExtractAgent
{% if agent_name == 'ObservablesCountAgent' or agent_name == 'ExtractAgent' %}
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/eval/observables-count-results');
        const data = await response.json();
        
        if (data.success && data.results && data.models) {
            // Display model summary
            const modelSummary = document.getElementById('model-summary');
            let summaryHtml = '';
            
            // Sort models by parse success rate
            const sortedModels = data.models.sort((a, b) => {
                const aRate = data.model_summaries[a]?.parse_success_rate || 0;
                const bRate = data.model_summaries[b]?.parse_success_rate || 0;
                return bRate - aRate;
            });
            
            for (const modelKey of sortedModels) {
                const summary = data.model_summaries[modelKey];
                if (!summary) continue;
                
                const parseRate = summary.parse_success_rate || 0;
                const avgTotal = summary.avg_total_observables || 0;
                
                const colorClass = parseRate >= 0.9 ? 'bg-green-100 dark:bg-green-900' : 
                                 parseRate >= 0.7 ? 'bg-yellow-100 dark:bg-yellow-900' : 
                                 'bg-red-100 dark:bg-red-900';
                
                summaryHtml += `
                    <div class="${colorClass} p-3 rounded">
                        <div class="text-xs text-gray-600 dark:text-gray-400">${summary.description || modelKey}</div>
                        <div class="text-xl font-bold">${(parseRate * 100).toFixed(1)}%</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Avg: ${avgTotal.toFixed(1)}</div>
                    </div>
                `;
            }
            modelSummary.innerHTML = summaryHtml || '<div class="text-gray-500">No model data available</div>';
            
            // Build table header with model columns
            const headerRow = document.getElementById('observables-table-header');
            let headerHtml = `
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">URL</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Title</th>
            `;
            for (const modelKey of sortedModels) {
                const summary = data.model_summaries[modelKey];
                const displayName = summary?.description || modelKey;
                headerHtml += `<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">${displayName}</th>`;
            }
            headerRow.innerHTML = headerHtml;
            
            // Display results table
            const tbody = document.getElementById('observables-results-table-body');
            let tableHtml = '';
            
            for (const row of data.results) {
                tableHtml += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-3 py-2 text-xs">
                            <a href="${row.url}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline max-w-xs truncate block">
                                ${row.url.length > 40 ? row.url.substring(0, 40) + '...' : row.url}
                            </a>
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900 dark:text-white max-w-xs truncate" title="${row.title}">
                            ${row.title}
                        </td>
                `;
                
                // Add model columns
                for (const modelKey of sortedModels) {
                    const modelResult = row.models[modelKey];
                    if (!modelResult) {
                        tableHtml += `<td class="px-3 py-2 text-center text-xs text-gray-400">-</td>`;
                    } else if (modelResult.parse_success && modelResult.total !== null) {
                        const total = modelResult.total;
                        const colorClass = total > 0 ? 'text-green-600 dark:text-green-400 font-semibold' : 'text-gray-400';
                        tableHtml += `<td class="px-3 py-2 text-center text-xs ${colorClass}">${total}</td>`;
                    } else {
                        tableHtml += `<td class="px-3 py-2 text-center text-xs text-red-600 dark:text-red-400">‚úó</td>`;
                    }
                }
                
                tableHtml += `</tr>`;
            }
            
            tbody.innerHTML = tableHtml;
            document.getElementById('observables-results-loading').classList.add('hidden');
            document.getElementById('observables-results-content').classList.remove('hidden');
        } else {
            const loadingEl = document.getElementById('observables-results-loading');
            if (data.error) {
                loadingEl.textContent = `No results available yet. Run the evaluation script to generate results. Error: ${data.error}`;
            } else {
                loadingEl.textContent = 'No observables count results available. Run the evaluation script to generate results.';
            }
            loadingEl.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading observables count results:', error);
        const loadingEl = document.getElementById('observables-results-loading');
        loadingEl.textContent = `Error loading observables count results: ${error.message}. Make sure to run the evaluation script first.`;
        loadingEl.classList.remove('hidden');
    }
});
{% endif %}

// Load benchmark graphs for RankAgent
{% if agent_name == 'RankAgent' %}
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/eval/rank-agent-benchmarks');
        const data = await response.json();
        
        if (data.success) {
            // Render score distribution chart
            if (data.score_distribution && data.score_distribution.mean !== null) {
                renderScoreDistributionChart(data.score_distribution);
            }
            
            // Render model comparison chart
            if (data.model_comparison && Object.keys(data.model_comparison).length > 0) {
                renderModelComparisonChart(data.model_comparison);
            }
            
            // Render threshold accuracy chart
            if (data.threshold_accuracy_trends && data.threshold_accuracy_trends.length > 0) {
                renderThresholdAccuracyChart(data.threshold_accuracy_trends);
            }
            
            // Render score trends chart
            if (data.score_mean_trends && data.score_std_trends) {
                renderScoreTrendsChart(data.score_mean_trends, data.score_std_trends);
            }
            
            document.getElementById('benchmarks-loading').classList.add('hidden');
            document.getElementById('benchmarks-content').classList.remove('hidden');
        } else {
            document.getElementById('benchmarks-loading').textContent = data.message || 'No benchmark data available';
        }
    } catch (error) {
        console.error('Error loading benchmark data:', error);
        document.getElementById('benchmarks-loading').textContent = 'Error loading benchmark data';
    }
});

function renderScoreDistributionChart(distribution) {
    const ctx = document.getElementById('score-distribution-chart').getContext('2d');
    
    const mean = distribution.mean || 0;
    const std = distribution.std || 0;
    const min = distribution.min || 0;
    const max = distribution.max || 10;
    
    // Use actual buckets if available, otherwise show summary stats
    let buckets;
    if (distribution.buckets && Array.isArray(distribution.buckets)) {
        buckets = distribution.buckets;
    } else {
        // Fallback: create approximation from summary stats
        buckets = Array(11).fill(0);
        if (mean !== null && mean !== undefined) {
            // Simple approximation: place peak at mean, spread based on std
            const meanBucket = Math.round(Math.min(Math.max(mean, 0), 10));
            buckets[meanBucket] = 10; // Peak value
            
            // Add some spread if std is available
            if (std && std > 0) {
                for (let i = 0; i <= 10; i++) {
                    if (i !== meanBucket) {
                        const distance = Math.abs(i - mean);
                        buckets[i] = Math.max(0, Math.round(10 * Math.exp(-(distance * distance) / (2 * std * std))));
                    }
                }
            }
        }
    }
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 11}, (_, i) => i),
            datasets: [{
                label: 'Score Distribution',
                data: buckets,
                backgroundColor: getThemeColor('--chart-blue-fill') || 'rgba(59, 130, 246, 0.6)',
                borderColor: getThemeColor('--action-info') || 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Score (0-10)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            if (mean !== null && std !== null) {
                                return `Mean: ${mean.toFixed(2)}, Std: ${std.toFixed(2)}`;
                            }
                            return '';
                        }
                    }
                }
            }
        }
    });
}

function renderModelComparisonChart(modelComparison) {
    const ctx = document.getElementById('model-comparison-chart').getContext('2d');
    
    const models = Object.keys(modelComparison);
    const scoreMeans = models.map(m => modelComparison[m].avg_score_mean || 0);
    const accuracies = models.map(m => (modelComparison[m].avg_threshold_accuracy || 0) * 100);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: models,
            datasets: [{
                label: 'Avg Score Mean',
                data: scoreMeans,
                backgroundColor: getThemeColor('--chart-blue-fill') || 'rgba(59, 130, 246, 0.6)',
                borderColor: getThemeColor('--action-info') || 'rgb(59, 130, 246)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Threshold Accuracy (%)',
                data: accuracies,
                backgroundColor: getThemeColor('--chart-green-fill') || 'rgba(34, 197, 94, 0.6)',
                borderColor: getThemeColor('--action-success-light') || 'rgb(34, 197, 94)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    max: 10,
                    title: {
                        display: true,
                        text: 'Score Mean'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Accuracy (%)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function renderThresholdAccuracyChart(trends) {
    const ctx = document.getElementById('threshold-accuracy-chart').getContext('2d');
    
    const sortedTrends = trends.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedTrends.map(t => new Date(t.timestamp).toLocaleDateString()),
            datasets: [{
                label: 'Threshold Accuracy',
                data: sortedTrends.map(t => (t.value || 0) * 100),
                borderColor: getThemeColor('--action-success-light') || 'rgb(34, 197, 94)',
                backgroundColor: getThemeColor('--action-execute-fill') || 'rgba(34, 197, 94, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Accuracy (%)'
                    }
                }
            }
        }
    });
}

function renderScoreTrendsChart(meanTrends, stdTrends) {
    const ctx = document.getElementById('score-trends-chart').getContext('2d');
    
    const sortedMean = meanTrends.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    const sortedStd = stdTrends.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedMean.map(t => new Date(t.timestamp).toLocaleDateString()),
            datasets: [{
                label: 'Score Mean',
                data: sortedMean.map(t => t.value || 0),
                borderColor: getThemeColor('--action-info') || 'rgb(59, 130, 246)',
                backgroundColor: getThemeColor('--action-info-fill') || 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                yAxisID: 'y'
            }, {
                label: 'Score Std Dev',
                data: sortedStd.map(t => t.value || 0),
                borderColor: getThemeColor('--action-danger') || 'rgb(239, 68, 68)',
                backgroundColor: getThemeColor('--action-danger-fill') || 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    max: 10,
                    title: {
                        display: true,
                        text: 'Score Mean'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Std Dev'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}
{% endif %}

// Load manual test results for OSDetection
{% if agent_name == 'OSDetection' %}
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/eval/os-detection-manual-results');
        const data = await response.json();
        
        if (data.success && data.results) {
            // Display accuracy summary
            const accuracySummary = document.getElementById('accuracy-summary');
            const modelNames = {
                'gemini': 'Gemini',
                'sonnet_4_5': 'Sonnet 4.5',
                'haiku_4_5': 'Haiku 4.5',
                'chatgpt4o': 'GPT-4o',
                'chatgpt5_1': 'GPT-5.1',
                'sec_bert': 'SEC-BERT',
                'cti_bert': 'CTI-BERT',
                'deepseek_r1': 'DeepSeek R1',
                'qwen2_7b': 'Qwen2-7B',
                'qwen3_4b': 'Qwen3-4B',
                'llama_3_1_8b': 'Llama 3.1-8B',
                'llama_3_8b': 'Llama 3-8B',
                'llama_3_13b': 'Llama 3-13B',
                'llama_3_3_70b': 'Llama 3.3-70B',
                'phi_3_mini': 'Phi-3 Mini',
                'llama_3_2_1b': 'Llama 3.2-1B',
                'mistral_7b': 'Mistral-7B',
                'mixtral_8x7b': 'Mixtral 8x7B'
            };
            
            let summaryHtml = '';
            for (const [key, name] of Object.entries(modelNames)) {
                const accuracy = data.accuracies[key];
                if (accuracy !== undefined) {
                    const colorClass = accuracy >= 0.9 ? 'bg-green-100 dark:bg-green-900' : 
                                     accuracy >= 0.7 ? 'bg-yellow-100 dark:bg-yellow-900' : 
                                     'bg-red-100 dark:bg-red-900';
                    summaryHtml += `
                        <div class="${colorClass} p-3 rounded">
                            <div class="text-xs text-gray-600 dark:text-gray-400">${name}</div>
                            <div class="text-xl font-bold">${(accuracy * 100).toFixed(1)}%</div>
                        </div>
                    `;
                }
            }
            accuracySummary.innerHTML = summaryHtml || '<div class="text-gray-500">No accuracy data available</div>';
            
            // Display results table
            const tbody = document.getElementById('manual-results-table-body');
            let tableHtml = '';
            
            for (const row of data.results) {
                const human = row.human;
                const getCellClass = (value) => {
                    if (!value || value === 'Unknown') return 'text-gray-400';
                    return value === human ? 'text-green-600 dark:text-green-400 font-semibold' : 'text-red-600 dark:text-red-400';
                };
                
                const getCellContent = (value) => {
                    if (!value || value === 'Unknown') return '-';
                    const match = value === human;
                    return match ? `‚úì ${value}` : value;
                };
                
                tableHtml += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-3 py-2 text-xs">
                            <a href="${row.url}" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline max-w-xs truncate block">
                                ${row.url.length > 40 ? row.url.substring(0, 40) + '...' : row.url}
                            </a>
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900 dark:text-white max-w-xs truncate" title="${row.title}">
                            ${row.title}
                        </td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.gemini)}">${getCellContent(row.gemini)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.sonnet_4_5)}">${getCellContent(row.sonnet_4_5)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.haiku_4_5)}">${getCellContent(row.haiku_4_5)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.chatgpt4o)}">${getCellContent(row.chatgpt4o)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.chatgpt5_1)}">${getCellContent(row.chatgpt5_1)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.sec_bert)}">${getCellContent(row.sec_bert)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.cti_bert)}">${getCellContent(row.cti_bert)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.deepseek_r1)}">${getCellContent(row.deepseek_r1)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.qwen2_7b)}">${getCellContent(row.qwen2_7b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.qwen3_4b)}">${getCellContent(row.qwen3_4b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.llama_3_1_8b)}">${getCellContent(row.llama_3_1_8b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.llama_3_8b)}">${getCellContent(row.llama_3_8b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.llama_3_13b)}">${getCellContent(row.llama_3_13b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.llama_3_3_70b)}">${getCellContent(row.llama_3_3_70b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.phi_3_mini)}">${getCellContent(row.phi_3_mini)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.llama_3_2_1b)}">${getCellContent(row.llama_3_2_1b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.mistral_7b)}">${getCellContent(row.mistral_7b)}</td>
                        <td class="px-3 py-2 text-center text-xs ${getCellClass(row.mixtral_8x7b)}">${getCellContent(row.mixtral_8x7b)}</td>
                        <td class="px-3 py-2 text-center text-xs font-bold text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900">${human}</td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = tableHtml;
            document.getElementById('manual-results-loading').classList.add('hidden');
            document.getElementById('manual-results-content').classList.remove('hidden');
        } else {
            document.getElementById('manual-results-loading').textContent = 'No manual test results available';
        }
    } catch (error) {
        console.error('Error loading manual test results:', error);
        document.getElementById('manual-results-loading').textContent = 'Error loading manual test results';
    }
});
{% endif %}
</script>
{% endblock %}

