{% extends "base.html" %}

{% block title %}Scraper Metrics - Analytics - Huntable Detection Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/analytics" class="text-gray-700 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400">Analytics</a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-1 text-gray-500 md:ml-2 dark:text-gray-400">Scraper Metrics</span>
                    </div>
                </li>
            </ol>
        </nav>
        
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">‚ö° Scraper Metrics</h1>
        <p class="text-gray-600 dark:text-gray-400">Monitor article collection performance and source health</p>
    </div>

    <!-- Metrics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Articles Today</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="articlesToday">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Sources</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="activeSources">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                    <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Response Time</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="avgResponseTime">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-red-100 dark:bg-red-900 rounded-lg">
                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Error Rate</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="errorRate">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Collection Rate Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìà Collection Rate (Last 7 Days)</h3>
            <div class="h-64">
                <canvas id="collectionRateChart"></canvas>
            </div>
        </div>

        <!-- Source Health Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üè• Source Health Distribution</h3>
            <div class="h-64">
                <canvas id="sourceHealthChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Ingestion Analytics Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Hunt Score Ranges Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üéØ Hunt Score Ranges (Last 30 Days)</h3>
            <div class="h-64">
                <canvas id="huntScoreChart"></canvas>
            </div>
        </div>

        <!-- Hourly Distribution Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üïê Hourly Distribution (Today)</h3>
            <div class="h-64">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Source Performance Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">üìä Source Performance Details</h3>
                <button id="sourcePerformanceToggle" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                    <svg class="w-5 h-5 transform transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="sourcePerformanceContent" class="overflow-x-auto hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Source</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Articles Today</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Success</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Error Rate</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Avg Response</th>
                    </tr>
                </thead>
                <tbody id="sourcePerformanceTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Table content will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Article Ingestion Analytics -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mt-8">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">üìä Article Ingestion Analytics</h3>
                <button id="ingestionAnalyticsToggle" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                    <svg class="w-5 h-5 transform transition-transform duration-200 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="ingestionAnalyticsContent" class="p-6 hidden">
            <div class="text-gray-600 dark:text-gray-400">
                Click "Load Analytics" to view article collection trends
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load scraper metrics data
async function loadScraperMetrics() {
    try {
        // Load overview metrics
        const overviewResponse = await fetch('/api/analytics/scraper/overview');
        const overviewData = await overviewResponse.json();
        
        document.getElementById('articlesToday').textContent = overviewData.articles_today || '-';
        document.getElementById('activeSources').textContent = overviewData.active_sources || '-';
        document.getElementById('avgResponseTime').textContent = overviewData.avg_response_time ? 
            overviewData.avg_response_time + 'ms' : '-';
        document.getElementById('errorRate').textContent = overviewData.error_rate ? 
            overviewData.error_rate + '%' : '-';

        // Load collection rate chart data
        const collectionResponse = await fetch('/api/analytics/scraper/collection-rate');
        const collectionData = await collectionResponse.json();
        renderCollectionRateChart(collectionData);

        // Load source health chart data
        const healthResponse = await fetch('/api/analytics/scraper/source-health');
        const healthData = await healthResponse.json();
        renderSourceHealthChart(healthData);

        // Load source performance table
        const performanceResponse = await fetch('/api/analytics/scraper/source-performance');
        const performanceData = await performanceResponse.json();
        renderSourcePerformanceTable(performanceData);

        // Load ingestion analytics for charts
        const ingestionResponse = await fetch('/api/health/ingestion');
        const ingestionData = await ingestionResponse.json();
        if (ingestionData.status === 'healthy' && ingestionData.ingestion) {
            renderIngestionCharts(ingestionData.ingestion);
            renderIngestionAnalytics(ingestionData.ingestion);
        }

    } catch (error) {
        console.error('Failed to load scraper metrics:', error);
    }
}

// Render collection rate chart
function renderCollectionRateChart(data) {
    const ctx = document.getElementById('collectionRateChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels || [],
            datasets: [{
                label: 'Articles Collected',
                data: data.values || [],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Render source health chart
function renderSourceHealthChart(data) {
    const ctx = document.getElementById('sourceHealthChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels || [],
            datasets: [{
                data: data.values || [],
                backgroundColor: [
                    'rgb(34, 197, 94)',  // Green for healthy
                    'rgb(251, 191, 36)', // Yellow for warning
                    'rgb(239, 68, 68)'   // Red for error
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Render source performance table
function renderSourcePerformanceTable(data) {
    const tbody = document.getElementById('sourcePerformanceTable');
    tbody.innerHTML = '';

    data.sources?.forEach(source => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                ${source.name}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                    source.status === 'healthy' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                    source.status === 'warning' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                }">
                    ${source.status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${source.articles_today || 0}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${source.last_success || 'Never'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${source.error_rate ? source.error_rate + '%' : '0%'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${source.avg_response ? source.avg_response + 'ms' : '-'}
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Render ingestion analytics content
function renderIngestionAnalytics(ingestion) {
    const content = document.getElementById('ingestionAnalyticsContent');
    if (!content) return;
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Summary Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-medium text-blue-900">Total Articles</h3>
                    <p class="text-2xl font-bold text-blue-600">${ingestion.total_stats.total_articles.toLocaleString()}</p>
                </div>
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-medium text-green-900">Active Sources</h3>
                    <p class="text-2xl font-bold text-green-600">${ingestion.total_stats.total_sources}</p>
                </div>
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h3 class="font-medium text-purple-900">Earliest Article</h3>
                    <p class="text-sm font-bold text-purple-600">${ingestion.total_stats.earliest_article ? new Date(ingestion.total_stats.earliest_article).toLocaleDateString() : 'N/A'}</p>
                </div>
                <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                    <h3 class="font-medium text-orange-900">Latest Article</h3>
                    <p class="text-sm font-bold text-orange-600">${ingestion.total_stats.latest_article ? new Date(ingestion.total_stats.latest_article).toLocaleDateString() : 'N/A'}</p>
                </div>
            </div>

            <!-- Source Breakdown -->
            <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                <h3 class="font-medium text-slate-900 mb-4">üì∞ Top Sources (Last 7 Days)</h3>
                <div class="space-y-3">
                    ${ingestion.source_breakdown.map(source => `
                        <div class="p-3 bg-white rounded border border-slate-200">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-slate-900">${source.source_name}</span>
                                <span class="text-sm font-bold text-blue-600">${source.articles_count} articles</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                <div class="text-center p-2 bg-blue-50 rounded">
                                    <div class="font-medium text-blue-900">Average Hunt Score</div>
                                    <div class="text-lg font-bold ${source.avg_hunt_score >= 60 ? 'text-green-600' : source.avg_hunt_score >= 40 ? 'text-yellow-600' : 'text-red-600'}">${source.avg_hunt_score.toFixed(1)}</div>
                                </div>
                                <div class="text-center p-2 bg-green-50 rounded">
                                    <div class="font-medium text-green-900">Chosen</div>
                                    <div class="text-sm font-bold text-green-600">${source.chosen_ratio}</div>
                                    <div class="text-xs text-gray-600">${source.chosen_count}</div>
                                </div>
                                <div class="text-center p-2 bg-red-50 rounded">
                                    <div class="font-medium text-red-900">Rejected</div>
                                    <div class="text-sm font-bold text-red-600">${source.rejected_ratio}</div>
                                    <div class="text-xs text-gray-600">${source.rejected_count}</div>
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded">
                                    <div class="font-medium text-gray-900">Unclassified</div>
                                    <div class="text-sm font-bold text-gray-600">${source.unclassified_ratio}</div>
                                    <div class="text-xs text-gray-600">${source.unclassified_count}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// Render ingestion analytics charts
function renderIngestionCharts(ingestion) {
    // Prepare hunt score ranges data
    const huntScoreLabels = ingestion.hunt_score_ranges.map(item => item.date).reverse();
    const excellentData = ingestion.hunt_score_ranges.map(item => item.excellent).reverse();
    const goodData = ingestion.hunt_score_ranges.map(item => item.good).reverse();
    const moderateData = ingestion.hunt_score_ranges.map(item => item.moderate).reverse();
    const lowData = ingestion.hunt_score_ranges.map(item => item.low).reverse();
    const minimalData = ingestion.hunt_score_ranges.map(item => item.minimal).reverse();
    
    // Prepare hourly distribution data
    const hourlyLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
    const hourlyData = Array.from({length: 24}, (_, i) => {
        const hourData = ingestion.hourly_distribution.find(h => h.hour === i);
        return hourData ? hourData.articles_count : 0;
    });
    
    // Create charts
    createHuntScoreChart(huntScoreLabels, excellentData, goodData, moderateData, lowData, minimalData);
    createHourlyChart(hourlyLabels, hourlyData);
}

// Chart creation functions
function createHuntScoreChart(labels, excellentData, goodData, moderateData, lowData, minimalData) {
    const ctx = document.getElementById('huntScoreChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Excellent (80-100)',
                data: excellentData,
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }, {
                label: 'Good (60-79)',
                data: goodData,
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }, {
                label: 'Moderate (40-59)',
                data: moderateData,
                backgroundColor: 'rgba(251, 191, 36, 0.8)',
                borderColor: 'rgb(251, 191, 36)',
                borderWidth: 1
            }, {
                label: 'Low (20-39)',
                data: lowData,
                backgroundColor: 'rgba(249, 115, 22, 0.8)',
                borderColor: 'rgb(249, 115, 22)',
                borderWidth: 1
            }, {
                label: 'Minimal (0-19)',
                data: minimalData,
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: 'rgb(239, 68, 68)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    type: 'logarithmic',
                    beginAtZero: true,
                    min: 1
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

function createHourlyChart(labels, data) {
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Articles',
                data: data,
                backgroundColor: 'rgba(147, 51, 234, 0.8)',
                borderColor: 'rgb(147, 51, 234)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Toggle functionality for Source Performance Details and Ingestion Analytics panels
document.addEventListener('DOMContentLoaded', function() {
    // Source Performance toggle
    const sourceToggleButton = document.getElementById('sourcePerformanceToggle');
    const sourceContent = document.getElementById('sourcePerformanceContent');
    const sourceIcon = sourceToggleButton?.querySelector('svg');
    
    if (sourceToggleButton && sourceContent && sourceIcon) {
        sourceToggleButton.addEventListener('click', function() {
            const isHidden = sourceContent.classList.contains('hidden');
            
            if (isHidden) {
                sourceContent.classList.remove('hidden');
                sourceIcon.style.transform = 'rotate(0deg)';
            } else {
                sourceContent.classList.add('hidden');
                sourceIcon.style.transform = 'rotate(180deg)';
            }
        });
    }

    // Ingestion Analytics toggle
    const analyticsToggleButton = document.getElementById('ingestionAnalyticsToggle');
    const analyticsContent = document.getElementById('ingestionAnalyticsContent');
    const analyticsIcon = analyticsToggleButton?.querySelector('svg');
    
    if (analyticsToggleButton && analyticsContent && analyticsIcon) {
        analyticsToggleButton.addEventListener('click', function() {
            const isHidden = analyticsContent.classList.contains('hidden');
            
            if (isHidden) {
                analyticsContent.classList.remove('hidden');
                analyticsIcon.style.transform = 'rotate(0deg)';
            } else {
                analyticsContent.classList.add('hidden');
                analyticsIcon.style.transform = 'rotate(180deg)';
            }
        });
    }
});

// Load metrics on page load
document.addEventListener('DOMContentLoaded', loadScraperMetrics);
</script>
{% endblock %}
