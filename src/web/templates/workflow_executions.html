{% extends "base.html" %}

{% block title %}Workflow Executions - Huntable CTI Scraper{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üîÑ Workflow Executions</h1>
                <p class="text-gray-600 dark:text-gray-400">Monitor agentic workflow execution history and status</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="refreshExecutions()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                    üîÑ Refresh
                </button>
                <select id="statusFilter" onchange="filterExecutions()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Workflow Visualization -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">üîÄ LangGraph Workflow State Machine</h2>
        <div id="workflowVisualization" class="relative bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
            <svg viewBox="0 0 900 350" class="w-full h-auto">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#6b7280"/>
                    </marker>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <!-- Edges/Arrows -->
                <g stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)">
                    <!-- Step 0 -> Step 1 -->
                    <line x1="150" y1="175" x2="250" y2="175"/>
                    <!-- Step 1 -> Decision -->
                    <line x1="350" y1="175" x2="420" y2="175"/>
                    <!-- Decision -> Step 2 (if continue) -->
                    <line x1="440" y1="165" x2="540" y2="100"/>
                    <text x="490" y="130" fill="#10b981" font-size="10">Score ‚â• 6</text>
                    <!-- Step 2 -> Step 3 -->
                    <line x1="640" y1="125" x2="740" y2="125"/>
                    <!-- Step 3 -> Step 4 -->
                    <line x1="790" y1="155" x2="790" y2="220"/>
                    <!-- Step 4 -> Step 5 -->
                    <line x1="540" y1="250" x2="440" y2="250"/>
                    <!-- Decision -> End (if stop) -->
                    <line x1="440" y1="185" x2="440" y2="300" stroke-dasharray="5,5"/>
                    <line x1="440" y1="300" x2="900" y2="300" stroke-dasharray="5,5"/>
                    <text x="670" y="295" fill="#ef4444" font-size="10">Score &lt; 6 ‚Üí End</text>
                </g>
                
                <!-- Nodes -->
                <g id="workflowNodes">
                    <!-- Step 0: Junk Filter -->
                    <rect x="50" y="145" width="100" height="60" rx="8" fill="#3b82f6" class="workflow-node" data-step="junk_filter"/>
                    <text x="100" y="165" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 0</text>
                    <text x="100" y="185" text-anchor="middle" fill="white" font-size="10">Junk Filter</text>
                    
                    <!-- Step 1: Rank Article -->
                    <rect x="250" y="145" width="100" height="60" rx="8" fill="#10b981" class="workflow-node" data-step="rank_article"/>
                    <text x="300" y="165" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 1</text>
                    <text x="300" y="185" text-anchor="middle" fill="white" font-size="10">LLM Rank</text>
                    
                    <!-- Conditional Decision Diamond -->
                    <polygon points="420,175 460,155 460,195 420,215" fill="#f59e0b" stroke="#92400e" stroke-width="2"/>
                    <text x="440" y="178" text-anchor="middle" fill="white" font-weight="bold" font-size="9">‚â•6?</text>
                    
                    <!-- Step 2: Extract Agent -->
                    <rect x="540" y="70" width="100" height="60" rx="8" fill="#f59e0b" class="workflow-node" data-step="extract_agent"/>
                    <text x="590" y="90" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 2</text>
                    <text x="590" y="110" text-anchor="middle" fill="white" font-size="10">Extract</text>
                    
                    <!-- Step 3: Generate SIGMA -->
                    <rect x="740" y="95" width="100" height="60" rx="8" fill="#ef4444" class="workflow-node" data-step="generate_sigma"/>
                    <text x="790" y="115" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 3</text>
                    <text x="790" y="135" text-anchor="middle" fill="white" font-size="10">Generate</text>
                    <text x="790" y="150" text-anchor="middle" fill="white" font-size="10">SIGMA</text>
                    
                    <!-- Step 4: Similarity Search -->
                    <rect x="540" y="220" width="100" height="60" rx="8" fill="#ec4899" class="workflow-node" data-step="similarity_search"/>
                    <text x="590" y="240" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 4</text>
                    <text x="590" y="260" text-anchor="middle" fill="white" font-size="10">Similarity</text>
                    
                    <!-- Step 5: Queue -->
                    <rect x="340" y="220" width="100" height="60" rx="8" fill="#8b5cf6" class="workflow-node" data-step="promote_to_queue"/>
                    <text x="390" y="240" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 5</text>
                    <text x="390" y="260" text-anchor="middle" fill="white" font-size="10">Queue</text>
                    
                    <!-- Queue -> End -->
                    <line x1="340" y1="250" x2="200" y2="300" stroke-dasharray="3,3"/>
                    <line x1="200" y1="300" x2="900" y2="300" stroke-dasharray="3,3"/>
                    
                    <!-- End Node -->
                    <circle cx="900" cy="300" r="25" fill="#6b7280"/>
                    <text x="900" y="306" text-anchor="middle" fill="white" font-weight="bold" font-size="12">END</text>
                </g>
            </svg>
            
            <!-- Legend -->
            <div class="mt-4 grid grid-cols-6 gap-2 text-xs">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span>Filter</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span>Rank</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                    <span>Extract</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                    <span>SIGMA</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-pink-500 rounded"></div>
                    <span>Similarity</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                    <span>Queue</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div id="executionStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Total Executions</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="totalExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Running</div>
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="runningExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="completedExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Failed</div>
            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="failedExecutions">-</div>
        </div>
    </div>

    <!-- Executions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Article</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Current Step</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ranking Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="executionsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Execution Detail Modal -->
    <div id="executionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Execution Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div id="executionDetailContent" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
let executions = [];

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>',
        'running': '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:bg-blue-200">Running</span>',
        'completed': '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:bg-green-200">Completed</span>',
        'failed': '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:bg-red-200">Failed</span>'
    };
    return badges[status] || '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">' + status + '</span>';
}

function getStepBadge(step) {
    const steps = {
        'junk_filter': 'üîç Filter',
        'rank_article': 'üìä Rank',
        'extract_agent': 'üî¨ Extract',
        'generate_sigma': '‚ö° SIGMA',
        'similarity_search': 'üîé Similarity',
        'promote_to_queue': 'üì• Queue'
    };
    return steps[step] || step || '-';
}

async function loadExecutions() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        const url = statusFilter ? `/api/workflow/executions?status=${statusFilter}` : '/api/workflow/executions';
        
        const response = await fetch(url);
        if (response.ok) {
            executions = await response.json();
            renderExecutions();
            updateStats();
        }
    } catch (error) {
        console.error('Error loading executions:', error);
    }
}

function renderExecutions() {
    const tbody = document.getElementById('executionsTableBody');
    
    if (executions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No executions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = executions.map(exec => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${exec.id}</td>
            <td class="px-6 py-4 text-sm">
                <a href="/articles/${exec.article_id}" class="text-purple-600 hover:text-purple-800 dark:text-purple-400">
                    ${exec.article_title || 'Article ' + exec.article_id}
                </a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(exec.status)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${getStepBadge(exec.current_step)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                ${exec.ranking_score ? exec.ranking_score.toFixed(1) : '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${new Date(exec.created_at).toLocaleString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button onclick="viewExecution(${exec.id})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 mr-2">View</button>
                ${exec.status === 'failed' ? `<button onclick="retryExecution(${exec.id})" class="text-green-600 hover:text-green-800 dark:text-green-400">Retry</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function updateStats() {
    const stats = {
        total: executions.length,
        running: executions.filter(e => e.status === 'running').length,
        completed: executions.filter(e => e.status === 'completed').length,
        failed: executions.filter(e => e.status === 'failed').length
    };
    
    document.getElementById('totalExecutions').textContent = stats.total;
    document.getElementById('runningExecutions').textContent = stats.running;
    document.getElementById('completedExecutions').textContent = stats.completed;
    document.getElementById('failedExecutions').textContent = stats.failed;
}

function highlightCurrentStep(step) {
    // Remove all highlights
    document.querySelectorAll('.workflow-node').forEach(node => {
        node.style.filter = 'none';
        node.style.stroke = 'none';
        node.style.strokeWidth = '0';
    });
    
    // Highlight current step
    if (step) {
        const node = document.querySelector(`[data-step="${step}"]`);
        if (node) {
            node.style.filter = 'url(#glow)';
            node.style.stroke = '#fbbf24';
            node.style.strokeWidth = '3';
        }
    }
}

async function viewExecution(executionId) {
    try {
        const response = await fetch(`/api/workflow/executions/${executionId}`);
        if (response.ok) {
            const exec = await response.json();
            
            // Highlight current step in visualization
            highlightCurrentStep(exec.current_step);
            
            const content = `
                <div class="space-y-4">
                    <div><strong>Execution ID:</strong> ${exec.id}</div>
                    <div><strong>Article:</strong> <a href="/articles/${exec.article_id}" class="text-purple-600">${exec.article_title}</a></div>
                    <div><strong>Status:</strong> ${getStatusBadge(exec.status)}</div>
                    <div><strong>Current Step:</strong> ${getStepBadge(exec.current_step)}</div>
                    ${exec.ranking_score ? `<div><strong>Ranking Score:</strong> ${exec.ranking_score.toFixed(1)}/10</div>` : ''}
                    ${exec.error_message ? `<div class="bg-red-50 dark:bg-red-900/20 p-3 rounded"><strong>Error:</strong> ${exec.error_message}</div>` : ''}
                    ${exec.sigma_rules ? `<div><strong>SIGMA Rules Generated:</strong> ${exec.sigma_rules.length}</div>` : ''}
                    ${exec.extraction_result ? `<div><strong>Discrete Huntables:</strong> ${exec.extraction_result.discrete_huntables_count || 0}</div>` : ''}
                    <div><strong>Created:</strong> ${new Date(exec.created_at).toLocaleString()}</div>
                    ${exec.completed_at ? `<div><strong>Completed:</strong> ${new Date(exec.completed_at).toLocaleString()}</div>` : ''}
                </div>
            `;
            
            document.getElementById('executionDetailContent').innerHTML = content;
            document.getElementById('executionModal').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading execution details:', error);
    }
}

async function retryExecution(executionId) {
    if (!confirm('Retry this failed execution?')) return;
    
    try {
        const response = await fetch(`/api/workflow/executions/${executionId}/retry`, { method: 'POST' });
        if (response.ok) {
            alert('Retry initiated successfully');
            await loadExecutions();
        } else {
            alert('Error retrying execution');
        }
    } catch (error) {
        console.error('Error retrying execution:', error);
        alert('Error retrying execution');
    }
}

function closeModal() {
    document.getElementById('executionModal').classList.add('hidden');
}

function filterExecutions() {
    loadExecutions();
}

function refreshExecutions() {
    loadExecutions();
}

// Auto-refresh every 10 seconds
setInterval(loadExecutions, 10000);

// Load on page load
loadExecutions();
</script>
{% endblock %}

