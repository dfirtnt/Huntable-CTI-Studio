{% extends "base.html" %}

{% block title %}Workflow Executions - Huntable CTI Scraper{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üîÑ Workflow Executions</h1>
                <p class="text-gray-600 dark:text-gray-400">Monitor agentic workflow execution history and status</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="openExecuteModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors">
                    ‚ñ∂Ô∏è Execute Workflow
                </button>
                <button onclick="refreshExecutions()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                    üîÑ Refresh
                </button>
                <select id="statusFilter" onchange="filterExecutions()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Workflow Visualization -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">üîÄ LangGraph Workflow State Machine</h2>
        <div id="workflowVisualization" class="relative bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
            <svg viewBox="0 0 900 350" class="w-full h-auto">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#6b7280"/>
                    </marker>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <!-- Edges/Arrows -->
                <g stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)">
                    <!-- Step 0 -> Step 1 -->
                    <line x1="150" y1="175" x2="250" y2="175"/>
                    <!-- Step 1 -> Decision -->
                    <line x1="350" y1="175" x2="420" y2="175"/>
                    <!-- Decision -> Step 2 (if continue) -->
                    <line x1="440" y1="165" x2="540" y2="100"/>
                    <text x="490" y="130" fill="#10b981" font-size="10">Score ‚â• 6</text>
                    <!-- Step 2 -> Step 3 -->
                    <line x1="640" y1="125" x2="740" y2="125"/>
                    <!-- Step 3 -> Step 4 -->
                    <line x1="790" y1="155" x2="790" y2="220"/>
                    <!-- Step 4 -> Step 5 -->
                    <line x1="540" y1="250" x2="440" y2="250"/>
                    <!-- Decision -> End (if stop) -->
                    <line x1="440" y1="185" x2="440" y2="300" stroke-dasharray="5,5"/>
                    <line x1="440" y1="300" x2="900" y2="300" stroke-dasharray="5,5"/>
                    <text x="670" y="295" fill="#ef4444" font-size="10">Score &lt; 6 ‚Üí End</text>
                </g>
                
                <!-- Nodes -->
                <g id="workflowNodes">
                    <!-- Step 0: Junk Filter -->
                    <rect x="50" y="145" width="100" height="60" rx="8" fill="#3b82f6" class="workflow-node" data-step="junk_filter"/>
                    <text x="100" y="165" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 0</text>
                    <text x="100" y="185" text-anchor="middle" fill="white" font-size="10">Junk Filter</text>
                    
                    <!-- Step 1: Rank Article -->
                    <rect x="250" y="145" width="100" height="60" rx="8" fill="#10b981" class="workflow-node" data-step="rank_article"/>
                    <text x="300" y="165" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 1</text>
                    <text x="300" y="185" text-anchor="middle" fill="white" font-size="10">LLM Ranking</text>
                    
                    <!-- Conditional Decision Diamond -->
                    <polygon points="420,175 460,155 460,195 420,215" fill="#f59e0b" stroke="#92400e" stroke-width="2"/>
                    <text x="440" y="178" text-anchor="middle" fill="white" font-weight="bold" font-size="9">‚â•6?</text>
                    
                    <!-- Step 2: Extract Agent -->
                    <rect x="540" y="70" width="100" height="60" rx="8" fill="#f59e0b" class="workflow-node" data-step="extract_agent"/>
                    <text x="590" y="90" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 2</text>
                    <text x="590" y="110" text-anchor="middle" fill="white" font-size="10">Extract</text>
                    
                    <!-- Step 3: Generate SIGMA -->
                    <rect x="740" y="95" width="100" height="60" rx="8" fill="#ef4444" class="workflow-node" data-step="generate_sigma"/>
                    <text x="790" y="115" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 3</text>
                    <text x="790" y="135" text-anchor="middle" fill="white" font-size="10">Generate</text>
                    <text x="790" y="150" text-anchor="middle" fill="white" font-size="10">SIGMA</text>
                    
                    <!-- Step 4: Similarity Search -->
                    <rect x="540" y="220" width="100" height="60" rx="8" fill="#ec4899" class="workflow-node" data-step="similarity_search"/>
                    <text x="590" y="240" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 4</text>
                    <text x="590" y="260" text-anchor="middle" fill="white" font-size="10">Similarity</text>
                    
                    <!-- Step 5: Queue -->
                    <rect x="340" y="220" width="100" height="60" rx="8" fill="#8b5cf6" class="workflow-node" data-step="promote_to_queue"/>
                    <text x="390" y="240" text-anchor="middle" fill="white" font-weight="bold" font-size="11">Step 5</text>
                    <text x="390" y="260" text-anchor="middle" fill="white" font-size="10">Queue</text>
                    
                    <!-- Queue -> End -->
                    <line x1="340" y1="250" x2="200" y2="300" stroke-dasharray="3,3"/>
                    <line x1="200" y1="300" x2="900" y2="300" stroke-dasharray="3,3"/>
                    
                    <!-- End Node -->
                    <circle cx="900" cy="300" r="25" fill="#6b7280"/>
                    <text x="900" y="306" text-anchor="middle" fill="white" font-weight="bold" font-size="12">END</text>
                </g>
            </svg>
            
            <!-- Legend -->
            <div class="mt-4 grid grid-cols-6 gap-2 text-xs">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">Filter</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">Rank</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">Extract</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">SIGMA</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-pink-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">Similarity</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                    <span class="text-gray-900 dark:text-white">Queue</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div id="executionStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Total Executions</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="totalExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Running</div>
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="runningExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="completedExecutions">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Failed</div>
            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="failedExecutions">-</div>
        </div>
    </div>

    <!-- Executions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Article</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Current Step</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ranking Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="executionsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Execute Workflow Modal -->
    <div id="executeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Execute Workflow</h3>
                <button onclick="closeExecuteModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">‚úï</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="articleIdInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Article ID
                    </label>
                    <input type="number" 
                           id="articleIdInput" 
                           min="1"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white"
                           placeholder="Enter article ID">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter the ID of the article to process through the workflow</p>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="useLangGraphServer" 
                           class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                    <label for="useLangGraphServer" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                        Use LangGraph Server (creates traces in Langfuse)
                    </label>
                </div>
                <div id="executeError" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3 text-sm text-red-700 dark:text-red-400"></div>
                <div class="flex justify-end space-x-4">
                    <button onclick="closeExecuteModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="executeWorkflow()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors">
                        Execute
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Detail Modal -->
    <div id="executionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Execution Details - Step-by-Step Inputs & Outputs</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">‚úï</button>
            </div>
            <div id="executionDetailContent" class="space-y-4 max-h-[85vh] overflow-y-auto">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
let executions = [];

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-900 dark:bg-yellow-900 dark:text-white">Pending</span>',
        'running': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-900 dark:bg-blue-900 dark:text-white">Running</span>',
        'completed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-900 dark:bg-green-900 dark:text-white">Completed</span>',
        'failed': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-900 dark:bg-red-900 dark:text-white">Failed</span>'
    };
    return badges[status] || '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-900 dark:bg-gray-800 dark:text-gray-100">' + status + '</span>';
}

function getStepBadge(step) {
    const steps = {
        'junk_filter': 'üîç Filter',
        'rank_article': 'üìä Rank',
        'extract_agent': 'üî¨ Extract',
        'generate_sigma': '‚ö° SIGMA',
        'similarity_search': 'üîé Similarity',
        'promote_to_queue': 'üì• Queue'
    };
    return steps[step] || step || '-';
}

async function loadExecutions() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        const url = statusFilter ? `/api/workflow/executions?status=${statusFilter}` : '/api/workflow/executions';
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            executions = data.executions || data; // Support both old and new format
            renderExecutions();
            updateStats(data);
        }
    } catch (error) {
        console.error('Error loading executions:', error);
    }
}

function renderExecutions() {
    const tbody = document.getElementById('executionsTableBody');
    
    if (executions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-300">No executions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = executions.map(exec => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${exec.id}</td>
            <td class="px-6 py-4 text-sm">
                <a href="/articles/${exec.article_id}" class="text-purple-600 hover:text-purple-800 dark:text-white dark:hover:text-gray-300">
                    ${exec.article_title || 'Article ' + exec.article_id}
                </a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(exec.status)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${getStepBadge(exec.current_step)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                ${exec.ranking_score ? exec.ranking_score.toFixed(1) : '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${new Date(exec.created_at).toLocaleString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button onclick="viewExecution(${exec.id})" class="text-blue-600 hover:text-blue-900 dark:text-white dark:hover:text-gray-300 mr-2">View</button>
                ${exec.status === 'failed' ? `<button onclick="retryExecution(${exec.id})" class="text-green-600 hover:text-green-900 dark:text-white dark:hover:text-gray-300">Retry</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function updateStats(data) {
    // Use accurate counts from API response if available, otherwise calculate from filtered array
    const stats = {
        total: data?.total !== undefined ? data.total : executions.length,
        running: data?.running !== undefined ? data.running : executions.filter(e => e.status === 'running').length,
        completed: data?.completed !== undefined ? data.completed : executions.filter(e => e.status === 'completed').length,
        failed: data?.failed !== undefined ? data.failed : executions.filter(e => e.status === 'failed').length
    };
    
    document.getElementById('totalExecutions').textContent = stats.total;
    document.getElementById('runningExecutions').textContent = stats.running;
    document.getElementById('completedExecutions').textContent = stats.completed;
    document.getElementById('failedExecutions').textContent = stats.failed;
}

function highlightCurrentStep(step) {
    // Remove all highlights
    document.querySelectorAll('.workflow-node').forEach(node => {
        node.style.filter = 'none';
        node.style.stroke = 'none';
        node.style.strokeWidth = '0';
    });
    
    // Highlight current step
    if (step) {
        const node = document.querySelector(`[data-step="${step}"]`);
        if (node) {
            node.style.filter = 'url(#glow)';
            node.style.stroke = '#fbbf24';
            node.style.strokeWidth = '3';
        }
    }
}

function formatJSON(obj) {
    if (!obj) return '<span class="text-gray-400">null</span>';
    return '<pre class="bg-gray-50 dark:bg-gray-900 p-3 rounded text-xs overflow-x-auto border border-gray-200 dark:border-gray-700">' + 
           JSON.stringify(obj, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
           '</pre>';
}

function formatText(text, maxLength = 500) {
    if (!text) return '<span class="text-gray-400">null</span>';
    const truncated = text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    return '<pre class="bg-gray-50 dark:bg-gray-900 p-3 rounded text-xs overflow-x-auto border border-gray-200 dark:border-gray-700 whitespace-pre-wrap break-words">' + 
           truncated.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
           '</pre>';
}

async function viewExecution(executionId) {
    try {
        const response = await fetch(`/api/workflow/executions/${executionId}`);
        if (response.ok) {
            const exec = await response.json();
            
            // Highlight current step in visualization
            highlightCurrentStep(exec.current_step);
            
            const config = exec.config_snapshot || {};
            
            const content = `
                <div class="space-y-4 text-gray-900 dark:text-white">
                    <!-- Header Info -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong class="text-gray-900 dark:text-white">Execution ID:</strong> ${exec.id}</div>
                            <div><strong class="text-gray-900 dark:text-white">Article:</strong> <a href="/articles/${exec.article_id}" class="text-purple-600 dark:text-white hover:underline">${exec.article_title || 'Article ' + exec.article_id}</a></div>
                            <div><strong class="text-gray-900 dark:text-white">Status:</strong> ${getStatusBadge(exec.status)}</div>
                            <div><strong class="text-gray-900 dark:text-white">Current Step:</strong> ${getStepBadge(exec.current_step)}</div>
                            <div><strong class="text-gray-900 dark:text-white">Created:</strong> ${new Date(exec.created_at).toLocaleString()}</div>
                            ${exec.completed_at ? `<div><strong class="text-gray-900 dark:text-white">Completed:</strong> ${new Date(exec.completed_at).toLocaleString()}</div>` : ''}
                        </div>
                        ${exec.error_message ? `<div class="mt-2 bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-200 dark:border-red-800"><strong>Error:</strong> ${exec.error_message}</div>` : ''}
                    </div>

                    <!-- Step 0: Junk Filter -->
                    <details class="border border-blue-200 dark:border-blue-800 rounded-lg overflow-hidden" open>
                        <summary class="bg-blue-100 dark:bg-blue-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-blue-200 dark:hover:bg-blue-900/60">
                            Step 0: üîç Junk Filter
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ Article Content Length: ${exec.junk_filter_result?.original_length || 'N/A'} chars</div>
                                    <div>‚Ä¢ Threshold: ${config.junk_filter_threshold || 0.8}</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                ${exec.junk_filter_result ? `
                                    <div class="mt-1 text-sm">
                                        <div>‚Ä¢ Filtered Content Length: ${exec.junk_filter_result.filtered_length || 0} chars</div>
                                        <div>‚Ä¢ Chunks Kept: ${exec.junk_filter_result.chunks_kept || 0}</div>
                                        <div>‚Ä¢ Chunks Removed: ${exec.junk_filter_result.chunks_removed || 0}</div>
                                        <div>‚Ä¢ Is Huntable: ${exec.junk_filter_result.is_huntable ? '‚úÖ Yes' : '‚ùå No'}</div>
                                        <div>‚Ä¢ Confidence: ${(exec.junk_filter_result.confidence * 100).toFixed(1)}%</div>
                                    </div>
                                    ${formatJSON(exec.junk_filter_result)}
                                ` : '<span class="text-gray-400">No results</span>'}
                            </div>
                        </div>
                    </details>

                    <!-- Step 1: Rank Article -->
                    <details class="border border-green-200 dark:border-green-800 rounded-lg overflow-hidden" ${exec.ranking_score ? 'open' : ''}>
                        <summary class="bg-green-100 dark:bg-green-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-green-200 dark:hover:bg-green-900/60">
                            Step 1: üìä LLM Ranking ${exec.ranking_score ? `(${exec.ranking_score.toFixed(1)}/10)` : ''}
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ Article Title: ${exec.article_title || 'N/A'}</div>
                                    <div>‚Ä¢ Filtered Content: ${exec.junk_filter_result?.filtered_length || 0} chars</div>
                                    <div>‚Ä¢ Threshold: ${config.ranking_threshold || 6.0}</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                ${exec.ranking_score ? `
                                    <div class="mt-1 text-sm">
                                        <div>‚Ä¢ Ranking Score: <strong>${exec.ranking_score.toFixed(1)}/10</strong></div>
                                        <div>‚Ä¢ Threshold: ${config.ranking_threshold || 6.0}/10</div>
                                        <div>‚Ä¢ Decision: ${exec.ranking_score >= (config.ranking_threshold || 6.0) ? '‚úÖ Continue' : '‚ùå Stop'}</div>
                                    </div>
                                    ${exec.ranking_reasoning ? `
                                        <details class="mt-3 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                            <summary class="bg-gray-50 dark:bg-gray-700/50 px-3 py-2 cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                üí≠ Reasoning
                                            </summary>
                                            <div class="p-3 bg-white dark:bg-gray-800">
                                                <pre class="text-xs text-gray-700 dark:text-gray-300 whitespace-pre-wrap font-mono">${exec.ranking_reasoning}</pre>
                                            </div>
                                        </details>
                                    ` : ''}
                                ` : '<span class="text-gray-400">No results</span>'}
                            </div>
                        </div>
                    </details>

                    <!-- Step 2: Extract Agent -->
                    <details class="border border-yellow-200 dark:border-yellow-800 rounded-lg overflow-hidden" ${exec.extraction_result ? 'open' : ''}>
                        <summary class="bg-yellow-100 dark:bg-yellow-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-yellow-200 dark:hover:bg-yellow-900/60">
                            Step 2: üî¨ Extract Agent ${exec.extraction_result ? `(${exec.extraction_result.discrete_huntables_count || 0} huntables)` : ''}
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ Filtered Content: ${exec.junk_filter_result?.filtered_length || 0} chars</div>
                                    <div>‚Ä¢ Article Title: ${exec.article_title || 'N/A'}</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                ${exec.extraction_result ? `
                                    <div class="mt-1 text-sm">
                                        <div>‚Ä¢ Discrete Huntables: <strong>${exec.extraction_result.discrete_huntables_count || exec.extraction_result.summary?.count || 0}</strong></div>
                                        <div>‚Ä¢ Observables: ${exec.extraction_result.observables?.length || 0}</div>
                                        ${exec.extraction_result.summary?.platforms_detected && exec.extraction_result.summary.platforms_detected.length > 0 ? `<div>‚Ä¢ Platforms: ${exec.extraction_result.summary.platforms_detected.join(', ')}</div>` : ''}
                                    </div>
                                    ${exec.extraction_result.observables && exec.extraction_result.observables.length > 0 ? `
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-sm text-purple-600 dark:text-white hover:underline">View ${exec.extraction_result.observables.length} Observables</summary>
                                            <div class="mt-2 max-h-64 overflow-y-auto">
                                                <div class="space-y-2 text-xs bg-gray-50 dark:bg-gray-900 p-3 rounded border border-gray-200 dark:border-gray-700">
                                                    ${exec.extraction_result.observables.slice(0, 20).map((obs, idx) => {
                                                        const type = obs.type || 'Unknown';
                                                        const value = obs.value || '';
                                                        const platform = obs.platform || '';
                                                        const sourceContext = obs.source_context || '';
                                                        return `<div class="border-b border-gray-300 dark:border-gray-600 pb-2">
                                                            <div class="font-semibold text-gray-900 dark:text-white">${idx + 1}. ${type}</div>
                                                            <div class="text-gray-700 dark:text-gray-300 break-all">${value.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                                            ${platform ? `<div class="text-gray-600 dark:text-gray-400">Platform: ${platform}</div>` : ''}
                                                            ${sourceContext ? `<div class="text-gray-600 dark:text-gray-400 italic">Context: ${sourceContext}</div>` : ''}
                                                        </div>`;
                                                    }).join('')}
                                                    ${exec.extraction_result.observables.length > 20 ? `<div class="text-gray-500 dark:text-gray-300">... and ${exec.extraction_result.observables.length - 20} more</div>` : ''}
                                                </div>
                                            </div>
                                        </details>
                                    ` : ''}
                                    ${exec.extraction_result.raw_response ? `
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-sm text-blue-600 dark:text-white hover:underline">View Raw LLM Response</summary>
                                            <div class="mt-2">${formatText(exec.extraction_result.raw_response, 1000)}</div>
                                        </details>
                                    ` : ''}
                                ` : '<span class="text-gray-400">No results</span>'}
                            </div>
                        </div>
                    </details>

                    <!-- Step 3: Generate SIGMA -->
                    <details class="border border-red-200 dark:border-red-800 rounded-lg overflow-hidden" ${exec.sigma_rules && exec.sigma_rules.length > 0 ? 'open' : ''}>
                        <summary class="bg-red-100 dark:bg-red-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-red-200 dark:hover:bg-red-900/60">
                            Step 3: ‚ö° Generate SIGMA ${exec.sigma_rules ? `(${exec.sigma_rules.length} rules)` : '(0 rules)'}
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ Extraction Result: ${exec.extraction_result ? exec.extraction_result.discrete_huntables_count + ' huntables' : 'N/A'}</div>
                                    <div>‚Ä¢ Filtered Content: ${exec.junk_filter_result?.filtered_length || 0} chars</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                ${exec.sigma_rules && exec.sigma_rules.length > 0 ? `
                                    <div class="mt-1 text-sm">
                                        <div>‚Ä¢ SIGMA Rules Generated: <strong>${exec.sigma_rules.length}</strong></div>
                                    </div>
                                    ${exec.sigma_rules.slice(0, 3).map((rule, idx) => `
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-sm text-purple-600 dark:text-white hover:underline">Rule ${idx + 1}: ${rule.title || 'Untitled'}</summary>
                                            <div class="mt-2">${formatJSON(rule)}</div>
                                        </details>
                                    `).join('')}
                                    ${exec.sigma_rules.length > 3 ? `<div class="text-sm text-gray-500 dark:text-gray-300 mt-2">... and ${exec.sigma_rules.length - 3} more rules</div>` : ''}
                                ` : '<span class="text-gray-400">No SIGMA rules generated</span>'}
                            </div>
                        </div>
                    </details>

                    <!-- Step 4: Similarity Search -->
                    <details class="border border-pink-200 dark:border-pink-800 rounded-lg overflow-hidden" ${exec.similarity_results ? 'open' : ''}>
                        <summary class="bg-pink-100 dark:bg-pink-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-pink-200 dark:hover:bg-pink-900/60">
                            Step 4: üîé Similarity Search
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ SIGMA Rules: ${exec.sigma_rules ? exec.sigma_rules.length : 0}</div>
                                    <div>‚Ä¢ Similarity Threshold: ${config.similarity_threshold || 0.5}</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                ${exec.similarity_results ? `
                                    <div class="mt-1 text-sm">
                                        <div>‚Ä¢ Results: ${exec.similarity_results.length}</div>
                                        ${exec.similarity_results.length > 0 ? `
                                            <div>‚Ä¢ Max Similarity: ${Math.max(...exec.similarity_results.map(r => r.max_similarity || 0)).toFixed(3)}</div>
                                        ` : ''}
                                    </div>
                                    ${formatJSON(exec.similarity_results)}
                                ` : '<span class="text-gray-400">No results</span>'}
                            </div>
                        </div>
                    </details>

                    <!-- Step 5: Queue Promotion -->
                    <details class="border border-purple-200 dark:border-purple-800 rounded-lg overflow-hidden">
                        <summary class="bg-purple-100 dark:bg-purple-900/40 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-purple-200 dark:hover:bg-purple-900/60">
                            Step 5: üì• Queue Promotion
                        </summary>
                        <div class="p-4 space-y-3 bg-white dark:bg-gray-800">
                            <div>
                                <strong class="text-gray-900 dark:text-white">Inputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ SIGMA Rules: ${exec.sigma_rules ? exec.sigma_rules.length : 0}</div>
                                    <div>‚Ä¢ Similarity Results: ${exec.similarity_results ? exec.similarity_results.length : 0}</div>
                                    <div>‚Ä¢ Similarity Threshold: ${config.similarity_threshold || 0.5}</div>
                                </div>
                            </div>
                            <div>
                                <strong class="text-gray-900 dark:text-white">Outputs:</strong>
                                <div class="mt-1 text-sm">
                                    <div>‚Ä¢ Rules Queued: ${exec.similarity_results ? exec.similarity_results.filter(r => (r.max_similarity || 0) < (config.similarity_threshold || 0.5)).length : 0}</div>
                                    <div>‚Ä¢ Check <a href="/workflow#queue" class="text-purple-600 dark:text-white hover:underline">SIGMA Queue</a> for queued rules</div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Configuration -->
                    <details class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <summary class="bg-gray-100 dark:bg-gray-700 px-4 py-3 cursor-pointer font-semibold text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600">
                            ‚öôÔ∏è Configuration Snapshot
                        </summary>
                        <div class="p-4 bg-white dark:bg-gray-800">
                            ${formatJSON(exec.config_snapshot)}
                        </div>
                    </details>
                </div>
            `;
            
            document.getElementById('executionDetailContent').innerHTML = content;
            document.getElementById('executionModal').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading execution details:', error);
        document.getElementById('executionDetailContent').innerHTML = 
            `<div class="text-red-600 dark:text-red-400">Error loading execution details: ${error.message}</div>`;
    }
}

async function retryExecution(executionId) {
    if (!confirm('Retry this failed execution?')) return;
    
    try {
        const response = await fetch(`/api/workflow/executions/${executionId}/retry`, { method: 'POST' });
        if (response.ok) {
            alert('Retry initiated successfully');
            await loadExecutions();
        } else {
            alert('Error retrying execution');
        }
    } catch (error) {
        console.error('Error retrying execution:', error);
        alert('Error retrying execution');
    }
}

function closeModal() {
    document.getElementById('executionModal').classList.add('hidden');
}

// Close modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const executionModal = document.getElementById('executionModal');
        const executeModal = document.getElementById('executeModal');
        
        if (executionModal && !executionModal.classList.contains('hidden')) {
            closeModal();
        }
        if (executeModal && !executeModal.classList.contains('hidden')) {
            closeExecuteModal();
        }
    }
});

function filterExecutions() {
    loadExecutions();
}

function refreshExecutions() {
    loadExecutions();
}

function openExecuteModal() {
    const modal = document.getElementById('executeModal');
    const input = document.getElementById('articleIdInput');
    
    modal.classList.remove('hidden');
    input.value = '';
    document.getElementById('executeError').classList.add('hidden');
    
    // Use setTimeout to ensure focus happens after modal is visible
    setTimeout(() => {
        input.focus();
        input.select();
    }, 10);
}

function closeExecuteModal() {
    document.getElementById('executeModal').classList.add('hidden');
    document.getElementById('articleIdInput').value = '';
    document.getElementById('executeError').classList.add('hidden');
}

async function executeWorkflow() {
    const articleId = document.getElementById('articleIdInput').value.trim();
    const useLangGraphServer = document.getElementById('useLangGraphServer').checked;
    const errorDiv = document.getElementById('executeError');
    
    // Validate input
    if (!articleId || isNaN(articleId) || parseInt(articleId) < 1) {
        errorDiv.textContent = 'Please enter a valid article ID';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    errorDiv.classList.add('hidden');
    
    try {
        const url = `/api/workflow/articles/${articleId}/trigger?use_langgraph_server=${useLangGraphServer}`;
        const response = await fetch(url, { method: 'POST' });
        
        if (response.ok) {
            const result = await response.json();
            closeExecuteModal();
            
            if (result.via_langgraph_server) {
                alert('‚úÖ Workflow executed via LangGraph Server\n\n' +
                      `Execution ID: ${result.execution_id}\n` +
                      'This will create traces in Langfuse.');
            } else {
                alert('‚úÖ Workflow execution started\n\n' +
                      `Execution ID: ${result.execution_id}\n` +
                      'Executing via Celery (fast, no traces).');
            }
            
            // Refresh the executions list
            await loadExecutions();
        } else {
            const error = await response.json();
            errorDiv.textContent = error.detail || 'Failed to execute workflow';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error executing workflow:', error);
        errorDiv.textContent = 'Error executing workflow: ' + error.message;
        errorDiv.classList.remove('hidden');
    }
}

// Handle Enter key in article ID input
document.addEventListener('DOMContentLoaded', function() {
    const articleIdInput = document.getElementById('articleIdInput');
    if (articleIdInput) {
        articleIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeWorkflow();
            }
        });
    }
});

// Auto-refresh every 10 seconds
setInterval(loadExecutions, 10000);

// Load on page load
loadExecutions();
</script>
{% endblock %}

