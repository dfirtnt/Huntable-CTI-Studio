{% extends "base.html" %}

{% block title %}SIGMA Rule Queue - Huntable CTI Studio{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üì• SIGMA Rule Queue</h1>
                <p class="text-gray-600 dark:text-gray-400">Review and manage SIGMA rules pending PR submission</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="loadQueue()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                    üîÑ Refresh
                </button>
                <select id="statusFilter" onchange="filterQueue()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="submitted">Submitted</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Queue Statistics -->
    <div id="queueStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Pending Review</div>
            <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="pendingCount">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Approved</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="approvedCount">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Rejected</div>
            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="rejectedCount">-</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="text-sm text-gray-600 dark:text-gray-400">Submitted</div>
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="submittedCount">-</div>
        </div>
    </div>

    <!-- Queue Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Article</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rule Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Max Similarity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="queueTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Rule Preview Modal -->
    <div id="ruleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white dark:bg-gray-800 max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-gray-800 pb-2 border-b">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">SIGMA Rule Preview</h3>
                <button onclick="closeRuleModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                <div id="rulePreviewContent">
                    <!-- Content loaded dynamically -->
                </div>
                <div id="actionButtons" class="flex space-x-4 pt-4 border-t sticky bottom-0 bg-white dark:bg-gray-800">
                    <button onclick="approveRule(currentRuleId)" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">
                        ‚úÖ Approve
                    </button>
                    <button onclick="rejectRule(currentRuleId)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">
                        ‚ùå Reject
                    </button>
                    <button onclick="openEnrichModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md">
                        ‚ú® Enrich
                    </button>
                    <button onclick="checkSimilarRulesForQueue()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                        üîç Similarity Search
                    </button>
                    <button onclick="closeRuleModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrich Rule Modal -->
    <div id="enrichModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white dark:bg-gray-800 max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-gray-800 pb-2 border-b">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">‚ú® AI-Assisted Rule Enrichment</h3>
                <button onclick="closeEnrichModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Enrichment Instructions (optional):
                    </label>
                    <textarea id="enrichInstruction" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">Improve and enrich this SIGMA rule with better detection logic, more comprehensive conditions, and proper metadata.</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Original Rule:
                    </label>
                    <textarea id="enrichOriginalRule" readonly rows="15" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-50 font-mono text-sm leading-relaxed resize-none"></textarea>
                </div>
                <div id="enrichLoading" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Enriching rule with AI...</p>
                </div>
                <div id="enrichResult" class="hidden">
                    <div class="mb-3 flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Enriched Rule:
                        </label>
                        <div class="flex space-x-2">
                            <button onclick="toggleEnrichView()" id="toggleViewBtn" class="px-3 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                                üìä Show Comparison
                            </button>
                        </div>
                    </div>
                    <div id="enrichComparisonView" class="hidden mb-4">
                        <div class="mb-2 text-xs text-gray-600 dark:text-gray-400" id="enrichIterationInfo"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-gray-50 dark:bg-gray-900">
                                <h6 class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2" id="enrichLeftLabel">Original Rule</h6>
                                <pre id="enrichOriginalComparison" class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-96 overflow-y-auto text-gray-900 dark:text-gray-100"></pre>
                            </div>
                            <div class="border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-green-50 dark:bg-green-900/20">
                                <h6 class="text-xs font-bold text-green-700 dark:text-green-300 mb-2" id="enrichRightLabel">Enriched Rule</h6>
                                <pre id="enrichedComparison" class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-96 overflow-y-auto text-gray-900 dark:text-gray-100"></pre>
                            </div>
                        </div>
                    </div>
                    <textarea id="enrichedRuleYaml" rows="20" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-xs"></textarea>
                </div>
                <div id="enrichError" class="hidden p-4 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-md text-red-800 dark:text-red-200"></div>
                    <div id="enrichActionButtons" class="flex space-x-4 pt-4 border-t sticky bottom-0 bg-white dark:bg-gray-800">
                    <button onclick="applyEnrichedRule()" id="applyEnrichBtn" class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">
                        ‚úÖ Apply Enriched Rule
                    </button>
                    <button onclick="enrichRule()" id="enrichBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md">
                        ‚ú® Enrich Rule
                    </button>
                    <button onclick="enrichRuleFurther()" id="enrichFurtherBtn" class="hidden px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md">
                        üîÑ Enrich Further
                    </button>
                    <button onclick="closeEnrichModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let queue = [];
let currentRuleId = null;
let isEditMode = false;
let originalYaml = '';
let editedYaml = '';
let currentEnrichedYaml = null; // Track current enriched state for iterative enrichment
let enrichIteration = 0; // Track number of enrichment iterations

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>',
        'approved': '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:bg-green-200">Approved</span>',
        'rejected': '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:bg-red-200">Rejected</span>',
        'submitted': '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:bg-purple-200">Submitted</span>'
    };
    return badges[status] || '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">' + status + '</span>';
}

async function loadQueue() {
    try {
        const statusFilter = document.getElementById('statusFilter').value;
        const url = statusFilter ? `/api/sigma-queue/list?status=${statusFilter}` : '/api/sigma-queue/list';
        
        const response = await fetch(url);
        if (response.ok) {
            queue = await response.json();
            renderQueue();
            updateStats();
        }
    } catch (error) {
        console.error('Error loading queue:', error);
    }
}

function renderQueue() {
    const tbody = document.getElementById('queueTableBody');
    
    if (queue.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No queued rules found</td></tr>';
        return;
    }
    
    tbody.innerHTML = queue.map(rule => {
        const metadata = rule.rule_metadata || {};
        const title = metadata.title || 'Untitled Rule';
        
        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${rule.id}</td>
                <td class="px-6 py-4 text-sm">
                    <a href="/articles/${rule.article_id}" class="text-purple-600 hover:text-purple-800 dark:text-purple-400">
                        ${rule.article_title || 'Article ' + rule.article_id}
                    </a>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${title}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${rule.max_similarity ? (rule.max_similarity * 100).toFixed(1) + '%' : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(rule.status)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    ${new Date(rule.created_at).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="previewRule(${rule.id})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 mr-2">Preview</button>
                    ${rule.status === 'pending' ? `
                        <button onclick="approveRule(${rule.id})" class="text-green-600 hover:text-green-800 dark:text-green-400 mr-2">Approve</button>
                        <button onclick="rejectRule(${rule.id})" class="text-red-600 hover:text-red-800 dark:text-red-400">Reject</button>
                    ` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

function updateStats() {
    const stats = {
        pending: queue.filter(r => r.status === 'pending').length,
        approved: queue.filter(r => r.status === 'approved').length,
        rejected: queue.filter(r => r.status === 'rejected').length,
        submitted: queue.filter(r => r.status === 'submitted').length
    };
    
    document.getElementById('pendingCount').textContent = stats.pending;
    document.getElementById('approvedCount').textContent = stats.approved;
    document.getElementById('rejectedCount').textContent = stats.rejected;
    document.getElementById('submittedCount').textContent = stats.submitted;
}

function previewRule(ruleId) {
    const rule = queue.find(r => r.id === ruleId);
    if (!rule) return;
    
    currentRuleId = ruleId;
    isEditMode = false;
    originalYaml = rule.rule_yaml;
    editedYaml = rule.rule_yaml;
    
    renderRulePreview(rule);
    document.getElementById('ruleModal').classList.remove('hidden');
}

function renderRulePreview(rule) {
    const metadata = rule.rule_metadata || {};
    const similarityScores = rule.similarity_scores || [];
    
    let similarRulesHtml = '';
    if (similarityScores.length > 0) {
        similarRulesHtml = `
            <div class="mt-4">
                <h4 class="font-semibold mb-2">Similar Existing Rules:</h4>
                <ul class="list-disc list-inside space-y-1">
                    ${similarityScores.slice(0, 5).map(s => `
                        <li>${s.title || s.rule_id} (${(s.similarity * 100).toFixed(1)}% similar)</li>
                    `).join('')}
                </ul>
            </div>
        `;
    }
    
    const yamlSection = isEditMode ? `
        <div class="mt-4">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold">Rule YAML:</h4>
                <button onclick="cancelEdit()" class="text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">
                    Cancel
                </button>
            </div>
            <textarea id="yamlEditor" class="w-full bg-gray-100 dark:bg-gray-900 p-4 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs" rows="20" style="font-family: 'Courier New', monospace;">${escapeHtml(editedYaml)}</textarea>
        </div>
    ` : `
        <div class="mt-4">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold">Rule YAML:</h4>
                <button onclick="enableEditMode()" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400">
                    ‚úèÔ∏è Edit
                </button>
            </div>
            <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded overflow-x-auto text-xs"><code>${escapeHtml(editedYaml)}</code></pre>
        </div>
    `;
    
    const content = `
        <div class="space-y-4">
            <div><strong>Rule ID:</strong> ${rule.id}</div>
            <div><strong>Article:</strong> <a href="/articles/${rule.article_id}" class="text-purple-600">${rule.article_title || 'Article ' + rule.article_id}</a></div>
            <div><strong>Max Similarity:</strong> ${rule.max_similarity ? (rule.max_similarity * 100).toFixed(1) + '%' : 'N/A'}</div>
            ${similarRulesHtml}
            ${yamlSection}
        </div>
    `;
    
    document.getElementById('rulePreviewContent').innerHTML = content;
    updateActionButtons();
}

function enableEditMode() {
    isEditMode = true;
    const rule = queue.find(r => r.id === currentRuleId);
    if (rule) {
        renderRulePreview(rule);
        // Focus the textarea after render
        setTimeout(() => {
            const editor = document.getElementById('yamlEditor');
            if (editor) {
                editor.focus();
            }
        }, 100);
    }
}

function cancelEdit() {
    isEditMode = false;
    editedYaml = originalYaml;
    const rule = queue.find(r => r.id === currentRuleId);
    if (rule) {
        renderRulePreview(rule);
    }
}

function saveYamlEdit() {
    const editor = document.getElementById('yamlEditor');
    if (!editor) return;
    
    editedYaml = editor.value;
    isEditMode = false;
    const rule = queue.find(r => r.id === currentRuleId);
    if (rule) {
        renderRulePreview(rule);
    }
}

function updateActionButtons() {
    const buttonContainer = document.getElementById('actionButtons');
    if (!buttonContainer) return;
    
    if (isEditMode) {
        buttonContainer.innerHTML = `
            <button onclick="saveYamlEdit()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                üíæ Save Changes
            </button>
            <button onclick="cancelEdit()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md">
                Cancel Edit
            </button>
        `;
    } else {
        buttonContainer.innerHTML = `
            <button onclick="approveRule(currentRuleId)" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md">
                ‚úÖ Approve
            </button>
            <button onclick="rejectRule(currentRuleId)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">
                ‚ùå Reject
            </button>
            <button onclick="openEnrichModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md">
                ‚ú® Enrich
            </button>
            <button onclick="checkSimilarRulesForQueue()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                üîç Similarity Search
            </button>
            <button onclick="closeRuleModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md">
                Cancel
            </button>
        `;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function approveRule(ruleId) {
    if (!confirm('Approve this rule for PR submission?')) return;
    
    try {
        // Save any pending edits first
        if (isEditMode) {
            saveYamlEdit();
        }
        
        const payload = { status: 'approved' };
        // Include edited YAML if it differs from original
        if (editedYaml !== originalYaml) {
            payload.rule_yaml = editedYaml;
        }
        
        const response = await fetch(`/api/sigma-queue/${ruleId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            alert('Rule approved successfully');
            closeRuleModal();
            await loadQueue();
        } else {
            alert('Error approving rule');
        }
    } catch (error) {
        console.error('Error approving rule:', error);
        alert('Error approving rule');
    }
}

async function rejectRule(ruleId) {
    const notes = prompt('Rejection reason (optional):');
    
    try {
        // Save any pending edits first
        if (isEditMode) {
            saveYamlEdit();
        }
        
        const payload = { review_notes: notes || null };
        // Include edited YAML if it differs from original
        if (editedYaml !== originalYaml) {
            payload.rule_yaml = editedYaml;
        }
        
        const response = await fetch(`/api/sigma-queue/${ruleId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            alert('Rule rejected');
            closeRuleModal();
            await loadQueue();
        } else {
            alert('Error rejecting rule');
        }
    } catch (error) {
        console.error('Error rejecting rule:', error);
        alert('Error rejecting rule');
    }
}

function closeRuleModal() {
    document.getElementById('ruleModal').classList.add('hidden');
    currentRuleId = null;
    isEditMode = false;
    originalYaml = '';
    editedYaml = '';
}

function openEnrichModal() {
    const rule = queue.find(r => r.id === currentRuleId);
    if (!rule) return;
    
    // Reset state
    currentEnrichedYaml = null;
    enrichIteration = 0;
    
    // Set original rule YAML
    document.getElementById('enrichOriginalRule').value = rule.rule_yaml;
    document.getElementById('enrichInstruction').value = 'Improve and enrich this SIGMA rule with better detection logic, more comprehensive conditions, and proper metadata.';
    document.getElementById('enrichResult').classList.add('hidden');
    document.getElementById('enrichError').classList.add('hidden');
    document.getElementById('applyEnrichBtn').classList.add('hidden');
    document.getElementById('enrichFurtherBtn').classList.add('hidden');
    document.getElementById('enrichBtn').classList.remove('hidden');
    document.getElementById('enrichLoading').classList.add('hidden');
    
    // Reset comparison view
    document.getElementById('enrichComparisonView').classList.add('hidden');
    document.getElementById('enrichedRuleYaml').classList.remove('hidden');
    document.getElementById('toggleViewBtn').textContent = 'üìä Show Comparison';
    document.getElementById('enrichLeftLabel').textContent = 'Original Rule';
    document.getElementById('enrichRightLabel').textContent = 'Enriched Rule';
    document.getElementById('enrichIterationInfo').textContent = '';
    
    // Show modal
    document.getElementById('enrichModal').classList.remove('hidden');
}

function closeEnrichModal() {
    document.getElementById('enrichModal').classList.add('hidden');
}

async function enrichRule() {
    const rule = queue.find(r => r.id === currentRuleId);
    if (!rule) return;
    
    // Get API key - try settings API first, fallback to localStorage
    let apiKey = null;
    try {
        const response = await fetch('/api/settings');
        if (response.ok) {
            const data = await response.json();
            const settings = data.settings || {};
            apiKey = settings.WORKFLOW_OPENAI_API_KEY || settings.OPENAI_API_KEY;
        }
    } catch (error) {
        console.warn('Could not fetch API key from settings API, trying localStorage:', error);
    }
    
    // Fallback to localStorage if not found in settings API
    if (!apiKey) {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        apiKey = settings.aiOpenaiApiKey || settings.workflowOpenaiApiKey;
    }
    
    if (!apiKey) {
        document.getElementById('enrichError').textContent = 'Please configure your OpenAI API key in Settings first.';
        document.getElementById('enrichError').classList.remove('hidden');
        return;
    }
    
    const instruction = document.getElementById('enrichInstruction').value.trim();
    
    // Show loading, hide error and result
    const enrichBtn = document.getElementById('enrichBtn');
    enrichBtn.disabled = true;
    enrichBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>Enriching...';
    enrichBtn.classList.add('opacity-75', 'cursor-not-allowed');
    
    document.getElementById('enrichLoading').classList.remove('hidden');
    document.getElementById('enrichError').classList.add('hidden');
    document.getElementById('enrichResult').classList.add('hidden');
    
    try {
        const response = await fetch(`/api/sigma-queue/${currentRuleId}/enrich`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-OpenAI-API-Key': apiKey
            },
            body: JSON.stringify({
                instruction: instruction || undefined
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            const enrichedYaml = data.enriched_yaml;
            enrichIteration++;
            
            // Determine what to compare against
            const previousYaml = currentEnrichedYaml || document.getElementById('enrichOriginalRule').value;
            const isIterative = currentEnrichedYaml !== null;
            
            console.log('Enrichment successful, showing comparison view', { iteration: enrichIteration, isIterative });
            
            // Get all elements first
            const enrichResult = document.getElementById('enrichResult');
            const comparisonView = document.getElementById('enrichComparisonView');
            const textarea = document.getElementById('enrichedRuleYaml');
            const toggleBtn = document.getElementById('toggleViewBtn');
            const originalComparison = document.getElementById('enrichOriginalComparison');
            const enrichedComparison = document.getElementById('enrichedComparison');
            const applyBtn = document.getElementById('applyEnrichBtn');
            const enrichBtn = document.getElementById('enrichBtn');
            const enrichFurtherBtn = document.getElementById('enrichFurtherBtn');
            const leftLabel = document.getElementById('enrichLeftLabel');
            const rightLabel = document.getElementById('enrichRightLabel');
            const iterationInfo = document.getElementById('enrichIterationInfo');
            
            if (!enrichResult || !comparisonView || !textarea || !toggleBtn) {
                console.error('Missing elements for comparison view');
                alert('Error: Could not display comparison view. Please check console.');
                return;
            }
            
            // Update current enriched state
            currentEnrichedYaml = enrichedYaml;
            
            // Set enriched rule in textarea
            textarea.value = enrichedYaml;
            
            // Update labels and info based on iteration
            if (isIterative) {
                leftLabel.textContent = `Previous (Iteration ${enrichIteration - 1})`;
                rightLabel.textContent = `Enriched (Iteration ${enrichIteration})`;
                iterationInfo.textContent = `üîÑ Iterative enrichment - This is iteration #${enrichIteration}. Building on previous enrichment.`;
            } else {
                leftLabel.textContent = 'Original Rule';
                rightLabel.textContent = 'Enriched Rule';
                iterationInfo.textContent = '';
            }
            
            // Populate comparison view
            originalComparison.textContent = previousYaml;
            enrichedComparison.textContent = enrichedYaml;
            
            // Show result section first
            enrichResult.classList.remove('hidden');
            
            // Force a reflow to ensure DOM is updated
            enrichResult.offsetHeight;
            
            // Show comparison view by default
            comparisonView.classList.remove('hidden');
            textarea.classList.add('hidden');
            toggleBtn.textContent = 'üìù Show Editor';
            
            // Scroll comparison view into view if needed
            setTimeout(() => {
                comparisonView.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            // Show buttons
            applyBtn.classList.remove('hidden');
            enrichBtn.classList.add('hidden');
            enrichFurtherBtn.classList.remove('hidden'); // Show "Enrich Further" button
            
            console.log('Comparison view should now be visible');
        } else {
            document.getElementById('enrichError').textContent = data.detail || 'Error enriching rule';
            document.getElementById('enrichError').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error enriching rule:', error);
        document.getElementById('enrichError').textContent = 'Network error: ' + error.message;
        document.getElementById('enrichError').classList.remove('hidden');
    } finally {
        document.getElementById('enrichLoading').classList.add('hidden');
        const enrichBtn = document.getElementById('enrichBtn');
        enrichBtn.disabled = false;
        enrichBtn.innerHTML = '‚ú® Enrich Rule';
        enrichBtn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

async function enrichRuleFurther() {
    // Use the current enriched rule as the base for further enrichment
    if (!currentEnrichedYaml) {
        alert('No enriched rule to build upon. Please enrich the rule first.');
        return;
    }
    
    // Get API key
    let apiKey = null;
    try {
        const response = await fetch('/api/settings');
        if (response.ok) {
            const data = await response.json();
            const settings = data.settings || {};
            apiKey = settings.WORKFLOW_OPENAI_API_KEY || settings.OPENAI_API_KEY;
        }
    } catch (error) {
        console.warn('Could not fetch API key from settings API, trying localStorage:', error);
    }
    
    if (!apiKey) {
        const settings = JSON.parse(localStorage.getItem('ctiScraperSettings') || '{}');
        apiKey = settings.aiOpenaiApiKey || settings.workflowOpenaiApiKey;
    }
    
    if (!apiKey) {
        document.getElementById('enrichError').textContent = 'Please configure your OpenAI API key in Settings first.';
        document.getElementById('enrichError').classList.remove('hidden');
        return;
    }
    
    // Prompt for new instruction
    const newInstruction = prompt('Enter additional enrichment instructions (or leave empty for default):\n\nThis will enrich the already-enriched rule further.');
    
    if (newInstruction === null) return; // User cancelled
    
    // Show loading
    const enrichFurtherBtn = document.getElementById('enrichFurtherBtn');
    enrichFurtherBtn.disabled = true;
    enrichFurtherBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>Enriching Further...';
    enrichFurtherBtn.classList.add('opacity-75', 'cursor-not-allowed');
    
    document.getElementById('enrichLoading').classList.remove('hidden');
    document.getElementById('enrichError').classList.add('hidden');
    
    try {
        const response = await fetch(`/api/sigma-queue/${currentRuleId}/enrich`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-OpenAI-API-Key': apiKey
            },
            body: JSON.stringify({
                instruction: newInstruction.trim() || undefined,
                current_rule_yaml: currentEnrichedYaml  // Pass current enriched YAML
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            const enrichedYaml = data.enriched_yaml;
            enrichIteration++;
            
            // Get previous version for comparison
            const previousYaml = currentEnrichedYaml;
            
            // Get all elements
            const enrichResult = document.getElementById('enrichResult');
            const comparisonView = document.getElementById('enrichComparisonView');
            const textarea = document.getElementById('enrichedRuleYaml');
            const toggleBtn = document.getElementById('toggleViewBtn');
            const originalComparison = document.getElementById('enrichOriginalComparison');
            const enrichedComparison = document.getElementById('enrichedComparison');
            const leftLabel = document.getElementById('enrichLeftLabel');
            const rightLabel = document.getElementById('enrichRightLabel');
            const iterationInfo = document.getElementById('enrichIterationInfo');
            
            // Update current enriched state
            currentEnrichedYaml = enrichedYaml;
            
            // Set enriched rule in textarea
            textarea.value = enrichedYaml;
            
            // Update labels for iterative enrichment
            leftLabel.textContent = `Previous (Iteration ${enrichIteration - 1})`;
            rightLabel.textContent = `Enriched (Iteration ${enrichIteration})`;
            iterationInfo.textContent = `üîÑ Iterative enrichment - This is iteration #${enrichIteration}. Building on previous enrichment.`;
            
            // Populate comparison view
            originalComparison.textContent = previousYaml;
            enrichedComparison.textContent = enrichedYaml;
            
            // Ensure views are visible
            enrichResult.classList.remove('hidden');
            comparisonView.classList.remove('hidden');
            textarea.classList.add('hidden');
            toggleBtn.textContent = 'üìù Show Editor';
            
            // Scroll into view
            setTimeout(() => {
                comparisonView.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
        } else {
            document.getElementById('enrichError').textContent = data.detail || 'Error enriching rule further';
            document.getElementById('enrichError').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error enriching rule further:', error);
        document.getElementById('enrichError').textContent = 'Network error: ' + error.message;
        document.getElementById('enrichError').classList.remove('hidden');
    } finally {
        document.getElementById('enrichLoading').classList.add('hidden');
        enrichFurtherBtn.disabled = false;
        enrichFurtherBtn.innerHTML = 'üîÑ Enrich Further';
        enrichFurtherBtn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

async function applyEnrichedRule() {
    const enrichedYaml = document.getElementById('enrichedRuleYaml').value;
    if (!enrichedYaml.trim()) {
        alert('No enriched rule to apply');
        return;
    }
    
    if (!confirm('Apply the enriched rule? This will update the rule YAML.')) return;
    
    try {
        const response = await fetch(`/api/sigma-queue/${currentRuleId}/yaml`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rule_yaml: enrichedYaml })
        });
        
        if (response.ok) {
            // Close only the enrich modal
            closeEnrichModal();
            
            // Update the rule in the queue array
            const rule = queue.find(r => r.id === currentRuleId);
            if (rule) {
                rule.rule_yaml = enrichedYaml;
                // Update editedYaml and originalYaml to reflect the change
                editedYaml = enrichedYaml;
                originalYaml = enrichedYaml;
                isEditMode = false;
                
                // Re-render the rule preview with updated YAML
                renderRulePreview(rule);
            }
            
            // Reload queue in background to sync with server
            loadQueue().catch(err => console.error('Error reloading queue:', err));
        } else {
            alert('Error applying enriched rule');
        }
    } catch (error) {
        console.error('Error applying enriched rule:', error);
        alert('Error applying enriched rule');
    }
}

// Close enrich modal when clicking outside
const enrichModal = document.getElementById('enrichModal');
if (enrichModal) {
    enrichModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeEnrichModal();
        }
    });
}

// Close enrich modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('enrichModal');
        if (modal && !modal.classList.contains('hidden')) {
            closeEnrichModal();
        }
    }
});

function toggleEnrichView() {
    const comparisonView = document.getElementById('enrichComparisonView');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const textarea = document.getElementById('enrichedRuleYaml');
    
    if (!comparisonView || !toggleBtn || !textarea) {
        console.error('Toggle enrich view: elements not found');
        return;
    }
    
    if (comparisonView.classList.contains('hidden')) {
        comparisonView.classList.remove('hidden');
        textarea.classList.add('hidden');
        toggleBtn.textContent = 'üìù Show Editor';
    } else {
        comparisonView.classList.add('hidden');
        textarea.classList.remove('hidden');
        toggleBtn.textContent = 'üìä Show Comparison';
    }
}

// Close modal when clicking outside
const ruleModal = document.getElementById('ruleModal');
if (ruleModal) {
    ruleModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeRuleModal();
        }
    });
}

// Close modal with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('ruleModal');
        if (modal && !modal.classList.contains('hidden')) {
            closeRuleModal();
        }
    }
});

function filterQueue() {
    loadQueue();
}

// Auto-refresh every 30 seconds
setInterval(loadQueue, 30000);

// Load on page load
loadQueue();

// Similar Rules functionality
let currentQueueRule = null;
let isSimilarRulesModalExpanded = false;

async function checkSimilarRulesForQueue() {
    const rule = queue.find(r => r.id === currentRuleId);
    if (!rule) {
        alert('Rule not found');
        return;
    }
    
    currentQueueRule = rule;
    
    // Show loading indicator
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'similarRulesLoading';
    loadingMsg.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center';
    loadingMsg.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-700 dark:text-gray-300">Searching for similar rules in SigmaHQ repository...</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This may take 20-30 seconds</p>
            </div>
        </div>
    `;
    document.body.appendChild(loadingMsg);
    
    try {
        // Use the queued rule's direct comparison endpoint
        // This compares the specific queued rule's YAML, not the article's generated rules
        const response = await fetch(`/api/sigma-queue/${currentRuleId}/similar-rules?force=true`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            signal: AbortSignal.timeout(60000)  // 60 second timeout
        });
        
        // Remove loading indicator
        const loadingEl = document.getElementById('similarRulesLoading');
        if (loadingEl) loadingEl.remove();
        
        if (!response.ok) {
            // Try to parse error response
            let errorMessage = `HTTP error! status: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.detail || errorData.message || errorMessage;
            } catch (e) {
                // If JSON parsing fails, use status text
                errorMessage = response.statusText || errorMessage;
            }
            alert('Error finding similar rules: ' + errorMessage);
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Parse current rule YAML to extract rule structure
            let currentRuleParsed = null;
            try {
                const yaml = rule.rule_yaml || '';
                const metadata = rule.rule_metadata || {};
                
                if (yaml) {
                    // Function to parse YAML block (improved parser for nested structures)
                    function parseYamlBlock(blockText, indentLevel = 0) {
                        const lines = blockText.split('\n');
                        const result = {};
                        let i = 0;
                        
                        while (i < lines.length) {
                            const line = lines[i];
                            const trimmed = line.trim();
                            if (!trimmed || trimmed.startsWith('#')) {
                                i++;
                                continue;
                            }
                            
                            // Get current line indent
                            const currentIndent = line.match(/^(\s*)/)[1].length;
                            
                            // Check for key-value pair (allow keys with underscores, hyphens, etc.)
                            // Pattern: key: value or key: (with nested content on next line)
                            const kvMatch = trimmed.match(/^([\w_-]+(?:\|[\w_-]+)*):\s*(.*)$/);
                            if (kvMatch) {
                                const key = kvMatch[1];
                                let value = kvMatch[2].trim();
                                
                                // Remove quotes if present
                                if ((value.startsWith('"') && value.endsWith('"')) || 
                                    (value.startsWith("'") && value.endsWith("'"))) {
                                    value = value.slice(1, -1);
                                }
                                
                                // Check if next line starts a nested block or if value is empty (nested content)
                                if (i + 1 < lines.length) {
                                    const nextLine = lines[i + 1];
                                    if (nextLine.trim()) {
                                        const nextIndent = nextLine.match(/^(\s*)/)[1].length;
                                        
                                        if (nextIndent > currentIndent || (!value && nextIndent >= currentIndent)) {
                                            // Nested block - extract it
                                            const nestedLines = [];
                                            let j = i + 1;
                                            while (j < lines.length) {
                                                const nestedLine = lines[j];
                                                if (!nestedLine.trim()) {
                                                    nestedLines.push(nestedLine);
                                                    j++;
                                                    continue;
                                                }
                                                const nestedIndent = nestedLine.match(/^(\s*)/)[1].length;
                                                // Stop if we hit same or less indentation (and it's not empty)
                                                if (nestedIndent <= currentIndent && nestedLine.trim()) {
                                                    break;
                                                }
                                                nestedLines.push(nestedLine);
                                                j++;
                                            }
                                            const nestedBlock = nestedLines.join('\n');
                                            if (nestedBlock.trim()) {
                                                value = parseYamlBlock(nestedBlock, nextIndent);
                                            }
                                            i = j - 1;
                                        } else if (!value) {
                                            // Empty value, no nested content
                                            value = null;
                                        }
                                    }
                                }
                                
                                // Handle array values (lines starting with -)
                                if (typeof value === 'string' && value.startsWith('-')) {
                                    const arrayValues = [];
                                    let arrayLine = i;
                                    while (arrayLine < lines.length) {
                                        const arrLine = lines[arrayLine].trim();
                                        if (arrLine.startsWith('-')) {
                                            const arrValue = arrLine.substring(1).trim();
                                            // Remove quotes
                                            const cleanValue = (arrValue.startsWith('"') && arrValue.endsWith('"')) || 
                                                              (arrValue.startsWith("'") && arrValue.endsWith("'")) ?
                                                              arrValue.slice(1, -1) : arrValue;
                                            arrayValues.push(cleanValue);
                                        } else if (arrLine && !arrLine.startsWith('#')) {
                                            break;
                                        }
                                        arrayLine++;
                                    }
                                    if (arrayValues.length > 0) {
                                        value = arrayValues;
                                        i = arrayLine - 1;
                                    }
                                }
                                
                                result[key] = value;
                            }
                            i++;
                        }
                        
                        return result;
                    }
                    
                    // Extract logsource block
                    let logsourceObj = metadata.logsource || {};
                    const logsourceMatch = yaml.match(/^logsource:\s*\n((?:\s{2,}.*\n?)*)/m);
                    if (logsourceMatch && (!logsourceObj || Object.keys(logsourceObj).length === 0)) {
                        try {
                            logsourceObj = parseYamlBlock(logsourceMatch[1]);
                        } catch (e) {
                            console.warn('Could not parse logsource:', e);
                        }
                    }
                    
                    // Extract detection block (more complex, nested structure)
                    // Prefer metadata.detection if it exists and is complete
                    let detectionObj = metadata.detection || {};
                    
                    // Check if metadata detection is complete (has more than just condition)
                    const hasCompleteDetection = detectionObj && 
                        Object.keys(detectionObj).length > 1 || 
                        (Object.keys(detectionObj).length === 1 && Object.keys(detectionObj)[0] !== 'condition');
                    
                    if (!hasCompleteDetection) {
                        // Try to parse from YAML using improved parser
                        const detectionMatch = yaml.match(/^detection:\s*\n((?:\s{2,}.*\n?)*)/m);
                        if (detectionMatch) {
                            try {
                                // Use a more robust approach: try to parse the entire detection block
                                // Find where detection block ends (next top-level key or end of YAML)
                                const detectionStart = yaml.indexOf('detection:');
                                if (detectionStart !== -1) {
                                    const afterDetection = yaml.substring(detectionStart + 'detection:'.length);
                                    // Find next top-level key (starts at column 0, not indented)
                                    const nextTopLevelMatch = afterDetection.match(/\n^(\w+):/m);
                                    const detectionEnd = nextTopLevelMatch ? 
                                        detectionStart + 'detection:'.length + nextTopLevelMatch.index : 
                                        yaml.length;
                                    
                                    const detectionBlock = yaml.substring(detectionStart, detectionEnd);
                                    detectionObj = parseYamlBlock(detectionBlock.replace(/^detection:\s*\n?/, ''));
                                }
                            } catch (e) {
                                console.warn('Could not parse detection from YAML:', e);
                                // Fall back to metadata even if incomplete
                            }
                        }
                    }
                    
                    // Final fallback: ensure we have at least condition
                    if (!detectionObj || Object.keys(detectionObj).length === 0) {
                        detectionObj = { condition: 'selection' };
                    }
                    
                    currentRuleParsed = {
                        title: metadata.title || '',
                        description: metadata.description || '',
                        tags: metadata.tags || [],
                        logsource: logsourceObj,
                        detection: detectionObj,
                        level: metadata.level || '',
                        status: metadata.status || ''
                    };
                } else {
                    // No YAML, use metadata only
                    currentRuleParsed = {
                        title: metadata.title || '',
                        description: metadata.description || '',
                        tags: metadata.tags || [],
                        logsource: metadata.logsource || {},
                        detection: metadata.detection || {},
                        level: metadata.level || '',
                        status: metadata.status || ''
                    };
                }
            } catch (e) {
                console.warn('Could not parse rule structure:', e);
                // Fallback to metadata
                const metadata = rule.rule_metadata || {};
                currentRuleParsed = {
                    title: metadata.title || '',
                    description: metadata.description || '',
                    tags: metadata.tags || [],
                    logsource: metadata.logsource || {},
                    detection: metadata.detection || {},
                    level: metadata.level || '',
                    status: metadata.status || ''
                };
            }
            
            // Use parsed rule or create from metadata
            const generatedRules = currentRuleParsed ? [currentRuleParsed] : [];
            showSimilarRulesModal(data.matches, data.coverage_summary, generatedRules);
        } else {
            alert('Failed to find similar rules: ' + (data.message || 'Unknown error'));
        }
    } catch (error) {
        // Remove loading indicator
        const loadingEl = document.getElementById('similarRulesLoading');
        if (loadingEl) loadingEl.remove();
        
        console.error('Error checking similar rules:', error);
        if (error.name === 'AbortError' || error.name === 'TimeoutError') {
            alert('Request timed out - LLM reranking may still be processing. Try again in a moment.');
        } else {
            alert('Error checking similar rules: ' + error.message);
        }
    }
}

function showSimilarRulesModal(matches, coverageSummary, generatedRules = []) {
    // Remove any existing modal
    closeSimilarRulesModal();
    
    const modal = document.createElement('div');
    modal.id = 'similarRulesModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    
    // Add click outside to close
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeSimilarRulesModal();
        }
    });
    
    // Add ESC key to close
    const handleEsc = function(e) {
        if (e.key === 'Escape') {
            closeSimilarRulesModal();
            document.removeEventListener('keydown', handleEsc);
        }
    };
    document.addEventListener('keydown', handleEsc);
    
    
    // Build matches HTML
    let matchesHtml = '';
    if (!matches || matches.length === 0) {
        matchesHtml = `
            <div class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 text-green-500 dark:text-green-400 flex items-center justify-center">
                    <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <p class="text-lg font-semibold text-gray-900 dark:text-white mb-2">‚ú® Novel Detection Pattern</p>
                <p class="text-gray-600 dark:text-gray-400 mb-1">No similar rules found in SigmaHQ repository</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">This rule represents a unique detection pattern that is not currently covered by existing SigmaHQ rules.</p>
            </div>
        `;
    } else {
        // Get parsed data from current rule
        let newRuleLogsource = null;
        let newRuleDetection = null;
        if (generatedRules.length > 0) {
            const firstRule = generatedRules[0];
            newRuleLogsource = firstRule.logsource || null;
            newRuleDetection = firstRule.detection || null;
        }
        
        matchesHtml = matches.map((match, index) => {
            const similarityPercent = ((match.similarity_score || match.similarity || 0) * 100).toFixed(1);
            const coverageStatus = match.coverage_status || 'unknown';
            const statusIcon = coverageStatus === 'covered' ? '‚úì' : 
                              coverageStatus === 'extend' ? '‚ö°' : '‚ú®';
            
            // Determine status color classes (using full class names for Tailwind)
            let similarityColorClass = 'text-purple-600 dark:text-purple-400';
            let statusBadgeClass = 'text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900';
            if (coverageStatus === 'covered') {
                similarityColorClass = 'text-green-600 dark:text-green-400';
                statusBadgeClass = 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900';
            } else if (coverageStatus === 'extend') {
                similarityColorClass = 'text-yellow-600 dark:text-yellow-400';
                statusBadgeClass = 'text-yellow-600 dark:text-yellow-400 bg-yellow-100 dark:bg-yellow-900';
            }
            
            // Escape rule_id for JavaScript
            const escapedRuleId = match.rule_id ? match.rule_id.replace(/'/g, "\\'") : '';
            // Escape logsource and detection for safe JSON display
            const logsourceJson = match.logsource ? JSON.stringify(match.logsource, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A';
            const detectionJson = match.detection ? JSON.stringify(match.detection, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A';
            // Escape new rule logsource and detection
            const newRuleLogsourceJson = newRuleLogsource ? JSON.stringify(newRuleLogsource, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A';
            const newRuleDetectionJson = newRuleDetection ? JSON.stringify(newRuleDetection, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A';
            
            return `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900 dark:text-white">${escapeHtml(match.title || 'Untitled Rule')}</h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${escapeHtml(match.description || 'No description')}</p>
                        </div>
                        <div class="ml-4 flex flex-col items-end">
                            <div class="text-2xl font-bold ${similarityColorClass}">${similarityPercent}%</div>
                            <div class="text-xs ${statusBadgeClass} px-2 py-1 rounded mt-1">
                                ${statusIcon} ${coverageStatus.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    ${match.llm_explanation ? `
                        <div class="mt-3 p-2 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded">
                            <div class="text-xs font-bold text-green-900 dark:text-green-100 mb-1">ü§ñ LLM Explanation:</div>
                            <div class="text-xs text-green-800 dark:text-green-200 italic">${escapeHtml(match.llm_explanation)}</div>
                        </div>
                    ` : ''}
                    
                    ${match.similarity_breakdown || match.atom_jaccard !== undefined ? `
                        <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded">
                            <div class="text-xs font-bold text-blue-900 dark:text-blue-100 mb-2">üîç Behavioral Similarity Breakdown:</div>
                            <div class="grid grid-cols-2 gap-1 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-700 dark:text-gray-300">Atom Jaccard <span class="text-gray-500">(weight: 70%)</span>:</span>
                                    <span class="font-medium text-blue-700 dark:text-blue-300">${((match.atom_jaccard || match.similarity_breakdown?.atom_jaccard || 0) * 100).toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-700 dark:text-gray-300">Logic Shape <span class="text-gray-500">(weight: 30%)</span>:</span>
                                    <span class="font-medium text-blue-700 dark:text-blue-300">${match.logic_shape_similarity === null || match.logic_shape_similarity === undefined || match.similarity_breakdown?.logic_shape_similarity === null || match.similarity_breakdown?.logic_shape_similarity === undefined ? 'N/A' : ((match.logic_shape_similarity || match.similarity_breakdown?.logic_shape_similarity || 0) * 100).toFixed(1) + '%'}</span>
                                </div>
                                <div class="col-span-2 pt-1 border-t border-blue-200 dark:border-blue-700 flex justify-between">
                                    <span class="text-gray-700 dark:text-gray-300 font-semibold">Weighted Total:</span>
                                    <span class="font-medium text-blue-700 dark:text-blue-300">${similarityPercent}%</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                        <div><span class="font-medium text-gray-700 dark:text-gray-300">Rule ID:</span> <code class="text-xs bg-gray-100 dark:bg-gray-700 px-1 rounded text-gray-900 dark:text-gray-100">${escapeHtml(match.rule_id || 'N/A')}</code></div>
                        <div><span class="font-medium text-gray-700 dark:text-gray-300">Status:</span> <span class="text-gray-600 dark:text-gray-400">${escapeHtml(match.status || 'N/A')}</span></div>
                    </div>
                    
                    ${match.tags && match.tags.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Tags:</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${match.tags.slice(0, 5).map(tag => 
                                    `<span class="text-xs px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded">${escapeHtml(tag)}</span>`
                                ).join('')}
                                ${match.tags.length > 5 ? `<span class="text-xs text-gray-500 dark:text-gray-400">+${match.tags.length - 5} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${match.matched_discriminators && match.matched_discriminators.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Matched Behaviors:</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${match.matched_discriminators.slice(0, 5).map(d => 
                                    `<span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded">${escapeHtml(d)}</span>`
                                ).join('')}
                                ${match.matched_discriminators.length > 5 ? `<span class="text-xs text-gray-500 dark:text-gray-400">+${match.matched_discriminators.length - 5} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${(match.logsource || match.detection || (generatedRules.length > 0 && (generatedRules[0].logsource || generatedRules[0].detection))) ? `
                        <div class="mt-3 border-t border-gray-200 dark:border-gray-700 pt-3">
                            <button onclick="event.stopPropagation(); toggleRuleDetails('rule-details-${index}', 'toggle-icon-${index}')" 
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium flex items-center">
                                <svg id="toggle-icon-${index}" class="w-4 h-4 mr-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                <span>Show Logsource & Detection Comparison</span>
                            </button>
                            <div id="rule-details-${index}" class="hidden mt-2">
                                ${generatedRules.length > 0 ? `
                                    <div class="mb-4 p-2 bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded">
                                        <h6 class="text-xs font-bold text-yellow-900 dark:text-yellow-100 mb-1">üìù Current Rule: ${escapeHtml(generatedRules[0].title || 'Untitled')}</h6>
                                    </div>
                                ` : ''}
                                <div class="space-y-4">
                                    <!-- Logsource Comparison -->
                                    <div>
                                        <h6 class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">üìã Logsource Comparison</h6>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="border border-gray-200 dark:border-gray-700 rounded p-2 bg-yellow-50 dark:bg-yellow-900">
                                                <h6 class="text-xs font-bold text-yellow-900 dark:text-yellow-100 mb-2">Current Rule</h6>
                                                <pre class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-48 text-gray-900 dark:text-gray-100">${newRuleLogsourceJson}</pre>
                                            </div>
                                            <div class="border border-gray-200 dark:border-gray-700 rounded p-2 bg-blue-50 dark:bg-blue-900">
                                                <h6 class="text-xs font-bold text-blue-900 dark:text-blue-100 mb-2">Similar Rule</h6>
                                                <pre class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-48 text-gray-900 dark:text-gray-100">${logsourceJson}</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Detection Comparison -->
                                    <div>
                                        <h6 class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">üîç Detection Comparison</h6>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="border border-gray-200 dark:border-gray-700 rounded p-2 bg-yellow-50 dark:bg-yellow-900">
                                                <h6 class="text-xs font-bold text-yellow-900 dark:text-yellow-100 mb-2">Current Rule</h6>
                                                <pre class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-64 text-gray-900 dark:text-gray-100">${newRuleDetectionJson}</pre>
                                            </div>
                                            <div class="border border-gray-200 dark:border-gray-700 rounded p-2 bg-green-50 dark:bg-green-900">
                                                <h6 class="text-xs font-bold text-green-900 dark:text-green-100 mb-2">Similar Rule</h6>
                                                <pre class="text-xs bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-pre-wrap font-mono max-h-64 text-gray-900 dark:text-gray-100">${detectionJson}</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        üìÅ ${escapeHtml(match.file_path || 'N/A')}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    modal.innerHTML = `
        <div id="similarRulesModalContent" class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white dark:bg-gray-800 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">üîç Similar Rules in SigmaHQ Repository</h3>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleSimilarRulesModalExpand()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Expand to full screen">
                        <svg id="expandIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                    <button onclick="closeSimilarRulesModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
                Found ${matches ? matches.length : 0} most similar rules${matches && matches.length > 0 && matches[0].similarity_method === 'llm_reranked' ? ' (LLM-reranked)' : matches && matches.length > 0 && matches[0].similarity_method === 'novelty_assessment' ? ' (behavioral novelty assessment)' : ' (behavioral novelty assessment)'} (sorted by similarity)
                ${matches && matches[0] && matches[0].similarity_method === 'llm_reranked' ? `
                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        Analysis by: ${escapeHtml(matches[0].llm_provider || 'unknown')}${matches[0].llm_model ? ' ‚Äî ' + escapeHtml(matches[0].llm_model) : ''}
                    </div>
                ` : ''}
            </div>
            
            <div id="similarRulesMatchesContainer" class="space-y-3 max-h-96 overflow-y-auto">
                ${matchesHtml}
            </div>
            
            <div class="mt-6 flex justify-end">
                <button onclick="closeSimilarRulesModal()" 
                        class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function toggleSimilarRulesModalExpand() {
    const modalContent = document.getElementById('similarRulesModalContent');
    const expandIcon = document.getElementById('expandIcon');
    
    if (!modalContent) return;
    
    isSimilarRulesModalExpanded = !isSimilarRulesModalExpanded;
    
    const matchesContainer = document.getElementById('similarRulesMatchesContainer');
    
    if (isSimilarRulesModalExpanded) {
        // Expand to full screen
        modalContent.className = 'fixed inset-4 p-5 border shadow-lg rounded-md bg-white dark:bg-gray-800 transition-all duration-300 flex flex-col';
        modalContent.style.top = '1rem';
        modalContent.style.left = '1rem';
        modalContent.style.right = '1rem';
        modalContent.style.bottom = '1rem';
        modalContent.style.width = 'auto';
        modalContent.style.maxWidth = 'none';
        modalContent.style.margin = '0';
        
        // Increase max height of matches container
        if (matchesContainer) {
            matchesContainer.className = 'space-y-3 flex-1 overflow-y-auto';
        }
        
        // Update icon to show minimize
        if (expandIcon) {
            expandIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25"></path>';
        }
    } else {
        // Return to normal size
        modalContent.className = 'relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white dark:bg-gray-800 transition-all duration-300';
        modalContent.style.top = '';
        modalContent.style.left = '';
        modalContent.style.right = '';
        modalContent.style.bottom = '';
        modalContent.style.width = '';
        modalContent.style.maxWidth = '';
        modalContent.style.margin = '';
        
        // Reset max height of matches container
        if (matchesContainer) {
            matchesContainer.className = 'space-y-3 max-h-96 overflow-y-auto';
        }
        
        // Update icon to show expand
        if (expandIcon) {
            expandIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>';
        }
    }
}

function closeSimilarRulesModal() {
    const modal = document.getElementById('similarRulesModal');
    if (modal) {
        modal.remove();
        isSimilarRulesModalExpanded = false;
    }
}

function toggleRuleDetails(detailsId, iconId) {
    const detailsDiv = document.getElementById(detailsId);
    const iconSvg = document.getElementById(iconId);
    const button = iconSvg ? iconSvg.closest('button') : null;
    
    if (!detailsDiv || !iconSvg) {
        return;
    }
    
    const isHidden = detailsDiv.classList.contains('hidden');
    
    if (isHidden) {
        detailsDiv.classList.remove('hidden');
        iconSvg.style.transform = 'rotate(180deg)';
        if (button) {
            const span = button.querySelector('span');
            if (span) span.textContent = 'Hide Logsource & Detection Comparison';
        }
    } else {
        detailsDiv.classList.add('hidden');
        iconSvg.style.transform = 'rotate(0deg)';
        if (button) {
            const span = button.querySelector('span');
            if (span) span.textContent = 'Show Logsource & Detection Comparison';
        }
    }
}
</script>
{% endblock %}

