{% extends "base.html" %}

{% block title %}Dashboard v2 - Huntable CTI Studio{% endblock %}

{% block content %}
<style>
/* Modern shadcn-inspired design tokens */
:root {
    --radius: 8px;
    --card-bg: hsl(240 10% 3.9%);
    --card-border: hsl(240 3.7% 15.9%);
    --muted: hsl(240 3.7% 15.9%);
    --muted-foreground: hsl(240 5% 64.9%);
}

.modern-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    transition: all 0.2s ease;
}

.modern-card:hover {
    border-color: hsl(240 5% 26%);
}

.badge {
    display: inline-flex;
    align-items: center;
    border-radius: 6px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-success {
    background: hsl(142 76% 36% / 0.2);
    color: hsl(142 76% 56%);
    border: 1px solid hsl(142 76% 36% / 0.3);
}

.badge-warning {
    background: hsl(48 96% 53% / 0.2);
    color: hsl(48 96% 73%);
    border: 1px solid hsl(48 96% 53% / 0.3);
}

.badge-danger {
    background: hsl(0 84% 60% / 0.2);
    color: hsl(0 84% 70%);
    border: 1px solid hsl(0 84% 60% / 0.3);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--card-border);
}

.stat-item:last-child {
    border-bottom: none;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    position: relative;
}

.health-indicator::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    border: 2px solid currentColor;
    opacity: 0.3;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.2); opacity: 0; }
}
</style>

<div class="min-h-screen p-4 md:p-6 lg:p-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Dashboard v2 (Modern)</h1>
        <p class="text-gray-400">Real-time threat intelligence monitoring with modern UI</p>
        <div class="mt-3 text-sm text-gray-500">
            Last updated: <span id="last-updated">{{ current_time }}</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        
        <!-- Article Ingestion Health -->
        <div class="modern-card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-white">Article Ingestion Health</h3>
                <div id="health-indicator" class="health-indicator bg-green-500"></div>
            </div>
            <div class="space-y-1">
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Uptime</span>
                    <span id="uptime-value" class="font-mono text-green-400">98.7%</span>
                </div>
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Total Sources</span>
                    <span id="total-sources" class="font-mono text-white">135</span>
                </div>
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Avg Response</span>
                    <span id="avg-response" class="font-mono text-blue-400">1.42s</span>
                </div>
            </div>
        </div>

        <!-- Volume Charts -->
        <div class="modern-card p-6 md:col-span-2">
            <h3 class="text-lg font-semibold text-white mb-6">Article Volume</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm text-gray-400">Daily Volume</h4>
                        <span class="badge badge-success">7 days</span>
                    </div>
                    <div class="h-40"><canvas id="dailyChart"></canvas></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm text-gray-400">Hourly Volume</h4>
                        <span class="badge badge-success">24 hours</span>
                    </div>
                    <div class="h-40"><canvas id="hourlyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Failing Sources -->
        <div class="modern-card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-white">Failing Sources</h3>
                <span class="badge badge-danger">3 issues</span>
            </div>
            <div class="space-y-3">
                <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/20">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-white">CyberIntelBlog</span>
                        <span class="badge badge-danger">7</span>
                    </div>
                    <div class="text-xs text-gray-400">Last: 2025-10-03</div>
                </div>
                <div class="p-3 rounded-lg bg-red-500/5 border border-red-500/10">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-white">APTTracker</span>
                        <span class="badge badge-warning">5</span>
                    </div>
                    <div class="text-xs text-gray-400">Last: 2025-10-04</div>
                </div>
            </div>
        </div>

        <!-- High Score Articles -->
        <div class="modern-card p-6 md:col-span-2">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-white">High-Score Articles</h3>
                <a href="/articles" class="text-sm text-blue-400 hover:text-blue-300">View All →</a>
            </div>
            <div id="high-score-articles-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="p-4 rounded-lg bg-gray-700/50 border border-gray-600">
                    <div class="text-right mb-2">
                        <span class="badge badge-success">85</span>
                    </div>
                    <h4 class="font-semibold text-white mb-2">Loading articles...</h4>
                    <p class="text-sm text-gray-400">Please wait</p>
                </div>
            </div>
        </div>

        <!-- System Stats -->
        <div class="modern-card p-6">
            <h3 class="text-lg font-semibold text-white mb-6">System Stats</h3>
            <div class="space-y-1">
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Total Articles</span>
                    <span class="font-mono text-white">{{ stats.total_articles if stats else '0' }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Active Sources</span>
                    <span class="font-mono text-green-400">{{ sources|length if sources else '0' }}</span>
                </div>
                <div class="stat-item">
                    <span class="text-gray-400 text-sm">Queue</span>
                    <span class="font-mono text-yellow-400">12</span>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
Chart.defaults.color = '#71717a';
Chart.defaults.borderColor = 'rgba(113, 113, 122, 0.2)';

let dailyChart = null;
let hourlyChart = null;

async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/data');
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();
        
        document.getElementById('uptime-value').textContent = data.health.uptime + '%';
        document.getElementById('total-sources').textContent = data.health.total_sources;
        document.getElementById('avg-response').textContent = data.health.avg_response_time + 's';
        
        const indicator = document.getElementById('health-indicator');
        indicator.className = data.health.uptime > 95 ? 'health-indicator bg-green-500' : 'health-indicator bg-yellow-500';
        
        if (dailyChart && data.volume.daily) {
            const keys = Object.keys(data.volume.daily).sort();
            dailyChart.data.labels = keys;
            dailyChart.data.datasets[0].data = keys.map(k => data.volume.daily[k]);
            dailyChart.update('none');
        }
        
        if (hourlyChart && data.volume.hourly) {
            hourlyChart.data.labels = Object.keys(data.volume.hourly);
            hourlyChart.data.datasets[0].data = Object.values(data.volume.hourly);
            hourlyChart.update('none');
        }
        
        const container = document.getElementById("high-score-articles-container");
        if (container && data.top_articles) {
            container.innerHTML = "";
            data.top_articles.forEach(article => {
                const badgeClass = "badge-warning";
                const card = document.createElement("a");
                card.href = `/articles/${article.id}`;
                card.className = "block p-4 rounded-lg bg-gray-700/50 border border-gray-600 hover:border-gray-500 transition";
                card.innerHTML = `
                    <div class="text-right mb-2">
                        <span class="badge ${badgeClass}">${article.hunt_score || 0}</span>
                    </div>
                    <h4 class="font-semibold text-white mb-2">${article.title || "Untitled"}</h4>
                    <p class="text-sm text-gray-400">View details →</p>
                `;
                container.appendChild(card);
            });
        }
        
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
    } catch (error) {
        console.error('Dashboard load error:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    
    const opts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
            legend: { display: false },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
                displayColors: false,
                titleFont: { size: 0 },
                callbacks: {
                    title: function() {
                        return '';
                    },
                    label: function(context) {
                        return context.parsed.y;
                    }
                },
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1
            }
        },
        scales: {
            x: { grid: { color: 'rgba(113, 113, 122, 0.1)' } },
            y: { grid: { color: 'rgba(113, 113, 122, 0.1)' } }
        }
    };
    
    dailyChart = new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            datasets: [{
                data: [234, 287, 260, 312, 298],
                borderColor: 'hsl(142 76% 46%)',
                backgroundColor: 'hsla(142 76% 46% / 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: opts
    });

    hourlyChart = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: ['00', '04', '08', '12', '16', '20'],
            datasets: [{
                data: [10, 15, 22, 19, 18, 25],
                borderColor: 'hsl(221 83% 53%)',
                backgroundColor: 'hsla(221 83% 53% / 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: opts
    });
    
    loadDashboardData();
    setInterval(loadDashboardData, 60000);
});
</script>
{% endblock %}