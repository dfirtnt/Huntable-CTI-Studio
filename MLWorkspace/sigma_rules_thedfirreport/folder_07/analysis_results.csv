Filename,Excerpts from DFIR Report,LogSource and Detection
proc_creation_win_reg_bitlocker.yml,"Registry modifications were part of a setup.bat script executed by threat actors. BitLocker registry keys added include: HKLM\SOFTWARE\Policies\Microsoft\FVE\ with EnableBDEWithNoTPM=1, UseAdvancedStartup=1, UseTPM=2, UseTPMKey=2, UseTPMKeyPIN=2, RecoveryKeyMessageSource=2, UseTPMPIN=2, and RecoveryKeyMessage with ransomware contact information. The modifications enable BitLocker encryption with advanced startup options and add a custom recovery message. The script used PowerShell commands to further configure BitLocker including Initialize-Tpm and enabling BitLocker features designed to prepare systems for full disk encryption and prevent recovery.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains|all:
            - 'REG'
            - 'ADD'
            - '\SOFTWARE\Policies\Microsoft\FVE'
            - '/v'
            - '/f'
        CommandLine|contains:
            - 'EnableBDEWithNoTPM'
            - 'UseAdvancedStartup'
            - 'UseTPM'
            - 'UseTPMKey'
            - 'UseTPMKeyPIN'
            - 'RecoveryKeyMessageSource'
            - 'UseTPMPIN'
            - 'RecoveryKeyMessage'
    condition: selection"
proc_creation_win_reg_defender_exclusion.yml,"Qbot used reg.exe to add Windows Defender folder exclusions: C:\Windows\system32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Microsoft Antimalware\Exclusions\Paths /f /t REG_DWORD /v C:\ProgramData\Microsoft\Oweboiqnb /d 0 and C:\Windows\system32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths /f /t REG_DWORD /v C:\ProgramData\Microsoft\Oweboiqnb /d 0. These commands added exclusions for a folder named Oweboiqnb in the ProgramData directory, preventing Windows Defender from scanning files in that location as a defense evasion technique.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\reg.exe'
        CommandLine|contains:
            - 'SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths'
            - 'SOFTWARE\Microsoft\Microsoft Antimalware\Exclusions\Paths'
        CommandLine|contains|all:
            - 'ADD '
            - '/t '
            - 'REG_DWORD '
            - '/v '
            - '/d '
            - '0'
    condition: selection"
proc_creation_win_reg_disable_defender_wmi_autologger.yml,"Threat actors used batch scripts (fed1.bat, fed2.bat, fed3.bat) to disable WMI Autologger sessions for Defender, stop Defender services, remove Defender from startup and context menus, and disable Defender scheduled tasks. Specific registry modifications included setting Defender service start values to 4 (disabled), disabling real-time monitoring, stopping SpyNet reporting, and preventing sample submissions. A representative command: reg add HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderApiLogger /v Start /t REG_DWORD /d 0 /f. The scripts appeared to be lifted from an existing source for defense evasion.","logsource:
    category: process_creation
    product: windows
detection:
    selection_img:
        - Image|endswith: '\reg.exe'
        - OriginalFileName: 'reg.exe'
    selection_reg_path:
        CommandLine|contains:
            - '\Control\WMI\Autologger\DefenderApiLogger\Start'
            - '\Control\WMI\Autologger\DefenderAuditLogger\Start'
    selection_reg_add:
        CommandLine|contains|all:
            - 'add'
            - '0'
    filter_main_enable:
        CommandLine|contains: '0x00000001'
    condition: all of selection_* and not 1 of filter_main_*"
proc_creation_win_reg_lsa_disable_restricted_admin.yml,"Threat actors attempted to enable Restricted Admin Mode by modifying the registry using two methods: PSExec command psexec \\<redacted> -u <redacted>\\<redacted> -p <redacted> reg add hklm\\system\\currentcontrolset\\control\\lsa /f /v DisableRestrictedAdmin /t REG_DWORD /d 0 and PowerShell command using Invoke-WMIExec to run New-ItemProperty -Path HKLM:\\System\\CurrentControlSet\\Control\\Lsa -Name DisableRestrictedAdmin -Value 0 -PropertyType DWORD. The goal was to enable Restricted Admin Mode which allows pass-the-hash RDP attacks where an attacker can establish an RDP session using just the NTLM hash without needing the actual password. Evidence of successful configuration was found in EventID 4624 logs showing Restricted Admin Mode set to Yes.","logsource:
    product: windows
    category: process_creation
detection:
    selection:
        CommandLine|contains|all:
            - '\System\CurrentControlSet\Control\Lsa\'
            - 'DisableRestrictedAdmin'
    condition: selection"
proc_creation_win_reg_lsa_ppl_protection_disabled.yml,"Threat actor disabled LSA protection using the registry command: reg add HKLM\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL /t REG_DWORD /d 0 /f. This was part of the threat actor's defense evasion techniques during the intrusion, aimed at disabling Local Security Authority (LSA) protected process light (PPL) protections.","logsource:
    category: process_creation
    product: windows
detection:
    selection_img:
        - Image|endswith: '\reg.exe'
        - OriginalFileName: 'reg.exe'
    selection_cli:
        CommandLine|contains: 'SYSTEM\CurrentControlSet\Control\Lsa'
        CommandLine|contains|all:
            - ' add '
            - ' /d 0'
            - ' /v RunAsPPL '
    condition: all of selection_*"
proc_creation_win_reg_open_command.yml,"Threat actors used a batch script named fodhelper_reg_hashes.bat to dump registry hives. The technique involves using the fodhelper.exe utility with registry key manipulation, adding entries to HKCU\software\classes\ms-settings\shell\open\command, and saving specific registry hives to files: reg.exe save hklm\sam c:\ProgramData\sam.save, reg.exe save hklm\security c:\ProgramData\security.save, reg.exe save hklm\system c:\ProgramData\system.save. The script uses /ve and /v flags to add and modify registry keys with DelegateExecute being a key part of the manipulation. After dumping the hives, the script deletes the modified registry keys. This method allows credential access by dumping sensitive registry hives containing system authentication information.","logsource:
    category: process_creation
    product: windows
detection:
    selection_1:
        CommandLine|contains|all:
            - 'reg'
            - 'add'
            - 'hkcu\software\classes\ms-settings\shell\open\command'
            - '/ve '
            - '/d'
    selection_2:
        CommandLine|contains|all:
            - 'reg'
            - 'add'
            - 'hkcu\software\classes\ms-settings\shell\open\command'
            - '/v'
            - 'DelegateExecute'
    selection_3:
        CommandLine|contains|all:
            - 'reg'
            - 'delete'
            - 'hkcu\software\classes\ms-settings'
    condition: 1 of selection_*"
proc_creation_win_reg_rdp_keys_tamper.yml,"Threat actors made multiple registry modifications to enable and configure RDP including: increasing maximum RDP connections with REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp /t REG_DWORD /v MaxInstanceCount /d 0xffffffff /f, enabling RDP listener with REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp /t REG_DWORD /v fEnableWinStation /d 1 /f. Configuring terminal server settings to allow terminal server connections, enable concurrent sessions, allow multiple sessions per user, and set terminal services to auto-start. The modifications were part of lateral movement allowing threat actors to establish interactive administrative RDP sessions across different hosts in the network.","logsource:
    product: windows
    category: process_creation
detection:
    selection_main_img:
        - Image|endswith: '\reg.exe'
        - OriginalFileName: 'reg.exe'
    selection_main_cli:
        CommandLine|contains|all:
            - ' add '
            - '\CurrentControlSet\Control\Terminal Server'
            - 'REG_DWORD'
            - ' /f'
    selection_values_1:
        CommandLine|contains|all:
            - 'Licensing Core'
            - 'EnableConcurrentSessions'
    selection_values_2:
        CommandLine|contains:
            - 'WinStations\RDP-Tcp'
            - 'MaxInstanceCount'
            - 'fEnableWinStation'
            - 'TSUserEnabled'
            - 'TSEnabled'
            - 'TSAppCompat'
            - 'IdleWinStationPoolCount'
            - 'TSAdvertise'
            - 'AllowTSConnections'
            - 'fSingleSessionPerUser'
            - 'fDenyTSConnections'
    condition: all of selection_main_* and 1 of selection_values_*"
proc_creation_win_reg_windows_defender_tamper.yml,"Threat actor used PowerShell to modify Windows Defender settings including disabling Behavior Monitoring, setting Severe Threat default action to Allow, disabling Real-time Monitoring, and adding exclusion path for C:\Windows. The PowerShell command used was: try {Set-MpPreference -DisableBehaviorMonitoring 1 -AsJob; Set-MpPreference -SevereThreatDefaultAction Allow -AsJob; Set-MpPreference -DisableRealtimeMonitoring 1 -AsJob; Add-MpPreference -ExclusionPath C:\\Windows -Force -AsJob} catch {}. These actions were part of the threat actor's defense evasion techniques during the intrusion.","logsource:
    category: process_creation
    product: windows
detection:
    selection_root_img:
        - Image|endswith: '\reg.exe'
        - OriginalFileName: 'reg.exe'
    selection_root_path:
        CommandLine|contains:
            - 'SOFTWARE\Microsoft\Windows Defender\'
            - 'SOFTWARE\Policies\Microsoft\Windows Defender Security Center'
            - 'SOFTWARE\Policies\Microsoft\Windows Defender\'
    selection_dword_0:
        CommandLine|contains|all:
            - ' add '
            - 'd 0'
        CommandLine|contains:
            - 'DisallowExploitProtectionOverride'
            - 'EnableControlledFolderAccess'
            - 'MpEnablePus'
            - 'PUAProtection'
            - 'SpynetReporting'
            - 'SubmitSamplesConsent'
            - 'TamperProtection'
    selection_dword_1:
        CommandLine|contains|all:
            - ' add '
            - 'd 1'
        CommandLine|contains:
            - 'DisableAccess'
            - 'DisableAntiSpyware'
            - 'DisableAntiSpywareRealtimeProtection'
            - 'DisableAntiVirus'
            - 'DisableAntiVirusSignatures'
            - 'DisableArchiveScanning'
            - 'DisableBehaviorMonitoring'
            - 'DisableBlockAtFirstSeen'
            - 'DisableCloudProtection'
            - 'DisableConfig'
            - 'DisableEnhancedNotifications'
            - 'DisableIntrusionPreventionSystem'
            - 'DisableIOAVProtection'
            - 'DisableNetworkProtection'
            - 'DisableOnAccessProtection'
            - 'DisablePrivacyMode'
            - 'DisableRealtimeMonitoring'
            - 'DisableRoutinelyTakingAction'
            - 'DisableScanOnRealtimeEnable'
            - 'DisableScriptScanning'
            - 'DisableSecurityCenter'
            - 'Notification_Suppress'
            - 'SignatureDisableUpdateOnStartupWithoutEngine'
    condition: all of selection_root_* and 1 of selection_dword_*"
proc_creation_win_registry_special_accounts_hide_user.yml,"The threat actor created a script that uses the registry key HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList to hide a user account from the login screen. The script creates a user named Support and then adds a registry value: reg add HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList /t REG_DWORD /f /d 0 /v Support. Setting the value to 0 prevents the Support account from being displayed on the login screen, effectively hiding it from view while still maintaining system access.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\reg.exe'
        CommandLine|contains|all:
            - '\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList'
            - 'add'
            - '/v'
            - '/d 0'
    condition: selection"
proc_creation_win_regsvr32_dllregisterserver_exec.yml,"After dropping 1.dll (Cobalt Strike) on the domain controller, the threat actor executed it using: rundll32.exe 1.dll, DllRegisterServer. This command was used to register or execute the Cobalt Strike DLL on the compromised domain controller. The execution method suggests an attempt to load and initialize the malicious DLL using the standard Windows DLL registration mechanism.","logsource:
    category: process_creation
    product: windows
detection:
    selection_image:
        - Image|endswith: '\regsvr32.exe'
        - OriginalFileName: 'REGSVR32.EXE'
    selection_cmdline:
        CommandLine|contains:
            - ' /s '
            - ' /e '
    filter_main_paths:
        - CommandLine|contains:
              - ':\Program Files (x86)'
              - ':\Program Files\'
              - ':\Windows\System32\'
              - ':\Windows\SysWOW64\'
        - CurrentDirectory|contains:
              - ':\Program Files (x86)'
              - ':\Program Files\'
              - ':\Windows\System32\'
              - ':\Windows\SysWOW64\'
    filter_main_other_flags:
        CommandLine|contains:
            - ' /i:'
            - '/U '
    filter_main_rpcproxy:
        ParentCommandLine|endswith: ':\Windows\System32\RpcProxy\RpcProxy.dll'
        CommandLine: 'regsvr32 /s rpcproxy.dll'
    condition: all of selection_* and not 1 of filter_main_*"