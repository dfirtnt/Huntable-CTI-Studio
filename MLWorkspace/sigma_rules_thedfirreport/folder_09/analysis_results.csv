Filename,Excerpts from DFIR Report,LogSource and Detection
proc_creation_win_schtasks_appdata_local_system.yml,"Based on referenced DFIR report URLs, Qbot threat actors created scheduled tasks that execute files from C:\Users\<USER>\AppData\Local directories with SYSTEM privileges. These tasks were used for persistence and to execute malicious payloads from user profile directories, often with elevated permissions to maintain access and execute additional malicious activities.","logsource:
    product: windows
    category: process_creation
detection:
    selection:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains|all:
            - '/Create'
            - '/RU'
            - '/TR'
            - 'C:\Users\'
            - '\AppData\Local\'
        CommandLine|contains:
            - 'NT AUT'
            - ' SYSTEM '
    filter:
        ParentImage|contains|all:
            - '\AppData\Local\Temp\'
            - 'TeamViewer_.exe'
        Image|endswith: '\schtasks.exe'
        CommandLine|contains: '/TN TVInstallRestore'
    condition: selection and not filter"
proc_creation_win_schtasks_disable.yml,"Threat actors used batch scripts (fed1.bat, fed2.bat, fed3.bat) to disable WMI Autologger sessions for Defender, stop Defender services, remove Defender from startup and context menus, and disable Defender scheduled tasks. This was part of their defense evasion strategy where adversaries stop services or processes by disabling their respective scheduled tasks in order to conduct data destructive activities. The scripts appeared to be lifted from an existing source for defense evasion.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains|all:
            - '/Change'
            - '/TN'
            - '/disable'
        CommandLine|contains:
            - '\Windows\BitLocker'
            - '\Windows\ExploitGuard'
            - '\Windows\ExploitGuard\ExploitGuard MDM policy Refresh'
            - '\Windows\SystemRestore\SR'
            - '\Windows\UpdateOrchestrator\'
            - '\Windows\Windows Defender\'
            - '\Windows\WindowsBackup\'
            - '\Windows\WindowsUpdate\'
    condition: selection"
proc_creation_win_schtasks_guid_task_name.yml,"Threat actors created scheduled tasks with GUID-like names as part of their persistence strategy. Examples from DFIR reports include tasks named with GUIDs like {97F2F70B-10D1-4447-A2F3-9B070C86E261} which executed PowerShell commands to decode and execute base64 encoded payloads stored in the registry. This technique helps blend malicious tasks with legitimate system tasks that sometimes use GUID naming conventions.","logsource:
    product: windows
    category: process_creation
detection:
    selection_img:
        Image|endswith: '\schtasks.exe'
        CommandLine|contains: '/Create '
    selection_tn:
        CommandLine|contains:
            - '/TN ""{'
            - ""/TN '{"
            - ""/TN {"
    selection_end:
        CommandLine|contains:
            - '}""'
            - ""}'"
            - '} '
    condition: all of selection_*"
proc_creation_win_schtasks_openssh_tunnelling.yml,"From referenced DFIR report, threat actors potentially used SSH tunneling for persistence and command and control. They likely created scheduled tasks that call OpenSSH tools (sshd.exe or ssh.exe) to establish reverse SSH tunnels to attacker servers, providing persistent remote access and bypassing network security controls.","logsource:
    product: windows
    category: process_creation
detection:
    selection_img:
        - Image|endswith: '\schtasks.exe'
        - OriginalFileName: 'schtasks.exe'
    selection_cli_sshd:
        CommandLine|contains|all:
            - ' /create '
            - 'sshd.exe'
            - '-f'
    selection_cli_ssh:
        CommandLine|contains|all:
            - ' /create '
            - 'ssh.exe'
            - '-i'
    condition: selection_img and 1 of selection_cli_*"
proc_creation_win_schtasks_reg_loader_encoded.yml,"Threat actors created a scheduled task with a GUID name {97F2F70B-10D1-4447-A2F3-9B070C86E261} that executed a PowerShell command: cmd /c start /min \"\" powershell.exe -Command IEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((Get-ItemProperty -Path HKCU:\SOFTWARE\Pvoeooxf).yzbbvhhdypa))). This task executed every 30 minutes and decoded base64 encoded payload stored in the Windows Registry using PowerShell for persistence and payload execution.","logsource:
    product: windows
    category: process_creation
detection:
    selection_img:
        - Image|endswith: '\schtasks.exe'
        - OriginalFileName: 'schtasks.exe'
    selection_cli_create:
        CommandLine|contains: '/Create'
    selection_cli_encoding:
        CommandLine|contains:
            - 'FromBase64String'
            - 'encodedcommand'
    selection_cli_get:
        CommandLine|contains:
            - 'Get-ItemProperty'
            - ' gp '
    selection_cli_hive:
        CommandLine|contains:
            - 'HKCU:'
            - 'HKLM:'
            - 'registry::'
            - 'HKEY_'
    condition: all of selection_*"
proc_creation_win_schtasks_reg_loader.yml,"Threat actors created a scheduled task with a GUID name {97F2F70B-10D1-4447-A2F3-9B070C86E261} that executed a PowerShell command to retrieve and execute payloads from the Windows Registry. The task used Get-ItemProperty to access registry values and executed the stored payload, providing a persistence mechanism that stores malicious code in the registry rather than on disk.","logsource:
    product: windows
    category: process_creation
detection:
    selection_img:
        - Image|endswith: '\schtasks.exe'
        - OriginalFileName: 'schtasks.exe'
    selection_cli_create:
        CommandLine|contains: '/Create'
    selection_cli_get:
        CommandLine|contains:
            - 'Get-ItemProperty'
            - ' gp '
    selection_cli_hive:
        CommandLine|contains:
            - 'HKCU:'
            - 'HKLM:'
            - 'registry::'
            - 'HKEY_'
    filter_main_encoding:
        CommandLine|contains:
            - 'FromBase64String'
            - 'encodedcommand'
    condition: all of selection_* and not 1 of filter_*"
proc_creation_win_sqlcmd_veeam_dump.yml,"Threat actor used sqlcmd.exe to dump credentials from the Veeam database: sqlcmd -E -S localhost,51341 -E -y0 -Q SELECT TOP (1000) [id],[user_name],[password],[usn],[description],[visible],[change_time_utc]FROM [VeeamBackup].[dbo].[Credentials]. They created a C# decryption script to decode the base64 encoded passwords using DPAPI (Data Protection API), created a file veeam1.cs.txt with a decryption method, used .NET Framework's csc.exe to compile the script, and executed the script to reveal passwords used by Veeam. The decryption was done using ProtectedData.Unprotect() method which decrypts data protected by the local machine's encryption key. The entire process was performed via RDP on the backup server.","logsource:
    category: process_creation
    product: windows
detection:
    selection_tools:
        Image|endswith: '\sqlcmd.exe'
    selection_query:
        CommandLine|contains|all:
            - 'SELECT'
            - 'TOP'
            - '[VeeamBackup].[dbo].[Credentials]'
    condition: all of selection_*"
proc_creation_win_susp_copy_system_dir_lolbin.yml,"Threat actor used xcopy to copy rundll32.exe to %temp%\entails.exe, likely to evade detection logic based around command line execution. The threat actor used multiple methods to copy files across the network including direct copy command on the domain controller and WMIC to execute copy commands from remote hosts. Specific suspicious copy operations included copying rundll32.exe to %temp%\entails.exe, copying k.exe and p.bat to other hosts in the domain, and attempting to copy files using both direct copy and WMIC as a redundant method. These copy operations were part of the threat actor's lateral movement and file transfer strategy.","logsource:
    category: process_creation
    product: windows
detection:
    selection_tools_cmd:
        Image|endswith: '\cmd.exe'
        CommandLine|contains: 'copy '
    selection_tools_pwsh:
        Image|endswith:
            - '\powershell.exe'
            - '\pwsh.exe'
        CommandLine|contains:
            - 'copy-item'
            - ' copy '
            - 'cpi '
            - ' cp '
    selection_tools_other:
        - Image|endswith:
              - '\robocopy.exe'
              - '\xcopy.exe'
        - OriginalFileName:
              - 'robocopy.exe'
              - 'XCOPY.EXE'
    selection_target_path:
        CommandLine|contains:
            - '\System32'
            - '\SysWOW64'
            - '\WinSxS'
    selection_target_lolbin:
        CommandLine|contains:
            - '\bitsadmin.exe'
            - '\calc.exe'
            - '\certutil.exe'
            - '\cmdl32.exe'
            - '\cscript.exe'
            - '\mshta.exe'
            - '\rundll32.exe'
            - '\wscript.exe'
    condition: 1 of selection_tools_* and all of selection_target_*"
proc_creation_win_susp_copy_system_dir.yml,"Threat actor used xcopy to copy rundll32.exe to %temp%\entails.exe, likely to evade detection logic based around command line execution. The threat actor used multiple methods to copy files across the network including direct copy command on the domain controller and WMIC to execute copy commands from remote hosts. Specific suspicious copy operations included copying rundll32.exe to %temp%\entails.exe, copying k.exe and p.bat to other hosts in the domain, and attempting to copy files using both direct copy and WMIC as a redundant method. These copy operations were part of the threat actor's lateral movement and file transfer strategy.","logsource:
    category: process_creation
    product: windows
detection:
    selection_cmd:
        Image|endswith: '\cmd.exe'
        CommandLine|contains: 'copy '
    selection_pwsh:
        Image|endswith:
            - '\powershell.exe'
            - '\pwsh.exe'
        CommandLine|contains:
            - 'copy-item'
            - ' copy '
            - 'cpi '
            - ' cp '
    selection_other:
        - Image|endswith:
              - '\robocopy.exe'
              - '\xcopy.exe'
        - OriginalFileName:
              - 'robocopy.exe'
              - 'XCOPY.EXE'
    target:
        CommandLine|contains:
            - '\System32'
            - '\SysWOW64'
            - '\WinSxS'
    condition: 1 of selection_* and target"
proc_creation_win_susp_eventlog_content_recon.yml,"From referenced DFIR reports, threat actors use different log query utilities and commands to search and dump the content of specific event logs or look for specific event IDs. This technique is used to extract sensitive information from event logs such as usernames, IP addresses, hostnames, etc. Attackers may query specific event logs like Microsoft-Windows-Security-Auditing, Microsoft-Windows-PowerShell, Security logs, and target specific event IDs like 4624 (logon events), 4778 (session reconnect), and 25 (Terminal Services session events) to gather intelligence about system activity and users.","logsource:
    category: process_creation
    product: windows
detection:
    selection_wmi:
        CommandLine|contains|all:
            - 'Select'
            - 'Win32_NTLogEvent'
    selection_wevtutil_img:
        - Image|endswith: '\wevtutil.exe'
        - OriginalFileName: 'wevtutil.exe'
    selection_wevtutil_cli:
        CommandLine|contains:
            - ' qe '
            - ' query-events '
    selection_wmic_img:
        - Image|endswith: '\wmic.exe'
        - OriginalFileName: 'wmic.exe'
    selection_wmic_cli:
        CommandLine|contains: ' ntevent'
    selection_cmdlet:
        CommandLine|contains:
            - 'Get-WinEvent '
            - 'get-eventlog '
    selection_logs_name:
        CommandLine|contains:
            - 'Microsoft-Windows-PowerShell'
            - 'Microsoft-Windows-Security-Auditing'
            - 'Microsoft-Windows-TerminalServices-LocalSessionManager'
            - 'Microsoft-Windows-TerminalServices-RemoteConnectionManager'
            - 'Microsoft-Windows-Windows Defender'
            - 'PowerShellCore'
            - 'Security'
            - 'Windows PowerShell'
    selection_logs_eid:
        CommandLine|contains:
            - '-InstanceId 462?'
            - '.eventid -eq 462?'
            - 'EventCode=?462?'
            - 'EventIdentifier=?462?'
            - 'System[EventID=462?]'
            - '-InstanceId 4778'
            - '.eventid -eq 4778'
            - 'System[EventID=4778]'
            - 'EventCode=?4778?'
            - 'EventIdentifier=?4778?'
            - '-InstanceId 25'
            - '.eventid -eq 25'
            - 'System[EventID=25]'
            - 'EventCode=?25?'
            - 'EventIdentifier=?25?'
    condition: 1 of selection_logs_* and (selection_wmi or all of selection_wevtutil_* or all of selection_wmic_* or selection_cmdlet)"