Filename,Excerpts from DFIR Report,LogSource and Detection
proc_creation_win_net_user_add_never_expire.yml,"Command Used: NET USER Adminv$ !67hCS14ORVg /ADD /expires:never. Specific techniques observed include creating a new local user account, setting account to never expire, adding the new user to local administrators group, and hiding the user account via registry. Detection indicators include watching for NET USER commands with /expires:never flag, monitoring for new users added to Administrators group, and checking registry key HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist.","logsource:
    category: process_creation
    product: windows
detection:
    selection_img:
        - Image|endswith:
              - '\net.exe'
              - '\net1.exe'
        - OriginalFileName:
              - 'net.exe'
              - 'net1.exe'
    selection_cli:
        CommandLine|contains|all:
            - 'user'
            - 'add'
            - 'expires:never'
    condition: all of selection_*"
proc_creation_win_nltest_recon.yml,"Attackers used nltest commands for domain reconnaissance and trust discovery: nltest /domain_trusts /all_trusts and nltest /dclist:DOMAIN. Commands were part of discovery phase to map domain trusts, list domain controllers, and gather network environment information. Also observed: nltest /domain_trusts executed from injected svchost.exe process and later from Cobalt Strike beacons, indicating systematic approach to network reconnaissance.","logsource:
    category: process_creation
    product: windows
detection:
    selection_nltest:
        - Image|endswith: '\nltest.exe'
        - OriginalFileName: 'nltestrk.exe'
    selection_recon:
        - CommandLine|contains|all:
              - 'server'
              - 'query'
        - CommandLine|contains:
              - '/user'
              - 'all_trusts'
              - 'dclist:'
              - 'dnsgetdc:'
              - 'domain_trusts'
              - 'dsgetdc:'
              - 'parentdomain'
              - 'trusted_domains'
    condition: all of selection_*"
proc_creation_win_notepad_local_passwd_discovery.yml,"Two specific instances of password file discovery using Notepad: 1) After running Mimikatz, threat actor opened the newly generated password file in Notepad, 2) On a file share server, threat actor discovered a txt file that contained IT-related cleartext passwords and proceeded with opening the txt file using Notepad. These actions were captured in Sysmon event logs, specifically event code 1 showing Notepad process execution.","logsource:
    product: windows
    category: process_creation
detection:
    selection:
        ParentImage|endswith: '\explorer.exe'
        Image|endswith: '\notepad.exe'
        CommandLine|endswith:
            - 'password*.txt'
            - 'password*.csv'
            - 'password*.doc'
            - 'password*.xls'
    condition: selection"
proc_creation_win_nslookup_domain_discovery.yml,"Qbot malware performed network reconnaissance using the command: nslookup -querytype=ALL -timeout=10 _ldap._tcp.dc._msdcs.REDACTED. This specific query is typically used to discover domain controllers in a Windows Active Directory environment. The command attempts to locate LDAP services associated with domain controllers, which helps the attacker map the network's domain infrastructure as part of Qbot's broader discovery phase.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains|all:
            - 'nslookup'
            - '_ldap._tcp.dc._msdcs.'
    condition: selection"
proc_creation_win_office_from_proxy_executing_regsvr32_payload.yml,"Initial execution involved an xlsm document that used a macro to initiate a wmic command and executed a file via regsvr32 from a remote executable disguised as a GIF image. Specific execution: wmic.exe process call create 'regsvr32 -s C:\Users\Public\microsoft.security'. Downloaded file from http://vpu03jivmm03qncgx.com/index.gif where the GIF was actually the IcedID malware. The execution method leveraged Office application (Excel) to spawn a suspicious child process through wmic and regsvr32.","logsource:
    product: windows
    category: process_creation
detection:
    selection_img:
        - Image|endswith: '\wbem\WMIC.exe'
        - OriginalFileName: 'wmic.exe'
    selection_other:
        CommandLine|contains:
            - 'regsvr32'
            - 'rundll32'
            - 'msiexec'
            - 'mshta'
            - 'verclsid'
        ParentImage|endswith:
            - '\winword.exe'
            - '\excel.exe'
            - '\powerpnt.exe'
        CommandLine|contains|all:
            - 'process'
            - 'create'
            - 'call'
    condition: all of selection_*"
proc_creation_win_office_from_proxy_executing_regsvr32_payload2.yml,"Initial execution involved an xlsm document that used a macro to initiate a wmic command and executed a file via regsvr32 from a remote executable disguised as a GIF image. Specific execution: wmic.exe process call create 'regsvr32 -s C:\Users\Public\microsoft.security'. Downloaded file from http://vpu03jivmm03qncgx.com/index.gif where the GIF was actually the IcedID malware. The execution method leveraged Office application (Excel) to spawn a suspicious child process through wmic and regsvr32.","logsource:
    product: windows
    category: process_creation
detection:
    selection1:
        CommandLine|contains:
            - 'regsvr32'
            - 'rundll32'
            - 'msiexec'
            - 'mshta'
            - 'verclsid'
    selection2:
        - Image|endswith: '\wbem\WMIC.exe'
        - CommandLine|contains: 'wmic '
    selection3:
        ParentImage|endswith:
            - '\winword.exe'
            - '\excel.exe'
            - '\powerpnt.exe'
    selection4:
        CommandLine|contains|all:
            - 'process'
            - 'create'
            - 'call'
    condition: all of selection*"
proc_creation_win_office_spawning_wmi_commandline.yml,"Initial execution involved an xlsm document that used a macro to initiate a wmic command and executed a file via regsvr32 from a remote executable disguised as a GIF image. Specific execution: wmic.exe process call create 'regsvr32 -s C:\Users\Public\microsoft.security'. Downloaded file from http://vpu03jivmm03qncgx.com/index.gif where the GIF was actually the IcedID malware. The execution method leveraged Office application (Excel) to spawn a suspicious child process through wmic and regsvr32.","logsource:
    product: windows
    category: process_creation
detection:
    selection1:
        - Image|endswith: '\wbem\WMIC.exe'
        - CommandLine|contains: 'wmic '
    selection2:
        ParentImage|endswith:
            - '\winword.exe'
            - '\excel.exe'
            - '\powerpnt.exe'
            - '\msaccess.exe'
            - '\mspub.exe'
            - '\eqnedt32.exe'
            - '\visio.exe'
    condition: all of selection*"
proc_creation_win_office_susp_child_processes.yml,"Initial execution involved an xlsm document that used a macro to initiate a wmic command and executed a file via regsvr32 from a remote executable disguised as a GIF image. Specific execution: wmic.exe process call create 'regsvr32 -s C:\Users\Public\microsoft.security'. Downloaded file from http://vpu03jivmm03qncgx.com/index.gif where the GIF was actually the IcedID malware. The execution method leveraged Office application (Excel) to spawn a suspicious child process through wmic and regsvr32.","logsource:
    category: process_creation
    product: windows
detection:
    selection_parent:
        ParentImage|endswith:
            - '\EQNEDT32.EXE'
            - '\EXCEL.EXE'
            - '\MSACCESS.EXE'
            - '\MSPUB.exe'
            - '\ONENOTE.EXE'
            - '\POWERPNT.exe'
            - '\VISIO.exe'
            - '\WINWORD.EXE'
            - '\wordpad.exe'
            - '\wordview.exe'
    selection_child_processes:
        - OriginalFileName:
              - 'bitsadmin.exe'
              - 'CertOC.exe'
              - 'CertUtil.exe'
              - 'Cmd.Exe'
              - 'CMSTP.EXE'
              - 'cscript.exe'
              - 'curl.exe'
              - 'HH.exe'
              - 'IEExec.exe'
              - 'InstallUtil.exe'
              - 'javaw.exe'
              - 'Microsoft.Workflow.Compiler.exe'
              - 'msdt.exe'
              - 'MSHTA.EXE'
              - 'msiexec.exe'
              - 'Msxsl.exe'
              - 'odbcconf.exe'
              - 'pcalua.exe'
              - 'PowerShell.EXE'
              - 'RegAsm.exe'
              - 'RegSvcs.exe'
              - 'REGSVR32.exe'
              - 'RUNDLL32.exe'
              - 'schtasks.exe'
              - 'ScriptRunner.exe'
              - 'wmic.exe'
              - 'WorkFolders.exe'
              - 'wscript.exe'
        - Image|endswith:
              - '\AppVLP.exe'
              - '\bash.exe'
              - '\bitsadmin.exe'
              - '\certoc.exe'
              - '\certutil.exe'
              - '\cmd.exe'
              - '\cmstp.exe'
              - '\control.exe'
              - '\cscript.exe'
              - '\curl.exe'
              - '\forfiles.exe'
              - '\hh.exe'
              - '\ieexec.exe'
              - '\installutil.exe'
              - '\javaw.exe'
              - '\mftrace.exe'
              - '\Microsoft.Workflow.Compiler.exe'
              - '\msbuild.exe'
              - '\msdt.exe'
              - '\mshta.exe'
              - '\msidb.exe'
              - '\msiexec.exe'
              - '\msxsl.exe'
              - '\odbcconf.exe'
              - '\pcalua.exe'
              - '\powershell.exe'
              - '\pwsh.exe'
              - '\regasm.exe'
              - '\regsvcs.exe'
              - '\regsvr32.exe'
              - '\rundll32.exe'
              - '\schtasks.exe'
              - '\scrcons.exe'
              - '\scriptrunner.exe'
              - '\sh.exe'
              - '\svchost.exe'
              - '\verclsid.exe'
              - '\wmic.exe'
              - '\workfolders.exe'
              - '\wscript.exe'
    selection_child_susp_paths:
        Image|contains:
            - '\AppData\'
            - '\Users\Public\'
            - '\ProgramData\'
            - '\Windows\Tasks\'
            - '\Windows\Temp\'
            - '\Windows\System32\Tasks\'
    condition: selection_parent and 1 of selection_child_*"
proc_creation_win_powershell_base64_invoke_susp_cmdlets.yml,"Multiple layers of encoding were used including hexadecimal, XOR, base64, and gunzip decoding. Encoded commands often invoked Mimikatz credential extraction, LaZagne password dumping, remote execution via WMIExec, and SharpHound Active Directory discovery. A representative encoded command used XOR and Base64, which when decoded revealed Invoke-Mimikatz. Used complex decoding methods and often used -nop -w hidden -c PowerShell flags to hide execution while frequently downloading and executing remote scripts.","logsource:
    category: process_creation
    product: windows
detection:
    selection:
        CommandLine|contains:
            - 'SQBuAHYAbwBrAGUALQBCAGwAbwBvAGQASABvAHUAbgBkA'
            - 'kAbgB2AG8AawBlAC0AQgBsAG8AbwBkAEgAbwB1AG4AZA'
            - 'JAG4AdgBvAGsAZQAtAEIAbABvAG8AZABIAG8AdQBuAGQA'
            - 'SQBuAHYAbwBrAGUALQBNAGkAbQBpAGsAYQB0AHoA'
            - 'kAbgB2AG8AawBlAC0ATQBpAG0AaQBrAGEAdAB6A'
            - 'JAG4AdgBvAGsAZQAtAE0AaQBtAGkAawBhAHQAeg'
            - 'SQBuAHYAbwBrAGUALQBXAE0ASQBFAHgAZQBjA'
            - 'kAbgB2AG8AawBlAC0AVwBNAEkARQB4AGUAYw'
            - 'JAG4AdgBvAGsAZQAtAFcATQBJAEUAeABlAGMA'
    condition: selection"
proc_creation_win_powershell_base64_invoke.yml,"Multiple layers of encoding were used including hexadecimal, XOR, base64, and gunzip decoding. Encoded commands often invoked Mimikatz credential extraction, LaZagne password dumping, remote execution via WMIExec, and SharpHound Active Directory discovery. A representative encoded command used XOR and Base64, which when decoded revealed Invoke-Mimikatz. Used complex decoding methods and often used -nop -w hidden -c PowerShell flags to hide execution while frequently downloading and executing remote scripts.","logsource:
    category: process_creation
    product: windows
detection:
    selection_img:
        - Image|endswith:
              - '\powershell.exe'
              - '\pwsh.exe'
        - OriginalFileName:
              - 'PowerShell.EXE'
              - 'pwsh.dll'
    selection_cli_enc:
        CommandLine|contains: ' -e'
    selection_cli_invoke:
        CommandLine|contains:
            - 'SQBuAHYAbwBrAGUALQ'
            - 'kAbgB2AG8AawBlAC0A'
            - 'JAG4AdgBvAGsAZQAtA'
            - 'SW52b2tlL'
            - 'ludm9rZS'
            - 'JbnZva2Ut'
    condition: all of selection_*"